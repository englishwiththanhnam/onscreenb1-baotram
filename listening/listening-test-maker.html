<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bài Thi Nghe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- === CẤU HÌNH FIREBASE === -->
    <script type="module">
        // DỰ ÁN CHÍNH (DÙNG CHO DATABASE & AUTH)
        const primaryFirebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.primaryFirebaseConfig = primaryFirebaseConfig;

        // DỰ ÁN PHỤ (CHỈ DÙNG CHO STORAGE)
        const storageFirebaseConfig = {
          apiKey: "AIzaSyD6jCTrKWrerZTyB_sAejxqcuUpUvg91Pk",
          authDomain: "data-storage-285e6.firebaseapp.com",
          projectId: "data-storage-285e6",
          storageBucket: "data-storage-285e6.appspot.com",
          messagingSenderId: "300159133661",
          appId: "1:300159133661:web:28c26715e55f840c88f834",
          measurementId: "G-VYE4DKRXEF"
        };
        window.storageFirebaseConfig = storageFirebaseConfig;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .btn { font-weight: 600; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .input-field { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; }
        textarea.input-field { min-height: 200px; font-family: monospace; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4f46e5; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Styles for drag and drop */
        .draggable { cursor: move; }
        .dragging { opacity: 0.5; background: #c7d2fe; }
        .drag-over { border: 2px dashed #4f46e5; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- Màn hình đăng nhập -->
    <div id="login-screen" class="fixed inset-0 bg-gray-800 bg-opacity-90 flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Đăng nhập Giáo viên</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input">Email</label><input type="email" id="email-input" class="input-field w-full mt-1"></div>
                <div><label for="password-input">Mật khẩu</label><input type="password" id="password-input" class="input-field w-full mt-1"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-6xl mx-auto" style="display: none;">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Soạn Thảo Bài Thi Nghe</h1>
            <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
        </div>

        <!-- Thông tin chung -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="test-id">Listening Test ID</label><input type="text" id="test-id" class="input-field mt-1" placeholder="vd: ielts_listening_test_1"></div>
                <div><label for="test-title">Tiêu đề</label><input type="text" id="test-title" class="input-field mt-1" placeholder="vd: IELTS Listening Practice Test 1"></div>
            </div>
        </div>

        <!-- Cấu hình Audio -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Cấu hình Audio</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div><label for="play-count">Số lần nghe</label><input type="number" id="play-count" class="input-field mt-1" value="1" min="1"></div>
                <div><label for="pause-between">Giây nghỉ giữa các file</label><input type="number" id="pause-between" class="input-field mt-1" value="5" min="0"></div>
                <div class="md:col-span-3">
                    <label for="audio-upload">Tải lên file audio (mp3, wav, m4a)</label>
                    <input type="file" id="audio-upload" class="mt-1" multiple accept="audio/*">
                    <p class="text-xs text-gray-500 mt-2">Kéo thả các file dưới đây để sắp xếp lại thứ tự phát.</p>
                    <div id="upload-status-list" class="mt-2 text-sm text-gray-600 space-y-2 p-2 border rounded-md bg-gray-50 min-h-[50px]"></div>
                </div>
            </div>
        </div>
        
        <!-- Nội dung & Đáp án -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Nội dung & Đáp án</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div><label for="questions-html">Nội dung đề thi (HTML)</label><textarea id="questions-html" class="input-field" placeholder="Dán mã HTML..."></textarea></div>
                <div><label for="answers-text">Đáp án</label><textarea id="answers-text" class="input-field" placeholder="1. answer one..."></textarea></div>
            </div>
        </div>

        <!-- Nút lưu -->
        <div class="mt-8 text-center">
             <button id="upload-btn" class="btn btn-primary text-lg w-full md:w-1/2"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bài Thi</button>
             <p id="upload-log" class="font-semibold mt-2 h-5"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const appState = { db: null, auth: null, storage: null, audioFiles: [] };
        const DOM = {
            loginScreen: document.getElementById('login-screen'),
            mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'),
            testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'),
            playCountInput: document.getElementById('play-count'),
            pauseBetweenInput: document.getElementById('pause-between'),
            audioUploadInput: document.getElementById('audio-upload'),
            uploadStatusList: document.getElementById('upload-status-list'),
            questionsHtmlInput: document.getElementById('questions-html'),
            answersTextInput: document.getElementById('answers-text'),
            uploadBtn: document.getElementById('upload-btn'),
            uploadLog: document.getElementById('upload-log'),
        };

        function parseAnswers(text) {
            const answers = {};
            let totalQuestions = 0;
            text.trim().split('\n').forEach(line => {
                const match = line.trim().match(/^(\d+)\s*[.-]?\s*(.*)/);
                if (match) {
                    answers[match[1]] = match[2].trim();
                    totalQuestions++;
                }
            });
            return { answers, totalQuestions };
        }
        
        function renderAudioList() {
            DOM.uploadStatusList.innerHTML = '';
            appState.audioFiles.forEach((fileData, index) => {
                const item = document.createElement('div');
                item.className = 'draggable p-2 border rounded-md bg-white flex items-center justify-between';
                item.draggable = true;
                item.dataset.index = index;
                
                let statusIcon = '';
                if (fileData.uploading) {
                    statusIcon = '<div class="loader"></div>';
                } else if (fileData.url) {
                    statusIcon = '<i class="fas fa-check-circle text-green-500"></i>';
                } else {
                    statusIcon = '<i class="fas fa-times-circle text-red-500"></i>';
                }

                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-grip-vertical text-gray-400"></i>
                        <span>${fileData.name}</span>
                    </div>
                    ${statusIcon}
                `;
                DOM.uploadStatusList.appendChild(item);
            });
        }

        async function handleFileUpload(files) {
            DOM.uploadBtn.disabled = true;
            const newFiles = Array.from(files).map(file => ({
                name: file.name,
                file: file,
                uploading: true,
                url: null
            }));
            appState.audioFiles.push(...newFiles);
            renderAudioList();

            await Promise.all(newFiles.map(async (fileData) => {
                try {
                    const storageRef = ref(appState.storage, `listening_audio/${Date.now()}_${fileData.name}`);
                    await uploadBytes(storageRef, fileData.file);
                    fileData.url = await getDownloadURL(storageRef);
                } catch (error) {
                    console.error("File upload error:", error);
                } finally {
                    fileData.uploading = false;
                }
            }));
            
            renderAudioList();
            DOM.uploadBtn.disabled = false;
        }

        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            const { answers, totalQuestions } = parseAnswers(DOM.answersTextInput.value);
            
            const audioURLs = appState.audioFiles.map(f => f.url).filter(Boolean);

            if (!testId || !title || totalQuestions === 0 || audioURLs.length === 0) {
                alert("Vui lòng nhập đủ thông tin, đáp án và tải lên ít nhất một file audio thành công.");
                return;
            }

            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang lưu bài thi...';

            try {
                const testData = {
                    title,
                    questionsHTML: DOM.questionsHtmlInput.value,
                    answers,
                    totalQuestions,
                    audioURLs, // Save the sorted URLs
                    playCount: parseInt(DOM.playCountInput.value, 10) || 1,
                    pauseBetween: parseInt(DOM.pauseBetweenInput.value, 10) || 0,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };

                await setDoc(doc(appState.db, "listening_tests", testId), testData);
                
                DOM.uploadLog.textContent = `THÀNH CÔNG! Đã lưu bài thi nghe ID: "${testId}".`;
                setTimeout(() => window.close(), 2000);

            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }
        
        function setupDragAndDrop() {
            let draggedItem = null;
            DOM.uploadStatusList.addEventListener('dragstart', (e) => {
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });

            DOM.uploadStatusList.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
            });

            DOM.uploadStatusList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(DOM.uploadStatusList, e.clientY);
                if (afterElement == null) {
                    DOM.uploadStatusList.appendChild(draggedItem);
                } else {
                    DOM.uploadStatusList.insertBefore(draggedItem, afterElement);
                }
            });
            
            DOM.uploadStatusList.addEventListener('drop', (e) => {
                e.preventDefault();
                const newOrder = Array.from(DOM.uploadStatusList.children).map(item => {
                    return appState.audioFiles[parseInt(item.dataset.index)];
                });
                appState.audioFiles = newOrder;
                // Re-render to update dataset.index for future drags
                renderAudioList();
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        }

        function init() {
            const primaryApp = initializeApp(window.primaryFirebaseConfig, "primary");
            appState.db = getFirestore(primaryApp);
            appState.auth = getAuth(primaryApp);

            const storageApp = initializeApp(window.storageFirebaseConfig, "storageApp");
            appState.storage = getStorage(storageApp);

            onAuthStateChanged(appState.auth, user => {
                DOM.loginScreen.style.display = user ? 'none' : 'flex';
                DOM.mainContent.style.display = user ? 'block' : 'none';
            });

            DOM.loginBtn.addEventListener('click', async () => {
                try { await signInWithEmailAndPassword(appState.auth, DOM.emailInput.value, DOM.passwordInput.value); } 
                catch (error) { DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.'; }
            });
            DOM.logoutBtn.addEventListener('click', () => signOut(appState.auth));
            DOM.audioUploadInput.addEventListener('change', (e) => handleFileUpload(e.target.files));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);
            
            setupDragAndDrop();
        }
        
        init();
    </script>
</body>
</html>
