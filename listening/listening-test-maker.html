<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bài Thi Nghe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- === CẤU HÌNH FIREBASE === -->
    <script type="module">
        // CHỈ CẦN CẤU HÌNH CỦA DỰ ÁN CHÍNH
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .btn { font-weight: 600; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .input-field { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; }
        textarea.input-field { min-height: 200px; font-family: monospace; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- Màn hình đăng nhập -->
    <div id="login-screen" class="fixed inset-0 bg-gray-800 bg-opacity-90 flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Đăng nhập Giáo viên</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input">Email</label><input type="email" id="email-input" class="input-field w-full mt-1"></div>
                <div><label for="password-input">Mật khẩu</label><input type="password" id="password-input" class="input-field w-full mt-1"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-6xl mx-auto" style="display: none;">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Soạn Thảo Bài Thi Nghe</h1>
            <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
        </div>

        <!-- Thông tin chung -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="test-id">Listening Test ID</label><input type="text" id="test-id" class="input-field mt-1" placeholder="vd: ielts_listening_test_1"></div>
                <div><label for="test-title">Tiêu đề</label><input type="text" id="test-title" class="input-field mt-1" placeholder="vd: IELTS Listening Practice Test 1"></div>
            </div>
        </div>

        <!-- Cấu hình Audio -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Cấu hình Audio</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="play-count">Số lần nghe</label><input type="number" id="play-count" class="input-field mt-1" value="1" min="1"></div>
                <div><label for="pause-between">Giây nghỉ giữa các file</label><input type="number" id="pause-between" class="input-field mt-1" value="5" min="0"></div>
            </div>
            <div class="mt-6">
                <label for="audio-urls" class="block text-sm font-medium text-gray-700">Danh sách Link Audio</label>
                <p class="text-xs text-gray-500 mt-1">Dán các link audio công khai vào đây, mỗi link một dòng. Thứ tự dán sẽ là thứ tự phát.</p>
                <textarea id="audio-urls" class="input-field mt-2" rows="5" placeholder="https://firebasestorage.googleapis.com/.../file1.mp3?alt=media&token=...\nhttps://firebasestorage.googleapis.com/.../file2.mp3?alt=media&token=..."></textarea>
            </div>
        </div>
        
        <!-- Nội dung & Đáp án -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Nội dung & Đáp án</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div><label for="questions-html">Nội dung đề thi (HTML)</label><textarea id="questions-html" class="input-field" placeholder="Dán mã HTML..."></textarea></div>
                <div><label for="answers-text">Đáp án</label><textarea id="answers-text" class="input-field" placeholder="1. answer one..."></textarea></div>
            </div>
        </div>

        <!-- Nút lưu -->
        <div class="mt-8 text-center">
             <button id="upload-btn" class="btn btn-primary text-lg w-full md:w-1/2"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bài Thi</button>
             <p id="upload-log" class="font-semibold mt-2 h-5"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const appState = { db: null, auth: null };
        const DOM = {
            loginScreen: document.getElementById('login-screen'),
            mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'),
            testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'),
            playCountInput: document.getElementById('play-count'),
            pauseBetweenInput: document.getElementById('pause-between'),
            audioUrlsTextarea: document.getElementById('audio-urls'),
            questionsHtmlInput: document.getElementById('questions-html'),
            answersTextInput: document.getElementById('answers-text'),
            uploadBtn: document.getElementById('upload-btn'),
            uploadLog: document.getElementById('upload-log'),
        };

        function parseAnswers(text) {
            const answers = {};
            let totalQuestions = 0;
            text.trim().split('\n').forEach(line => {
                const match = line.trim().match(/^(\d+)\s*[.-]?\s*(.*)/);
                if (match) {
                    answers[match[1]] = match[2].trim();
                    totalQuestions++;
                }
            });
            return { answers, totalQuestions };
        }

        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            const { answers, totalQuestions } = parseAnswers(DOM.answersTextInput.value);
            
            const audioURLs = DOM.audioUrlsTextarea.value.trim().split('\n').filter(url => url.trim().startsWith('http'));

            if (!testId || !title || totalQuestions === 0 || audioURLs.length === 0) {
                alert("Vui lòng nhập đủ thông tin, đáp án và ít nhất một link audio.");
                return;
            }

            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang lưu bài thi...';

            try {
                const testData = {
                    title,
                    questionsHTML: DOM.questionsHtmlInput.value,
                    answers,
                    totalQuestions,
                    audioURLs,
                    playCount: parseInt(DOM.playCountInput.value, 10) || 1,
                    pauseBetween: parseInt(DOM.pauseBetweenInput.value, 10) || 0,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };

                await setDoc(doc(appState.db, "listening_tests", testId), testData);
                DOM.uploadLog.textContent = `THÀNH CÔNG! Đã lưu bài thi nghe ID: "${testId}".`;
                setTimeout(() => window.close(), 2000);

            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }
        
        function init() {
            const app = initializeApp(window.firebaseConfig);
            appState.db = getFirestore(app);
            appState.auth = getAuth(app);

            onAuthStateChanged(appState.auth, user => {
                DOM.loginScreen.style.display = user ? 'none' : 'flex';
                DOM.mainContent.style.display = user ? 'block' : 'none';
            });

            DOM.loginBtn.addEventListener('click', async () => {
                try { await signInWithEmailAndPassword(appState.auth, DOM.emailInput.value, DOM.passwordInput.value); } 
                catch (error) { DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.'; }
            });
            DOM.logoutBtn.addEventListener('click', () => signOut(appState.auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);
        }
        
        init();
    </script>
</body>
</html>
