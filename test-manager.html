<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Điều Khiển Quản Lý</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- === CẤU HÌNH FIREBASE === -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .btn { font-weight: 600; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-green { background-color: #10b981; color: white; }
        .btn-orange { background-color: #f97316; color: white; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4f46e5; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-not-started { background-color: #e5e7eb; color: #4b5563; }
        .status-submitted { background-color: #d1fae5; color: #065f46; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- Màn hình đăng nhập -->
    <div id="login-screen" class="fixed inset-0 bg-gray-800 bg-opacity-90 flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Đăng nhập Giáo viên</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="email-input" class="input-field w-full mt-1"></div>
                <div><label for="password-input" class="block text-sm font-medium text-gray-700">Mật khẩu</label><input type="password" id="password-input" class="input-field w-full mt-1"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-7xl mx-auto" style="display: none;">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Bảng Điều Khiển</h1>
            <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Danh sách Bài tập</h2>
                    <div class="flex gap-2">
                        <button onclick="window.open('test-maker.html', '_blank')" class="btn btn-primary" title="Tạo đề trắc nghiệm"><i class="fas fa-file-alt"></i></button>
                        <button onclick="window.open('reading/reading-test-maker.html', '_blank')" class="btn btn-green" title="Tạo bài đọc hiểu"><i class="fas fa-book-open"></i></button>
                        <button onclick="window.open('listening/listening-test-maker.html', '_blank')" class="btn btn-orange" title="Tạo bài thi nghe"><i class="fas fa-headphones"></i></button>
                    </div>
                </div>
                <div id="test-list" class="space-y-2">
                    <div class="text-center py-8"><div class="loader mx-auto"></div></div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <div id="details-view">
                    <div class="text-center text-gray-500 py-16">
                        <i class="fas fa-arrow-left text-4xl mb-4"></i>
                        <p class="text-xl">Chọn một bài tập từ danh sách để xem chi tiết.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, deleteDoc, query, where, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const app = initializeApp(window.firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let localTestsCache = [];

        function listenForData() {
            const collections = {
                standard: 'tests',
                reading: 'reading_tests',
                listening: 'listening_tests'
            };
            let combinedResults = {};

            Object.entries(collections).forEach(([type, name]) => {
                onSnapshot(collection(db, name), (snapshot) => {
                    combinedResults[type] = snapshot.docs.map(doc => ({ id: doc.id, testType: type, ...doc.data() }));
                    localTestsCache = Object.values(combinedResults).flat();
                    renderTestList();
                    const selectedTestId = document.querySelector('#test-list .bg-indigo-100')?.dataset.testId;
                    if (selectedTestId && localTestsCache.find(t => t.id === selectedTestId)) {
                        listenForSubmissions(selectedTestId);
                    }
                });
            });
        }

        function renderTestList() {
            const selectedTestId = document.querySelector('#test-list .bg-indigo-100')?.dataset.testId;
            const testListEl = document.getElementById('test-list');
            testListEl.innerHTML = '';
            if (localTestsCache.length === 0) {
                testListEl.innerHTML = '<p class="text-gray-500 text-center py-4">Chưa có bài tập nào.</p>';
                return;
            }
            localTestsCache.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
            
            localTestsCache.forEach(test => {
                const icons = {
                    standard: '<i class="fas fa-file-alt text-indigo-600"></i>',
                    reading: '<i class="fas fa-book-open text-green-600"></i>',
                    listening: '<i class="fas fa-headphones text-orange-500"></i>'
                };
                const item = document.createElement('div');
                item.className = `p-3 border rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-100 ${test.id === selectedTestId ? 'bg-indigo-100' : ''}`;
                item.dataset.testId = test.id;
                item.dataset.testType = test.testType;
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl w-6 text-center">${icons[test.testType]}</span>
                        <div><p class="font-bold">${test.title}</p><p class="text-sm text-gray-500">${test.id}</p></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-edit-test btn btn-secondary" title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete-test btn btn-danger" title="Xóa"><i class="fas fa-trash"></i></button>
                    </div>`;
                testListEl.appendChild(item);
            });
        }

        function renderDetailsView(test, submissions) {
            const detailsViewEl = document.getElementById('details-view');
            if (!test) {
                detailsViewEl.innerHTML = `<div class="text-center text-gray-500 py-16"><p>Bài tập không tồn tại.</p></div>`;
                return;
            }

            const studentPage = { 
                standard: 'student.html', 
                reading: 'reading/student-reading-test.html', 
                listening: 'listening/listening-student.html' 
            };
            detailsViewEl.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-700">${test.title}</h2>
                <div class="mb-6 p-4 bg-gray-50 rounded-lg mt-4">
                    <h3 class="font-bold mb-2">Thêm học sinh mới</h3>
                    <textarea id="new-student-list" class="input-field" rows="3" placeholder="Dán danh sách tên, mỗi tên một dòng..."></textarea>
                    <button id="add-students-btn" class="btn btn-primary mt-2 w-full">Thêm và tạo mã</button>
                </div>
                <div>
                    <h3 class="font-bold mb-2">Danh sách học sinh (${submissions.length})</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead><tr><th class="p-2 border-b">Tên</th><th class="p-2 border-b">Mã</th><th class="p-2 border-b">Trạng thái</th><th class="p-2 border-b">Điểm</th><th class="p-2 border-b"></th></tr></thead>
                            <tbody>
                                ${submissions.map(sub => `
                                    <tr>
                                        <td class="p-2 border-b"><a href="${studentPage[test.testType]}?submission_id=${sub.id}" target="_blank" class="text-blue-600 hover:underline">${sub.studentName}</a></td>
                                        <td class="p-2 border-b font-mono">${sub.id}</td>
                                        <td class="p-2 border-b"><span class="status-badge ${sub.status === 'submitted' ? 'status-submitted' : 'status-not-started'}">${sub.status === 'submitted' ? 'Đã nộp' : 'Chưa làm'}</span></td>
                                        <td class="p-2 border-b font-bold">${sub.status === 'submitted' ? `${sub.score} / ${sub.totalPoints}` : '-'}</td>
                                        <td class="p-2 border-b text-right"><button class="btn-delete-student btn btn-danger btn-sm" data-sub-id="${sub.id}"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }
        
        function listenForSubmissions(testId) {
            onSnapshot(query(collection(db, "submissions"), where("testId", "==", testId)), (snapshot) => {
                const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentTest = localTestsCache.find(t => t.id === testId);
                renderDetailsView(currentTest, submissions);
            });
        }

        // --- Event Listeners & Auth ---
        onAuthStateChanged(auth, user => {
            document.getElementById('login-screen').style.display = user ? 'none' : 'flex';
            document.getElementById('main-content').style.display = user ? 'block' : 'none';
            if (user) listenForData();
        });
        
        document.getElementById('login-btn').addEventListener('click', async () => {
             try { await signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value); } 
             catch (e) { document.getElementById('login-error').textContent = 'Đăng nhập thất bại.'; }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        document.getElementById('test-list').addEventListener('click', (e) => {
            const item = e.target.closest('[data-test-id]');
            if (!item) return;

            const editBtn = e.target.closest('.btn-edit-test');
            const deleteBtn = e.target.closest('.btn-delete-test');
            
            if (editBtn) {
                const testType = item.dataset.testType;
                const page = { 
                    standard: 'test-maker.html', 
                    reading: 'reading/reading-test-maker.html', 
                    listening: 'listening/listening-test-maker.html' 
                };
                window.open(`${page[testType]}`, '_blank'); // Removed edit param for simplicity
            } else if (deleteBtn) {
                if (!confirm(`Bạn có chắc muốn xóa bài tập này?`)) return;
                const collectionName = `${item.dataset.testType}_tests`.replace('standard_tests', 'tests');
                deleteDoc(doc(db, collectionName, item.dataset.testId));
            } else {
                listenForSubmissions(item.dataset.testId);
                document.querySelectorAll('#test-list > div').forEach(el => el.classList.remove('bg-indigo-100'));
                item.classList.add('bg-indigo-100');
            }
        });

        document.getElementById('details-view').addEventListener('click', async (e) => {
            const testId = document.querySelector('#test-list .bg-indigo-100')?.dataset.testId;
            if (!testId) return;

            if (e.target.closest('#add-students-btn')) {
                const names = document.getElementById('new-student-list').value.trim().split('\n').filter(Boolean);
                for (const name of names) {
                    const code = Math.random().toString().substr(2, 6);
                    await setDoc(doc(db, "submissions", code), { studentName: name.trim(), testId, status: 'not-started' });
                }
                document.getElementById('new-student-list').value = '';
            } else if (e.target.closest('.btn-delete-student')) {
                const subId = e.target.closest('.btn-delete-student').dataset.subId;
                if (confirm(`Xóa bài làm của học sinh này?`)) await deleteDoc(doc(db, "submissions", subId));
            }
        });
    </script>
</body>
</html>
