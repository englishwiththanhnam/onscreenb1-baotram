<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Kiểm Tra Online - Đăng nhập</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>

    <style>
        :root {
            --primary-accent: #6d28d9; --text-primary: #0f172a; --app-bg-start: #f5f7ff;
            --app-bg-end: #e0e7ff; --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6);
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--app-bg-start); background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%); }
        .glass-panel { background: var(--glass-bg-color); backdrop-filter: blur(12px); border-radius: 24px; border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 rgba(67, 56, 202, 0.15); }
        .btn-primary { background: var(--primary-accent); color: white; transition: all 0.3s ease; padding: 12px 24px; border-radius: 12px; font-weight: 600; }
        .btn-primary:hover:not(:disabled) { background: #5b21b6; transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }
        .input-field { background: rgba(255, 255, 255, 0.6); border: 2px solid var(--glass-border-color); color: var(--text-primary); width: 100%; padding: 12px; border-radius: 16px; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: var(--primary-accent); transform: scale(1.02); }
    </style>
</head>
<body>
    <div id="login-container" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="glass-panel p-8 sm:p-12 w-full max-w-md text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">Chào mừng trở lại!</h1>
            <p class="text-gray-600 mb-8">Đăng nhập để xem bài tập của bạn.</p>
            
            <div class="space-y-4">
                <input type="email" id="email-input" class="input-field" placeholder="Email hoặc Tên đăng nhập" required>
                <input type="password" id="password-input" class="input-field" placeholder="Mật khẩu" required>
            </div>
            
            <button id="login-btn" class="btn-primary w-full mt-6 text-lg">Đăng nhập</button>
            <p id="error-message" class="text-red-500 mt-4 h-5"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const app = initializeApp(window.firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const errorMessage = document.getElementById('error-message');

        async function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                errorMessage.textContent = "Vui lòng nhập đầy đủ thông tin.";
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            errorMessage.textContent = '';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Sau khi đăng nhập thành công, kiểm tra vai trò để điều hướng
                await redirectUserBasedOnRole(user);

            } catch (error) {
                errorMessage.textContent = "Tên đăng nhập hoặc mật khẩu không chính xác.";
                loginBtn.disabled = false;
                loginBtn.textContent = 'Đăng nhập';
            }
        }
        
        async function redirectUserBasedOnRole(user) {
            if (!user) return;
            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (userData.role === 'teacher') {
                        window.location.href = 'test-manager.html';
                    } else if (userData.role === 'student') {
                        // CHUẨN BỊ CHO BƯỚC 2:
                        // window.location.href = 'student-dashboard.html';
                        alert("Đăng nhập học sinh thành công! Trang Bảng điều khiển sẽ được xây dựng ở bước tiếp theo.");
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Đăng nhập';
                    } else {
                        errorMessage.textContent = 'Tài khoản không được phân quyền.';
                        auth.signOut();
                    }
                } else {
                    errorMessage.textContent = 'Không tìm thấy thông tin người dùng.';
                    auth.signOut();
                }
            } catch (err) {
                 errorMessage.textContent = 'Lỗi khi xác thực vai trò.';
                 auth.signOut();
            }
        }
        
        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        
    </script>
</body>
</html>
