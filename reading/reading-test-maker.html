<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bài Đọc Hiểu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- === CẤU HÌNH FIREBASE === -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.firebasestorage.app",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .btn { font-weight: 600; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .input-field { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; }
        .input-field:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        textarea.input-field { min-height: 200px; font-family: monospace; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- === MÀN HÌNH ĐĂNG NHẬP (GIỮ NGUYÊN) === -->
    <div id="login-screen" class="fixed inset-0 bg-gray-800 bg-opacity-90 flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Đăng nhập Giáo viên</h2>
            <div class="space-y-4 text-left">
                <div>
                    <label for="email-input" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email-input" class="input-field w-full mt-1">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Mật khẩu</label>
                    <input type="password" id="password-input" class="input-field w-full mt-1">
                </div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-6xl mx-auto" style="display: none;">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Soạn Thảo Bài Đọc Hiểu</h1>
            <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
        </div>

        <!-- THÔNG TIN CHUNG -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="test-id" class="block text-sm font-medium text-gray-700">Reading Test ID (Mã định danh)</label>
                    <input type="text" id="test-id" class="input-field mt-1" placeholder="vd: ielts_cam18_test1_p1">
                </div>
                <div>
                    <label for="test-title" class="block text-sm font-medium text-gray-700">Tiêu đề</label>
                    <input type="text" id="test-title" class="input-field mt-1" placeholder="vd: IELTS Cambridge 18 - Test 1 Passage 1">
                </div>
            </div>
        </div>

        <!-- NỘI DUNG -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Nội dung bài đọc</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <label for="passage-html" class="block text-sm font-medium text-gray-700 mb-2">Ngữ liệu (Dán mã HTML vào đây)</label>
                    <textarea id="passage-html" class="input-field" placeholder="Dán mã HTML của bài đọc..."></textarea>
                </div>
                <div>
                    <label for="questions-html" class="block text-sm font-medium text-gray-700 mb-2">Câu hỏi (Dán mã HTML vào đây)</label>
                    <textarea id="questions-html" class="input-field" placeholder="Dán mã HTML của phần câu hỏi..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- ĐÁP ÁN -->
        <div class="bg-white p-6 rounded-lg shadow-md">
             <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Đáp án</h2>
             <label for="answers-text" class="block text-sm font-medium text-gray-700 mb-2">Nhập đáp án theo định dạng: mỗi đáp án một dòng (vd: "1. TRUE", "2. NOT GIVEN")</label>
             <textarea id="answers-text" class="input-field" rows="10" placeholder="1. TRUE&#10;2. FALSE&#10;3. NOT GIVEN&#10;4. C&#10;..."></textarea>
        </div>

        <!-- NÚT LƯU -->
        <div class="mt-8 text-center">
             <button id="upload-btn" class="btn btn-primary text-lg w-full md:w-1/2"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bài Đọc Lên Firebase</button>
             <p id="upload-log" class="font-semibold mt-2 h-5"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- APP STATE & DOM ---
        const appState = { db: null, auth: null };
        const DOM = {
            loginScreen: document.getElementById('login-screen'),
            mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'),
            testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'),
            passageHtmlInput: document.getElementById('passage-html'),
            questionsHtmlInput: document.getElementById('questions-html'),
            answersTextInput: document.getElementById('answers-text'),
            uploadBtn: document.getElementById('upload-btn'),
            uploadLog: document.getElementById('upload-log'),
        };

        /**
         * Parses the raw text from the answers textarea into a structured object.
         * @param {string} text The raw text from the textarea.
         * @returns {object} An object where keys are question numbers and values are the answers.
         */
        function parseAnswers(text) {
            const answers = {};
            const lines = text.trim().split('\n');
            let totalQuestions = 0;
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                // Matches "1. Answer" or "1 Answer" or "1-Answer"
                const match = trimmedLine.match(/^(\d+)\s*[.-]?\s*(.*)/);
                if (match) {
                    const number = match[1];
                    const answerText = match[2].trim();
                    answers[number] = answerText;
                    totalQuestions++;
                }
            });
            return { answers, totalQuestions };
        }

        /**
         * Uploads the complete reading test data to Firestore.
         */
        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            const passageHTML = DOM.passageHtmlInput.value;
            const questionsHTML = DOM.questionsHtmlInput.value;
            const { answers, totalQuestions } = parseAnswers(DOM.answersTextInput.value);

            if (!testId || !title || !passageHTML || !questionsHTML || totalQuestions === 0) {
                alert("Vui lòng nhập đầy đủ ID, Tiêu đề, Ngữ liệu, Câu hỏi và ít nhất một Đáp án.");
                return;
            }

            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang tải lên...';
            DOM.uploadLog.className = 'font-semibold mt-2 h-5 text-blue-600';

            try {
                const testData = {
                    title,
                    passageHTML,
                    questionsHTML,
                    answers,
                    totalQuestions,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    // Add other metadata if needed, like in the main test system
                    isLocked: false, 
                    answersPublished: false,
                };

                // We save this in a new collection called 'reading_tests'
                await setDoc(doc(appState.db, "reading_tests", testId), testData);
                
                DOM.uploadLog.textContent = `THÀNH CÔNG! Đã lưu bài đọc với ID "${testId}".`;
                DOM.uploadLog.className = 'font-semibold mt-2 h-5 text-green-600';
                
                setTimeout(() => window.close(), 2000);

            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
                DOM.uploadLog.className = 'font-semibold mt-2 h-5 text-red-600';
                console.error("Upload error:", error);
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }
        
        // --- INITIALIZATION ---
        function init() {
            // Initialize Firebase
            const app = initializeApp(window.firebaseConfig);
            appState.db = getFirestore(app);
            appState.auth = getAuth(app);

            // Authentication listener
            onAuthStateChanged(appState.auth, user => {
                if (user) {
                    DOM.loginScreen.style.display = 'none';
                    DOM.mainContent.style.display = 'block';
                } else {
                    DOM.loginScreen.style.display = 'flex';
                    DOM.mainContent.style.display = 'none';
                }
            });

            // Event Listeners
            DOM.loginBtn.addEventListener('click', async () => {
                const email = DOM.emailInput.value;
                const password = DOM.passwordInput.value;
                DOM.loginError.textContent = '';
                try {
                    await signInWithEmailAndPassword(appState.auth, email, password);
                } catch (error) {
                    DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.';
                }
            });
            DOM.logoutBtn.addEventListener('click', () => signOut(appState.auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);
        }
        
        // Start the application
        init();
    </script>
</body>
</html>
