<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bộ Từ Vựng Chuyên Nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blur-intensity: 12px; --saturation-intensity: 150%; --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6); --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9; --text-primary: #0f172a; --text-secondary: #475569;
            --app-bg-start: #f5f7ff; --app-bg-end: #e0e7ff;
        }
        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45); --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25); --primary-accent: #a78bfa; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --app-bg-start: #0f172a; --app-bg-end: #1e293b;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--app-bg-start); background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%); color: var(--text-primary); }
        body.dark h1, body.dark h2, body.dark label, body.dark p, body.dark input, body.dark textarea, body.dark select { color: var(--text-primary); }
        body.dark .text-gray-700 { color: var(--text-primary) !important; }
        body.dark #dark-mode-label .fa-moon { color: var(--primary-accent); } #dark-mode-label .fa-sun { color: #f59e0b; }
        .background-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .shape { position: absolute; border-radius: 50%; filter: blur(25px); opacity: 0.6; animation: float 30s infinite alternate ease-in-out; }
        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation-duration: 35s; }
        @keyframes float { from { transform: translateY(20px) scale(1); } to { transform: translateY(-20px) scale(1.05); } }
        .glass-panel { background: var(--glass-bg-color); backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity)); border-radius: 24px; border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none !important; }
        .btn-primary { background: var(--primary-accent); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.4); color: var(--text-primary); border: 1px solid rgba(255, 255, 255, 0.6); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        .btn-danger { background: #ef4444; color: white; }
        .input-field { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); width: 100%; padding: 12px; border-radius: 12px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal.is-open { display: flex; }
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #data-table th { position: sticky; top: 0; background-color: rgba(255,255,255,0.6); backdrop-filter: blur(5px); z-index: 10; }
        body.dark #data-table th { background-color: rgba(29, 39, 58, 0.6); }
        [contenteditable]:focus { outline: 2px solid var(--primary-accent); background-color: rgba(255, 255, 255, 0.7); border-radius: 4px; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="background-shapes"><div class="shape shape1"></div><div class="shape shape2"></div></div>

    <div id="login-screen" class="modal is-open">
        <div class="glass-panel p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">Đăng nhập</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email-input" class="input-field"></div>
                <div><label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label><input type="password" id="password-input" class="input-field"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-screen-xl mx-auto" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <h1 id="page-title" class="text-4xl font-bold">Trình Soạn Thảo Bộ Từ Vựng</h1>
            <div class="flex items-center gap-4">
                <label id="dark-mode-label" class="flex items-center cursor-pointer text-slate-500">
                    <i class="fas fa-moon mr-2"></i>
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <i class="fas fa-sun ml-2"></i>
                </label>
                <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <aside class="lg:col-span-2 space-y-8">
                <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
                    <div class="space-y-4">
                        <div><label for="test-id" class="block text-sm font-medium">Mã định danh (ID)</label><input type="text" id="test-id" class="input-field" placeholder="vd: unit_1_family"></div>
                        <div><label for="test-title" class="block text-sm font-medium">Tiêu đề bộ từ vựng</label><input type="text" id="test-title" class="input-field" placeholder="vd: Unit 1: Family Life"></div>
                    </div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Nhập liệu & Cài đặt</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-1">File Từ vựng (.csv)</label>
                            <label for="vocab-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                            <input type="file" id="vocab-csv-upload" class="hidden" accept=".csv">
                            <p id="vocab-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                        </div>
                         <div>
                            <label class="block text-sm font-medium mb-1">File Cấu trúc (.csv)</label>
                            <label for="structures-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                            <input type="file" id="structures-csv-upload" class="hidden" accept=".csv">
                            <p id="structures-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="cefr-level-slider" class="block text-sm font-medium mb-1">Trình độ (CEFR)</label>
                        <input type="range" id="cefr-level-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <div class="flex justify-between text-xs mt-1"><span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span></div>
                        <p id="cefr-level-display" class="text-center font-semibold mt-2"></p>
                    </div>
                    <div class="text-center mt-6"><button id="process-files-btn" class="btn btn-primary">Xử lý Dữ liệu</button></div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Cấu hình AI</h2>
                    <div class="space-y-4">
                        <div><label for="gemini-api-key" class="block text-sm font-medium">Google Gemini API Key</label><input type="password" id="gemini-api-key" class="input-field" placeholder="Dán API Key của bạn..."></div>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-3 space-y-8">
                <div id="data-review-section" class="glass-panel p-6 hidden">
                     <h2 class="text-2xl font-bold text-gray-700 mb-4">4. Bảng dữ liệu & Làm giàu</h2>
                    <div id="table-container" class="max-h-[80vh] overflow-auto rounded-lg border border-white/50">
                        <table id="data-table" class="w-full text-sm">
                            <thead>
                                <tr class="text-left"><th class="p-3">Từ vựng / Phiên âm</th><th class="p-3">Nghĩa</th><th class="p-3">Cấu trúc & Ví dụ</th><th class="p-3">Từ gây nhiễu</th><th class="p-3 text-center">AI</th></tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 text-center flex flex-wrap justify-center gap-4">
                        <button id="fetch-audio-btn" class="btn btn-secondary"><i class="fas fa-volume-up mr-2"></i>Tìm Audio</button>
                        <button id="enrich-ai-btn" class="btn btn-secondary"><i class="fas fa-wand-magic-sparkles mr-2"></i>Làm giàu bằng AI</button>
                    </div>
                </div>
                <div class="text-center"><button id="upload-btn" class="btn btn-primary text-lg w-full"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng</button><p id="upload-log" class="font-semibold mt-2 h-5"></p></div>
            </main>
        </div>
    </div>
    
    <div id="custom-alert-modal" class="modal"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // =================================================================
        // == BƯỚC QUAN TRỌNG: ĐIỀN THÔNG TIN CỦA BẠN VÀO ĐÂY ==
        // =================================================================
const firebaseConfig = {
  apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
  authDomain: "b1-baotram.firebaseapp.com",
  projectId: "b1-baotram",
  storageBucket: "b1-baotram.firebasestorage.app",
  messagingSenderId: "948701163187",
  appId: "1:948701163187:web:043f2d381d63e741114ac6",
  measurementId: "G-33NHT07JHE"
};
        const CLOUD_FUNCTION_URL = "https://getoaldaudio-asjwauz37q-uc.a.run.app";
        // =================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let localWordList = [], vocabCsvText = '', structuresCsvText = '';

        const DOM = {
            loginScreen: document.getElementById('login-screen'), mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'), passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'), testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'), dataReviewSection: document.getElementById('data-review-section'),
            dataTableBody: document.getElementById('data-table-body'), fetchAudioBtn: document.getElementById('fetch-audio-btn'),
            enrichAiBtn: document.getElementById('enrich-ai-btn'), uploadBtn: document.getElementById('upload-btn'),
            uploadLog: document.getElementById('upload-log'), alertModal: document.getElementById('custom-alert-modal'), 
            vocabCsvUploadInput: document.getElementById('vocab-csv-upload'), vocabFileNameDisplay: document.getElementById('vocab-file-name'),
            structuresCsvUploadInput: document.getElementById('structures-csv-upload'), structuresFileNameDisplay: document.getElementById('structures-file-name'),
            processFilesBtn: document.getElementById('process-files-btn'), darkModeToggle: document.getElementById('dark-mode-toggle'),
            cefrSlider: document.getElementById('cefr-level-slider'), cefrDisplay: document.getElementById('cefr-level-display'),
            geminiApiKeyInput: document.getElementById('gemini-api-key'),
        };

        function showAlert(message) {
            DOM.alertModal.innerHTML = `<div class="glass-panel text-center p-8 rounded-lg"><p class="text-lg mb-6">${message}</p><button id="alert-ok-btn" class="btn btn-primary">OK</button></div>`;
            DOM.alertModal.classList.add('is-open');
            document.getElementById('alert-ok-btn').onclick = () => DOM.alertModal.classList.remove('is-open');
        }

        function parseAndStructureCSV(vocabText, structuresText) {
            const vocabRows = vocabText.trim().split(/\r?\n/);
            const vocab = vocabRows.map((row, index) => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 4 && columns[0]) {
                    return { id: index + 1, word: columns[0], type: columns[1], pronunciation: columns[2], meaning: columns[3], audioUrl: '', structures: [], exampleSentence: '', distractors_en: [], distractors_vi: [], isEnriched: false };
                }
                return null;
            }).filter(Boolean);

            const structureRows = structuresText.trim().split(/\r?\n/);
            const structures = structureRows.map(row => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 2 && columns[0]) return { phrase: columns[0], meaning: columns[1] };
                return null;
            }).filter(Boolean);

            vocab.forEach(v => {
                const wordLower = v.word.toLowerCase();
                const matchRegex = new RegExp(`\\b${wordLower}s?\\b`, 'i');
                v.structures = structures.filter(s => matchRegex.test(s.phrase));
            });
            localWordList = vocab;
        }

        function renderTable() {
            DOM.dataTableBody.innerHTML = '';
            localWordList.forEach((word, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-slate-700 align-top';
                const audioIconHTML = word.audioUrl ? `<a href="${word.audioUrl}" target="_blank" title="Nghe"><i class="fas fa-volume-up ml-2 text-blue-500"></i></a>` : '';
                const structuresHTML = word.structures.map(s => {
                    const examplesHTML = (s.applicationExamples || []).map((ex, exIdx) => `<li contenteditable="true" data-word-index="${index}" data-structure-index="${word.structures.indexOf(s)}" data-example-index="${exIdx}">${ex}</li>`).join('');
                    return `<div class="p-1.5 my-1 bg-violet-100 dark:bg-slate-700 rounded-md"><p class="font-semibold text-violet-800 dark:text-violet-300">${s.phrase}</p><p class="text-xs text-slate-600 dark:text-slate-400">${s.meaning}</p>${examplesHTML ? `<ul class="list-disc list-inside mt-1 text-sky-700 dark:text-sky-400">${examplesHTML}</ul>` : ''}</div>`;
                }).join('');
                const exampleHTML = word.exampleSentence ? `<div class="mt-2 p-1.5 bg-green-100 dark:bg-emerald-900/50 rounded-md"><p class="font-semibold text-green-800 dark:text-green-300">Ví dụ (Từ vựng):</p><p class="text-xs" contenteditable="true" data-word-index="${index}" data-field="exampleSentence">${word.exampleSentence}</p></div>` : '';
                const distractorsHTML = word.distractors_en.length > 0 ? `<div class="text-xs"><p class="font-semibold">EN:</p><ul class="list-disc list-inside" data-word-index="${index}" data-field="distractors_en">${word.distractors_en.map((d, d_idx) => `<li contenteditable="true" data-distractor-index="${d_idx}">${d}</li>`).join('')}</ul><p class="font-semibold mt-1">VI:</p><ul class="list-disc list-inside" data-word-index="${index}" data-field="distractors_vi">${word.distractors_vi.map((d, d_idx) => `<li contenteditable="true" data-distractor-index="${d_idx}">${d}</li>`).join('')}</ul></div>` : '<span class="text-xs text-gray-400">Chưa có</span>';

                row.innerHTML = `
                    <td class="p-3"><div class="flex items-center"><p class="font-bold text-base" contenteditable="true" data-word-index="${index}" data-field="word">${word.word}</p>${audioIconHTML}</div><p class="font-mono text-sm text-violet-700 dark:text-violet-400" contenteditable="true" data-word-index="${index}" data-field="pronunciation">${word.pronunciation}</p><p class="text-xs text-slate-500">(${word.type})</p></td>
                    <td class="p-3" contenteditable="true" data-word-index="${index}" data-field="meaning">${word.meaning}</td>
                    <td class="p-3 text-xs">${structuresHTML}${exampleHTML}</td>
                    <td class="p-3">${distractorsHTML}</td>
                    <td class="p-3 text-center">${word.isEnriched ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>' : '<i class="fas fa-hourglass-half text-2xl text-gray-400"></i>'}</td>
                `;
                DOM.dataTableBody.appendChild(row);
            });
        }
        
        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            if (!testId || !title || localWordList.length === 0) return showAlert("Vui lòng nhập ID, Tiêu đề và xử lý dữ liệu.");
            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang lưu...';
            try {
                await setDoc(doc(db, "vocab_sets", testId), { title, wordList: localWordList, updatedAt: serverTimestamp() }, { merge: true });
                DOM.uploadLog.textContent = 'THÀNH CÔNG!';
            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }
        
        const handleFileUpload = (event, type) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'vocab') { vocabCsvText = e.target.result; DOM.vocabFileNameDisplay.textContent = file.name; } 
                else { structuresCsvText = e.target.result; DOM.structuresFileNameDisplay.textContent = file.name; }
            };
            reader.readAsText(file);
        };

        function getCefrLevelDescription() {
            const value = parseInt(DOM.cefrSlider.value, 10);
            if (value <= 10) return "A1"; if (value <= 30) return "A2"; if (value <= 50) return "B1";
            if (value <= 70) return "B2"; if (value <= 90) return "C1"; return "C2";
        }

        function setupEventListeners() {
            onAuthStateChanged(auth, user => {
                DOM.loginScreen.classList.toggle('is-open', !user);
                DOM.mainContent.style.display = user ? 'block' : 'none';
            });

            DOM.loginBtn.addEventListener('click', async () => {
                try { await signInWithEmailAndPassword(auth, DOM.emailInput.value, DOM.passwordInput.value); } 
                catch (e) { DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.'; }
            });

            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);
            DOM.vocabCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'vocab'));
            DOM.structuresCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'structures'));
            
            DOM.processFilesBtn.addEventListener('click', () => {
                if (!vocabCsvText || !structuresCsvText) return showAlert("Vui lòng tải lên cả hai file CSV.");
                parseAndStructureCSV(vocabCsvText, structuresCsvText);
                renderTable();
                DOM.dataReviewSection.classList.remove('hidden');
            });

            DOM.darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark');
                DOM.darkModeToggle.nextElementSibling.nextElementSibling.style.transform = DOM.darkModeToggle.checked ? 'translateX(100%)' : 'translateX(0)';
            });
            
            DOM.cefrSlider.addEventListener('input', () => DOM.cefrDisplay.textContent = getCefrLevelDescription());
            
            DOM.fetchAudioBtn.addEventListener('click', async () => {
                if (localWordList.length === 0) return showAlert("Chưa có dữ liệu.");

                const button = DOM.fetchAudioBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                
                for (let i = 0; i < localWordList.length; i++) {
                    const wordData = localWordList[i];
                    button.innerHTML = `<div class="loader"></div><span class="ml-2">Đang tìm... (${i + 1}/${localWordList.length})</span>`;
                    if (wordData.audioUrl || !wordData.word) continue;
                    try {
                        const response = await fetch(`${CLOUD_FUNCTION_URL}?word=${encodeURIComponent(wordData.word)}`);
                        if (!response.ok) throw new Error(`Server error`);
                        const result = await response.json();
                        if (result.success) wordData.audioUrl = result.audioUrl;
                    } catch (error) { console.error(`Lỗi với từ '${wordData.word}':`, error); }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                renderTable();
                button.disabled = false;
                button.innerHTML = originalHTML;
            });

            DOM.enrichAiBtn.addEventListener('click', async () => {
                showAlert("Chức năng AI đang được phát triển!");
                // Logic for AI enrichment will be added here in the future
            });
            
            DOM.dataTableBody.addEventListener('blur', (e) => {
                const target = e.target;
                if (target.hasAttribute('contenteditable')) {
                    const wordIndex = parseInt(target.closest('tr').querySelector('[data-word-index]').dataset.wordIndex, 10);
                    const field = target.dataset.field;
                    const newText = target.textContent;
                    if (isNaN(wordIndex) || !localWordList[wordIndex]) return;
                    
                    const wordData = localWordList[wordIndex];
                    if (field) {
                        wordData[field] = newText;
                    } else if (target.dataset.structureIndex !== undefined) {
                        const sIdx = parseInt(target.dataset.structureIndex, 10);
                        const eIdx = parseInt(target.dataset.exampleIndex, 10);
                        if (!isNaN(sIdx) && !isNaN(eIdx)) {
                            wordData.structures[sIdx].applicationExamples[eIdx] = newText;
                        }
                    } else if (target.dataset.distractorIndex !== undefined) {
                        // Logic for distractors
                    }
                }
            }, true);
        }

        DOM.cefrDisplay.textContent = getCefrLevelDescription();
        setupEventListeners();
    </script>
</body>
</html>
