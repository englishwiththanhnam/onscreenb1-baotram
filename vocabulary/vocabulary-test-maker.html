<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bộ Từ Vựng Chuyên Nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Thư viện docx.js để xuất file Word -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <style>
        :root {
            --blur-intensity: 12px; --saturation-intensity: 150%; --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6); --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9; --text-primary: #0f172a; --text-secondary: #475569;
            --app-bg-start: #f5f7ff; --app-bg-end: #e0e7ff;
        }
        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45); --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25); --primary-accent: #a78bfa; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --app-bg-start: #0f172a; --app-bg-end: #1e293b;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--app-bg-start); background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        body.dark h1, body.dark h2, body.dark label, body.dark p, body.dark input, body.dark textarea, body.dark select, body.dark summary, body.dark th { color: var(--text-primary); }
        body.dark .text-gray-700 { color: var(--text-primary) !important; }
        body.dark #dark-mode-label .fa-moon { color: var(--primary-accent); } #dark-mode-label .fa-sun { color: #f59e0b; }
        .background-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .shape { position: absolute; border-radius: 50%; filter: blur(25px); opacity: 0.6; animation: float 30s infinite alternate ease-in-out; }
        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation-duration: 35s; }
        @keyframes float { from { transform: translateY(20px) scale(1); } to { transform: translateY(-20px) scale(1.05); } }
        .glass-panel { background: var(--glass-bg-color); backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity)); border-radius: 24px; border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); transition: background 0.3s, border 0.3s; }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; user-select: none; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none !important; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary-accent); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.4); color: var(--text-primary); border: 1px solid rgba(255, 255, 255, 0.6); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        .btn-danger { background: #ef4444; color: white; }
        .input-field { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); width: 100%; padding: 12px; border-radius: 12px; transition: background 0.3s, border 0.3s; }
        .input-field:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-accent); }
        body.dark .input-field { background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.2); }
        .input-field:disabled { background-color: rgba(229, 231, 235, 0.5); cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal.is-open { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #data-table th { position: sticky; top: 0; background-color: rgba(255,255,255,0.6); backdrop-filter: blur(5px); z-index: 10; }
        body.dark #data-table th { background-color: rgba(29, 39, 58, 0.6); }
        [contenteditable]:focus { outline: 2px solid var(--primary-accent); background-color: rgba(255, 255, 255, 0.7); border-radius: 4px; }
        body.dark [contenteditable]:focus { background-color: rgba(0, 0, 0, 0.3); }
        .task-details { border-left: 2px solid var(--primary-accent); padding-left: 12px; margin-top: 8px; }
        .task-summary { font-weight: 700; cursor: pointer; list-style: none; }
        .task-summary::-webkit-details-marker { display: none; }
        .task-content { font-size: 12px; margin-top: 8px; color: var(--text-secondary); }
        .task-content .sentence, .task-content .option { background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 6px; margin: 4px 0; color: var(--text-primary); }
        body.dark .task-content .sentence, body.dark .task-content .option { background: rgba(255,255,255,0.08); }
        .correct-answer { border-left: 3px solid #22c55e; }
        .missing-task { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="background-shapes"><div class="shape shape1"></div><div class="shape shape2"></div></div>

    <!-- Login Screen -->
    <div id="login-screen" class="modal is-open">
        <div class="glass-panel p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">Đăng nhập</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email-input" class="input-field"></div>
                <div><label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label><input type="password" id="password-input" class="input-field"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="max-w-screen-2xl mx-auto" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <h1 id="page-title" class="text-4xl font-bold">Trình Soạn Thảo Bộ Từ Vựng</h1>
            <div class="flex items-center gap-4">
                <label id="dark-mode-label" class="flex items-center cursor-pointer text-slate-500">
                    <i class="fas fa-moon mr-2"></i>
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <i class="fas fa-sun ml-2"></i>
                </label>
                <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Panel: Controls -->
            <aside class="lg:col-span-2 space-y-8">
                <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
                    <div class="space-y-4">
                        <div><label for="test-id" class="block text-sm font-medium">Mã định danh (ID)</label><input type="text" id="test-id" class="input-field" placeholder="vd: unit_1_family"></div>
                        <div><label for="test-title" class="block text-sm font-medium">Tiêu đề bộ từ vựng</label><input type="text" id="test-title" class="input-field" placeholder="vd: Unit 1: Family Life"></div>
                    </div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Nhập liệu & Cài đặt</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                             <label class="block text-sm font-medium mb-1">File Từ vựng (.csv)</label>
                             <label for="vocab-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                             <input type="file" id="vocab-csv-upload" class="hidden" accept=".csv">
                             <p id="vocab-file-name" class="text-gray-600 mt-2 text-sm text-center truncate"></p>
                         </div>
                         <div>
                             <label class="block text-sm font-medium mb-1">File Cấu trúc (.csv)</label>
                             <label for="structures-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                             <input type="file" id="structures-csv-upload" class="hidden" accept=".csv">
                             <p id="structures-file-name" class="text-gray-600 mt-2 text-sm text-center truncate"></p>
                         </div>
                     </div>
                    <div class="mt-6">
                        <label for="cefr-level-slider" class="block text-sm font-medium mb-1">Trình độ (CEFR)</label>
                        <input type="range" id="cefr-level-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <div class="flex justify-between text-xs mt-1"><span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span></div>
                        <p id="cefr-level-display" class="text-center font-semibold mt-2"></p>
                    </div>
                    <div class="text-center mt-6"><button id="process-files-btn" class="btn btn-primary">Xử lý Dữ liệu</button></div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Cấu hình AI</h2>
                    <div class="space-y-4">
                        <div><label for="gemini-api-key" class="block text-sm font-medium">Google Gemini API Key</label><input type="password" id="gemini-api-key" class="input-field" placeholder="Dán API Key của bạn..."></div>
                        <div>
                            <label for="ai-model-select" class="block text-sm font-medium text-gray-700 mb-1">Mô hình Gemini</label>
                            <select id="ai-model-select" class="input-field w-full">
                                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Nhanh & Tiết kiệm)</option>
                                <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Chất lượng cao)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right Panel: Data and Actions -->
            <main class="lg:col-span-3 space-y-8">
                <div id="data-review-section" class="glass-panel p-6 hidden">
                     <h2 class="text-2xl font-bold text-gray-700 mb-4">4. Dữ liệu Khảo thí</h2>
                    <div id="table-container" class="max-h-[80vh] overflow-auto rounded-lg border border-white/50">
                        <table id="data-table" class="w-full text-sm">
                            <thead>
                                <tr class="text-left">
                                    <th class="p-3 w-8"><input type="checkbox" id="select-all-checkbox"></th>
                                    <th class="p-3 w-1/4">Từ vựng & Cấu trúc</th>
                                    <th class="p-3 w-3/4">Các Gói Bài Tập</th>
                                    <th class="p-3 text-center">AI</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 text-center flex flex-wrap justify-center gap-4">
                        <button id="fetch-audio-btn" class="btn btn-secondary"><i class="fas fa-volume-up mr-2"></i>Tìm Audio</button>
                        <button id="enrich-missing-btn" class="btn btn-secondary"><i class="fas fa-magic-wand-sparkles mr-2"></i>Làm giàu (Lỗ hổng)</button>
                        <button id="enrich-all-btn" class="btn btn-secondary"><i class="fas fa-sync-alt mr-2"></i>Làm giàu (Ghi đè)</button>
                        <button id="manual-enrich-btn" class="btn btn-secondary"><i class="fas fa-paste mr-2"></i>Làm giàu Thủ công</button>
                        <button id="export-word-btn" class="btn btn-secondary"><i class="fas fa-file-word mr-2"></i>Xuất ra Word</button>
                    </div>
                </div>
                <div class="text-center"><button id="upload-btn" class="btn btn-primary text-lg w-full"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng</button><p id="upload-log" class="font-semibold mt-2 h-5"></p></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="custom-alert-modal" class="modal"></div>
    <div id="manual-prompt-modal" class="modal">
        <div class="glass-panel p-8 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Làm giàu dữ liệu thủ công</h2>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">Bước 1: Sao chép Prompt này</label>
                    <textarea id="manual-prompt-output" readonly class="input-field flex-grow font-mono text-xs"></textarea>
                    <button id="copy-prompt-btn" class="btn btn-primary mt-2">Sao chép Prompt</button>
                </div>
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">Bước 2: Dán kết quả JSON từ Gemini vào đây</label>
                    <textarea id="manual-prompt-input" class="input-field flex-grow font-mono text-xs" placeholder="Dán kết quả JSON tại đây..."></textarea>
                    <button id="process-manual-result-btn" class="btn btn-primary mt-2">Cập nhật dữ liệu</button>
                </div>
            </div>
            <button id="close-manual-modal-btn" class="btn btn-danger mt-6 mx-auto">Đóng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        const CLOUD_FUNCTION_URL = "https://getoaldaudio-asjwauz37q-uc.a.run.app";
        const AI_BATCH_SIZE = 5;
        const ALL_TASK_TYPES = [
            "basic_example", "meaning_mcq", "word_family_mcq", "sentence_unscramble", 
            "error_correction", "ipa_fill", "collocation_odd_one_out", "best_fit_replacement",
            "inference_from_scenario", "best_paraphrase", "antonym_mcq", "tripled_sentence",
            "main_idea", "paragraph_completion", "argument_strengthening", "argument_weakening",
            "tone_purpose_analysis", "sentence_role_analysis"
        ];

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let localWordList = [], vocabCsvText = '', structuresCsvText = '';

        // --- DOM ELEMENTS ---
        const DOM = {
            loginScreen: document.getElementById('login-screen'), mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'), passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'), testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'), dataReviewSection: document.getElementById('data-review-section'),
            dataTableBody: document.getElementById('data-table-body'), fetchAudioBtn: document.getElementById('fetch-audio-btn'),
            enrichMissingBtn: document.getElementById('enrich-missing-btn'), enrichAllBtn: document.getElementById('enrich-all-btn'),
            manualEnrichBtn: document.getElementById('manual-enrich-btn'),
            uploadBtn: document.getElementById('upload-btn'), uploadLog: document.getElementById('upload-log'),
            alertModal: document.getElementById('custom-alert-modal'), 
            vocabCsvUploadInput: document.getElementById('vocab-csv-upload'), vocabFileNameDisplay: document.getElementById('vocab-file-name'),
            structuresCsvUploadInput: document.getElementById('structures-csv-upload'), structuresFileNameDisplay: document.getElementById('structures-file-name'),
            processFilesBtn: document.getElementById('process-files-btn'), darkModeToggle: document.getElementById('dark-mode-toggle'),
            cefrSlider: document.getElementById('cefr-level-slider'), cefrDisplay: document.getElementById('cefr-level-display'),
            geminiApiKeyInput: document.getElementById('gemini-api-key'), aiModelSelect: document.getElementById('ai-model-select'),
            manualPromptModal: document.getElementById('manual-prompt-modal'), manualPromptOutput: document.getElementById('manual-prompt-output'),
            manualPromptInput: document.getElementById('manual-prompt-input'), copyPromptBtn: document.getElementById('copy-prompt-btn'),
            processManualResultBtn: document.getElementById('process-manual-result-btn'), closeManualModalBtn: document.getElementById('close-manual-modal-btn'),
            pageTitle: document.getElementById('page-title'),
            exportWordBtn: document.getElementById('export-word-btn'),
            selectAllCheckbox: document.getElementById('select-all-checkbox'),
        };

        // --- UI & HELPERS ---
        function showAlert(message, type = 'info', details = '') {
            const colors = { info: 'blue', success: 'green', error: 'red' };
            const colorClass = `bg-${colors[type]}-500`;
            const detailsHTML = details ? `<pre class="mt-4 p-2 bg-gray-100 dark:bg-gray-800 text-left text-xs rounded-md max-h-40 overflow-auto">${details}</pre>` : '';
            DOM.alertModal.innerHTML = `<div class="glass-panel text-center p-8 rounded-lg max-w-lg w-full"><p class="text-lg mb-6">${message}</p>${detailsHTML}<button id="alert-ok-btn" class="btn ${colorClass} text-white mt-4">OK</button></div>`;
            DOM.alertModal.classList.add('is-open');
            document.getElementById('alert-ok-btn').onclick = () => DOM.alertModal.classList.remove('is-open');
        }

        function getCefrLevelDescription() {
            const value = parseInt(DOM.cefrSlider.value, 10);
            if (value <= 10) return "A1"; if (value <= 30) return "A2"; if (value <= 50) return "B1";
            if (value <= 70) return "B2"; if (value <= 90) return "C1"; return "C2";
        }

        function updateButtonState(button, isLoading, originalHTML, loadingText = 'Đang xử lý...') {
            button.disabled = isLoading;
            if (isLoading) {
                button.innerHTML = `<div class="loader"></div><span class="ml-2">${loadingText}</span>`;
            } else {
                button.innerHTML = originalHTML;
            }
        }

        // --- DATA PROCESSING ---
        function parseAndStructureCSV(vocabText, structuresText) {
            const vocabRows = vocabText.trim().split(/\r?\n/).filter(Boolean);
            const vocab = vocabRows.map((row, index) => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 4 && columns[0]) {
                    return { 
                        id: index + 1, word: columns[0], type: columns[1], 
                        pronunciation: columns[2], meaning: columns[3], 
                        audioUrl: '', structures: [], generated_tasks: null
                    };
                }
                return null;
            }).filter(Boolean);
            
            if (structuresText) {
                const structureRows = structuresText.trim().split(/\r?\n/).filter(Boolean);
                const structures = structureRows.map(row => {
                    const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                    if (columns.length >= 2 && columns[0]) return { phrase: columns[0], meaning: columns[1] };
                    return null;
                }).filter(Boolean);

                vocab.forEach(v => {
                    const wordLower = v.word.toLowerCase();
                    const matchRegex = new RegExp(`\\b${wordLower}(s|es|ing|ed)?\\b`, 'i');
                    v.structures = structures
                        .filter(s => matchRegex.test(s.phrase.toLowerCase()))
                        .map(s => ({...s}));
                });
            }
            localWordList = vocab;
        }

        function renderTable() {
            DOM.dataTableBody.innerHTML = '';
            localWordList.forEach((word, wordIndex) => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-slate-700 align-top';
                row.dataset.wordId = word.id;

                const audioIconHTML = word.audioUrl ? `<a href="${word.audioUrl}" target="_blank" title="Nghe"><i class="fas fa-volume-up ml-2 text-blue-500 hover:text-blue-400"></i></a>` : '';
                
                const structuresHTML = word.structures && word.structures.length > 0
                    ? `<div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                        <h4 class="font-semibold text-xs uppercase text-slate-400 dark:text-slate-500">Cấu trúc liên quan</h4>
                        <ul class="mt-1 space-y-2">
                            ${word.structures.map((structure, structIndex) => `
                                <li class="text-sm">
                                    <p class="font-semibold" contenteditable="true" data-path="structures[${structIndex}].phrase" data-word-index="${wordIndex}">${structure.phrase}</p>
                                    <p class="text-xs text-slate-500" contenteditable="true" data-path="structures[${structIndex}].meaning" data-word-index="${wordIndex}">${structure.meaning}</p>
                                </li>
                            `).join('')}
                        </ul>
                       </div>`
                    : '';

                const wordInfoHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            <p class="font-bold text-base" contenteditable="true" data-path="word" data-word-index="${wordIndex}">${word.word}</p>
                            ${audioIconHTML}
                        </div>
                        <p class="font-mono text-sm text-violet-700 dark:text-violet-400" contenteditable="true" data-path="pronunciation" data-word-index="${wordIndex}">${word.pronunciation}</p>
                        <p class="text-xs text-slate-500" contenteditable="true" data-path="type" data-word-index="${wordIndex}">(${word.type})</p>
                        <p class="mt-2 text-sm" contenteditable="true" data-path="meaning" data-word-index="${wordIndex}">${word.meaning}</p>
                        ${structuresHTML}
                    </td>`;
                
                const tasks = word.generated_tasks;
                const missingTasks = ALL_TASK_TYPES.filter(type => !tasks || !tasks[type]);

                let tasksHTML = '';
                if (tasks) {
                    tasksHTML = ALL_TASK_TYPES.map(taskKey => {
                        const taskData = tasks[taskKey];
                        if (!taskData) return '';
                        return `<span class="inline-block bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300">${taskKey}</span>`;
                    }).join('');
                }
                
                if (missingTasks.length > 0) {
                    tasksHTML += missingTasks.map(taskKey => `<span class="inline-block bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-red-900 dark:text-red-300">${taskKey}</span>`).join('');
                }

                const aiStatusIcon = tasks ? `<i class="fas fa-check-circle text-2xl text-green-500"></i>` : `<i class="fas fa-times-circle text-2xl text-gray-400"></i>`;

                row.innerHTML = `
                    <td class="p-3 text-center"><input type="checkbox" class="row-checkbox" data-word-id="${word.id}"></td>
                    ${wordInfoHTML}
                    <td class="p-3">${tasksHTML}</td>
                    <td class="p-3 text-center align-middle ai-status-cell">${aiStatusIcon}</td>
                `;
                DOM.dataTableBody.appendChild(row);
            });
        }
        
        function updateNestedObject(obj, path, value) {
            const keys = path.replace(/\[(\w+)\]/g, '.$1').replace(/^\./, '').split('.');
            let current = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                const key = keys[i];
                if (current[key] === undefined || current[key] === null) { 
                    console.error(`Path does not exist: ${keys.slice(0, i + 1).join('.')}`); 
                    return; 
                }
                current = current[key];
            }
            current[keys[keys.length - 1]] = value;
        }

        // --- AI & API ---
        
        function getPromptForBatch(batch, overwriteAll = false) {
            const cefrLevel = getCefrLevelDescription();
            const batchInput = batch.map(wordData => {
                const missingTasks = overwriteAll ? ALL_TASK_TYPES : ALL_TASK_TYPES.filter(type => !wordData.generated_tasks || !wordData.generated_tasks[type]);
                return {
                    id: wordData.id,
                    word: wordData.word,
                    type: wordData.type,
                    meaning: wordData.meaning,
                    pronunciation: wordData.pronunciation,
                    structures: wordData.structures,
                    tasks_to_generate: missingTasks
                };
            });

            return `
# MISSION & ROLE
You are a **Master Instructional Designer** for English Language Testing (ELT). Your mission is to craft high-quality, pedagogically sound assessment items based on a provided list of words and specific task types.

# GUIDING PRINCIPLES
- **CEFR Alignment**: All content MUST be appropriate for the target **${cefrLevel}** level.
- **Context is King**: Leverage provided \`structures\` to create authentic contexts.
- **Plausible Distractors**: Distractors should be tempting but clearly incorrect.
- **Targeted Generation**: You will be given a specific list of \`tasks_to_generate\` for each word. You MUST generate ONLY these specified tasks.

# INPUT & OUTPUT SPECIFICATION

## INPUT
You will receive a JSON array. For each object, you MUST generate the tasks listed in the \`tasks_to_generate\` array.
\`\`\`json
${JSON.stringify(batchInput, null, 2)}
\`\`\`

## OUTPUT
You **MUST** return **ONLY** a single, valid JSON array. Do **NOT** include any explanatory text or markdown formatting. Each object in the output array must contain the original \`id\` and a \`generated_tasks\` object containing ONLY the newly generated tasks.

**Example Output Structure for a single word:**
\`\`\`json
{
  "id": 1,
  "generated_tasks": {
    "basic_example": "A clear, contextual sentence using the word.",
    "meaning_mcq": { "distractors_en": ["word1", "word2"], "distractors_vi": ["nghĩa1", "nghĩa2"] }
  }
}
\`\`\`
---
**FINAL INSTRUCTIONS**
- **Proficiency Level**: Strictly align with the **${cefrLevel}** level.
- **Format**: Return only a valid JSON array.
- **Begin!**
`;
        }


        async function callGeminiAPI(prompt, model) {
            const apiKey = DOM.geminiApiKeyInput.value.trim();
            if (!apiKey) throw new Error("Vui lòng nhập Google Gemini API Key.");
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`Lỗi API Gemini: ${errorBody.error.message}`);
            }
            const result = await response.json();
            const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!responseText) throw new Error("Cấu trúc phản hồi API không hợp lệ.");
            try {
                return JSON.parse(responseText);
            } catch (e) {
                console.error("Lỗi parse JSON từ API:", responseText);
                throw new Error("Kết quả trả về từ AI không phải là JSON hợp lệ.");
            }
        }

        function processAiResults(aiDataArray) {
            const successfulWords = [];
            const failedWords = [];

            if (!Array.isArray(aiDataArray)) {
                showAlert("Lỗi nghiêm trọng", "Kết quả AI trả về không phải là một mảng. Vui lòng kiểm tra lại output từ Gemini.", JSON.stringify(aiDataArray, null, 2));
                return;
            }
            
            aiDataArray.forEach(enrichedData => {
                if (!enrichedData || typeof enrichedData.id === 'undefined' || !enrichedData.generated_tasks) {
                    failedWords.push({ reason: "Cấu trúc không hợp lệ hoặc thiếu ID/tasks.", data: enrichedData });
                    return;
                }

                const wordToUpdate = localWordList.find(w => w.id === enrichedData.id);
                if (wordToUpdate) {
                    // Initialize if it doesn't exist
                    if (!wordToUpdate.generated_tasks) {
                        wordToUpdate.generated_tasks = {};
                    }
                    // Merge new tasks
                    Object.assign(wordToUpdate.generated_tasks, enrichedData.generated_tasks);
                    successfulWords.push(wordToUpdate.word);
                } else {
                    failedWords.push({ reason: `Không tìm thấy từ với ID: ${enrichedData.id}`, data: enrichedData });
                }
            });

            renderTable();

            if (failedWords.length > 0) {
                const errorDetails = failedWords.map(f => `Lý do: ${f.reason}\nDữ liệu: ${JSON.stringify(f.data, null, 2)}`).join('\n\n');
                showAlert(`Hoàn tất với ${failedWords.length} lỗi.`, 'error', errorDetails);
            } else {
                showAlert(`Làm giàu thành công cho ${successfulWords.length} từ!`, 'success');
            }
        }

        // --- FIREBASE & AUTHENTICATION ---
        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            if (!testId || !title || localWordList.length === 0) {
                return showAlert("Vui lòng nhập ID, Tiêu đề và xử lý dữ liệu.", 'error');
            }
            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang lưu...';
            try {
                await setDoc(doc(db, "vocab_sets", testId), { 
                    title, 
                    wordList: localWordList, 
                    updatedAt: serverTimestamp() 
                }, { merge: true });
                DOM.uploadLog.textContent = 'Lưu THÀNH CÔNG!';
                setTimeout(() => { DOM.uploadLog.textContent = ''; }, 3000);
            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }

        async function loadAndPopulateTestData(testId) {
            showAlert("Đang tải dữ liệu đề thi...");
            const docRef = doc(db, "vocab_sets", testId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const testData = docSnap.data();
                    
                    DOM.pageTitle.textContent = "Chỉnh sửa Bộ từ vựng";
                    DOM.testIdInput.value = testId;
                    DOM.testIdInput.disabled = true;
                    DOM.testTitleInput.value = testData.title || "";
                    
                    localWordList = testData.wordList || [];
                    
                    localWordList.forEach(word => {
                        if (!word.generated_tasks) word.generated_tasks = null;
                        if (!word.structures) word.structures = [];
                    });

                    renderTable();
                    DOM.dataReviewSection.classList.remove('hidden');
                    
                    DOM.uploadBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cập nhật Bộ Từ Vựng';
                    
                    const uploadSection = DOM.processFilesBtn.closest('.glass-panel');
                    uploadSection.style.opacity = '0.5';
                    uploadSection.style.pointerEvents = 'none';
                    uploadSection.title = 'Không thể nhập file CSV khi đang chỉnh sửa.';

                    DOM.alertModal.classList.remove('is-open');

                } else {
                    showAlert(`Lỗi: Không tìm thấy bộ từ vựng với ID: ${testId}`, 'error');
                }
            } catch (error) {
                showAlert(`Lỗi khi tải dữ liệu: ${error.message}`, 'error');
                console.error("Error loading test data:", error);
            }
        }
        
        function exportToWord() {
            if (localWordList.length === 0) {
                return showAlert("Không có dữ liệu để xuất.", 'error');
            }

            const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;
            const docChildren = [];
            const charOpts = ['A', 'B', 'C', 'D', 'E', 'F'];

            docChildren.push(new Paragraph({
                text: DOM.testTitleInput.value || "Vocabulary Test",
                heading: HeadingLevel.TITLE,
                alignment: AlignmentType.CENTER,
            }));

            localWordList.forEach((wordData, index) => {
                if (!wordData.generated_tasks) return;

                docChildren.push(new Paragraph({
                    children: [
                        new TextRun({ text: `${index + 1}. ${wordData.word}`, bold: true, size: 28 }),
                        new TextRun({ text: `    ${wordData.pronunciation}`, italics: true, size: 24 })
                    ],
                    spacing: { before: 400, after: 200 },
                }));

                const tasks = wordData.generated_tasks;
                
                const createMCQ = (title, question, correctAnswer, distractors) => {
                    if(!question || !correctAnswer || !Array.isArray(distractors)) return;
                    
                    docChildren.push(new Paragraph({ text: title, bold: true, spacing: { before: 200 } }));
                    docChildren.push(new Paragraph({ text: question, italics: true }));
                    const options = [correctAnswer, ...distractors].sort(() => Math.random() - 0.5);
                    options.forEach((opt, i) => {
                        docChildren.push(new Paragraph({ text: `${charOpts[i]}. ${opt}` }));
                    });
                    docChildren.push(new Paragraph({ text: " " })); // Spacer
                };
                
                const createTextInput = (title, question) => {
                    if(!question) return;
                    docChildren.push(new Paragraph({ text: title, bold: true, spacing: { before: 200 } }));
                    docChildren.push(new Paragraph({ text: question, italics: true }));
                    docChildren.push(new Paragraph("Answer: __________________________________________________"));
                    docChildren.push(new Paragraph({ text: " " })); // Spacer
                };
                
                if(tasks.meaning_mcq) createMCQ('Meaning MCQ (English)', `What is the meaning of "${wordData.word}"?`, wordData.meaning, tasks.meaning_mcq.distractors_vi || []);
                if(tasks.word_family_mcq) createMCQ('Word Family', (tasks.word_family_mcq.sentence || '').replace(tasks.word_family_mcq.blank_placeholder || '[BLANK]', '______'), tasks.word_family_mcq.correct_answer, tasks.word_family_mcq.distractors || []);
                if(tasks.antonym_mcq) createMCQ('Antonym', tasks.antonym_mcq.sentence_context, tasks.antonym_mcq.correct_antonym, tasks.antonym_mcq.distractors || []);
                if(tasks.error_correction) createTextInput('Error Correction', `Correct the sentence: "${tasks.error_correction.incorrect_sentence || ''}"`);
                if(tasks.sentence_unscramble) createTextInput('Sentence Unscramble', `Unscramble the words to form a correct sentence: "${(tasks.sentence_unscramble.correct_sentence || '').split(' ').sort(() => Math.random() - 0.5).join(' / ')}"`);
                if(tasks.best_fit_replacement) createMCQ('Best-fit Replacement', tasks.best_fit_replacement.sentence, tasks.best_fit_replacement.correct_answer, tasks.best_fit_replacement.distractors || []);
                if(tasks.main_idea) createMCQ(`Main Idea of the Passage`, tasks.main_idea.paragraph, tasks.main_idea.correct_answer, tasks.main_idea.distractors || []);
                if(tasks.paragraph_completion) createMCQ(`Find the Conclusion`, tasks.paragraph_completion.paragraph_body, tasks.paragraph_completion.correct_conclusion, tasks.paragraph_completion.distractors || []);
                if(tasks.argument_strengthening) createMCQ(`Strengthen the Argument`, tasks.argument_strengthening.argument_text, tasks.argument_strengthening.correct_evidence, tasks.argument_strengthening.distractors || []);
                if(tasks.argument_weakening) createMCQ(`Weaken the Argument`, tasks.argument_weakening.argument_text, tasks.argument_weakening.correct_weakener, tasks.argument_weakening.distractors || []);
                if(tasks.tone_purpose_analysis) createMCQ(tasks.tone_purpose_analysis.question, tasks.tone_purpose_analysis.paragraph, tasks.tone_purpose_analysis.correct_answer, tasks.tone_purpose_analysis.distractors || []);
                if(tasks.collocation_odd_one_out) createMCQ('Collocation Odd One Out', tasks.collocation_odd_one_out.question, `(The odd one out is: ${tasks.collocation_odd_one_out.answer})`, tasks.collocation_odd_one_out.options || []);

            });

            const doc = new Document({
                sections: [{ properties: {}, children: docChildren }],
            });

            Packer.toBlob(doc).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${DOM.testIdInput.value || 'vocabulary-test'}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showAlert("File Word đã được tạo và tải xuống!", 'success');
            }).catch(err => {
                console.error("Error exporting to Word:", err);
                showAlert("Đã xảy ra lỗi khi xuất file Word.", 'error');
            });
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    DOM.loginScreen.classList.remove('is-open');
                    DOM.mainContent.style.display = 'block';
                    initializePage();
                } else {
                    DOM.loginScreen.classList.add('is-open');
                    DOM.mainContent.style.display = 'none';
                }
            });

            DOM.loginBtn.addEventListener('click', async () => {
                DOM.loginError.textContent = '';
                try { 
                    await signInWithEmailAndPassword(auth, DOM.emailInput.value, DOM.passwordInput.value); 
                } catch (e) { 
                    DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.'; 
                }
            });

            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);

            const handleFileUpload = (event, type) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (type === 'vocab') { 
                        vocabCsvText = e.target.result; 
                        DOM.vocabFileNameDisplay.textContent = file.name; 
                    } else { 
                        structuresCsvText = e.target.result; 
                        DOM.structuresFileNameDisplay.textContent = file.name; 
                    }
                };
                reader.readAsText(file);
            };

            DOM.vocabCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'vocab'));
            DOM.structuresCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'structures'));
            
            DOM.processFilesBtn.addEventListener('click', () => {
                if (!vocabCsvText) return showAlert("Vui lòng tải lên file CSV từ vựng.", 'error');
                parseAndStructureCSV(vocabCsvText, structuresCsvText || '');
                renderTable();
                DOM.dataReviewSection.classList.remove('hidden');
            });

            DOM.darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark');
                const dot = DOM.darkModeToggle.nextElementSibling.nextElementSibling;
                dot.style.transform = DOM.darkModeToggle.checked ? 'translateX(100%)' : 'translateX(0)';
            });
            
            DOM.cefrSlider.addEventListener('input', () => DOM.cefrDisplay.textContent = getCefrLevelDescription());
            
            DOM.fetchAudioBtn.addEventListener('click', async () => {
                if (localWordList.length === 0) return showAlert("Chưa có dữ liệu.", 'error');
                const button = DOM.fetchAudioBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                for (let i = 0; i < localWordList.length; i++) {
                    const wordData = localWordList[i];
                    updateButtonState(button, true, '', `Đang tìm... (${i + 1}/${localWordList.length})`);
                    if (wordData.audioUrl || !wordData.word) continue;
                    try {
                        const response = await fetch(`${CLOUD_FUNCTION_URL}?word=${encodeURIComponent(wordData.word)}`);
                        if (!response.ok) throw new Error(`Server error`);
                        const result = await response.json();
                        if (result.success) wordData.audioUrl = result.audioUrl;
                    } catch (error) { console.error(`Lỗi với từ '${wordData.word}':`, error); }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                renderTable();
                updateButtonState(button, false, originalHTML);
            });

            const handleEnrichment = async (overwriteAll) => {
                const selectedRows = Array.from(document.querySelectorAll('.row-checkbox:checked'));
                const selectedWordIds = selectedRows.map(cb => parseInt(cb.dataset.wordId, 10));
                
                let wordsToEnrich = localWordList.filter(w => selectedWordIds.includes(w.id));
                if (wordsToEnrich.length === 0) {
                    return showAlert("Vui lòng chọn ít nhất một từ để làm giàu.", 'error');
                }
                
                if (!overwriteAll) {
                    wordsToEnrich = wordsToEnrich.filter(w => ALL_TASK_TYPES.some(type => !w.generated_tasks || !w.generated_tasks[type]));
                     if (wordsToEnrich.length === 0) {
                        return showAlert("Các từ đã chọn đã có đủ dữ liệu. Chọn 'Làm giàu (Ghi đè)' nếu muốn tạo lại.", 'info');
                    }
                }

                const button = overwriteAll ? DOM.enrichAllBtn : DOM.enrichMissingBtn;
                const originalHTML = button.innerHTML;
                updateButtonState(button, true, originalHTML);

                try {
                    for (let i = 0; i < wordsToEnrich.length; i += AI_BATCH_SIZE) {
                        const batch = wordsToEnrich.slice(i, i + AI_BATCH_SIZE);
                        updateButtonState(button, true, '', `Đang xử lý... (${i + batch.length}/${wordsToEnrich.length})`);
                        const prompt = getPromptForBatch(batch, overwriteAll);
                        const model = DOM.aiModelSelect.value;
                        const results = await callGeminiAPI(prompt, model);
                        processAiResults(results);
                    }
                } catch (error) {
                    showAlert(`Lỗi khi làm giàu dữ liệu: ${error.message}`, 'error');
                } finally {
                    updateButtonState(button, false, originalHTML);
                }
            };

            DOM.enrichMissingBtn.addEventListener('click', () => handleEnrichment(false));
            DOM.enrichAllBtn.addEventListener('click', async () => {
                const confirmed = confirm("Hành động này sẽ ghi đè tất cả dữ liệu AI hiện có cho các từ đã chọn. Bạn có chắc chắn?");
                if (confirmed) {
                    await handleEnrichment(true);
                }
            });

            DOM.exportWordBtn.addEventListener('click', exportToWord);

            DOM.manualEnrichBtn.addEventListener('click', () => {
                const selectedRows = Array.from(document.querySelectorAll('.row-checkbox:checked'));
                const selectedWordIds = selectedRows.map(cb => parseInt(cb.dataset.wordId, 10));
                const wordsToEnrich = localWordList.filter(w => selectedWordIds.includes(w.id));

                if (wordsToEnrich.length === 0) return showAlert("Vui lòng chọn ít nhất một từ để làm giàu thủ công.", 'error');
                
                DOM.manualPromptOutput.value = getPromptForBatch(wordsToEnrich, false); // Always generate for missing
                DOM.manualPromptInput.value = '';
                DOM.manualPromptModal.classList.add('is-open');
            });
            DOM.closeManualModalBtn.addEventListener('click', () => DOM.manualPromptModal.classList.remove('is-open'));
            DOM.copyPromptBtn.addEventListener('click', () => {
                DOM.manualPromptOutput.select();
                document.execCommand('copy');
                showAlert("Đã sao chép Prompt!", 'success');
            });
            DOM.processManualResultBtn.addEventListener('click', () => {
                try {
                    const jsonText = DOM.manualPromptInput.value.trim().replace(/^```json\s*|```\s*$/g, '');
                    if (!jsonText) throw new Error("Vui lòng dán kết quả JSON.");
                    const results = JSON.parse(jsonText);
                    processAiResults(results);
                    DOM.manualPromptModal.classList.remove('is-open');
                } catch (error) {
                    showAlert(`Lỗi xử lý JSON: ${error.message}`, 'error');
                }
            });
            
            DOM.dataTableBody.addEventListener('blur', (e) => {
                const target = e.target;
                if (target.hasAttribute('contenteditable')) {
                    const wordIndex = parseInt(target.dataset.wordIndex, 10);
                    const path = target.dataset.path;
                    const newText = target.textContent;
                    if (isNaN(wordIndex) || !localWordList[wordIndex] || !path) return;
                    updateNestedObject(localWordList[wordIndex], path, newText);
                }
            }, true);

            DOM.selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
            });
        }
        
        // --- PAGE INITIALIZATION ---
        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const testIdToEdit = urlParams.get('edit');

            if (testIdToEdit) {
                await loadAndPopulateTestData(testIdToEdit);
            } else {
                DOM.pageTitle.textContent = "Trình Soạn Thảo Bộ Từ Vựng";
                DOM.uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng';
            }
        }

        // Start the application
        DOM.cefrDisplay.textContent = getCefrLevelDescription();
        setupEventListeners();

    </script>
</body>
</html>
