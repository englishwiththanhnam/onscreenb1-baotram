<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bộ Từ Vựng Chuyên Nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blur-intensity: 12px; --saturation-intensity: 150%; --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6); --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9; --text-primary: #0f172a; --text-secondary: #475569;
            --app-bg-start: #f5f7ff; --app-bg-end: #e0e7ff;
        }
        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45); --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25); --primary-accent: #a78bfa; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --app-bg-start: #0f172a; --app-bg-end: #1e293b;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--app-bg-start); background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%); color: var(--text-primary); }
        body.dark h1, body.dark h2, body.dark label, body.dark p { color: var(--text-primary); }
        body.dark .text-gray-700 { color: var(--text-primary) !important; }
        .background-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .shape { position: absolute; border-radius: 50%; filter: blur(25px); opacity: 0.6; }
        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; animation: float 28s infinite alternate ease-in-out; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation: float 32s infinite alternate ease-in-out; }
        @keyframes float { from { transform: translateY(20px); } to { transform: translateY(-20px); } }
        .glass-panel { background: var(--glass-bg-color); backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity)); border-radius: 24px; border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none !important; }
        .btn-primary { background: var(--primary-accent); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.4); color: var(--text-primary); border: 1px solid rgba(255, 255, 255, 0.6); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        .btn-danger { background: #ef4444; color: white; }
        .input-field { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); width: 100%; padding: 12px; border-radius: 12px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal.is-open { display: flex; }
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #data-table th { position: sticky; top: 0; background-color: rgba(255,255,255,0.6); backdrop-filter: blur(5px); z-index: 10; }
        body.dark #data-table th { background-color: rgba(29, 39, 58, 0.6); }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="background-shapes"><div class="shape shape1"></div><div class="shape shape2"></div></div>

    <div id="login-screen" class="modal is-open">
        <div class="glass-panel p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">Đăng nhập Giáo viên</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email-input" class="input-field"></div>
                <div><label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label><input type="password" id="password-input" class="input-field"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-screen-xl mx-auto" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Trình Soạn Thảo Bộ Từ Vựng</h1>
            <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <aside class="lg:col-span-2 space-y-8">
                <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
                    <div class="space-y-4">
                        <div><label for="test-id" class="block text-sm font-medium">Mã định danh (ID)</label><input type="text" id="test-id" class="input-field" placeholder="vd: unit_1_family"></div>
                        <div><label for="test-title" class="block text-sm font-medium">Tiêu đề bộ từ vựng</label><input type="text" id="test-title" class="input-field" placeholder="vd: Unit 1: Family Life"></div>
                    </div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Nhập liệu</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="vocab-csv-upload" class="block text-sm font-medium text-gray-700 mb-1">File Từ vựng (.csv)</label>
                            <label for="vocab-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                            <input type="file" id="vocab-csv-upload" class="hidden" accept=".csv">
                            <p id="vocab-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                        </div>
                         <div>
                            <label for="structures-csv-upload" class="block text-sm font-medium text-gray-700 mb-1">File Cấu trúc (.csv)</label>
                            <label for="structures-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                            <input type="file" id="structures-csv-upload" class="hidden" accept=".csv">
                            <p id="structures-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                        </div>
                    </div>
                    <div class="text-center mt-6"><button id="process-files-btn" class="btn btn-primary">Xử lý Dữ liệu</button></div>
                </div>
            </aside>

            <main class="lg:col-span-3 space-y-8">
                <div id="data-review-section" class="glass-panel p-6 hidden">
                     <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Bảng dữ liệu & Làm giàu</h2>
                    <div id="table-container" class="max-h-[60vh] overflow-auto rounded-lg border border-white/50">
                        <table id="data-table" class="w-full text-sm">
                            <thead>
                                <tr class="text-left"><th class="p-3">Từ vựng / Phiên âm</th><th class="p-3">Nghĩa</th><th class="p-3">Cấu trúc</th></tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="fetch-audio-btn" class="btn btn-secondary"><i class="fas fa-volume-up mr-2"></i>Tìm link âm thanh</button>
                        </div>
                </div>
                <div class="text-center"><button id="upload-btn" class="btn btn-primary text-lg w-full"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng</button><p id="upload-log" class="font-semibold mt-2 h-5"></p></div>
            </main>
        </div>
    </div>
    
    <div id="custom-alert-modal" class="modal"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // =================================================================
        // == BƯỚC QUAN TRỌNG: ĐIỀN THÔNG TIN CỦA BẠN VÀO ĐÂY ==
        // =================================================================

        // 1. Dán cấu hình Firebase của PROJECT SPARK (chứa giao diện app)
        const firebaseConfig = {
            apiKey: "AIza...",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };

        // 2. Dán URL của Cloud Function đã triển khai thành công
        const CLOUD_FUNCTION_URL = "https://getoaldaudio-asjwauz37q-uc.a.run.app";

        // =================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let localWordList = [];
        let vocabCsvText = '', structuresCsvText = '';

        const DOM = {
            loginScreen: document.getElementById('login-screen'), mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'), passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'), testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'), dataReviewSection: document.getElementById('data-review-section'),
            dataTableBody: document.getElementById('data-table-body'), fetchAudioBtn: document.getElementById('fetch-audio-btn'),
            uploadBtn: document.getElementById('upload-btn'), uploadLog: document.getElementById('upload-log'),
            alertModal: document.getElementById('custom-alert-modal'), 
            vocabCsvUploadInput: document.getElementById('vocab-csv-upload'), vocabFileNameDisplay: document.getElementById('vocab-file-name'),
            structuresCsvUploadInput: document.getElementById('structures-csv-upload'), structuresFileNameDisplay: document.getElementById('structures-file-name'),
            processFilesBtn: document.getElementById('process-files-btn'),
        };

        function showAlert(message) {
            DOM.alertModal.innerHTML = `<div class="glass-panel text-center p-8 rounded-lg"><p class="text-lg mb-6">${message}</p><button id="alert-ok-btn" class="btn btn-primary">OK</button></div>`;
            DOM.alertModal.classList.add('is-open');
            document.getElementById('alert-ok-btn').onclick = () => DOM.alertModal.classList.remove('is-open');
        }

        function parseAndStructureCSV(vocabText, structuresText) {
            const vocabRows = vocabText.trim().split(/\r?\n/);
            const vocab = vocabRows.map((row, index) => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 4 && columns[0]) {
                    return { id: index + 1, word: columns[0], type: columns[1], pronunciation: columns[2], meaning: columns[3], audioUrl: '', structures: [] };
                }
                return null;
            }).filter(Boolean);

            const structureRows = structuresText.trim().split(/\r?\n/);
            const structures = structureRows.map(row => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 2 && columns[0]) return { phrase: columns[0], meaning: columns[1] };
                return null;
            }).filter(Boolean);

            vocab.forEach(v => {
                const wordLower = v.word.toLowerCase();
                const matchRegex = new RegExp(`\\b${wordLower}s?\\b`, 'i');
                v.structures = structures.filter(s => matchRegex.test(s.phrase));
            });
            localWordList = vocab;
        }

        function renderTable() {
            DOM.dataTableBody.innerHTML = '';
            localWordList.forEach(word => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-slate-700';
                const audioIconHTML = word.audioUrl ? `<a href="${word.audioUrl}" target="_blank" title="Nghe" class="ml-2 text-blue-500"><i class="fas fa-volume-up"></i></a>` : '';
                const structuresHTML = word.structures.map(s => `<div class="p-1 my-1 bg-violet-100 dark:bg-slate-700 rounded-md"><p class="font-semibold text-violet-800 dark:text-violet-300">${s.phrase}</p><p class="text-xs text-slate-600 dark:text-slate-400">${s.meaning}</p></div>`).join('');

                row.innerHTML = `
                    <td class="p-3 align-top"><div class="flex items-center"><p class="font-bold">${word.word}</p>${audioIconHTML}</div><p class="text-sm text-gray-600">${word.pronunciation} (${word.type})</p></td>
                    <td class="p-3 align-top">${word.meaning}</td>
                    <td class="p-3 align-top text-xs">${structuresHTML || '<span class="text-gray-400">Không có</span>'}</td>
                `;
                DOM.dataTableBody.appendChild(row);
            });
        }
        
        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            if (!testId || !title || localWordList.length === 0) return showAlert("Vui lòng nhập ID, Tiêu đề và xử lý dữ liệu.");
            
            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang lưu...';
            try {
                await setDoc(doc(db, "vocab_sets", testId), { title, wordList: localWordList, updatedAt: serverTimestamp() }, { merge: true });
                DOM.uploadLog.textContent = 'THÀNH CÔNG!';
            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }

        const handleFileUpload = (event, type) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'vocab') {
                    vocabCsvText = e.target.result;
                    DOM.vocabFileNameDisplay.textContent = file.name;
                } else {
                    structuresCsvText = e.target.result;
                    DOM.structuresFileNameDisplay.textContent = file.name;
                }
            };
            reader.readAsText(file);
        };

        function setupEventListeners() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    DOM.loginScreen.classList.remove('is-open');
                    DOM.mainContent.style.display = 'block';
                } else {
                    DOM.loginScreen.classList.add('is-open');
                    DOM.mainContent.style.display = 'none';
                }
            });

            DOM.loginBtn.addEventListener('click', async () => {
                try { await signInWithEmailAndPassword(auth, DOM.emailInput.value, DOM.passwordInput.value); } 
                catch (e) { DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.'; }
            });

            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);

            DOM.vocabCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'vocab'));
            DOM.structuresCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'structures'));
            
            DOM.processFilesBtn.addEventListener('click', () => {
                if (!vocabCsvText || !structuresCsvText) return showAlert("Vui lòng tải lên cả hai file CSV.");
                parseAndStructureCSV(vocabCsvText, structuresCsvText);
                renderTable();
                DOM.dataReviewSection.classList.remove('hidden');
            });
            
            DOM.fetchAudioBtn.addEventListener('click', async () => {
                if (localWordList.length === 0) return showAlert("Chưa có dữ liệu.");
                if (CLOUD_FUNCTION_URL.includes("URL_CUA_FUNCTION")) return showAlert("Lỗi: Vui lòng cấu hình URL của Cloud Function trong code.");

                const button = DOM.fetchAudioBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                let foundCount = 0;

                for (let i = 0; i < localWordList.length; i++) {
                    const wordData = localWordList[i];
                    button.innerHTML = `<div class="loader"></div><span class="ml-2">Đang tìm... (${i + 1}/${localWordList.length})</span>`;
                    if (wordData.audioUrl || !wordData.word) continue;
                    try {
                        const response = await fetch(`${CLOUD_FUNCTION_URL}?word=${encodeURIComponent(wordData.word)}`);
                        if (!response.ok) throw new Error(`Server error`);
                        const result = await response.json();
                        if (result.success) {
                            wordData.audioUrl = result.audioUrl;
                            foundCount++;
                        }
                    } catch (error) { console.error(`Lỗi với từ '${wordData.word}':`, error); }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                renderTable();
                button.disabled = false;
                button.innerHTML = originalHTML;
                showAlert(`Hoàn tất! Tìm thấy ${foundCount}/${localWordList.length} link.`);
            });
        }

        setupEventListeners();
    </script>
</body>
</html>
