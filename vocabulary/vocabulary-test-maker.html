<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bộ Từ Vựng Chuyên Nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- MỚI: Thêm thư viện docx.js để xuất file Word -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <style>
        :root {
            --blur-intensity: 12px; --saturation-intensity: 150%; --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6); --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9; --text-primary: #0f172a; --text-secondary: #475569;
            --app-bg-start: #f5f7ff; --app-bg-end: #e0e7ff;
        }
        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45); --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25); --primary-accent: #a78bfa; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --app-bg-start: #0f172a; --app-bg-end: #1e293b;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--app-bg-start); background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        body.dark h1, body.dark h2, body.dark label, body.dark p, body.dark input, body.dark textarea, body.dark select, body.dark summary, body.dark th { color: var(--text-primary); }
        body.dark .text-gray-700 { color: var(--text-primary) !important; }
        body.dark #dark-mode-label .fa-moon { color: var(--primary-accent); } #dark-mode-label .fa-sun { color: #f59e0b; }
        .background-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .shape { position: absolute; border-radius: 50%; filter: blur(25px); opacity: 0.6; animation: float 30s infinite alternate ease-in-out; }
        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation-duration: 35s; }
        @keyframes float { from { transform: translateY(20px) scale(1); } to { transform: translateY(-20px) scale(1.05); } }
        .glass-panel { background: var(--glass-bg-color); backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity)); border-radius: 24px; border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); transition: background 0.3s, border 0.3s; }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; user-select: none; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none !important; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary-accent); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.4); color: var(--text-primary); border: 1px solid rgba(255, 255, 255, 0.6); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        .btn-danger { background: #ef4444; color: white; }
        .input-field { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); width: 100%; padding: 12px; border-radius: 12px; transition: background 0.3s, border 0.3s; }
        .input-field:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-accent); }
        body.dark .input-field { background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.2); }
        .input-field:disabled { background-color: rgba(229, 231, 235, 0.5); cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal.is-open { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #data-table th { position: sticky; top: 0; background-color: rgba(255,255,255,0.6); backdrop-filter: blur(5px); z-index: 10; }
        body.dark #data-table th { background-color: rgba(29, 39, 58, 0.6); }
        [contenteditable]:focus { outline: 2px solid var(--primary-accent); background-color: rgba(255, 255, 255, 0.7); border-radius: 4px; }
        body.dark [contenteditable]:focus { background-color: rgba(0, 0, 0, 0.3); }
        .task-details { border-left: 2px solid var(--primary-accent); padding-left: 12px; margin-top: 8px; }
        .task-summary { font-weight: 700; cursor: pointer; list-style: none; }
        .task-summary::-webkit-details-marker { display: none; }
        .task-content { font-size: 12px; margin-top: 8px; color: var(--text-secondary); }
        .task-content .sentence { background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 6px; margin: 4px 0; color: var(--text-primary); }
        body.dark .task-content .sentence { background: rgba(255,255,255,0.08); }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="background-shapes"><div class="shape shape1"></div><div class="shape shape2"></div></div>

    <!-- Login Screen -->
    <div id="login-screen" class="modal is-open">
        <div class="glass-panel p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">Đăng nhập</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email-input" class="input-field"></div>
                <div><label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label><input type="password" id="password-input" class="input-field"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="max-w-screen-2xl mx-auto" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <h1 id="page-title" class="text-4xl font-bold">Trình Soạn Thảo Bộ Từ Vựng</h1>
            <div class="flex items-center gap-4">
                <label id="dark-mode-label" class="flex items-center cursor-pointer text-slate-500">
                    <i class="fas fa-moon mr-2"></i>
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <i class="fas fa-sun ml-2"></i>
                </label>
                <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Panel: Controls -->
            <aside class="lg:col-span-2 space-y-8">
                <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
                    <div class="space-y-4">
                        <div><label for="test-id" class="block text-sm font-medium">Mã định danh (ID)</label><input type="text" id="test-id" class="input-field" placeholder="vd: unit_1_family"></div>
                        <div><label for="test-title" class="block text-sm font-medium">Tiêu đề bộ từ vựng</label><input type="text" id="test-title" class="input-field" placeholder="vd: Unit 1: Family Life"></div>
                    </div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Nhập liệu & Cài đặt</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                             <label class="block text-sm font-medium mb-1">File Từ vựng (.csv)</label>
                             <label for="vocab-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                             <input type="file" id="vocab-csv-upload" class="hidden" accept=".csv">
                             <p id="vocab-file-name" class="text-gray-600 mt-2 text-sm text-center truncate"></p>
                         </div>
                         <div>
                             <label class="block text-sm font-medium mb-1">File Cấu trúc (.csv)</label>
                             <label for="structures-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                             <input type="file" id="structures-csv-upload" class="hidden" accept=".csv">
                             <p id="structures-file-name" class="text-gray-600 mt-2 text-sm text-center truncate"></p>
                         </div>
                     </div>
                    <div class="mt-6">
                        <label for="cefr-level-slider" class="block text-sm font-medium mb-1">Trình độ (CEFR)</label>
                        <input type="range" id="cefr-level-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <div class="flex justify-between text-xs mt-1"><span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span></div>
                        <p id="cefr-level-display" class="text-center font-semibold mt-2"></p>
                    </div>
                    <div class="text-center mt-6"><button id="process-files-btn" class="btn btn-primary">Xử lý Dữ liệu</button></div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Cấu hình AI</h2>
                    <div class="space-y-4">
                        <div><label for="gemini-api-key" class="block text-sm font-medium">Google Gemini API Key</label><input type="password" id="gemini-api-key" class="input-field" placeholder="Dán API Key của bạn..."></div>
                        <div>
                            <label for="ai-model-select" class="block text-sm font-medium text-gray-700 mb-1">Mô hình Gemini</label>
                            <select id="ai-model-select" class="input-field w-full">
                                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Nhanh & Tiết kiệm)</option>
                                <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Chất lượng cao)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right Panel: Data and Actions -->
            <main class="lg:col-span-3 space-y-8">
                <div id="data-review-section" class="glass-panel p-6 hidden">
                     <h2 class="text-2xl font-bold text-gray-700 mb-4">4. Dữ liệu Khảo thí do AI tạo</h2>
                    <div id="table-container" class="max-h-[80vh] overflow-auto rounded-lg border border-white/50">
                        <table id="data-table" class="w-full text-sm">
                            <thead>
                                <tr class="text-left">
                                    <th class="p-3 w-1/4">Từ vựng & Cấu trúc</th>
                                    <th class="p-3 w-3/4">Các Gói Bài Tập</th>
                                    <th class="p-3 text-center">AI</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 text-center flex flex-wrap justify-center gap-4">
                        <button id="fetch-audio-btn" class="btn btn-secondary"><i class="fas fa-volume-up mr-2"></i>Tìm Audio</button>
                        <button id="enrich-ai-btn" class="btn btn-secondary"><i class="fas fa-wand-magic-sparkles mr-2"></i>Làm giàu Tự động</button>
                        <button id="manual-enrich-btn" class="btn btn-secondary"><i class="fas fa-paste mr-2"></i>Làm giàu Thủ công</button>
                        <button id="export-word-btn" class="btn btn-secondary"><i class="fas fa-file-word mr-2"></i>Xuất ra Word</button>
                    </div>
                </div>
                <div class="text-center"><button id="upload-btn" class="btn btn-primary text-lg w-full"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng</button><p id="upload-log" class="font-semibold mt-2 h-5"></p></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="custom-alert-modal" class="modal"></div>
    <div id="manual-prompt-modal" class="modal">
        <div class="glass-panel p-8 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Làm giàu dữ liệu thủ công</h2>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">Bước 1: Sao chép Prompt này</label>
                    <textarea id="manual-prompt-output" readonly class="input-field flex-grow font-mono text-xs"></textarea>
                    <button id="copy-prompt-btn" class="btn btn-primary mt-2">Sao chép Prompt</button>
                </div>
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">Bước 2: Dán kết quả JSON từ Gemini vào đây</label>
                    <textarea id="manual-prompt-input" class="input-field flex-grow font-mono text-xs" placeholder="Dán kết quả JSON tại đây..."></textarea>
                    <button id="process-manual-result-btn" class="btn btn-primary mt-2">Cập nhật dữ liệu</button>
                </div>
            </div>
            <button id="close-manual-modal-btn" class="btn btn-danger mt-6 mx-auto">Đóng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        const CLOUD_FUNCTION_URL = "https://getoaldaudio-asjwauz37q-uc.a.run.app";
        const AI_BATCH_SIZE = 5;

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let localWordList = [], vocabCsvText = '', structuresCsvText = '';

        // --- DOM ELEMENTS ---
        const DOM = {
            loginScreen: document.getElementById('login-screen'), mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'), passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'), testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'), dataReviewSection: document.getElementById('data-review-section'),
            dataTableBody: document.getElementById('data-table-body'), fetchAudioBtn: document.getElementById('fetch-audio-btn'),
            enrichAiBtn: document.getElementById('enrich-ai-btn'), manualEnrichBtn: document.getElementById('manual-enrich-btn'),
            uploadBtn: document.getElementById('upload-btn'), uploadLog: document.getElementById('upload-log'),
            alertModal: document.getElementById('custom-alert-modal'), 
            vocabCsvUploadInput: document.getElementById('vocab-csv-upload'), vocabFileNameDisplay: document.getElementById('vocab-file-name'),
            structuresCsvUploadInput: document.getElementById('structures-csv-upload'), structuresFileNameDisplay: document.getElementById('structures-file-name'),
            processFilesBtn: document.getElementById('process-files-btn'), darkModeToggle: document.getElementById('dark-mode-toggle'),
            cefrSlider: document.getElementById('cefr-level-slider'), cefrDisplay: document.getElementById('cefr-level-display'),
            geminiApiKeyInput: document.getElementById('gemini-api-key'), aiModelSelect: document.getElementById('ai-model-select'),
            manualPromptModal: document.getElementById('manual-prompt-modal'), manualPromptOutput: document.getElementById('manual-prompt-output'),
            manualPromptInput: document.getElementById('manual-prompt-input'), copyPromptBtn: document.getElementById('copy-prompt-btn'),
            processManualResultBtn: document.getElementById('process-manual-result-btn'), closeManualModalBtn: document.getElementById('close-manual-modal-btn'),
            pageTitle: document.getElementById('page-title'),
            exportWordBtn: document.getElementById('export-word-btn'),
        };

        // --- UI & HELPERS ---
        function showAlert(message, type = 'info') {
            const colors = { info: 'blue', success: 'green', error: 'red' };
            const colorClass = `bg-${colors[type]}-500`;
            DOM.alertModal.innerHTML = `<div class="glass-panel text-center p-8 rounded-lg"><p class="text-lg mb-6">${message}</p><button id="alert-ok-btn" class="btn ${colorClass} text-white">OK</button></div>`;
            DOM.alertModal.classList.add('is-open');
            document.getElementById('alert-ok-btn').onclick = () => DOM.alertModal.classList.remove('is-open');
        }

        function getCefrLevelDescription() {
            const value = parseInt(DOM.cefrSlider.value, 10);
            if (value <= 10) return "A1"; if (value <= 30) return "A2"; if (value <= 50) return "B1";
            if (value <= 70) return "B2"; if (value <= 90) return "C1"; return "C2";
        }

        function updateButtonState(button, isLoading, originalHTML, loadingText = 'Đang xử lý...') {
            button.disabled = isLoading;
            if (isLoading) {
                button.innerHTML = `<div class="loader"></div><span class="ml-2">${loadingText}</span>`;
            } else {
                button.innerHTML = originalHTML;
            }
        }

        // --- DATA PROCESSING ---
        function parseAndStructureCSV(vocabText, structuresText) {
            const vocabRows = vocabText.trim().split(/\r?\n/).filter(Boolean);
            const vocab = vocabRows.map((row, index) => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 4 && columns[0]) {
                    return { 
                        id: index + 1, word: columns[0], type: columns[1], 
                        pronunciation: columns[2], meaning: columns[3], 
                        audioUrl: '', isEnriched: false, structures: [], generated_tasks: null
                    };
                }
                return null;
            }).filter(Boolean);
            
            if (structuresText) {
                const structureRows = structuresText.trim().split(/\r?\n/).filter(Boolean);
                const structures = structureRows.map(row => {
                    const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                    if (columns.length >= 2 && columns[0]) return { phrase: columns[0], meaning: columns[1] };
                    return null;
                }).filter(Boolean);

                vocab.forEach(v => {
                    const wordLower = v.word.toLowerCase();
                    const matchRegex = new RegExp(`\\b${wordLower}(s|es|ing|ed)?\\b`, 'i');
                    v.structures = structures
                        .filter(s => matchRegex.test(s.phrase.toLowerCase()))
                        .map(s => ({...s}));
                });
            }
            localWordList = vocab;
        }

        function renderTable() {
            DOM.dataTableBody.innerHTML = '';
            localWordList.forEach((word, wordIndex) => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-slate-700 align-top';

                const audioIconHTML = word.audioUrl ? `<a href="${word.audioUrl}" target="_blank" title="Nghe"><i class="fas fa-volume-up ml-2 text-blue-500 hover:text-blue-400"></i></a>` : '';
                
                const structuresHTML = word.structures && word.structures.length > 0
                    ? `<div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                        <h4 class="font-semibold text-xs uppercase text-slate-400 dark:text-slate-500">Cấu trúc liên quan</h4>
                        <ul class="mt-1 space-y-2">
                            ${word.structures.map((structure, structIndex) => `
                                <li class="text-sm">
                                    <p class="font-semibold" contenteditable="true" data-path="structures[${structIndex}].phrase" data-word-index="${wordIndex}">${structure.phrase}</p>
                                    <p class="text-xs text-slate-500" contenteditable="true" data-path="structures[${structIndex}].meaning" data-word-index="${wordIndex}">${structure.meaning}</p>
                                </li>
                            `).join('')}
                        </ul>
                       </div>`
                    : '';

                const wordInfoHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            <p class="font-bold text-base" contenteditable="true" data-path="word" data-word-index="${wordIndex}">${word.word}</p>
                            ${audioIconHTML}
                        </div>
                        <p class="font-mono text-sm text-violet-700 dark:text-violet-400" contenteditable="true" data-path="pronunciation" data-word-index="${wordIndex}">${word.pronunciation}</p>
                        <p class="text-xs text-slate-500">(${word.type})</p>
                        <p class="mt-2 text-sm" contenteditable="true" data-path="meaning" data-word-index="${wordIndex}">${word.meaning}</p>
                        ${structuresHTML}
                    </td>`;

                let tasksHTML = '<span class="text-xs text-gray-400 italic">Chưa có dữ liệu AI.</span>';
                const tasks = word.generated_tasks;

                if (tasks) {
                    const renderTask = (taskData, title, contentRenderer) => {
                        if (!taskData) return '';
                        return `
                            <details class="mt-2">
                                <summary class="task-summary">${title}</summary>
                                <div class="task-details">
                                    ${contentRenderer(taskData)}
                                </div>
                            </details>`;
                    };

                    tasksHTML = [
                        renderTask(tasks.basic_example, '1. Basic Example', data => `<div class="task-content"><p class="sentence" contenteditable="true" data-path="generated_tasks.basic_example" data-word-index="${wordIndex}">${data}</p></div>`),
                        renderTask(tasks.meaning_mcq, '2. Meaning MCQ', data => `<div class="task-content"><p><b>Distractors (EN):</b> ${(data.distractors_en || []).join(', ')}</p><p><b>Distractors (VI):</b> ${(data.distractors_vi || []).join(', ')}</p></div>`),
                        renderTask(tasks.word_family_mcq, '3. Word Family MCQ', data => `<div class="task-content"><p class="sentence">${(data.sentence || '').replace(data.blank_placeholder, `<b>[____]</b>`)}</p><p><b>Answer:</b> ${data.correct_answer || ''}</p><p><b>Distractors:</b> ${(data.distractors || []).join(', ')}</p></div>`),
                        renderTask(tasks.sentence_unscramble, '4. Sentence Unscramble', data => `<div class="task-content"><p class="sentence">${data.correct_sentence || ''}</p></div>`),
                        renderTask(tasks.error_correction, '5. Error Correction', data => `<div class="task-content"><p><b>Incorrect:</b> <span class="sentence">${data.incorrect_sentence || ''}</span></p><p><b>Correct:</b> <span class="sentence">${data.correct_sentence || ''}</span></p></div>`),
                        renderTask(tasks.ipa_fill, '6. IPA Fill', data => `<div class="task-content"><p><b>Gapped IPA:</b> ${data.gapped_ipa || ''}</p><p><b>Correct Vowel:</b> ${data.correct_vowel || ''}</p><p><b>Distractors:</b> ${(data.distractors || []).join(', ')}</p></div>`),
                        renderTask(tasks.best_fit_replacement, '7. Best-fit Replacement', data => `<div class="task-content"><p class="sentence">${(data.sentence || '').replace(data.word_to_replace, `<b><u>${data.word_to_replace}</u></b>`)}</p><p><b>Answer:</b> ${data.correct_answer}</p><p><b>Distractors:</b> ${(data.distractors || []).join(', ')}</p></div>`),
                        renderTask(tasks.inference_from_scenario, '8. Inference', data => `<div class="task-content"><p class="sentence">${data.scenario || ''}</p><p><b>Question:</b> ${data.question}</p><p><b>Answer:</b> ${data.correct_answer}</p></div>`),
                        renderTask(tasks.best_paraphrase, '9. Best Paraphrase', data => `<div class="task-content"><p><b>Original:</b></p><p class="sentence">${data.original_sentence || ''}</p><p><b>Correct Paraphrase:</b> ${ (data.options || []).find(o => o.is_correct)?.text || ''}</p></div>`),
                        renderTask(tasks.antonym_mcq, '10. Antonym MCQ', data => `<div class="task-content"><p class="sentence">${data.sentence_context || ''}</p><p><b>Keyword:</b> ${data.keyword}</p><p><b>Antonym:</b> ${data.correct_antonym}</p><p><b>Distractors:</b> ${(data.distractors || []).join(', ')}</p></div>`),
                        renderTask(tasks.tripled_sentence, '11. Tripled Sentence', data => `<div class="task-content"><p><b>Keyword:</b> ${data.keyword}</p><ul>${(data.examples || []).map(ex => `<li>${ex}</li>`).join('')}</ul></div>`),
                        renderTask(tasks.main_idea, '12. Main Idea', data => `<div class="task-content"><p><b>Paragraph:</b> ${data.paragraph || ''}</p><p><b>Main Idea:</b> ${data.correct_answer}</p></div>`),
                        renderTask(tasks.paragraph_completion, '13. Paragraph Completion', data => `<div class="task-content"><p><b>Body:</b> ${data.paragraph_body || ''}</p><p><b>Conclusion:</b> ${data.correct_conclusion}</p></div>`),
                        renderTask(tasks.argument_strengthening, '14. Argument Strengthening', data => `<div class="task-content"><p><b>Argument:</b> ${data.argument_text || ''}</p><p><b>Evidence:</b> ${data.correct_evidence}</p></div>`),
                        renderTask(tasks.argument_weakening, '15. Argument Weakening', data => `<div class="task-content"><p><b>Argument:</b> ${data.argument_text || ''}</p><p><b>Evidence:</b> ${data.correct_weakener}</p></div>`),
                        renderTask(tasks.tone_purpose_analysis, '16. Tone/Purpose Analysis', data => `<div class="task-content"><p><b>Paragraph:</b> ${data.paragraph || ''}</p><p><b>Question:</b> ${data.question}</p><p><b>Answer:</b> ${data.correct_answer}</p></div>`),
                        renderTask(tasks.sentence_role_analysis, '17. Sentence Role Analysis', data => `<div class="task-content"><p><b>Paragraph:</b> ${data.paragraph || ''}</p><p><b>Role of Sentence ${data.highlighted_sentence_index + 1}:</b> ${data.correct_role}</p></div>`),
                    ].filter(Boolean).join('');
                }

                row.innerHTML = `
                    ${wordInfoHTML}
                    <td class="p-3">${tasksHTML}</td>
                    <td class="p-3 text-center align-middle">${word.isEnriched ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>' : '<i class="fas fa-hourglass-half text-2xl text-gray-400"></i>'}</td>
                `;
                DOM.dataTableBody.appendChild(row);
            });
        }
        
        function updateNestedObject(obj, path, value) {
            const keys = path.replace(/\[(\w+)\]/g, '.$1').replace(/^\./, '').split('.');
            let current = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (current[keys[i]] === undefined || current[keys[i]] === null) { console.error(`Path does not exist: ${keys.slice(0, i + 1).join('.')}`); return; }
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = value;
        }

        // --- AI & API ---
        
        // UPGRADED PROMPT
        function getPromptForBatch(batch) {
            const cefrLevel = getCefrLevelDescription();
            const batchInput = batch.map(wordData => ({
                id: wordData.id,
                word: wordData.word,
                type: wordData.type,
                meaning: wordData.meaning,
                pronunciation: wordData.pronunciation,
                structures: wordData.structures 
            }));

            return `
# MISSION & ROLE
You are a **Master Instructional Designer** specializing in English Language Testing (ELT). Your mission is to craft high-quality, pedagogically sound assessment items. You are not a mere content generator; you are an expert in cognitive science and language acquisition, creating "cognitive puzzles" that test and reinforce a learner's understanding of vocabulary in a comprehensive, meaningful way.

# GUIDING PRINCIPLES
- **Pedagogical Soundness**: Every item must have a clear learning objective.
- **CEFR Alignment**: All content, from example sentences to distractors, MUST be appropriate for the target **${cefrLevel}** level.
- **Context is King**: Leverage the provided \`structures\` to create authentic, natural-sounding contexts. Avoid generic or nonsensical sentences.
- **Plausible Distractors**: The art of a good question lies in its distractors. They should be tempting to a learner who has a partial understanding but clearly incorrect to one who has mastered the concept.
- **Creativity & Variety**: Avoid repetitive sentence structures. Showcase the vocabulary in diverse and interesting scenarios.

# INPUT & OUTPUT SPECIFICATION

## INPUT
You will receive a JSON array of word objects. You MUST process every object in the array.
\`\`\`json
${JSON.stringify(batchInput, null, 2)}
\`\`\`

## OUTPUT
You **MUST** return **ONLY** a single, valid JSON array. Do **NOT** include any explanatory text, markdown formatting like \`\`\`json, or any other content outside of the JSON array itself. Each object in the output array must strictly adhere to the following full structure, containing all 18 task types:
\`\`\`json
{
  "id": "the_original_id_of_the_word",
  "generated_tasks": {
    "basic_example": "A clear, contextual sentence using the word.",
    "meaning_mcq": { "distractors_en": ["word1", "word2"], "distractors_vi": ["nghĩa1", "nghĩa2"] },
    "word_family_mcq": { "sentence": "A gapped sentence.", "blank_placeholder": "[BLANK]", "correct_answer": "The correct form.", "distractors": ["wrong_form1", "wrong_form2"] },
    "sentence_unscramble": { "correct_sentence": "The complete, correct sentence." },
    "error_correction": { "incorrect_sentence": "A sentence with a subtle error.", "correct_sentence": "The corrected version." },
    "ipa_fill": { "gapped_ipa": "/g_pt/", "correct_vowel": "æ", "distractors": ["e", "ɪ", "ɑː"] },
    "collocation_odd_one_out": { "question": "Which word does NOT collocate with '...'", "options": ["collocate1", "collocate2", "non_collocate"], "answer": "non_collocate" },
    "best_fit_replacement": { "sentence": "A sentence with a word to replace.", "word_to_replace": "The target word.", "correct_answer": "The best synonym.", "distractors": ["weaker_synonym1", "weaker_synonym2"] },
    "inference_from_scenario": { "scenario": "A short story.", "question": "What can be inferred?", "correct_answer": "The logical inference.", "distractors": ["distractor1", "distractor2"] },
    "best_paraphrase": { "original_sentence": "The original sentence.", "options": [ {"text": "A perfect paraphrase.", "similarity": 100, "is_correct": true}, {"text": "A slightly different meaning.", "similarity": 60, "is_correct": false} ] },
    "antonym_mcq": { "keyword": "the_word", "sentence_context": "A sentence highlighting the keyword.", "correct_antonym": "The true antonym.", "distractors": ["synonym1", "synonym2"] },
    "tripled_sentence": { "keyword": "the_word", "examples": ["Sentence in context A.", "Sentence in context B.", "Sentence in context C."] },
    "main_idea": { "paragraph": "A short paragraph.", "correct_answer": "The main point.", "distractors": ["A supporting detail.", "An overgeneralization."] },
    "paragraph_completion": { "paragraph_body": "A paragraph missing its conclusion.", "correct_conclusion": "The logical concluding sentence.", "distractors": ["An abrupt or illogical conclusion."] },
    "argument_strengthening": { "argument_text": "An author's argument.", "author_viewpoint": "A summary of the viewpoint.", "correct_evidence": "Evidence that supports the argument.", "distractors": ["Evidence that weakens it."] },
    "argument_weakening": { "argument_text": "An author's argument.", "author_viewpoint": "A summary of the viewpoint.", "correct_weakener": "Evidence that undermines the argument.", "distractors": ["Evidence that strengthens it."] },
    "tone_purpose_analysis": { "paragraph": "A paragraph with a specific tone.", "question": "The primary purpose of this passage is to...", "correct_answer": "e.g., 'question a popular belief'", "distractors": ["e.g., 'present an objective overview'"] },
    "sentence_role_analysis": { "paragraph": "[1] Sentence one. [2] Sentence two.", "highlighted_sentence_index": 1, "correct_role": "e.g., 'To provide evidence for the claim in sentence 1.'", "distractors": ["e.g., 'To state the main conclusion.'"] }
  }
}
\`\`\`

# DETAILED TASK GUIDELINES & HIGH-QUALITY EXAMPLES

**1. \`basic_example\`**:
- **Objective**: Provide the most clear, simple, and contextually appropriate example sentence.
- **High-Quality Example** (for "ubiquitous"): "In today's world, smartphones and Wi-Fi have become ubiquitous."
- **Poor Example**: "The ubiquitousness of the problem was startling." (Uses a different word form, less common).

**2. \`meaning_mcq\`**:
- **Objective**: Test semantic understanding with plausible distractors.
- **Strategy**: Distractors should be related (e.g., other feelings for an emotion word) or be common mistakes.
- **High-Quality Example** (for "diligent"): distractors_en: ["lazy", "intelligent", "creative"], distractors_vi: ["lười biếng", "thông minh", "sáng tạo"].

**3. \`word_family_mcq\`**:
- **Objective**: Test knowledge of different forms of a word.
- **Strategy**: Distractors MUST be other members of the word family or commonly confused forms.
- **High-Quality Example** (for "economy"): sentence: "The government needs to _______ the national budget carefully.", blank_placeholder: "[BLANK]", correct_answer: "economize", distractors: ["economic", "economical", "economics"].

**4. \`sentence_unscramble\`**:
- **Objective**: Test understanding of syntax and word order.
- **High-Quality Example** (for "collaborate"): "The two rival companies agreed to collaborate on the new project."

**5. \`error_correction\`**:
- **Objective**: Test ability to spot subtle grammatical or collocational errors.
- **Strategy**: Focus on common errors like prepositions, articles, or verb tenses, not obvious spelling mistakes.
- **High-Quality Example** (for "responsible"): incorrect_sentence: "He is responsible at managing the team.", correct_sentence: "He is responsible for managing the team."

**6. \`ipa_fill\`**:
- **Objective**: Test phonemic awareness.
- **Strategy**: Gap a single, distinctive vowel or consonant sound. Distractors should be phonetically similar.
- **High-Quality Example** (for "heat" /hiːt/): gapped_ipa: "/h_t/", correct_vowel: "iː", distractors: ["ɪ", "e", "eɪ"].

**7. \`collocation_odd_one_out\`**:
- **Objective**: Test knowledge of common word pairings (collocations).
- **High-Quality Example** (for "effort"): question: "Which verb does NOT typically collocate with 'effort'?", options: ["make", "put in", "do", "save"], answer: "do".

**8. \`best_fit_replacement\`**:
- **Objective**: Test understanding of semantic nuance and connotation.
- **Strategy**: Distractors should be synonyms but less precise or appropriate for the specific context.
- **High-Quality Example** (for "crucial"): sentence: "It is **crucial** that you submit the report by Friday.", word_to_replace: "crucial", correct_answer: "vital", distractors: ["important", "helpful", "suggested"].

**9. \`inference_from_scenario\`**:
- **Objective**: Test reading comprehension and logical deduction.
- **Strategy**: The answer must be strongly implied by the text, not explicitly stated.
- **High-Quality Example** (for "reluctant"): scenario: "John looked at the huge plate of Brussels sprouts. He slowly picked up his fork but didn't take a bite. 'My mother said I have to eat them,' he sighed.", question: "How does John feel about eating the Brussels sprouts?", correct_answer: "He is reluctant to eat them.", distractors: ["He is excited to eat them.", "He is allergic to them.", "He has never tried them before."].

**10. \`best_paraphrase\`**:
- **Objective**: Test ability to recognize the same meaning expressed differently.
- **Strategy**: Distractors should alter the original meaning in a subtle way (e.g., changing the certainty, scope, or focus).
- **High-Quality Example** (for "mitigate"): original_sentence: "The new flood barriers are designed to mitigate the effects of storm surges.", options: [{"text": "The barriers aim to lessen the impact of storm surges.", "similarity": 100, "is_correct": true}, {"text": "The barriers will completely prevent all damage from storms.", "similarity": 60, "is_correct": false}].

**11. \`antonym_mcq\`**:
- **Objective**: Test knowledge of opposites, with a twist.
- **Strategy**: The most effective distractors are often **synonyms** of the keyword, forcing the learner to carefully read the question.
- **High-Quality Example** (for "expand"): sentence_context: "The company plans to **expand** its operations in Asia.", keyword: "expand", correct_antonym: "contract", distractors: ["grow", "enlarge", "develop"].

**12. \`tripled_sentence\`**:
- **Objective**: Show understanding of a word's different uses or shades of meaning.
- **Strategy**: Use the keyword in three distinct, non-repetitive contexts.
- **High-Quality Example** (for "policy"): keyword: "policy", examples: ["The company has a strict no-smoking policy.", "The government's new economic policy was met with criticism.", "It's a good policy to always check your work before submitting it."].

**13. \`main_idea\`**:
- **Objective**: Test ability to synthesize information and identify the central point.
- **Strategy**: Distractors should be: a true but minor detail, a statement that is too broad, or a misinterpretation of the paragraph's focus.
- **High-Quality Example** (for "sustainable"): paragraph: "Sustainable agriculture focuses on long-term solutions. It avoids harsh chemicals that deplete the soil and seeks to conserve water. The goal is to produce healthy food for today's population without compromising the ability of future generations to do the same.", correct_answer: "Sustainable agriculture balances present needs with future resources.", distractors: ["Sustainable agriculture avoids harsh chemicals.", "All farming should be sustainable."].

**14. \`paragraph_completion\`**:
- **Objective**: Test logical flow and coherence.
- **Strategy**: The correct answer should logically follow from the preceding sentences. Distractors might be contradictory, irrelevant, or introduce a new topic abruptly.
- **High-Quality Example** (for "innovative"): paragraph_body: "The company's research team spent two years developing the new material. It's lighter, stronger, and more flexible than anything on the market. This breakthrough has already attracted interest from the aerospace and automotive industries...", correct_conclusion: "Consequently, the company is poised to become a leader in the field.", distractors: ["However, the team was disappointed with the results.", "The company also produces office furniture."].

**15. \`argument_strengthening\`**:
- **Objective**: Test critical thinking and the ability to evaluate evidence.
- **Strategy**: The correct answer provides a new piece of information or a logical reason that directly supports the argument's conclusion.
- **High-Quality Example** (for "mandatory"): argument_text: "The city council argues that bicycle helmets should be mandatory for all riders to reduce head injuries.", correct_evidence: "A recent study in a similar city showed a 40% decrease in serious head injuries after they implemented a mandatory helmet law.", distractors: ["Bicycle helmets can be expensive for some residents.", "Many cyclists enjoy the feeling of riding without a helmet."].

**16. \`argument_weakening\`**:
- **Objective**: Test the ability to identify flaws or counter-evidence.
- **Strategy**: The correct answer should expose a flaw in the argument's logic or provide evidence that contradicts its conclusion.
- **High-Quality Example** (for "censorship"): argument_text: "The activist group argues that censoring certain online content is necessary to protect children from harmful material.", correct_weakener: "Studies have shown that such censorship often leads to a 'Streisand effect,' where the banned content becomes even more popular and widely distributed.", distractors: ["Protecting children is a very important goal."].

**17. \`tone_purpose_analysis\`**:
- **Objective**: Test the ability to discern an author's attitude or intent.
- **Strategy**: Distractors should be plausible but less accurate descriptions of the tone (e.g., 'objective' vs. 'cautious', 'enthusiastic' vs. 'biased').
- **High-Quality Example** (for "skeptical"): paragraph: "While the new 'super-juice' is marketed as a miracle cure, its health claims are based on a single, small-scale study funded by its own parent company. Independent researchers have not yet replicated these extraordinary findings.", question: "The author's tone is best described as...", correct_answer: "skeptical and cautionary", distractors: ["enthusiastic and supportive", "objective and informative"].

**18. \`sentence_role_analysis\`**:
- **Objective**: Test understanding of how sentences function within a larger argument.
- **Strategy**: The correct answer accurately describes the logical function of one sentence in relation to another. Distractors can describe the roles of other sentences in the paragraph.
- **High-Quality Example** (for "illustrate"): paragraph: "[1] Many animals have developed incredible methods of camouflage. [2] For instance, the stick insect is almost indistinguishable from a twig, which helps it avoid predators.", "highlighted_sentence_index": 1, "correct_role": "To provide a specific example that illustrates the claim made in sentence 1.", "distractors": ["To state the main idea of the paragraph.", "To contradict the claim made in sentence 1."].

---
**FINAL INSTRUCTIONS**
- **Proficiency Level**: All generated content must be strictly aligned with the **${cefrLevel}** level.
- **Format**: Return only a valid JSON array.
- **Begin!**
`;
        }


        async function callGeminiAPI(prompt, model) {
            const apiKey = DOM.geminiApiKeyInput.value.trim();
            if (!apiKey) throw new Error("Vui lòng nhập Google Gemini API Key.");
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`Lỗi API Gemini: ${errorBody.error.message}`);
            }
            const result = await response.json();
            const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!responseText) throw new Error("Cấu trúc phản hồi API không hợp lệ.");
            try {
                return JSON.parse(responseText);
            } catch (e) {
                console.error("Lỗi parse JSON từ API:", responseText);
                throw new Error("Kết quả trả về từ AI không phải là JSON hợp lệ.");
            }
        }

        function processAiResults(aiDataArray) {
            if (!Array.isArray(aiDataArray)) throw new Error("Kết quả AI không phải là một mảng.");
            
            aiDataArray.forEach(enrichedData => {
                const wordToUpdate = localWordList.find(w => w.id === enrichedData.id);
                if (wordToUpdate) {
                    wordToUpdate.generated_tasks = enrichedData.generated_tasks || null;
                    wordToUpdate.isEnriched = true;
                }
            });
            renderTable();
        }

        // --- FIREBASE & AUTHENTICATION ---
        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            if (!testId || !title || localWordList.length === 0) {
                return showAlert("Vui lòng nhập ID, Tiêu đề và xử lý dữ liệu.", 'error');
            }
            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang lưu...';
            try {
                await setDoc(doc(db, "vocab_sets", testId), { 
                    title, 
                    wordList: localWordList, 
                    updatedAt: serverTimestamp() 
                }, { merge: true });
                DOM.uploadLog.textContent = 'Lưu THÀNH CÔNG!';
                setTimeout(() => { DOM.uploadLog.textContent = ''; }, 3000);
            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }

        async function loadAndPopulateTestData(testId) {
            showAlert("Đang tải dữ liệu đề thi...");
            const docRef = doc(db, "vocab_sets", testId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const testData = docSnap.data();
                    
                    DOM.pageTitle.textContent = "Chỉnh sửa Bộ từ vựng";
                    DOM.testIdInput.value = testId;
                    DOM.testIdInput.disabled = true;
                    DOM.testTitleInput.value = testData.title || "";
                    
                    localWordList = testData.wordList || [];
                    
                    localWordList.forEach(word => {
                        if (!word.generated_tasks) word.generated_tasks = null;
                        if (!word.structures) word.structures = [];
                    });

                    renderTable();
                    DOM.dataReviewSection.classList.remove('hidden');
                    
                    DOM.uploadBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cập nhật Bộ Từ Vựng';
                    
                    const uploadSection = DOM.processFilesBtn.closest('.glass-panel');
                    uploadSection.style.opacity = '0.5';
                    uploadSection.style.pointerEvents = 'none';
                    uploadSection.title = 'Không thể nhập file CSV khi đang chỉnh sửa.';

                    DOM.alertModal.classList.remove('is-open');

                } else {
                    showAlert(`Lỗi: Không tìm thấy bộ từ vựng với ID: ${testId}`, 'error');
                }
            } catch (error) {
                showAlert(`Lỗi khi tải dữ liệu: ${error.message}`, 'error');
                console.error("Error loading test data:", error);
            }
        }
        
        function exportToWord() {
            if (localWordList.length === 0) {
                return showAlert("Không có dữ liệu để xuất.", 'error');
            }

            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
            const docChildren = [];
            const charOpts = ['A', 'B', 'C', 'D', 'E', 'F'];

            docChildren.push(new Paragraph({
                text: DOM.testTitleInput.value || "Vocabulary Test",
                heading: HeadingLevel.TITLE,
                alignment: 'center',
            }));

            localWordList.forEach((wordData, index) => {
                if (!wordData.generated_tasks) return;

                docChildren.push(new Paragraph({
                    children: [
                        new TextRun({ text: `${index + 1}. ${wordData.word}`, bold: true, size: 28 }),
                        new TextRun({ text: `    ${wordData.pronunciation}`, italics: true, size: 24 })
                    ],
                    spacing: { before: 400, after: 200 },
                }));

                const tasks = wordData.generated_tasks;
                
                const createMCQ = (title, question, correctAnswer, distractors) => {
                    if(!question || !correctAnswer || !distractors || distractors.length < 1) return;
                    docChildren.push(new Paragraph({ text: title, bold: true, spacing: { before: 200 } }));
                    docChildren.push(new Paragraph({ text: question, italics: true }));
                    const options = [correctAnswer, ...distractors].sort(() => Math.random() - 0.5);
                    options.forEach((opt, i) => {
                        docChildren.push(new Paragraph({ text: `${charOpts[i]}. ${opt}` }));
                    });
                    docChildren.push(new Paragraph({ text: " " }));
                };
                
                const createTextInput = (title, question) => {
                    if(!question) return;
                    docChildren.push(new Paragraph({ text: title, bold: true, spacing: { before: 200 } }));
                    docChildren.push(new Paragraph({ text: question, italics: true }));
                    docChildren.push(new Paragraph("Answer: __________________________________________________"));
                    docChildren.push(new Paragraph({ text: " " }));
                };
                
                if(tasks.meaning_mcq) createMCQ('Meaning MCQ (English)', `What is the meaning of "${wordData.word}"?`, wordData.meaning, tasks.meaning_mcq.distractors_vi);
                if(tasks.word_family_mcq) createMCQ('Word Family', tasks.word_family_mcq.sentence.replace(tasks.word_family_mcq.blank_placeholder, '______'), tasks.word_family_mcq.correct_answer, tasks.word_family_mcq.distractors);
                if(tasks.antonym_mcq) createMCQ('Antonym', tasks.antonym_mcq.sentence_context, tasks.antonym_mcq.correct_antonym, tasks.antonym_mcq.distractors);
                if(tasks.error_correction) createTextInput('Error Correction', `Correct the sentence: "${tasks.error_correction.incorrect_sentence}"`);
                if(tasks.sentence_unscramble) createTextInput('Sentence Unscramble', `Unscramble the words to form a correct sentence: "${tasks.sentence_unscramble.correct_sentence.split(' ').sort(() => Math.random() - 0.5).join(' / ')}"`);
                if(tasks.best_fit_replacement) createMCQ('Best-fit Replacement', tasks.best_fit_replacement.sentence, tasks.best_fit_replacement.correct_answer, tasks.best_fit_replacement.distractors);
                if(tasks.main_idea) createMCQ(`Main Idea of the Passage`, tasks.main_idea.paragraph, tasks.main_idea.correct_answer, tasks.main_idea.distractors);
                if(tasks.paragraph_completion) createMCQ(`Find the Conclusion`, tasks.paragraph_completion.paragraph_body, tasks.paragraph_completion.correct_conclusion, tasks.paragraph_completion.distractors);
                if(tasks.argument_strengthening) createMCQ(`Strengthen the Argument`, tasks.argument_strengthening.argument_text, tasks.argument_strengthening.correct_evidence, tasks.argument_strengthening.distractors);
                if(tasks.argument_weakening) createMCQ(`Weaken the Argument`, tasks.argument_weakening.argument_text, tasks.argument_weakening.correct_weakener, tasks.argument_weakening.distractors);
                if(tasks.tone_purpose_analysis) createMCQ(tasks.tone_purpose_analysis.question, tasks.tone_purpose_analysis.paragraph, tasks.tone_purpose_analysis.correct_answer, tasks.tone_purpose_analysis.distractors);
            });

            const doc = new Document({
                sections: [{ properties: {}, children: docChildren }],
            });

            Packer.toBlob(doc).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${DOM.testIdInput.value || 'vocabulary-test'}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showAlert("File Word đã được tạo và tải xuống!", 'success');
            });
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    DOM.loginScreen.classList.remove('is-open');
                    DOM.mainContent.style.display = 'block';
                    initializePage();
                } else {
                    DOM.loginScreen.classList.add('is-open');
                    DOM.mainContent.style.display = 'none';
                }
            });

            DOM.loginBtn.addEventListener('click', async () => {
                DOM.loginError.textContent = '';
                try { 
                    await signInWithEmailAndPassword(auth, DOM.emailInput.value, DOM.passwordInput.value); 
                } catch (e) { 
                    DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.'; 
                }
            });

            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);

            const handleFileUpload = (event, type) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (type === 'vocab') { 
                        vocabCsvText = e.target.result; 
                        DOM.vocabFileNameDisplay.textContent = file.name; 
                    } else { 
                        structuresCsvText = e.target.result; 
                        DOM.structuresFileNameDisplay.textContent = file.name; 
                    }
                };
                reader.readAsText(file);
            };

            DOM.vocabCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'vocab'));
            DOM.structuresCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'structures'));
            
            DOM.processFilesBtn.addEventListener('click', () => {
                if (!vocabCsvText) return showAlert("Vui lòng tải lên file CSV từ vựng.", 'error');
                parseAndStructureCSV(vocabCsvText, structuresCsvText || '');
                renderTable();
                DOM.dataReviewSection.classList.remove('hidden');
            });

            DOM.darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark');
                const dot = DOM.darkModeToggle.nextElementSibling.nextElementSibling;
                dot.style.transform = DOM.darkModeToggle.checked ? 'translateX(100%)' : 'translateX(0)';
            });
            
            DOM.cefrSlider.addEventListener('input', () => DOM.cefrDisplay.textContent = getCefrLevelDescription());
            
            DOM.fetchAudioBtn.addEventListener('click', async () => {
                if (localWordList.length === 0) return showAlert("Chưa có dữ liệu.", 'error');
                const button = DOM.fetchAudioBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                for (let i = 0; i < localWordList.length; i++) {
                    const wordData = localWordList[i];
                    updateButtonState(button, true, '', `Đang tìm... (${i + 1}/${localWordList.length})`);
                    if (wordData.audioUrl || !wordData.word) continue;
                    try {
                        const response = await fetch(`${CLOUD_FUNCTION_URL}?word=${encodeURIComponent(wordData.word)}`);
                        if (!response.ok) throw new Error(`Server error`);
                        const result = await response.json();
                        if (result.success) wordData.audioUrl = result.audioUrl;
                    } catch (error) { console.error(`Lỗi với từ '${wordData.word}':`, error); }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                renderTable();
                updateButtonState(button, false, originalHTML);
            });

            DOM.enrichAiBtn.addEventListener('click', async () => {
                const wordsToEnrich = localWordList.filter(w => !w.isEnriched);
                if (wordsToEnrich.length === 0) return showAlert("Tất cả các từ đã được làm giàu.", 'success');
                const button = DOM.enrichAiBtn;
                const originalHTML = button.innerHTML;
                updateButtonState(button, true, originalHTML);
                try {
                    for (let i = 0; i < wordsToEnrich.length; i += AI_BATCH_SIZE) {
                        const batch = wordsToEnrich.slice(i, i + AI_BATCH_SIZE);
                        updateButtonState(button, true, '', `Đang xử lý... (${i + batch.length}/${wordsToEnrich.length})`);
                        const prompt = getPromptForBatch(batch);
                        const model = DOM.aiModelSelect.value;
                        const results = await callGeminiAPI(prompt, model);
                        processAiResults(results);
                    }
                    showAlert("Làm giàu dữ liệu bằng AI thành công!", 'success');
                } catch (error) {
                    showAlert(`Lỗi khi làm giàu dữ liệu: ${error.message}`, 'error');
                } finally {
                    updateButtonState(button, false, originalHTML);
                }
            });

            DOM.exportWordBtn.addEventListener('click', exportToWord);

            DOM.manualEnrichBtn.addEventListener('click', () => {
                const wordsToEnrich = localWordList.filter(w => !w.isEnriched);
                if (wordsToEnrich.length === 0) return showAlert("Tất cả các từ đã được làm giàu.", 'success');
                DOM.manualPromptOutput.value = getPromptForBatch(wordsToEnrich);
                DOM.manualPromptInput.value = '';
                DOM.manualPromptModal.classList.add('is-open');
            });
            DOM.closeManualModalBtn.addEventListener('click', () => DOM.manualPromptModal.classList.remove('is-open'));
            DOM.copyPromptBtn.addEventListener('click', () => {
                DOM.manualPromptOutput.select();
                document.execCommand('copy');
                showAlert("Đã sao chép Prompt!", 'success');
            });
            DOM.processManualResultBtn.addEventListener('click', () => {
                try {
                    const jsonText = DOM.manualPromptInput.value.trim().replace(/^```json\s*|```\s*$/g, '');
                    if (!jsonText) throw new Error("Vui lòng dán kết quả JSON.");
                    const results = JSON.parse(jsonText);
                    processAiResults(results);
                    DOM.manualPromptModal.classList.remove('is-open');
                    showAlert("Cập nhật thủ công thành công!", 'success');
                } catch (error) {
                    showAlert(`Lỗi xử lý JSON: ${error.message}`, 'error');
                }
            });
            
            DOM.dataTableBody.addEventListener('blur', (e) => {
                const target = e.target;
                if (target.hasAttribute('contenteditable')) {
                    const wordIndex = parseInt(target.dataset.wordIndex, 10);
                    const path = target.dataset.path;
                    const newText = target.textContent;
                    if (isNaN(wordIndex) || !localWordList[wordIndex] || !path) return;
                    updateNestedObject(localWordList[wordIndex], path, newText);
                }
            }, true);
        }
        
        // --- PAGE INITIALIZATION ---
        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const testIdToEdit = urlParams.get('edit');

            if (testIdToEdit) {
                await loadAndPopulateTestData(testIdToEdit);
            } else {
                DOM.pageTitle.textContent = "Trình Soạn Thảo Bộ Từ Vựng";
                DOM.uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng';
            }
        }

        // Start the application
        DOM.cefrDisplay.textContent = getCefrLevelDescription();
        setupEventListeners();

    </script>
</body>
</html>
