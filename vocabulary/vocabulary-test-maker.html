<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Soạn Thảo Bộ Từ Vựng Chuyên Nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blur-intensity: 12px; --saturation-intensity: 150%; --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6); --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9; --text-primary: #0f172a; --text-secondary: #475569;
            --app-bg-start: #f5f7ff; --app-bg-end: #e0e7ff;
        }
        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45); --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25); --primary-accent: #a78bfa; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --app-bg-start: #0f172a; --app-bg-end: #1e293b;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--app-bg-start); background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%); color: var(--text-primary); }
        body.dark h1, body.dark h2, body.dark label, body.dark p, body.dark input, body.dark textarea, body.dark select { color: var(--text-primary); }
        body.dark .text-gray-700 { color: var(--text-primary) !important; }
        body.dark #dark-mode-label .fa-moon { color: var(--primary-accent); } #dark-mode-label .fa-sun { color: #f59e0b; }
        .background-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .shape { position: absolute; border-radius: 50%; filter: blur(25px); opacity: 0.6; animation: float 30s infinite alternate ease-in-out; }
        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation-duration: 35s; }
        @keyframes float { from { transform: translateY(20px) scale(1); } to { transform: translateY(-20px) scale(1.05); } }
        .glass-panel { background: var(--glass-bg-color); backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity)); border-radius: 24px; border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none !important; }
        .btn-primary { background: var(--primary-accent); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.4); color: var(--text-primary); border: 1px solid rgba(255, 255, 255, 0.6); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        .btn-danger { background: #ef4444; color: white; }
        .input-field { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); width: 100%; padding: 12px; border-radius: 12px; }
        .input-field:disabled { background-color: rgba(229, 231, 235, 0.5); cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal.is-open { display: flex; }
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #data-table th { position: sticky; top: 0; background-color: rgba(255,255,255,0.6); backdrop-filter: blur(5px); z-index: 10; }
        body.dark #data-table th { background-color: rgba(29, 39, 58, 0.6); }
        [contenteditable]:focus { outline: 2px solid var(--primary-accent); background-color: rgba(255, 255, 255, 0.7); border-radius: 4px; }
        .sentence-template-display {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 8px;
            font-family: monospace;
            color: var(--text-primary);
        }
        .sentence-template-display .blank-word {
            background-color: var(--primary-accent);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="background-shapes"><div class="shape shape1"></div><div class="shape shape2"></div></div>

    <div id="login-screen" class="modal is-open">
        <div class="glass-panel p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">Đăng nhập</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email-input" class="input-field"></div>
                <div><label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label><input type="password" id="password-input" class="input-field"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">Đăng nhập</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-screen-2xl mx-auto" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <h1 id="page-title" class="text-4xl font-bold">Trình Soạn Thảo Bộ Từ Vựng</h1>
            <div class="flex items-center gap-4">
                <label id="dark-mode-label" class="flex items-center cursor-pointer text-slate-500">
                    <i class="fas fa-moon mr-2"></i>
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <i class="fas fa-sun ml-2"></i>
                </label>
                <button id="logout-btn" class="btn btn-danger">Đăng xuất</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <aside class="lg:col-span-2 space-y-8">
                <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Thông tin chung</h2>
                    <div class="space-y-4">
                        <div><label for="test-id" class="block text-sm font-medium">Mã định danh (ID)</label><input type="text" id="test-id" class="input-field" placeholder="vd: unit_1_family"></div>
                        <div><label for="test-title" class="block text-sm font-medium">Tiêu đề bộ từ vựng</label><input type="text" id="test-title" class="input-field" placeholder="vd: Unit 1: Family Life"></div>
                    </div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Nhập liệu & Cài đặt</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                             <label class="block text-sm font-medium mb-1">File Từ vựng (.csv)</label>
                             <label for="vocab-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                             <input type="file" id="vocab-csv-upload" class="hidden" accept=".csv">
                             <p id="vocab-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                         </div>
                         <div>
                             <label class="block text-sm font-medium mb-1">File Cấu trúc (.csv)</label>
                             <label for="structures-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>Tải lên</label>
                             <input type="file" id="structures-csv-upload" class="hidden" accept=".csv">
                             <p id="structures-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                         </div>
                    </div>
                    <div class="mt-6">
                        <label for="cefr-level-slider" class="block text-sm font-medium mb-1">Trình độ (CEFR)</label>
                        <input type="range" id="cefr-level-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <div class="flex justify-between text-xs mt-1"><span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span></div>
                        <p id="cefr-level-display" class="text-center font-semibold mt-2"></p>
                    </div>
                    <div class="text-center mt-6"><button id="process-files-btn" class="btn btn-primary">Xử lý Dữ liệu</button></div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Cấu hình AI</h2>
                    <div class="space-y-4">
                        <div><label for="gemini-api-key" class="block text-sm font-medium">Google Gemini API Key</label><input type="password" id="gemini-api-key" class="input-field" placeholder="Dán API Key của bạn..."></div>
                        <div>
                            <label for="ai-model-select" class="block text-sm font-medium text-gray-700 mb-1">Mô hình Gemini</label>
                            <select id="ai-model-select" class="input-field w-full">
                                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Nhanh & Tiết kiệm)</option>
                                <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Chất lượng cao)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-3 space-y-8">
                <div id="data-review-section" class="glass-panel p-6 hidden">
                     <h2 class="text-2xl font-bold text-gray-700 mb-4">4. Bảng dữ liệu & Làm giàu</h2>
                    <div id="table-container" class="max-h-[80vh] overflow-auto rounded-lg border border-white/50">
                        <table id="data-table" class="w-full text-sm">
                            <thead>
                                <tr class="text-left">
                                    <th class="p-3">Từ vựng</th>
                                    <th class="p-3">Ví dụ & Đục lỗ theo Ngữ cảnh</th>
                                    <th class="p-3">Nhiễu chung (Hỏi nghĩa)</th>
                                    <th class="p-3 text-center">AI</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 text-center flex flex-wrap justify-center gap-4">
                        <button id="fetch-audio-btn" class="btn btn-secondary"><i class="fas fa-volume-up mr-2"></i>Tìm Audio</button>
                        <button id="enrich-ai-btn" class="btn btn-secondary"><i class="fas fa-wand-magic-sparkles mr-2"></i>Làm giàu Tự động</button>
                        <button id="manual-enrich-btn" class="btn btn-secondary"><i class="fas fa-paste mr-2"></i>Làm giàu Thủ công</button>
                    </div>
                </div>
                <div class="text-center"><button id="upload-btn" class="btn btn-primary text-lg w-full"><i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng</button><p id="upload-log" class="font-semibold mt-2 h-5"></p></div>
            </main>
        </div>
    </div>
    
    <div id="custom-alert-modal" class="modal"></div>
    <div id="manual-prompt-modal" class="modal">
        <div class="glass-panel p-8 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Làm giàu dữ liệu thủ công</h2>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">Bước 1: Sao chép Prompt này</label>
                    <textarea id="manual-prompt-output" readonly class="input-field flex-grow font-mono text-xs"></textarea>
                    <button id="copy-prompt-btn" class="btn btn-primary mt-2">Sao chép Prompt</button>
                </div>
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">Bước 2: Dán kết quả JSON từ Gemini vào đây</label>
                    <textarea id="manual-prompt-input" class="input-field flex-grow font-mono text-xs" placeholder="Dán kết quả JSON tại đây..."></textarea>
                    <button id="process-manual-result-btn" class="btn btn-primary mt-2">Cập nhật dữ liệu</button>
                </div>
            </div>
            <button id="close-manual-modal-btn" class="btn btn-danger mt-6 mx-auto">Đóng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.firebasestorage.app",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        const CLOUD_FUNCTION_URL = "https://getoaldaudio-asjwauz37q-uc.a.run.app";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let localWordList = [], vocabCsvText = '', structuresCsvText = '';

        const DOM = {
            loginScreen: document.getElementById('login-screen'), mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'), passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'), testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'), dataReviewSection: document.getElementById('data-review-section'),
            dataTableBody: document.getElementById('data-table-body'), fetchAudioBtn: document.getElementById('fetch-audio-btn'),
            enrichAiBtn: document.getElementById('enrich-ai-btn'), manualEnrichBtn: document.getElementById('manual-enrich-btn'),
            uploadBtn: document.getElementById('upload-btn'), uploadLog: document.getElementById('upload-log'),
            alertModal: document.getElementById('custom-alert-modal'), 
            vocabCsvUploadInput: document.getElementById('vocab-csv-upload'), vocabFileNameDisplay: document.getElementById('vocab-file-name'),
            structuresCsvUploadInput: document.getElementById('structures-csv-upload'), structuresFileNameDisplay: document.getElementById('structures-file-name'),
            processFilesBtn: document.getElementById('process-files-btn'), darkModeToggle: document.getElementById('dark-mode-toggle'),
            cefrSlider: document.getElementById('cefr-level-slider'), cefrDisplay: document.getElementById('cefr-level-display'),
            geminiApiKeyInput: document.getElementById('gemini-api-key'), aiModelSelect: document.getElementById('ai-model-select'),
            manualPromptModal: document.getElementById('manual-prompt-modal'), manualPromptOutput: document.getElementById('manual-prompt-output'),
            manualPromptInput: document.getElementById('manual-prompt-input'), copyPromptBtn: document.getElementById('copy-prompt-btn'),
            processManualResultBtn: document.getElementById('process-manual-result-btn'), closeManualModalBtn: document.getElementById('close-manual-modal-btn'),
            pageTitle: document.getElementById('page-title'),
        };

        function showAlert(message) {
            DOM.alertModal.innerHTML = `<div class="glass-panel text-center p-8 rounded-lg"><p class="text-lg mb-6">${message}</p><button id="alert-ok-btn" class="btn btn-primary">OK</button></div>`;
            DOM.alertModal.classList.add('is-open');
            document.getElementById('alert-ok-btn').onclick = () => DOM.alertModal.classList.remove('is-open');
        }

        // NÂNG CẤP: Cấu trúc dữ liệu mới
        function parseAndStructureCSV(vocabText, structuresText) {
            const vocabRows = vocabText.trim().split(/\r?\n/);
            const vocab = vocabRows.map((row, index) => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 4 && columns[0]) {
                    // Cấu trúc khởi tạo mới
                    return { 
                        id: index + 1, 
                        word: columns[0], 
                        type: columns[1], 
                        pronunciation: columns[2], 
                        meaning: columns[3], 
                        audioUrl: '', 
                        isEnriched: false,
                        // Dữ liệu mới sẽ được AI điền vào
                        general_distractors: { en: [], vi: [] },
                        contextual_examples: []
                    };
                }
                return null;
            }).filter(Boolean);
            
            // Phần xử lý structures có thể giữ lại nếu cần tham chiếu, nhưng không trực tiếp gán vào word nữa
            // Hoặc có thể truyền vào prompt để AI có thêm ngữ cảnh
            localWordList = vocab;
        }

        // NÂNG CẤP: Render bảng với cấu trúc dữ liệu mới
        function renderTable() {
            DOM.dataTableBody.innerHTML = '';
            localWordList.forEach((word, wordIndex) => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-slate-700 align-top';

                const audioIconHTML = word.audioUrl ? `<a href="${word.audioUrl}" target="_blank" title="Nghe"><i class="fas fa-volume-up ml-2 text-blue-500"></i></a>` : '';
                
                // Hiển thị thông tin từ vựng cơ bản
                const wordInfoHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            <p class="font-bold text-base" contenteditable="true" data-path="word" data-word-index="${wordIndex}">${word.word}</p>
                            ${audioIconHTML}
                        </div>
                        <p class="font-mono text-sm text-violet-700 dark:text-violet-400" contenteditable="true" data-path="pronunciation" data-word-index="${wordIndex}">${word.pronunciation}</p>
                        <p class="text-xs text-slate-500">(${word.type})</p>
                        <p class="mt-2 text-sm" contenteditable="true" data-path="meaning" data-word-index="${wordIndex}">${word.meaning}</p>
                    </td>`;

                // Hiển thị các ví dụ ngữ cảnh và chỗ đục lỗ
                const contextualExamplesHTML = (word.contextual_examples || []).map((ex, exIndex) => {
                    const sentenceHTML = ex.sentence_template.replace(/\{\{(.*?)\}\}/g, '<span class="blank-word">$1</span>');
                    const blanksHTML = (ex.blanks || []).map((blank, blankIndex) => `
                        <div class="ml-4 mt-2">
                            <p class="font-semibold text-sky-700 dark:text-sky-300">Lỗ trống cho: <span class="font-bold text-sky-500">${blank.target_word}</span></p>
                            <ul class="list-disc list-inside text-xs">
                                ${blank.distractors.map((d, dIndex) => `<li contenteditable="true" data-path="contextual_examples[${exIndex}].blanks[${blankIndex}].distractors[${dIndex}]" data-word-index="${wordIndex}">${d}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('');
                    return `<div class="p-2 my-2 bg-green-100 dark:bg-emerald-900/50 rounded-md">
                                <p class="sentence-template-display">${sentenceHTML}</p>
                                ${blanksHTML}
                            </div>`;
                }).join('');

                // Hiển thị bộ từ gây nhiễu chung
                const generalDistractorsHTML = `
                    <div class="text-xs">
                        <p class="font-semibold">EN:</p>
                        <ul class="list-disc list-inside">
                            ${(word.general_distractors.en || []).map((d, dIndex) => `<li contenteditable="true" data-path="general_distractors.en[${dIndex}]" data-word-index="${wordIndex}">${d}</li>`).join('')}
                        </ul>
                        <p class="font-semibold mt-1">VI:</p>
                        <ul class="list-disc list-inside">
                            ${(word.general_distractors.vi || []).map((d, dIndex) => `<li contenteditable="true" data-path="general_distractors.vi[${dIndex}]" data-word-index="${wordIndex}">${d}</li>`).join('')}
                        </ul>
                    </div>
                `;

                row.innerHTML = `
                    ${wordInfoHTML}
                    <td class="p-3 text-xs">${contextualExamplesHTML || '<span class="text-gray-400">Chưa có</span>'}</td>
                    <td class="p-3">${generalDistractorsHTML}</td>
                    <td class="p-3 text-center">${word.isEnriched ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>' : '<i class="fas fa-hourglass-half text-2xl text-gray-400"></i>'}</td>
                `;
                DOM.dataTableBody.appendChild(row);
            });
        }
        
        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            if (!testId || !title || localWordList.length === 0) return showAlert("Vui lòng nhập ID, Tiêu đề và xử lý dữ liệu.");
            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'Đang lưu...';
            try {
                await setDoc(doc(db, "vocab_sets", testId), { title, wordList: localWordList, updatedAt: serverTimestamp() }, { merge: true });
                DOM.uploadLog.textContent = 'Lưu THÀNH CÔNG!';
                setTimeout(() => { DOM.uploadLog.textContent = ''; }, 3000);
            } catch (error) {
                DOM.uploadLog.textContent = `LỖI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }
        
        const handleFileUpload = (event, type) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'vocab') { vocabCsvText = e.target.result; DOM.vocabFileNameDisplay.textContent = file.name; } 
                else { structuresCsvText = e.target.result; DOM.structuresFileNameDisplay.textContent = file.name; }
            };
            reader.readAsText(file);
        };

        function getCefrLevelDescription() {
            const value = parseInt(DOM.cefrSlider.value, 10);
            if (value <= 10) return "A1"; if (value <= 30) return "A2"; if (value <= 50) return "B1";
            if (value <= 70) return "B2"; if (value <= 90) return "C1"; return "C2";
        }

        async function callGeminiAPI(prompt, model) {
            const apiKey = DOM.geminiApiKeyInput.value.trim();
            if (!apiKey) throw new Error("Vui lòng nhập Google Gemini API Key.");
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`Lỗi API Gemini: ${errorBody.error.message}`);
            }
            const result = await response.json();
            const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!responseText) throw new Error("Cấu trúc phản hồi API không hợp lệ.");
            // Thêm try-catch để debug lỗi parse JSON từ AI
            try {
                return JSON.parse(responseText);
            } catch (e) {
                console.error("Lỗi parse JSON từ API:", responseText);
                throw new Error("Kết quả trả về từ AI không phải là JSON hợp lệ.");
            }
        }

        // NÂNG CẤP: Prompt hoàn toàn mới
        function getPromptForBatch(batch) {
            const cefrLevel = getCefrLevelDescription();
            const batchInput = batch.map(wordData => ({
                id: wordData.id,
                word: wordData.word,
                type: wordData.type,
                meaning: wordData.meaning
            }));

            return `
Bạn là một chuyên gia khảo thí ngôn ngữ (Language Assessment Expert) với 10 năm kinh nghiệm ra đề thi tiếng Anh.
Nhiệm vụ của bạn là làm giàu dữ liệu từ vựng để tạo ra hai loại câu hỏi trắc nghiệm: (1) điền từ vào ngữ cảnh (đục lỗ) và (2) hỏi nghĩa của từ.

Đầu vào: ${JSON.stringify(batchInput)}

## YÊU CẦU CHUNG
Với MỖI object trong mảng đầu vào, hãy tạo một object mới trong mảng JSON kết quả.
Toàn bộ nội dung phải phù hợp với trình độ ${cefrLevel}.
Mỗi object kết quả phải có cấu trúc JSON lồng nhau như sau:

{
  "id": id_gốc,
  "general_distractors": {
    "en": ["Từ gây nhiễu chung 1", "Từ 2", "Từ 3"],
    "vi": ["Nghĩa gây nhiễu chung 1", "Nghĩa 2", "Nghĩa 3"]
  },
  "contextual_examples": [
    {
      "sentence_template": "Câu ví dụ 1, với các từ có thể đục lỗ được đánh dấu bằng {{từ_đó}}.",
      "blanks": [
        {
          "target_word": "từ_đó",
          "distractors": ["Nhiễu 1 cho từ_đó", "Nhiễu 2", "Nhiễu 3"]
        }
      ]
    }
  ]
}

---

## YÊU CẦU CHI TIẾT

### 1. Về "contextual_examples" (Dữ liệu cho bài Đục lỗ):
- Tạo ra **1 đến 2** câu ví dụ tiếng Anh tự nhiên, phong phú, thể hiện rõ cách dùng của từ gốc.
- Trong mỗi câu, hãy xác định **1 đến 2** từ "đắt giá" nhất (bao gồm từ gốc và có thể cả các từ quan trọng khác) để làm bài tập điền từ.
- **Đánh dấu** các từ đó bằng cách bọc chúng trong cặp dấu ngoặc nhọn kép. Ví dụ: \`{{word}}\`.
- Với **MỖI** từ được đánh dấu, hãy tạo một object "blanks" tương ứng:
    - \`target_word\`: Chính là từ bị đục lỗ.
    - \`distractors\`: Tạo 3 từ gây nhiễu **chất lượng cao** dành riêng cho ngữ cảnh của câu đó. Các từ nhiễu phải cùng loại từ và có vẻ hợp lý (plausible) khi đặt vào chỗ trống.

**Ví dụ tư duy cho "contextual_examples":**
- Từ gốc: "effort" (n)
- Kết quả mong muốn:
  \`\`\`json
  {
    "sentence_template": "She made a real {{effort}} to {{finish}} the project on time.",
    "blanks": [
      {
        "target_word": "effort",
        "distractors": ["attempt", "trial", "impression"]
      },
      {
        "target_word": "finish",
        "distractors": ["complete", "end", "achieve"]
      }
    ]
  }
  \`\`\`

### 2. Về "general_distractors" (Dữ liệu cho bài Hỏi nghĩa):
- Tạo một bộ gây nhiễu **chung**, không phụ thuộc vào ngữ cảnh câu nào.
- \`en\`: 3 từ tiếng Anh gây nhiễu, cùng loại từ, cùng trường nghĩa nhưng không đồng nghĩa hoàn toàn.
- \`vi\`: 3 nghĩa tiếng Việt gây nhiễu, có thể là nghĩa của các từ "en" bạn vừa tạo, hoặc các nghĩa liên quan nhưng không chính xác.

---

**QUAN TRỌNG:** CHỈ trả về một mảng JSON hợp lệ, không có bất kỳ giải thích nào khác.
`;
        }

        // NÂNG CẤP: Xử lý kết quả AI với cấu trúc mới
        function processAiResults(aiDataArray) {
            if (!Array.isArray(aiDataArray)) throw new Error("Kết quả AI không phải là một mảng.");
            
            aiDataArray.forEach(enrichedData => {
                const wordToUpdate = localWordList.find(w => w.id === enrichedData.id);
                if (wordToUpdate) {
                    // Cẩn thận gán giá trị, kiểm tra null/undefined để tránh lỗi
                    wordToUpdate.general_distractors = enrichedData.general_distractors || { en: [], vi: [] };
                    wordToUpdate.contextual_examples = enrichedData.contextual_examples || [];
                    wordToUpdate.isEnriched = true;
                }
            });
            renderTable();
        }

        function setupEventListeners() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    DOM.loginScreen.classList.remove('is-open');
                    DOM.mainContent.style.display = 'block';
                    initializePage();
                } else {
                    DOM.loginScreen.classList.add('is-open');
                    DOM.mainContent.style.display = 'none';
                }
            });

            DOM.loginBtn.addEventListener('click', async () => {
                try { await signInWithEmailAndPassword(auth, DOM.emailInput.value, DOM.passwordInput.value); } 
                catch (e) { DOM.loginError.textContent = 'Email hoặc mật khẩu không đúng.'; }
            });

            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);
            DOM.vocabCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'vocab'));
            DOM.structuresCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'structures'));
            
            DOM.processFilesBtn.addEventListener('click', () => {
                if (!vocabCsvText) return showAlert("Vui lòng tải lên file CSV từ vựng.");
                // File cấu trúc giờ là tùy chọn
                parseAndStructureCSV(vocabCsvText, structuresCsvText || '');
                renderTable();
                DOM.dataReviewSection.classList.remove('hidden');
            });

            DOM.darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark');
                DOM.darkModeToggle.nextElementSibling.nextElementSibling.style.transform = DOM.darkModeToggle.checked ? 'translateX(100%)' : 'translateX(0)';
            });
            
            DOM.cefrSlider.addEventListener('input', () => DOM.cefrDisplay.textContent = getCefrLevelDescription());
            
            DOM.fetchAudioBtn.addEventListener('click', async () => {
                if (localWordList.length === 0) return showAlert("Chưa có dữ liệu.");
                const button = DOM.fetchAudioBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                for (let i = 0; i < localWordList.length; i++) {
                    const wordData = localWordList[i];
                    button.innerHTML = `<div class="loader"></div><span class="ml-2">Đang tìm... (${i + 1}/${localWordList.length})</span>`;
                    if (wordData.audioUrl || !wordData.word) continue;
                    try {
                        const response = await fetch(`${CLOUD_FUNCTION_URL}?word=${encodeURIComponent(wordData.word)}`);
                        if (!response.ok) throw new Error(`Server error`);
                        const result = await response.json();
                        if (result.success) wordData.audioUrl = result.audioUrl;
                    } catch (error) { console.error(`Lỗi với từ '${wordData.word}':`, error); }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                renderTable();
                button.disabled = false;
                button.innerHTML = originalHTML;
            });

            DOM.enrichAiBtn.addEventListener('click', async () => {
                const wordsToEnrich = localWordList.filter(w => !w.isEnriched);
                if (wordsToEnrich.length === 0) return showAlert("Tất cả các từ đã được làm giàu.");
                const button = DOM.enrichAiBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<div class="loader"></div><span class="ml-2">Đang xử lý...</span>`;
                try {
                    const BATCH_SIZE = 20; // Giảm batch size vì prompt phức tạp hơn
                    for (let i = 0; i < wordsToEnrich.length; i += BATCH_SIZE) {
                        const batch = wordsToEnrich.slice(i, i + BATCH_SIZE);
                        const prompt = getPromptForBatch(batch);
                        const model = DOM.aiModelSelect.value;
                        const results = await callGeminiAPI(prompt, model);
                        processAiResults(results);
                    }
                    showAlert("Làm giàu dữ liệu bằng AI thành công!");
                } catch (error) {
                    showAlert(`Lỗi khi làm giàu dữ liệu: ${error.message}`);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }
            });

            DOM.manualEnrichBtn.addEventListener('click', () => {
                const wordsToEnrich = localWordList.filter(w => !w.isEnriched);
                if (wordsToEnrich.length === 0) return showAlert("Tất cả các từ đã được làm giàu.");
                DOM.manualPromptOutput.value = getPromptForBatch(wordsToEnrich);
                DOM.manualPromptInput.value = '';
                DOM.manualPromptModal.classList.add('is-open');
            });
            DOM.closeManualModalBtn.addEventListener('click', () => DOM.manualPromptModal.classList.remove('is-open'));
            DOM.copyPromptBtn.addEventListener('click', () => {
                DOM.manualPromptOutput.select();
                document.execCommand('copy');
                showAlert("Đã sao chép Prompt!");
            });
            DOM.processManualResultBtn.addEventListener('click', () => {
                try {
                    const jsonText = DOM.manualPromptInput.value.trim().replace(/^```json\s*|```\s*$/g, '');
                    const results = JSON.parse(jsonText);
                    processAiResults(results);
                    DOM.manualPromptModal.classList.remove('is-open');
                    showAlert("Cập nhật thủ công thành công!");
                } catch (error) {
                    showAlert(`Lỗi xử lý JSON: ${error.message}`);
                }
            });
            
            // NÂNG CẤP: Logic chỉnh sửa dữ liệu lồng nhau
            DOM.dataTableBody.addEventListener('blur', (e) => {
                const target = e.target;
                if (target.hasAttribute('contenteditable')) {
                    const wordIndex = parseInt(target.dataset.wordIndex, 10);
                    const path = target.dataset.path;
                    const newText = target.textContent;

                    if (isNaN(wordIndex) || !localWordList[wordIndex] || !path) return;
                    
                    // Sử dụng một hàm để cập nhật giá trị trong object lồng nhau
                    function updateNestedObject(obj, path, value) {
                        const keys = path.replace(/\[(\w+)\]/g, '.$1').replace(/^\./, '').split('.');
                        let current = obj;
                        for (let i = 0; i < keys.length - 1; i++) {
                            if (current[keys[i]] === undefined) {
                                // Nếu đường dẫn không tồn tại, không làm gì cả
                                return;
                            }
                            current = current[keys[i]];
                        }
                        current[keys[keys.length - 1]] = value;
                    }
                    
                    updateNestedObject(localWordList[wordIndex], path, newText);
                }
            }, true);
        }
        
        async function loadAndPopulateTestData(testId) {
            showAlert("Đang tải dữ liệu đề thi...");
            const docRef = doc(db, "vocab_sets", testId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const testData = docSnap.data();
                    
                    DOM.pageTitle.textContent = "Chỉnh sửa Bộ từ vựng";
                    DOM.testIdInput.value = testId;
                    DOM.testIdInput.disabled = true;
                    DOM.testTitleInput.value = testData.title || "";
                    
                    localWordList = testData.wordList || [];
                    // Đảm bảo dữ liệu cũ tương thích
                    localWordList.forEach(word => {
                        if (!word.general_distractors) word.general_distractors = { en: [], vi: [] };
                        if (!word.contextual_examples) word.contextual_examples = [];
                    });

                    renderTable();
                    DOM.dataReviewSection.classList.remove('hidden');
                    
                    DOM.uploadBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cập nhật Bộ Từ Vựng';
                    
                    DOM.alertModal.classList.remove('is-open');

                } else {
                    showAlert(`Lỗi: Không tìm thấy bộ từ vựng với ID: ${testId}`);
                }
            } catch (error) {
                showAlert(`Lỗi khi tải dữ liệu: ${error.message}`);
                console.error("Error loading test data:", error);
            }
        }

        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const testIdToEdit = urlParams.get('edit');

            if (testIdToEdit) {
                await loadAndPopulateTestData(testIdToEdit);
                const uploadSection = DOM.processFilesBtn.closest('.glass-panel');
                uploadSection.style.opacity = '0.5';
                uploadSection.style.pointerEvents = 'none';
                uploadSection.title = 'Không thể nhập file CSV khi đang chỉnh sửa.';
            } else {
                DOM.pageTitle.textContent = "Trình Soạn Thảo Bộ Từ Vựng";
                DOM.uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i>Lưu Bộ Từ Vựng';
            }
        }

        DOM.cefrDisplay.textContent = getCefrLevelDescription();
        setupEventListeners();

    </script>
</body>
</html>
