<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh So·∫°n Th·∫£o B·ªô T·ª´ V·ª±ng Chuy√™n Nghi·ªáp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blur-intensity: 12px; --saturation-intensity: 150%; --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6); --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9; --text-primary: #0f172a; --text-secondary: #475569;
            --app-bg-start: #f5f7ff; --app-bg-end: #e0e7ff;
        }
        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45); --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25); --primary-accent: #a78bfa; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --app-bg-start: #0f172a; --app-bg-end: #1e293b;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--app-bg-start); background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%); color: var(--text-primary); }
        body.dark h1, body.dark h2, body.dark label, body.dark p, body.dark input, body.dark textarea, body.dark select, body.dark summary { color: var(--text-primary); }
        body.dark .text-gray-700 { color: var(--text-primary) !important; }
        body.dark #dark-mode-label .fa-moon { color: var(--primary-accent); } #dark-mode-label .fa-sun { color: #f59e0b; }
        .background-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .shape { position: absolute; border-radius: 50%; filter: blur(25px); opacity: 0.6; animation: float 30s infinite alternate ease-in-out; }
        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation-duration: 35s; }
        @keyframes float { from { transform: translateY(20px) scale(1); } to { transform: translateY(-20px) scale(1.05); } }
        .glass-panel { background: var(--glass-bg-color); backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity)); border-radius: 24px; border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none !important; }
        .btn-primary { background: var(--primary-accent); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.4); color: var(--text-primary); border: 1px solid rgba(255, 255, 255, 0.6); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        .btn-danger { background: #ef4444; color: white; }
        .input-field { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); width: 100%; padding: 12px; border-radius: 12px; }
        .input-field:disabled { background-color: rgba(229, 231, 235, 0.5); cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal.is-open { display: flex; }
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #data-table th { position: sticky; top: 0; background-color: rgba(255,255,255,0.6); backdrop-filter: blur(5px); z-index: 10; }
        body.dark #data-table th { background-color: rgba(29, 39, 58, 0.6); }
        [contenteditable]:focus { outline: 2px solid var(--primary-accent); background-color: rgba(255, 255, 255, 0.7); border-radius: 4px; }
        .task-details { border-left: 2px solid var(--primary-accent); padding-left: 12px; margin-top: 8px; }
        .task-summary { font-weight: 700; cursor: pointer; }
        .task-summary::-webkit-details-marker { display: none; }
        .task-content { font-size: 12px; margin-top: 8px; }
        .task-content .sentence { background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 6px; margin: 4px 0; }
        body.dark .task-content .sentence { background: rgba(255,255,255,0.08); }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="background-shapes"><div class="shape shape1"></div><div class="shape shape2"></div></div>

    <div id="login-screen" class="modal is-open">
        <div class="glass-panel p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">ƒêƒÉng nh·∫≠p</h2>
            <div class="space-y-4 text-left">
                <div><label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email-input" class="input-field"></div>
                <div><label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u</label><input type="password" id="password-input" class="input-field"></div>
            </div>
            <button id="login-btn" class="btn btn-primary w-full mt-6">ƒêƒÉng nh·∫≠p</button>
            <p id="login-error" class="text-red-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content" class="max-w-screen-2xl mx-auto" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <h1 id="page-title" class="text-4xl font-bold">Tr√¨nh So·∫°n Th·∫£o B·ªô T·ª´ V·ª±ng</h1>
            <div class="flex items-center gap-4">
                <label id="dark-mode-label" class="flex items-center cursor-pointer text-slate-500">
                    <i class="fas fa-moon mr-2"></i>
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <i class="fas fa-sun ml-2"></i>
                </label>
                <button id="logout-btn" class="btn btn-danger">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <aside class="lg:col-span-2 space-y-8">
                <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">1. Th√¥ng tin chung</h2>
                    <div class="space-y-4">
                        <div><label for="test-id" class="block text-sm font-medium">M√£ ƒë·ªãnh danh (ID)</label><input type="text" id="test-id" class="input-field" placeholder="vd: unit_1_family"></div>
                        <div><label for="test-title" class="block text-sm font-medium">Ti√™u ƒë·ªÅ b·ªô t·ª´ v·ª±ng</label><input type="text" id="test-title" class="input-field" placeholder="vd: Unit 1: Family Life"></div>
                    </div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">2. Nh·∫≠p li·ªáu & C√†i ƒë·∫∑t</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                             <label class="block text-sm font-medium mb-1">File T·ª´ v·ª±ng (.csv)</label>
                             <label for="vocab-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>T·∫£i l√™n</label>
                             <input type="file" id="vocab-csv-upload" class="hidden" accept=".csv">
                             <p id="vocab-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                         </div>
                         <div>
                             <label class="block text-sm font-medium mb-1">File C·∫•u tr√∫c (.csv)</label>
                             <label for="structures-csv-upload" class="btn btn-secondary w-full"><i class="fas fa-upload mr-2"></i>T·∫£i l√™n</label>
                             <input type="file" id="structures-csv-upload" class="hidden" accept=".csv">
                             <p id="structures-file-name" class="text-gray-600 mt-2 text-sm text-center"></p>
                         </div>
                    </div>
                    <div class="mt-6">
                        <label for="cefr-level-slider" class="block text-sm font-medium mb-1">Tr√¨nh ƒë·ªô (CEFR)</label>
                        <input type="range" id="cefr-level-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <div class="flex justify-between text-xs mt-1"><span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span></div>
                        <p id="cefr-level-display" class="text-center font-semibold mt-2"></p>
                    </div>
                    <div class="text-center mt-6"><button id="process-files-btn" class="btn btn-primary">X·ª≠ l√Ω D·ªØ li·ªáu</button></div>
                </div>
                 <div class="glass-panel p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">3. C·∫•u h√¨nh AI</h2>
                    <div class="space-y-4">
                        <div><label for="gemini-api-key" class="block text-sm font-medium">Google Gemini API Key</label><input type="password" id="gemini-api-key" class="input-field" placeholder="D√°n API Key c·ªßa b·∫°n..."></div>
                        <div>
                            <label for="ai-model-select" class="block text-sm font-medium text-gray-700 mb-1">M√¥ h√¨nh Gemini</label>
                            <select id="ai-model-select" class="input-field w-full">
                                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Nhanh & Ti·∫øt ki·ªám)</option>
                                <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Ch·∫•t l∆∞·ª£ng cao)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-3 space-y-8">
                <div id="data-review-section" class="glass-panel p-6 hidden">
                     <h2 class="text-2xl font-bold text-gray-700 mb-4">4. D·ªØ li·ªáu Kh·∫£o th√≠ do AI t·∫°o</h2>
                    <div id="table-container" class="max-h-[80vh] overflow-auto rounded-lg border border-white/50">
                        <table id="data-table" class="w-full text-sm">
                            <thead>
                                <tr class="text-left">
                                    <th class="p-3 w-1/4">T·ª´ v·ª±ng</th>
                                    <th class="p-3 w-3/4">C√°c G√≥i B√†i T·∫≠p</th>
                                    <th class="p-3 text-center">AI</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 text-center flex flex-wrap justify-center gap-4">
                        <button id="fetch-audio-btn" class="btn btn-secondary"><i class="fas fa-volume-up mr-2"></i>T√¨m Audio</button>
                        <button id="enrich-ai-btn" class="btn btn-secondary"><i class="fas fa-wand-magic-sparkles mr-2"></i>L√†m gi√†u T·ª± ƒë·ªông</button>
                        <button id="manual-enrich-btn" class="btn btn-secondary"><i class="fas fa-paste mr-2"></i>L√†m gi√†u Th·ªß c√¥ng</button>
                    </div>
                </div>
                <div class="text-center"><button id="upload-btn" class="btn btn-primary text-lg w-full"><i class="fas fa-cloud-upload-alt mr-2"></i>L∆∞u B·ªô T·ª´ V·ª±ng</button><p id="upload-log" class="font-semibold mt-2 h-5"></p></div>
            </main>
        </div>
    </div>
    
    <div id="custom-alert-modal" class="modal"></div>
    <div id="manual-prompt-modal" class="modal">
        <div class="glass-panel p-8 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">L√†m gi√†u d·ªØ li·ªáu th·ªß c√¥ng</h2>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">B∆∞·ªõc 1: Sao ch√©p Prompt n√†y</label>
                    <textarea id="manual-prompt-output" readonly class="input-field flex-grow font-mono text-xs"></textarea>
                    <button id="copy-prompt-btn" class="btn btn-primary mt-2">Sao ch√©p Prompt</button>
                </div>
                <div class="flex flex-col h-full">
                    <label class="font-medium mb-2">B∆∞·ªõc 2: D√°n k·∫øt qu·∫£ JSON t·ª´ Gemini v√†o ƒë√¢y</label>
                    <textarea id="manual-prompt-input" class="input-field flex-grow font-mono text-xs" placeholder="D√°n k·∫øt qu·∫£ JSON t·∫°i ƒë√¢y..."></textarea>
                    <button id="process-manual-result-btn" class="btn btn-primary mt-2">C·∫≠p nh·∫≠t d·ªØ li·ªáu</button>
                </div>
            </div>
            <button id="close-manual-modal-btn" class="btn btn-danger mt-6 mx-auto">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.firebasestorage.app",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        const CLOUD_FUNCTION_URL = "https://getoaldaudio-asjwauz37q-uc.a.run.app";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let localWordList = [], vocabCsvText = '', structuresCsvText = '';

        const DOM = {
            loginScreen: document.getElementById('login-screen'), mainContent: document.getElementById('main-content'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            emailInput: document.getElementById('email-input'), passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'), testIdInput: document.getElementById('test-id'),
            testTitleInput: document.getElementById('test-title'), dataReviewSection: document.getElementById('data-review-section'),
            dataTableBody: document.getElementById('data-table-body'), fetchAudioBtn: document.getElementById('fetch-audio-btn'),
            enrichAiBtn: document.getElementById('enrich-ai-btn'), manualEnrichBtn: document.getElementById('manual-enrich-btn'),
            uploadBtn: document.getElementById('upload-btn'), uploadLog: document.getElementById('upload-log'),
            alertModal: document.getElementById('custom-alert-modal'), 
            vocabCsvUploadInput: document.getElementById('vocab-csv-upload'), vocabFileNameDisplay: document.getElementById('vocab-file-name'),
            structuresCsvUploadInput: document.getElementById('structures-csv-upload'), structuresFileNameDisplay: document.getElementById('structures-file-name'),
            processFilesBtn: document.getElementById('process-files-btn'), darkModeToggle: document.getElementById('dark-mode-toggle'),
            cefrSlider: document.getElementById('cefr-level-slider'), cefrDisplay: document.getElementById('cefr-level-display'),
            geminiApiKeyInput: document.getElementById('gemini-api-key'), aiModelSelect: document.getElementById('ai-model-select'),
            manualPromptModal: document.getElementById('manual-prompt-modal'), manualPromptOutput: document.getElementById('manual-prompt-output'),
            manualPromptInput: document.getElementById('manual-prompt-input'), copyPromptBtn: document.getElementById('copy-prompt-btn'),
            processManualResultBtn: document.getElementById('process-manual-result-btn'), closeManualModalBtn: document.getElementById('close-manual-modal-btn'),
            pageTitle: document.getElementById('page-title'),
        };

        function showAlert(message) {
            DOM.alertModal.innerHTML = `<div class="glass-panel text-center p-8 rounded-lg"><p class="text-lg mb-6">${message}</p><button id="alert-ok-btn" class="btn btn-primary">OK</button></div>`;
            DOM.alertModal.classList.add('is-open');
            document.getElementById('alert-ok-btn').onclick = () => DOM.alertModal.classList.remove('is-open');
        }

        function parseAndStructureCSV(vocabText, structuresText) {
            const vocabRows = vocabText.trim().split(/\r?\n/).filter(Boolean);
            const vocab = vocabRows.map((row, index) => {
                const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (columns.length >= 4 && columns[0]) {
                    return { 
                        id: index + 1, 
                        word: columns[0], 
                        type: columns[1], 
                        pronunciation: columns[2], 
                        meaning: columns[3], 
                        audioUrl: '', 
                        isEnriched: false,
                        structures: [],
                        generated_tasks: null
                    };
                }
                return null;
            }).filter(Boolean);
            
            if (structuresText) {
                const structureRows = structuresText.trim().split(/\r?\n/).filter(Boolean);
                const structures = structureRows.map(row => {
                    const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));
                    if (columns.length >= 2 && columns[0]) return { phrase: columns[0], meaning: columns[1] };
                    return null;
                }).filter(Boolean);

                vocab.forEach(v => {
                    const wordLower = v.word.toLowerCase();
                    const matchRegex = new RegExp(`\\b${wordLower}(s|es|ing|ed)?\\b`, 'i');
                    v.structures = structures
                        .filter(s => matchRegex.test(s.phrase))
                        .map(s => ({...s}));
                });
            }
            
            localWordList = vocab;
        }

        function renderTable() {
            DOM.dataTableBody.innerHTML = '';
            localWordList.forEach((word, wordIndex) => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-slate-700 align-top';

                const audioIconHTML = word.audioUrl ? `<a href="${word.audioUrl}" target="_blank" title="Nghe"><i class="fas fa-volume-up ml-2 text-blue-500"></i></a>` : '';
                
                const wordInfoHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            <p class="font-bold text-base" contenteditable="true" data-path="word" data-word-index="${wordIndex}">${word.word}</p>
                            ${audioIconHTML}
                        </div>
                        <p class="font-mono text-sm text-violet-700 dark:text-violet-400" contenteditable="true" data-path="pronunciation" data-word-index="${wordIndex}">${word.pronunciation}</p>
                        <p class="text-xs text-slate-500">(${word.type})</p>
                        <p class="mt-2 text-sm" contenteditable="true" data-path="meaning" data-word-index="${wordIndex}">${word.meaning}</p>
                    </td>`;

                let tasksHTML = '<span class="text-xs text-gray-400 italic">Ch∆∞a c√≥ d·ªØ li·ªáu AI.</span>';
                const tasks = word.generated_tasks;

                if (tasks) {
                    const t = tasks; // shorthand
                    const renderTask = (taskData, title, contentRenderer) => {
                        if (!taskData) return '';
                        return `
                            <details class="mt-2">
                                <summary class="task-summary">${title}</summary>
                                <div class="task-details">
                                    ${contentRenderer(taskData)}
                                </div>
                            </details>`;
                    };

                    tasksHTML = 
                        renderTask(t.basic_example, '1. V√≠ d·ª• c∆° b·∫£n', data => `<div class="task-content"><p class="sentence" contenteditable="true" data-path="generated_tasks.basic_example" data-word-index="${wordIndex}">${data}</p></div>`) +
                        renderTask(t.meaning_mcq, '2. Tr·∫Øc nghi·ªám nghƒ©a', data => `
                            <div class="task-content">
                                <p><b>Nhi·ªÖu (EN):</b></p>
                                <ul>${(data.distractors_en || []).map((d, i) => `<li contenteditable="true" data-path="generated_tasks.meaning_mcq.distractors_en[${i}]" data-word-index="${wordIndex}">${d}</li>`).join('')}</ul>
                                <p class="mt-2"><b>Nhi·ªÖu (VI):</b></p>
                                <ul>${(data.distractors_vi || []).map((d, i) => `<li contenteditable="true" data-path="generated_tasks.meaning_mcq.distractors_vi[${i}]" data-word-index="${wordIndex}">${d}</li>`).join('')}</ul>
                            </div>`) +
                        renderTask(t.word_family_mcq, '3. Tr·∫Øc nghi·ªám H·ªç t·ª´', data => `
                            <div class="task-content">
                                <p class="sentence">${data.sentence.replace(data.blank_placeholder, `<b>[____]</b>`)}</p>
                                <p><b>ƒê√°p √°n:</b> ${data.correct_answer}</p>
                                <p><b>Nhi·ªÖu:</b></p>
                                <ul>${(data.distractors || []).map((d, i) => `<li contenteditable="true" data-path="generated_tasks.word_family_mcq.distractors[${i}]" data-word-index="${wordIndex}">${d}</li>`).join('')}</ul>
                            </div>`) +
                        renderTask(t.sentence_unscramble, '4. S·∫Øp x·∫øp c√¢u', data => `
                            <div class="task-content">
                                <p><b>C√¢u ƒë√∫ng:</b></p>
                                <p class="sentence" contenteditable="true" data-path="generated_tasks.sentence_unscramble.correct_sentence" data-word-index="${wordIndex}">${data.correct_sentence}</p>
                            </div>`) +
                        renderTask(t.error_correction, '5. S·ª≠a l·ªói sai', data => `
                             <div class="task-content">
                                <p><b>C√¢u sai:</b></p>
                                <p class="sentence" contenteditable="true" data-path="generated_tasks.error_correction.incorrect_sentence" data-word-index="${wordIndex}">${data.incorrect_sentence}</p>
                                <p class="mt-2"><b>C√¢u ƒë√∫ng:</b></p>
                                <p class="sentence" contenteditable="true" data-path="generated_tasks.error_correction.correct_sentence" data-word-index="${wordIndex}">${data.correct_sentence}</p>
                            </div>`) +
                        renderTask(t.ipa_fill, '6. ƒêi·ªÅn phi√™n √¢m', data => `
                            <div class="task-content">
                                <p><b>Phi√™n √¢m ƒë·ª•c l·ªó:</b> ${data.gapped_ipa}</p>
                                <p><b>Nguy√™n √¢m ƒë√∫ng:</b> ${data.correct_vowel}</p>
                                <p><b>Nhi·ªÖu:</b></p>
                                <ul>${(data.distractors || []).map((d, i) => `<li contenteditable="true" data-path="generated_tasks.ipa_fill.distractors[${i}]" data-word-index="${wordIndex}">${d}</li>`).join('')}</ul>
                            </div>`) +
                        renderTask(t.collocation_odd_one_out, '7. Collocation Odd-One-Out', data => `
                            <div class="task-content">
                                <p class="sentence" contenteditable="true" data-path="generated_tasks.collocation_odd_one_out.question" data-word-index="${wordIndex}">${data.question}</p>
                                <ul>${(data.options || []).map((opt, i) => `<li contenteditable="true" data-path="generated_tasks.collocation_odd_one_out.options[${i}]" data-word-index="${wordIndex}">${opt} ${opt === data.answer ? '<b>(ƒê√°p √°n)</b>' : ''}</li>`).join('')}</ul>
                            </div>`) +
                        renderTask(t.best_fit_replacement, '8. Best-fit Replacement', data => `
                            <div class="task-content">
                                <p class="sentence" contenteditable="true" data-path="generated_tasks.best_fit_replacement.sentence" data-word-index="${wordIndex}">${data.sentence.replace(data.word_to_replace, `<b><u>${data.word_to_replace}</u></b>`)}</p>
                                <ul>
                                    <li contenteditable="true" data-path="generated_tasks.best_fit_replacement.correct_answer" data-word-index="${wordIndex}">${data.correct_answer} <b>(ƒê√°p √°n)</b></li>
                                    ${(data.distractors || []).map((opt, i) => `<li contenteditable="true" data-path="generated_tasks.best_fit_replacement.distractors[${i}]" data-word-index="${wordIndex}">${opt}</li>`).join('')}
                                </ul>
                            </div>`) +
                        renderTask(t.inference_from_scenario, '9. Inference from Scenario', data => `
                            <div class="task-content">
                                <p class="sentence" contenteditable="true" data-path="generated_tasks.inference_from_scenario.scenario" data-word-index="${wordIndex}">${data.scenario}</p>
                                <p class="mt-2" contenteditable="true" data-path="generated_tasks.inference_from_scenario.question" data-word-index="${wordIndex}">${data.question}</p>
                                <ul>
                                    <li contenteditable="true" data-path="generated_tasks.inference_from_scenario.correct_answer" data-word-index="${wordIndex}">${data.correct_answer} <b>(ƒê√°p √°n)</b></li>
                                    ${(data.distractors || []).map((opt, i) => `<li contenteditable="true" data-path="generated_tasks.inference_from_scenario.distractors[${i}]" data-word-index="${wordIndex}">${opt}</li>`).join('')}
                                </ul>
                            </div>`) +
                        renderTask(t.best_paraphrase, '10. Best Paraphrase', data => `
                            <div class="task-content">
                                <p><b>C√¢u g·ªëc:</b></p>
                                <p class="sentence" contenteditable="true" data-path="generated_tasks.best_paraphrase.original_sentence" data-word-index="${wordIndex}">${data.original_sentence}</p>
                                <p class="mt-2"><b>C√°c l·ª±a ch·ªçn:</b></p>
                                <ul>${(data.options || []).map((opt, i) => `<li contenteditable="true" data-path="generated_tasks.best_paraphrase.options[${i}].text" data-word-index="${wordIndex}">${opt.text} <b>(${opt.similarity}%${opt.is_correct ? ', ƒê√°p √°n' : ''})</b></li>`).join('')}</ul>
                            </div>`);
                }

                row.innerHTML = `
                    ${wordInfoHTML}
                    <td class="p-3">${tasksHTML}</td>
                    <td class="p-3 text-center align-middle">${word.isEnriched ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>' : '<i class="fas fa-hourglass-half text-2xl text-gray-400"></i>'}</td>
                `;
                DOM.dataTableBody.appendChild(row);
            });
        }
        
        async function uploadToFirebase() {
            const testId = DOM.testIdInput.value.trim();
            const title = DOM.testTitleInput.value.trim();
            if (!testId || !title || localWordList.length === 0) return showAlert("Vui l√≤ng nh·∫≠p ID, Ti√™u ƒë·ªÅ v√† x·ª≠ l√Ω d·ªØ li·ªáu.");
            DOM.uploadBtn.disabled = true;
            DOM.uploadLog.textContent = 'ƒêang l∆∞u...';
            try {
                await setDoc(doc(db, "vocab_sets", testId), { title, wordList: localWordList, updatedAt: serverTimestamp() }, { merge: true });
                DOM.uploadLog.textContent = 'L∆∞u TH√ÄNH C√îNG!';
                setTimeout(() => { DOM.uploadLog.textContent = ''; }, 3000);
            } catch (error) {
                DOM.uploadLog.textContent = `L·ªñI: ${error.message}`;
            } finally {
                DOM.uploadBtn.disabled = false;
            }
        }
        
        const handleFileUpload = (event, type) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'vocab') { vocabCsvText = e.target.result; DOM.vocabFileNameDisplay.textContent = file.name; } 
                else { structuresCsvText = e.target.result; DOM.structuresFileNameDisplay.textContent = file.name; }
            };
            reader.readAsText(file);
        };

        function getCefrLevelDescription() {
            const value = parseInt(DOM.cefrSlider.value, 10);
            if (value <= 10) return "A1"; if (value <= 30) return "A2"; if (value <= 50) return "B1";
            if (value <= 70) return "B2"; if (value <= 90) return "C1"; return "C2";
        }

        async function callGeminiAPI(prompt, model) {
            const apiKey = DOM.geminiApiKeyInput.value.trim();
            if (!apiKey) throw new Error("Vui l√≤ng nh·∫≠p Google Gemini API Key.");
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`L·ªói API Gemini: ${errorBody.error.message}`);
            }
            const result = await response.json();
            const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!responseText) throw new Error("C·∫•u tr√∫c ph·∫£n h·ªìi API kh√¥ng h·ª£p l·ªá.");
            try {
                return JSON.parse(responseText);
            } catch (e) {
                console.error("L·ªói parse JSON t·ª´ API:", responseText);
                throw new Error("K·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ AI kh√¥ng ph·∫£i l√† JSON h·ª£p l·ªá.");
            }
        }

        function getPromptForBatch(batch) {
    const cefrLevel = getCefrLevelDescription();
    const batchInput = batch.map(wordData => ({
        id: wordData.id,
        word: wordData.word,
        type: wordData.type,
        meaning: wordData.meaning,
        pronunciation: wordData.pronunciation,
        structures: wordData.structures.map(s => s.phrase)
    }));

    // [B·∫ÆT ƒê·∫¶U PROMPT M·ªöI]
    return `
# B·ªêI C·∫¢NH & VAI TR√í
B·∫°n l√† m·ªôt chuy√™n gia thi·∫øt k·∫ø n·ªôi dung gi√°o d·ª•c v√† kh·∫£o th√≠ ng√¥n ng·ªØ Anh v·ªõi 20 nƒÉm kinh nghi·ªám, am hi·ªÉu s√¢u s·∫Øc v·ªÅ t√¢m l√Ω h·ªçc nh·∫≠n th·ª©c v√† c√°c ph∆∞∆°ng ph√°p s∆∞ ph·∫°m hi·ªán ƒë·∫°i. Nhi·ªám v·ª• c·ªßa b·∫°n kh√¥ng ch·ªâ l√† t·∫°o ra c√¢u h·ªèi, m√† l√† t·∫°o ra nh·ªØng "b√†i to√°n t∆∞ duy" (cognitive puzzles) gi√∫p ki·ªÉm tra v√† c·ªßng c·ªë ki·∫øn th·ª©c c·ªßa h·ªçc vi√™n m·ªôt c√°ch to√†n di·ªán.

# NHI·ªÜM V·ª§ T·ªîNG QU√ÅT
D·ª±a tr√™n danh s√°ch t·ª´ v·ª±ng ƒë∆∞·ª£c cung c·∫•p, h√£y t·∫°o ra m·ªôt b·ªô d·ªØ li·ªáu b√†i t·∫≠p ho√†n ch·ªânh cho M·ªñI t·ª´. M·ªói b√†i t·∫≠p ph·∫£i ƒë∆∞·ª£c thi·∫øt k·∫ø m·ªôt c√°ch th√¥ng minh, c√≥ ch·ªß ƒë√≠ch s∆∞ ph·∫°m r√µ r√†ng v√† tu√¢n th·ªß NGHI√äM NG·∫∂T c·∫•u tr√∫c JSON ƒë∆∞·ª£c y√™u c·∫ßu. To√†n b·ªô n·ªôi dung ph·∫£i ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô ${cefrLevel}.

# D·ªÆ LI·ªÜU ƒê·∫¶U V√ÄO (INPUT)
M·ªôt m·∫£ng JSON ch·ª©a c√°c ƒë·ªëi t∆∞·ª£ng t·ª´ v·ª±ng:
${JSON.stringify(batchInput, null, 2)}

# C·∫§U TR√öC ƒê·∫¶U RA (OUTPUT)
B·∫ÆT BU·ªòC tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON (a valid JSON array), v√† CH·ªà DUY NH·∫§T m·∫£ng JSON n√†y, kh√¥ng c√≥ b·∫•t k·ª≥ vƒÉn b·∫£n n√†o kh√°c (k·ªÉ c·∫£ markdown "'''json"). M·ªói ƒë·ªëi t∆∞·ª£ng trong m·∫£ng ph·∫£i c√≥ c·∫•u tr√∫c ch√≠nh x√°c nh∆∞ sau:
{
  "id": "id_g·ªëc_c·ªßa_t·ª´",
  "generated_tasks": {
    "basic_example": "...",
    "meaning_mcq": { "distractors_en": ["..."], "distractors_vi": ["..."] },
    "word_family_mcq": { "sentence": "...", "blank_placeholder": "[BLANK]", "correct_answer": "...", "distractors": ["..."] },
    "sentence_unscramble": { "correct_sentence": "..." },
    "error_correction": { "incorrect_sentence": "...", "correct_sentence": "..." },
    "ipa_fill": { "gapped_ipa": "...", "correct_vowel": "...", "distractors": ["..."] },
    "collocation_odd_one_out": { "question": "...", "options": ["...", "..."], "answer": "..." },
    "best_fit_replacement": { "sentence": "...", "word_to_replace": "...", "correct_answer": "...", "distractors": ["..."] },
    "inference_from_scenario": { "scenario": "...", "question": "...", "correct_answer": "...", "distractors": ["..."] },
    "best_paraphrase": { "original_sentence": "...", "options": [ {"text": "...", "similarity": 100, "is_correct": true}, ... ] }
  }
}

---

# üß† C√ÅC NGUY√äN T·∫ÆC V√ÄNG ƒê·ªÇ T·∫†O C√ÇU H·ªéI CH·∫§T L∆Ø·ª¢NG CAO üß†
H√£y √°p d·ª•ng 4 ph∆∞∆°ng ph√°p t∆∞ duy sau ƒë·ªÉ t·∫°o ra c√°c ph∆∞∆°ng √°n nhi·ªÖu (distractors) th·ª±c s·ª± th√°ch th·ª©c. ƒê√¢y l√† kim ch·ªâ nam cho nhi·ªám v·ª• c·ªßa b·∫°n.

## 1. Ph∆∞∆°ng ph√°p ∆Øu ti√™n: B·∫´y Logic & Ng·ªØ c·∫£nh h·∫πp (Logic & Micro-context Traps)
* **Nguy√™n t·∫Øc:** C√°c ph∆∞∆°ng √°n nhi·ªÖu ƒë·ªÅu c√≥ v·∫ª h·ª£p l√Ω n·∫øu ch·ªâ x√©t nghƒ©a chung, nh∆∞ng l·∫°i tr·ªü n√™n v√¥ l√Ω ho·∫∑c m√¢u thu·∫´n khi soi chi·∫øu v·ªõi m·ªôt T·ª™, C·ª§M T·ª™, ho·∫∑c M·ªÜNH ƒê·ªÄ c·ª• th·ªÉ trong c√¢u (ng·ªØ c·∫£nh h·∫πp). ƒê√¢y l√† ph∆∞∆°ng ph√°p ki·ªÉm tra kh·∫£ nƒÉng ƒë·ªçc hi·ªÉu s√¢u.
* **V√≠ d·ª• T·ªêT:**
    * C√¢u: "Although he is a talented pianist, his recent performance was a huge ______; the critics' reviews were overwhelmingly negative."
    * ƒê√°p √°n ƒë√∫ng: **disappointment**
    * C√°c b·∫´y t∆∞ duy:
        * `success` (M√¢u thu·∫´n logic tr·ª±c ti·∫øp v·ªõi v·∫ø "reviews were overwhelmingly negative").
        * `surprise` (C√≥ th·ªÉ ƒë√∫ng trong m·ªôt ng·ªØ c·∫£nh kh√°c, nh∆∞ng "disappointment" h·ª£p logic h∆°n v√¨ n√≥ k·∫øt n·ªëi tr·ª±c ti·∫øp ƒë·∫øn "negative reviews").
        * `achievement` (M√¢u thu·∫´n logic t∆∞∆°ng t·ª± `success`).
* **V√≠ d·ª• X·∫§U:**
    * C√¢u: "The performance was a ______."
    * C√°c ph∆∞∆°ng √°n nhi·ªÖu: `disappointment`, `cat`, `table`, `running`. (Qu√° d·ªÖ, kh√¥ng c√≥ b·∫´y logic).

## 2. B·∫´y Gi·ªõi t·ª´ & C·∫•u tr√∫c theo sau (Preposition & Structural Traps)
* **Nguy√™n t·∫Øc:** C√°c ph∆∞∆°ng √°n nhi·ªÖu l√† nh·ªØng t·ª´ c√≥ nghƒ©a t∆∞∆°ng t·ª± ƒë√°p √°n ƒë√∫ng, nh∆∞ng ch√∫ng y√™u c·∫ßu m·ªôt gi·ªõi t·ª´ ho·∫∑c m·ªôt d·∫°ng c·∫•u tr√∫c ng·ªØ ph√°p (V-ing, to-V...) kh√°c so v·ªõi c·∫•u tr√∫c ƒë∆∞·ª£c cung c·∫•p trong c√¢u.
* **V√≠ d·ª• T·ªêT:**
    * C√¢u: "The team is incapable ______ completing the project on time."
    * ƒê√°p √°n ƒë√∫ng: **of**
    * C√°c b·∫´y t∆∞ duy khi ki·ªÉm tra t·ª´ "incapable": N·∫øu c√¢u h·ªèi l√† ƒëi·ªÅn t·ª´, c√°c ph∆∞∆°ng √°n nhi·ªÖu c√≥ th·ªÉ l√†:
        * `unable` (Y√™u c·∫ßu c·∫•u tr√∫c: "unable **to complete**").
        * `difficult` (Y√™u c·∫ßu c·∫•u tr√∫c: "**It is difficult for** the team to complete...").
        * `impossible` (T∆∞∆°ng t·ª± `difficult`).
* **V√≠ d·ª• X·∫§U:**
    * C√¢u: "He is interested ______ art."
    * Ph∆∞∆°ng √°n nhi·ªÖu: `on`, `at`, `for`. (Ch·ªâ l√† c√°c gi·ªõi t·ª´ ng·∫´u nhi√™n, kh√¥ng d·ª±a tr√™n c√°c t·ª´ ƒë·ªìng nghƒ©a c√≥ c·∫•u tr√∫c kh√°c).

## 3. B·∫´y T·ª´ lo·∫°i (Word Form Traps)
* **Nguy√™n t·∫Øc:** Cung c·∫•p c√°c ph∆∞∆°ng √°n nhi·ªÖu l√† nh·ªØng d·∫°ng t·ª´ kh√°c (danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´, tr·∫°ng t·ª´) c·ªßa c√πng m·ªôt t·ª´ g·ªëc.
* **V√≠ d·ª• T·ªêT:**
    * C√¢u: "The ______ of the new policy was met with public resistance."
    * ƒê√°p √°n ƒë√∫ng: **implementation** (danh t·ª´)
    * C√°c b·∫´y t∆∞ duy:
        * `implement` (ƒë·ªông t·ª´).
        * `implementing` (V-ing/danh ƒë·ªông t·ª´).
        * `implementable` (t√≠nh t·ª´).
* **V√≠ d·ª• X·∫§U:**
    * C√¢u: "The policy was ______."
    * Ph∆∞∆°ng √°n nhi·ªÖu: `good`, `implement`, `bad`. (Tr·ªôn l·∫´n c√°c lo·∫°i t·ª´ kh√¥ng li√™n quan, kh√¥ng t·∫°o th√†nh b·∫´y h·ªá th·ªëng).

## 4. B·∫´y "B·∫°n Th√¢n Gi·∫£" (False Friends Traps)
* **Nguy√™n t·∫Øc:** S·ª≠ d·ª•ng c√°c t·ª´ ti·∫øng Anh tr√¥ng ho·∫∑c nghe gi·ªëng m·ªôt t·ª´ trong ti·∫øng Vi·ªát nh∆∞ng l·∫°i mang √Ω nghƒ©a ho√†n to√†n kh√°c. S·ª≠ d·ª•ng nh∆∞ m·ªôt l·ª±a ch·ªçn cu·ªëi c√πng ƒë·ªÉ tƒÉng ƒë·ªô kh√≥ v√† s·ª± th√∫ v·ªã.
* **V√≠ d·ª• T·ªêT:**
    * C√¢u: "The company will finally ______ its new product next month."
    * ƒê√°p √°n ƒë√∫ng: **launch** (ra m·∫Øt)
    * C√°c b·∫´y t∆∞ duy:
        * `lunch` (B·∫´y "B·∫°n th√¢n gi·∫£" v·ªõi t·ª´ "ra m·∫Øt" khi ph√°t √¢m nhanh).
        * `present` (Nghƒ©a l√† "tr√¨nh b√†y", kh√¥ng m·∫°nh v√† kh√¥ng ƒë·∫∑c tr∆∞ng cho vi·ªác ra m·∫Øt s·∫£n ph·∫©m nh∆∞ "launch").
* **V√≠ d·ª• X·∫§U:**
    * S·ª≠ d·ª•ng c√°c b·∫´y qu√° r√µ r√†ng ho·∫∑c kh√¥ng li√™n quan ƒë·∫øn ng·ªØ c·∫£nh.

---

# H∆Ø·ªöNG D·∫™N CHI TI·∫æT CHO T·ª™NG D·∫†NG B√ÄI T·∫¨P

**V·ªõi m·ªói t·ª´ trong `batchInput`, h√£y t·∫°o c√°c b√†i t·∫≠p sau:**

**1. `basic_example`**
* **M·ª•c ti√™u:** Cung c·∫•p m·ªôt c√¢u v√≠ d·ª• ƒë∆°n gi·∫£n, r√µ r√†ng, d·ªÖ hi·ªÉu nh·∫•t c√≥ th·ªÉ ƒë·ªÉ h·ªçc vi√™n n·∫Øm ƒë∆∞·ª£c c√°ch d√πng c∆° b·∫£n c·ªßa t·ª´.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `ubiquitous`) "Smartphones have become ubiquitous in modern society."
* **K·∫øt qu·∫£ X·∫§U:** "The ubiquitous nature of the phenomenon was perplexing to the researchers." (C√¢u qu√° ph·ª©c t·∫°p cho m·ªôt v√≠ d·ª• c∆° b·∫£n).

**2. `meaning_mcq`**
* **M·ª•c ti√™u:** T·∫°o c√°c ph∆∞∆°ng √°n nhi·ªÖu cho c√¢u h·ªèi tr·∫Øc nghi·ªám nghƒ©a (c·∫£ ti·∫øng Anh v√† ti·∫øng Vi·ªát).
* **Ph∆∞∆°ng ph√°p √°p d·ª•ng:** **B·∫´y Logic & Ng·ªØ c·∫£nh h·∫πp**. C√°c ph∆∞∆°ng √°n nhi·ªÖu n√™n l√† c√°c t·ª´ c√≥ li√™n quan v·ªÅ ch·ªß ƒë·ªÅ ho·∫∑c l√† t·ª´ tr√°i nghƒ©a, g·∫ßn nghƒ©a.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `diligent`, nghƒ©a: si√™ng nƒÉng, c·∫ßn c√π)
    * `distractors_en`: ["lazy", "intelligent", "creative"] (lazy l√† tr√°i nghƒ©a, intelligent v√† creative l√† c√°c ph·∫©m ch·∫•t kh√°c c√≥ th·ªÉ g√¢y nh·∫ßm l·∫´n).
    * `distractors_vi`: ["l∆∞·ªùi bi·∫øng", "th√¥ng minh", "s√°ng t·∫°o"]
* **K·∫øt qu·∫£ X·∫§U:** `distractors_en`: ["happy", "blue", "fast"]. (Kh√¥ng li√™n quan, kh√¥ng t·∫°o ra th√°ch th·ª©c).

**3. `word_family_mcq`**
* **M·ª•c ti√™u:** Ki·ªÉm tra ki·∫øn th·ª©c v·ªÅ c√°c d·∫°ng t·ª´ (danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´...).
* **Ph∆∞∆°ng ph√°p √°p d·ª•ng:** **B·∫´y T·ª´ lo·∫°i**.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´ g·ªëc: `generous` (adj))
    * `sentence`: "Her ______ to the charity was greatly appreciated."
    * `correct_answer`: "generosity" (danh t·ª´)
    * `distractors`: ["generous", "generously", "generate"]
* **K·∫øt qu·∫£ X·∫§U:** `distractors`: ["kind", "give", "nicely"]. (Kh√¥ng ph·∫£i l√† c√°c d·∫°ng t·ª´ c·ªßa t·ª´ g·ªëc).

**4. `sentence_unscramble`**
* **M·ª•c ti√™u:** Gi√∫p h·ªçc vi√™n nh·∫≠n di·ªán c·∫•u tr√∫c c√¢u ƒë√∫ng.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `collaborate`) `correct_sentence`: "The two scientists decided to collaborate on the research project." (C√¢u t·ª± nhi√™n, c√≥ ƒë·ªô d√†i v·ª´a ph·∫£i).
* **K·∫øt qu·∫£ X·∫§U:** `correct_sentence`: "They collaborate." (Qu√° ng·∫Øn, kh√¥ng c√≥ gi√° tr·ªã h·ªçc t·∫≠p).

**5. `error_correction`**
* **M·ª•c ti√™u:** Ki·ªÉm tra kh·∫£ nƒÉng nh·∫≠n di·ªán c√°c l·ªói sai tinh vi v·ªÅ ng·ªØ ph√°p ho·∫∑c c√°ch d√πng t·ª´.
* **Ph∆∞∆°ng ph√°p √°p d·ª•ng:** **B·∫´y Gi·ªõi t·ª´ & C·∫•u tr√∫c theo sau**. T·∫≠p trung v√†o l·ªói collocation (k·∫øt h·ª£p t·ª´) ho·∫∑c l·ªói gi·ªõi t·ª´.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `responsible`)
    * `incorrect_sentence`: "He is responsible **at** managing the team's budget."
    * `correct_sentence`: "He is responsible **for** managing the team's budget."
* **K·∫øt qu·∫£ X·∫§U:** `incorrect_sentence`: "He responsible for team." (L·ªói qu√° c∆° b·∫£n v√† r√µ r√†ng).

**6. `ipa_fill`**
* **M·ª•c ti√™u:** Ki·ªÉm tra kh·∫£ nƒÉng nh·∫≠n di·ªán √¢m v·ªã trong phi√™n √¢m.
* **H∆∞·ªõng d·∫´n:** D·ª±a v√†o phi√™n √¢m IPA ƒë∆∞·ª£c cung c·∫•p, ƒë·ª•c l·ªó M·ªòT nguy√™n √¢m (vowel) v√† t·∫°o 3 nguy√™n √¢m nhi·ªÖu c√≥ c√°ch ph√°t √¢m g·∫ßn gi·ªëng.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `heat` /hiÀêt/)
    * `gapped_ipa`: "/h_t/"
    * `correct_vowel`: "iÀê"
    * `distractors`: ["…™", "e", "e…™"] (C√°c √¢m d·ªÖ nh·∫ßm l·∫´n v·ªõi /iÀê/).
* **K·∫øt qu·∫£ X·∫§U:** `distractors`: ["a", "b", "c"]. (Kh√¥ng ph·∫£i √¢m v·ªã).

**7. `collocation_odd_one_out`**
* **M·ª•c ti√™u:** Ki·ªÉm tra ki·∫øn th·ª©c v·ªÅ k·∫øt h·ª£p t·ª´ (collocation).
* **Ph∆∞∆°ng ph√°p √°p d·ª•ng:** **B·∫´y "B·∫°n Th√¢n Gi·∫£"** c√≥ th·ªÉ ƒë∆∞·ª£c d√πng cho ph∆∞∆°ng √°n lo·∫°i tr·ª´.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `effort`)
    * `question`: "Which verb does NOT collocate with 'effort'?"
    * `options`: ["make", "put in", "do", "save"]
    * `answer`: "do" (Ch√∫ng ta n√≥i "make an effort", kh√¥ng n√≥i "do an effort").
* **K·∫øt qu·∫£ X·∫§U:** `options`: ["make", "put in", "run", "save"]. ("run" qu√° kh√°c bi·ªát, kh√¥ng g√¢y nhi·ªÖu).

**8. `best_fit_replacement`**
* **M·ª•c ti√™u:** Ki·ªÉm tra kh·∫£ nƒÉng hi·ªÉu s·∫Øc th√°i nghƒ©a c·ªßa t·ª´ trong ng·ªØ c·∫£nh h·∫πp.
* **Ph∆∞∆°ng ph√°p √°p d·ª•ng:** **B·∫´y Logic & Ng·ªØ c·∫£nh h·∫πp**.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´ g·ªëc ƒë·ªÉ thay th·∫ø: `crucial`)
    * `sentence`: "Getting enough sleep is **vital** for both physical and mental health; without it, our cognitive functions decline sharply."
    * `word_to_replace`: "vital"
    * `correct_answer`: "crucial"
    * `distractors`: ["important", "helpful", "optional"] ("important" v√† "helpful" ƒë√∫ng v·ªÅ nghƒ©a chung nh∆∞ng kh√¥ng m·∫°nh b·∫±ng "vital/crucial" theo g·ª£i √Ω c·ªßa v·∫ø sau).
* **K·∫øt qu·∫£ X·∫§U:** `distractors`: ["bad", "sad", "red"]. (Kh√¥ng li√™n quan).

**9. `inference_from_scenario`**
* **M·ª•c ti√™u:** Ki·ªÉm tra kh·∫£ nƒÉng suy lu·∫≠n v√† hi·ªÉu √Ω ng·∫ßm d·ª±a tr√™n m·ªôt k·ªãch b·∫£n.
* **Ph∆∞∆°ng ph√°p √°p d·ª•ng:** **B·∫´y Logic & Ng·ªØ c·∫£nh h·∫πp**.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `reluctant`)
    * `scenario`: "John was offered a promotion that required moving to another city. He looked at photos of his family and friends, sighed, and told his boss he needed more time to think."
    * `question`: "How does John likely feel about the promotion?"
    * `correct_answer`: "He is reluctant to accept it."
    * `distractors`: ["He is excited to start a new life.", "He is indifferent to the offer.", "He has already decided to reject it."]
* **K·∫øt qu·∫£ X·∫§U:** `scenario`: "John was reluctant." `question`: "How does John feel?" (Kh√¥ng c√≥ k·ªãch b·∫£n ƒë·ªÉ suy lu·∫≠n).

**10. `best_paraphrase`**
* **M·ª•c ti√™u:** Ki·ªÉm tra kh·∫£ nƒÉng nh·∫≠n di·ªán c√¢u c√≥ nghƒ©a t∆∞∆°ng ƒë·ªìng nh·∫•t.
* **H∆∞·ªõng d·∫´n:** T·∫°o m·ªôt c√¢u g·ªëc v√† 4 c√¢u di·ªÖn gi·∫£i. M·ªôt c√¢u ph·∫£i l√† ƒë√°p √°n ƒë√∫ng (similarity 100%). C√°c c√¢u c√≤n l·∫°i ph·∫£i c√≥ m·ª©c ƒë·ªô t∆∞∆°ng ƒë·ªìng gi·∫£m d·∫ßn, t·∫°o ra s·ª± ph√¢n v√¢n tinh vi.
* **K·∫øt qu·∫£ T·ªêT:** (T·ª´: `mitigate`)
    * `original_sentence`: "The government has implemented new policies to mitigate the effects of climate change."
    * `options`: [
        {"text": "The government has introduced new policies to lessen the impact of climate change.", "similarity": 100, "is_correct": true},
        {"text": "The government is studying the effects of climate change through new policies.", "similarity": 70, "is_correct": false},
        {"text": "The government has stopped climate change with its new policies.", "similarity": 40, "is_correct": false},
        {"text": "The government's new policies are a result of climate change.", "similarity": 20, "is_correct": false}
    ]
* **K·∫øt qu·∫£ X·∫§U:** C√°c c√¢u `options` c√≥ nghƒ©a ho√†n to√†n kh√°c nhau, kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c kh·∫£ nƒÉng nh·∫≠n di·ªán s·∫Øc th√°i.

---
**NH·∫ÆC L·∫†I Y√äU C·∫¶U CU·ªêI C√ôNG:**
- ƒê·∫£m b·∫£o t·∫•t c·∫£ n·ªôi dung ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô **${cefrLevel}**.
- Ch·ªâ tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON h·ª£p l·ªá. Kh√¥ng th√™m b·∫•t k·ª≥ gi·∫£i th√≠ch hay ghi ch√∫ n√†o ngo√†i c·∫•u tr√∫c JSON ƒë√£ ƒë·ªãnh.
- H√£y b·∫Øt ƒë·∫ßu!
`;
}

        function processAiResults(aiDataArray) {
            if (!Array.isArray(aiDataArray)) throw new Error("K·∫øt qu·∫£ AI kh√¥ng ph·∫£i l√† m·ªôt m·∫£ng.");
            
            aiDataArray.forEach(enrichedData => {
                const wordToUpdate = localWordList.find(w => w.id === enrichedData.id);
                if (wordToUpdate) {
                    // G√°n to√†n b·ªô g√≥i d·ªØ li·ªáu b√†i t·∫≠p
                    wordToUpdate.generated_tasks = enrichedData.generated_tasks || null;
                    wordToUpdate.isEnriched = true;
                }
            });
            renderTable();
        }

        function setupEventListeners() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    DOM.loginScreen.classList.remove('is-open');
                    DOM.mainContent.style.display = 'block';
                    initializePage();
                } else {
                    DOM.loginScreen.classList.add('is-open');
                    DOM.mainContent.style.display = 'none';
                }
            });

            DOM.loginBtn.addEventListener('click', async () => {
                try { await signInWithEmailAndPassword(auth, DOM.emailInput.value, DOM.passwordInput.value); } 
                catch (e) { DOM.loginError.textContent = 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; }
            });

            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.uploadBtn.addEventListener('click', uploadToFirebase);
            DOM.vocabCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'vocab'));
            DOM.structuresCsvUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'structures'));
            
            DOM.processFilesBtn.addEventListener('click', () => {
                if (!vocabCsvText) return showAlert("Vui l√≤ng t·∫£i l√™n file CSV t·ª´ v·ª±ng.");
                parseAndStructureCSV(vocabCsvText, structuresCsvText || '');
                renderTable();
                DOM.dataReviewSection.classList.remove('hidden');
            });

            DOM.darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark');
                DOM.darkModeToggle.nextElementSibling.nextElementSibling.style.transform = DOM.darkModeToggle.checked ? 'translateX(100%)' : 'translateX(0)';
            });
            
            DOM.cefrSlider.addEventListener('input', () => DOM.cefrDisplay.textContent = getCefrLevelDescription());
            
            DOM.fetchAudioBtn.addEventListener('click', async () => {
                if (localWordList.length === 0) return showAlert("Ch∆∞a c√≥ d·ªØ li·ªáu.");
                const button = DOM.fetchAudioBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                for (let i = 0; i < localWordList.length; i++) {
                    const wordData = localWordList[i];
                    button.innerHTML = `<div class="loader"></div><span class="ml-2">ƒêang t√¨m... (${i + 1}/${localWordList.length})</span>`;
                    if (wordData.audioUrl || !wordData.word) continue;
                    try {
                        const response = await fetch(`${CLOUD_FUNCTION_URL}?word=${encodeURIComponent(wordData.word)}`);
                        if (!response.ok) throw new Error(`Server error`);
                        const result = await response.json();
                        if (result.success) wordData.audioUrl = result.audioUrl;
                    } catch (error) { console.error(`L·ªói v·ªõi t·ª´ '${wordData.word}':`, error); }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                renderTable();
                button.disabled = false;
                button.innerHTML = originalHTML;
            });

            DOM.enrichAiBtn.addEventListener('click', async () => {
                const wordsToEnrich = localWordList.filter(w => !w.isEnriched);
                if (wordsToEnrich.length === 0) return showAlert("T·∫•t c·∫£ c√°c t·ª´ ƒë√£ ƒë∆∞·ª£c l√†m gi√†u.");
                const button = DOM.enrichAiBtn;
                const originalHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<div class="loader"></div><span class="ml-2">ƒêang x·ª≠ l√Ω...</span>`;
                try {
                    const BATCH_SIZE = 2; 
                    for (let i = 0; i < wordsToEnrich.length; i += BATCH_SIZE) {
                        const batch = wordsToEnrich.slice(i, i + BATCH_SIZE);
                        button.innerHTML = `<div class="loader"></div><span class="ml-2">ƒêang x·ª≠ l√Ω... (${i + batch.length}/${wordsToEnrich.length})</span>`;
                        const prompt = getPromptForBatch(batch);
                        const model = DOM.aiModelSelect.value;
                        const results = await callGeminiAPI(prompt, model);
                        processAiResults(results);
                    }
                    showAlert("L√†m gi√†u d·ªØ li·ªáu b·∫±ng AI th√†nh c√¥ng!");
                } catch (error) {
                    showAlert(`L·ªói khi l√†m gi√†u d·ªØ li·ªáu: ${error.message}`);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }
            });

            DOM.manualEnrichBtn.addEventListener('click', () => {
                const wordsToEnrich = localWordList.filter(w => !w.isEnriched);
                if (wordsToEnrich.length === 0) return showAlert("T·∫•t c·∫£ c√°c t·ª´ ƒë√£ ƒë∆∞·ª£c l√†m gi√†u.");
                DOM.manualPromptOutput.value = getPromptForBatch(wordsToEnrich);
                DOM.manualPromptInput.value = '';
                DOM.manualPromptModal.classList.add('is-open');
            });
            DOM.closeManualModalBtn.addEventListener('click', () => DOM.manualPromptModal.classList.remove('is-open'));
            DOM.copyPromptBtn.addEventListener('click', () => {
                DOM.manualPromptOutput.select();
                document.execCommand('copy');
                showAlert("ƒê√£ sao ch√©p Prompt!");
            });
            DOM.processManualResultBtn.addEventListener('click', () => {
                try {
                    const jsonText = DOM.manualPromptInput.value.trim().replace(/^```json\s*|```\s*$/g, '');
                    const results = JSON.parse(jsonText);
                    processAiResults(results);
                    DOM.manualPromptModal.classList.remove('is-open');
                    showAlert("C·∫≠p nh·∫≠t th·ªß c√¥ng th√†nh c√¥ng!");
                } catch (error) {
                    showAlert(`L·ªói x·ª≠ l√Ω JSON: ${error.message}`);
                }
            });
            
            DOM.dataTableBody.addEventListener('blur', (e) => {
                const target = e.target;
                if (target.hasAttribute('contenteditable')) {
                    const wordIndex = parseInt(target.dataset.wordIndex, 10);
                    const path = target.dataset.path;
                    const newText = target.textContent;

                    if (isNaN(wordIndex) || !localWordList[wordIndex] || !path) return;
                    
                    function updateNestedObject(obj, path, value) {
                        const keys = path.replace(/\[(\w+)\]/g, '.$1').replace(/^\./, '').split('.');
                        let current = obj;
                        for (let i = 0; i < keys.length - 1; i++) {
                            if (current[keys[i]] === undefined) return;
                            current = current[keys[i]];
                        }
                        current[keys[keys.length - 1]] = value;
                    }
                    
                    updateNestedObject(localWordList[wordIndex], path, newText);
                }
            }, true);
        }
        
        async function loadAndPopulateTestData(testId) {
            showAlert("ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªÅ thi...");
            const docRef = doc(db, "vocab_sets", testId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const testData = docSnap.data();
                    
                    DOM.pageTitle.textContent = "Ch·ªânh s·ª≠a B·ªô t·ª´ v·ª±ng";
                    DOM.testIdInput.value = testId;
                    DOM.testIdInput.disabled = true;
                    DOM.testTitleInput.value = testData.title || "";
                    
                    localWordList = testData.wordList || [];
                    
                    localWordList.forEach(word => {
                        if (!word.generated_tasks) word.generated_tasks = null;
                    });

                    renderTable();
                    DOM.dataReviewSection.classList.remove('hidden');
                    
                    DOM.uploadBtn.innerHTML = '<i class="fas fa-save mr-2"></i>C·∫≠p nh·∫≠t B·ªô T·ª´ V·ª±ng';
                    
                    DOM.alertModal.classList.remove('is-open');

                } else {
                    showAlert(`L·ªói: Kh√¥ng t√¨m th·∫•y b·ªô t·ª´ v·ª±ng v·ªõi ID: ${testId}`);
                }
            } catch (error) {
                showAlert(`L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}`);
                console.error("Error loading test data:", error);
            }
        }

        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const testIdToEdit = urlParams.get('edit');

            if (testIdToEdit) {
                await loadAndPopulateTestData(testIdToEdit);
                const uploadSection = DOM.processFilesBtn.closest('.glass-panel');
                uploadSection.style.opacity = '0.5';
                uploadSection.style.pointerEvents = 'none';
                uploadSection.title = 'Kh√¥ng th·ªÉ nh·∫≠p file CSV khi ƒëang ch·ªânh s·ª≠a.';
            } else {
                DOM.pageTitle.textContent = "Tr√¨nh So·∫°n Th·∫£o B·ªô T·ª´ V·ª±ng";
                DOM.uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i>L∆∞u B·ªô T·ª´ V·ª±ng';
            }
        }

        DOM.cefrDisplay.textContent = getCefrLevelDescription();
        setupEventListeners();

    </script>
</body>
</html>
