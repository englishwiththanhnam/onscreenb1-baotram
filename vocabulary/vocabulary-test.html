<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Practice Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blur-intensity: 12px;
            --saturation-intensity: 150%;
            --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6);
            --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --app-bg-start: #f5f7ff;
            --app-bg-end: #e0e7ff;
        }

        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25);
            --primary-accent: #a78bfa;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --app-bg-start: #0f172a;
            --app-bg-end: #1e293b;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--app-bg-start);
            background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }
        
        body.sidebar-open {
            overflow: hidden;
        }
        
        .no-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .background-shapes {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            filter: blur(15px);
            transition: opacity 0.5s ease;
        }

        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; animation: float 28s infinite alternate ease-in-out; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation: float 32s infinite alternate ease-in-out; }
        .shape3 { width: 120px; height: 120px; background: linear-gradient(135deg, #a78bfa, #c4b5fd); top: 20%; right: 25%; animation: float 24s infinite alternate ease-in-out; }
        .shape4 { width: 80px; height: 80px; background: linear-gradient(135deg, #93c5fd, #bfdbfe); bottom: 5%; left: 30%; animation: float 20s infinite alternate ease-in-out; }

        body.dark .shape {
            opacity: 0.4;
        }

        @keyframes float {
            from { transform: translateY(20px) scale(1) rotate(0deg); }
            to { transform: translateY(-20px) scale(1.05) rotate(20deg); }
        }

        .app-layout { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 1; transition: padding-left 0.3s ease-in-out; }

        .glass-panel {
            position: relative;
            background: var(--glass-bg-color);
            backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            border-radius: 24px;
            border: 1px solid var(--glass-border-color);
            box-shadow: 0 8px 32px 0 var(--shadow-color), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }

        .card { padding: 1.5rem; }

        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 260px;
            padding: 1.5rem;
            z-index: 40;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        body.sidebar-open #sidebar {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            #sidebar {
                position: relative;
                transform: translateX(0);
                flex-shrink: 0;
            }
            .app-layout.sidebar-collapsed #sidebar {
                transform: translateX(-100%);
                margin-left: -260px;
            }
        }
        
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        body.sidebar-open #sidebar-overlay {
            opacity: 1;
            visibility: visible;
        }
        
        @media (min-width: 1024px) {
            #sidebar-overlay {
                display: none;
            }
        }

        .sidebar-nav-btn { display: flex; align-items: center; padding: 12px 16px; border-radius: 12px; font-weight: 600; color: var(--text-secondary); transition: all 0.2s ease-in-out; margin-bottom: 8px; }
        .sidebar-nav-btn i { width: 20px; margin-right: 16px; text-align: center; }
        .sidebar-nav-btn:hover { background-color: rgba(255, 255, 255, 0.4); color: var(--text-primary); transform: translateX(5px) scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sidebar-nav-btn.active { background-color: var(--primary-accent); color: white; box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3); transform: translateX(5px) scale(1.03); }
        
        body.dark .sidebar-nav-btn.active {
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
        }
        body.dark .sidebar-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #app { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 1.5rem; transition: margin-left 0.3s ease-in-out; }
        @media (min-width: 1024px) {
            #app { padding: 2rem; }
        }
        #app::-webkit-scrollbar { width: 8px; }
        #app::-webkit-scrollbar-track { background: transparent; }
        #app::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.1); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        #app::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.2); }

        .main-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        #menu-toggle-btn {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; transform: translateY(0); }
        .btn-main-action { background: var(--primary-accent); color: white; border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(91, 33, 182, 0.25); }
        body.dark .btn-main-action { color: #1e293b; }
        .btn-main-action:hover:not(:disabled) { background: #5b21b6; transform: translateY(-3px); box-shadow: 0 7px 20px rgba(91, 33, 182, 0.4); }
        body.dark .btn-main-action:hover:not(:disabled) { background: #9333ea; }

        .btn-secondary { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); color: var(--text-primary); border-color: rgba(255, 255, 255, 0.6); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.7); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        body.dark .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); }

        .btn:disabled { background-color: rgba(200, 200, 200, 0.7) !important; cursor: not-allowed; opacity: 0.7; transform: none !important; box-shadow: none !important; }
        body.dark .btn:disabled { background-color: rgba(71, 85, 105, 0.7) !important; }

        .answer-option {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        body.dark .answer-option {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .answer-option:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 1px rgba(255,255,255,0.3);
        }
        body.dark .answer-option:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .answer-option.selected {
            background-color: var(--primary-accent) !important;
            border-color: var(--primary-accent) !important;
            color: white !important;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 6px 20px rgba(91, 33, 182, 0.3);
        }
        body.dark .answer-option.selected {
            color: #1e293b !important;
        }

        .answer-option.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
        }
        body.dark .answer-option.correct {
            background-color: #052e16 !important;
            border-color: #16a34a !important;
            color: #a7f3d0 !important;
        }

        .answer-option.incorrect {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
            animation: shake 0.5s;
        }
        body.dark .answer-option.incorrect {
            background-color: #450a0a !important;
            border-color: #dc2626 !important;
            color: #fecaca !important;
        }
        .answer-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes scaleOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }

        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.2); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            align-items: center; 
            justify-content: center; 
        }
        .modal.is-open {
            display: flex;
        }
        .modal-content { 
            padding: 24px; 
            width: 90%; 
            max-width: 500px; 
            animation: scaleIn 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        .modal.is-closing .modal-content {
            animation: scaleOut 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-between; align-items: center; }
        .close-button { color: var(--text-secondary); font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-button:hover { color: var(--text-primary); }

        .flashcard-container { perspective: 1000px; min-height: 250px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction:column; align-items: center; justify-content: center; border-radius: 16px; padding: 20px; text-align: center; }
        .flashcard-front { background-color: rgba(255, 255, 255, 0.8); }
        body.dark .flashcard-front { background-color: rgba(51, 65, 85, 0.8); }
        .flashcard-back { background-color: rgba(230, 230, 255, 0.9); transform: rotateY(180deg); overflow-y: auto; }
        body.dark .flashcard-back { background-color: rgba(71, 85, 105, 0.9); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1rem; }
        body.dark .progress-bar { background-color: #4b5563; }
        .progress-bar-inner { background-color: var(--primary-accent); height: 100%; transition: width 0.5s ease-in-out; }

        .word-token-area { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; min-height: 50px; padding: 10px; border-radius: 12px; }
        .unscramble-area { border: 2px dashed var(--glass-border-color); }
        .word-token { cursor: pointer; background-color: #e0e7ff; color: #3730a3; padding: 8px 12px; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        body.dark .word-token { background-color: #3730a3; color: #e0e7ff; }
        .word-token:hover { transform: translateY(-2px); background-color: #c7d2fe; }
        body.dark .word-token:hover { background-color: #4338ca; }
        
        .clickable-word { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; }
        .clickable-word:hover { background-color: #e0e7ff; }
        body.dark .clickable-word:hover { background-color: #3730a3; }
        .clickable-word.selected { background-color: #fbbf24; color: #78350f; }
        body.dark .clickable-word.selected { background-color: #f59e0b; color: #422006; }
        
        .mindmap-container { display: flex; justify-content: center; align-items: center; flex-grow: 1; padding: 1rem; }
        .mindmap { position: relative; display: flex; justify-content: center; align-items: center; }
        .mindmap-center {
            padding: 1rem 1.5rem; background-color: var(--primary-accent); color: white; border-radius: 50px; font-weight: bold; z-index: 10;
        }
        body.dark .mindmap-center { color: #1e293b; }
        .mindmap-node {
            position: absolute; padding: 0.5rem 1rem; background: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.9); border-radius: 20px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease;
        }
        body.dark .mindmap-node { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .mindmap-node:hover { transform: scale(1.1); z-index: 20; }
        
        body.dark .text-slate-800, body.dark .text-slate-700, body.dark .text-violet-800 { color: var(--text-primary); }
        body.dark .text-slate-600, body.dark .text-slate-500 { color: var(--text-secondary); }
        body.dark .text-red-500 { color: #f87171; }
        body.dark .hover\:bg-red-100:hover { background-color: rgb(220 38 38 / 0.2); }
        body.dark .hover\:text-red-700:hover { color: #f87171; }

        .text-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--glass-border-color);
            background: var(--glass-bg-color);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .text-input:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.3);
        }
    </style>
</head>
<body>
    <div class="background-shapes">
        <div class="shape shape1"></div>
        <div class="shape shape2"></div>
        <div class="shape shape3"></div>
        <div class="shape shape4"></div>
    </div>

    <div id="loader-overlay" class="modal is-open">
        <div class="text-center">
            <div class="w-16 h-16 border-8 border-t-violet-500 border-gray-200 rounded-full animate-spin"></div>
            <p id="loader-text" class="text-lg font-semibold text-white mt-4">Đang tải dữ liệu...</p>
        </div>
    </div>

    <div class="app-layout" style="visibility: hidden;">
        <nav id="sidebar" class="glass-panel">
            <div>
                <div class="text-center mb-10">
                    <h1 id="sidebar-title" class="text-2xl font-bold">Vocab App</h1>
                    <p class="text-sm text-slate-600">by Thành Nam</p>
                </div>
                <div id="sidebar-nav" class="flex-grow">
                    <button id="nav-dashboard" class="sidebar-nav-btn active"><i class="fas fa-chart-pie"></i> Dashboard</button>
                    <button id="nav-study" class="sidebar-nav-btn"><i class="fas fa-book-open"></i> Study</button>
                    <button id="nav-practice" class="sidebar-nav-btn"><i class="fas fa-dumbbell"></i> Practice</button>
                    <button id="nav-test" class="sidebar-nav-btn"><i class="fas fa-graduation-cap"></i> Test</button>
                </div>
            </div>
            <div class="mt-auto">
                 <div class="pt-4 border-t border-white/20">
                    <button id="theme-toggle-btn" class="sidebar-nav-btn w-full">
                        <i id="theme-toggle-icon" class="fas fa-moon"></i>
                        <span id="theme-toggle-text">Dark Mode</span>
                    </button>
                </div>
                <button id="nav-reset" class="sidebar-nav-btn w-full justify-center text-red-500 hover:bg-red-100 hover:text-red-700">
                   <i class="fas fa-trash-alt mr-2"></i> Reset Progress
                </button>
            </div>
        </nav>
        
        <div id="sidebar-overlay"></div>

        <main id="app">
             <header class="main-header">
                 <button id="menu-toggle-btn" class="lg:hidden">
                     <i class="fas fa-bars text-xl"></i>
                 </button>
                 <div class="text-left flex-grow">
                     <h1 id="app-title" class="text-3xl lg:text-4xl font-bold">Dashboard</h1>
                     <p id="app-subtitle" class="text-slate-600 mt-1 lg:mt-2">Welcome back! Here's your learning progress.</p>
                 </div>
             </header>
             <div id="main-content">
                </div>
        </main>
    </div>

    <div id="word-list-modal" class="modal">
        <div class="modal-content glass-panel" style="max-width: 1200px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header pb-4 mb-4">
                <h2 id="modal-title" class="text-2xl font-bold">List</h2>
                <span id="close-word-modal-btn" class="close-button">&times;</span>
            </div>
            <div id="word-table-container" class="overflow-y-auto flex-grow">
                <table id="word-table" class="w-full text-sm text-left">
                </table>
            </div>
        </div>
    </div>
    
    <div id="test-setup-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header pb-4 mb-4">
                <h2 class="text-2xl font-bold">Test Setup</h2>
                <span id="close-test-modal-btn" class="close-button">&times;</span>
            </div>
            <div>
                <label for="question-count" class="block mb-2 font-medium">Number of questions:</label>
                <input type="number" id="question-count" class="w-full p-2 rounded-lg text-input" min="5" max="100" value="10">
                <div class="mt-6">
                    <button id="start-test-fixed-btn" class="btn btn-main-action w-full">Start with selected count</button>
                    <button id="start-test-all-btn" class="btn btn-secondary w-full mt-3">Test all items</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const App = {
            data: {
                db: null,
                submissionId: null,
                testId: null,
                words: [],
                structures: [],
                wordFamilies: {},
                progress: { learnedItems: {}, lastTestResult: null, incorrectCounts: {} },
                sessionItems: [],
                currentSessionIndex: 0,
                mode: null, // 'study', 'practice', 'test'
                currentCorrectAnswer: null,
                wasCorrect: false, // State for the latest answer
            },

            async init() {
                this.initTheme();
                this.initResponsiveSidebar();
                try {
                    this.data.submissionId = this.getSubmissionIdFromUrl();
                    // --- QUAN TRỌNG: Thay thế bằng Firebase config của bạn ---
                    const firebaseConfig = {
                        apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
                        authDomain: "b1-baotram.firebaseapp.com",
                        projectId: "b1-baotram",
                        storageBucket: "b1-baotram.appspot.com",
                        messagingSenderId: "948701163187",
                        appId: "1:948701163187:web:043f2d381d63e741114ac6"
                    };
                    // --- HẾT PHẦN THAY THẾ ---
                    const firebaseApp = initializeApp(firebaseConfig);
                    this.data.db = getFirestore(firebaseApp);
                    await this.loadDataFromFirebase();
                    this.initAntiCopy();
                    this.initModals();
                    this.initSidebarNav();
                    this.renderDashboard();
                    document.querySelector('.app-layout').style.visibility = 'visible';
                    document.getElementById('loader-overlay').classList.remove('is-open');
                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.showErrorState(error.message);
                }
            },
            
            getSubmissionIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('submission_id');
                if (!id) throw new Error("Mã truy cập (submission_id) không tồn tại trên URL.");
                return id;
            },

            async loadDataFromFirebase() {
                const loaderText = document.getElementById('loader-text');
                loaderText.textContent = 'Đang tải thông tin bài làm...';
                const submissionSnap = await getDoc(doc(this.data.db, "submissions", this.data.submissionId));
                if (!submissionSnap.exists()) throw new Error("Không tìm thấy bài làm với mã truy cập này.");
                
                const submissionData = submissionSnap.data();
                this.data.testId = submissionData.testId;
                if (!this.data.testId) throw new Error("Dữ liệu bài làm không hợp lệ (thiếu testId).");

                if (submissionData.progress) {
                    this.data.progress = submissionData.progress;
                    this.data.progress.learnedItems = this.data.progress.learnedItems || {};
                    this.data.progress.incorrectCounts = this.data.progress.incorrectCounts || {};
                }

                loaderText.textContent = 'Đang tải bộ từ vựng...';
                const vocabSetSnap = await getDoc(doc(this.data.db, "vocab_sets", this.data.testId));
                if (!vocabSetSnap.exists()) throw new Error(`Không tìm thấy bộ từ vựng với mã: ${this.data.testId}`);
                
                const vocabSetData = vocabSetSnap.data();
                document.title = vocabSetData.title || "Vocabulary Practice";
                document.getElementById('sidebar-title').textContent = vocabSetData.title;

                this.data.words = (vocabSetData.wordList || []).map((word, index) => ({...word, id: word.id || `word_${index}`, itemType: 'word'}));
                this.groupWordFamilies();
                this.parseAndStoreStructures();
                this.applyUserProgress();
            },
            
            applyUserProgress() {
                const { learnedItems } = this.data.progress;
                if (!learnedItems) return;
                this.data.words.forEach(word => { word.isLearned = !!learnedItems[word.id]; });
                this.data.structures.forEach(structure => { structure.isLearned = !!learnedItems[structure.id]; });
            },

            async saveProgressToFirebase() {
                if (!this.data.submissionId || !this.data.db) return;
                try {
                    // Chỉ cập nhật field progress và lastAccessed để tránh ghi đè dữ liệu khác
                    await setDoc(doc(this.data.db, "submissions", this.data.submissionId), { 
                        progress: this.data.progress, 
                        lastAccessed: serverTimestamp() 
                    }, { merge: true });
                } catch (error) {
                    console.error("Error saving progress:", error);
                    this.showCustomAlert("Lỗi: Không thể lưu tiến trình.", 'error');
                }
            },
            
            initTheme() {
                const themeToggleBtn = document.getElementById('theme-toggle-btn');
                const themeToggleIcon = document.getElementById('theme-toggle-icon');
                const themeToggleText = document.getElementById('theme-toggle-text');
                const body = document.body;
                const applyTheme = (theme) => {
                    body.classList.toggle('dark', theme === 'dark');
                    themeToggleIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                    themeToggleText.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
                };
                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);
                themeToggleBtn.addEventListener('click', () => {
                    const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            },

            initResponsiveSidebar() {
                const menuToggleBtn = document.getElementById('menu-toggle-btn');
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                const appLayout = document.querySelector('.app-layout');
                const toggleSidebar = () => {
                    if (window.innerWidth < 1024) {
                        document.body.classList.toggle('sidebar-open');
                    } else {
                        appLayout.classList.toggle('sidebar-collapsed');
                    }
                };
                menuToggleBtn?.addEventListener('click', toggleSidebar);
                sidebarOverlay?.addEventListener('click', toggleSidebar);
                document.querySelectorAll('#sidebar-nav .sidebar-nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (window.innerWidth < 1024) document.body.classList.remove('sidebar-open');
                    });
                });
            },
            
            initAntiCopy() {
                ['contextmenu', 'copy', 'cut', 'paste'].forEach(event => {
                    document.body.addEventListener(event, e => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        e.preventDefault();
                        this.showCustomAlert("Chức năng này đã bị vô hiệu hóa.", 'info');
                        return false;
                    });
                });
            },

            groupWordFamilies() {
                const families = {};
                this.data.words.forEach(word => {
                    const root = (word.familyRoot || word.word.split(/[\s-]/)[0]).toLowerCase().replace(/[^a-z]/g, '');
                    if (!families[root]) families[root] = [];
                    if (!families[root].some(w => w.id === word.id)) families[root].push(word);
                    word.familyRoot = root;
                });
                this.data.wordFamilies = families;
            },
            
            parseAndStoreStructures() {
                this.data.structures = [];
                this.data.words.forEach(word => {
                    if (word.structures && Array.isArray(word.structures)) {
                        word.structures.forEach((struct, s_idx) => {
                            this.data.structures.push({
                                ...struct, // phrase, meaning, applicationExamples
                                id: `structure_${word.id}_${s_idx}`,
                                itemType: 'structure',
                                rootWordId: word.id,
                                rootWord: word.word,
                                isLearned: false,
                            });
                        });
                    }
                });
            },

            updateProgress(itemId, isCorrect) {
                const { incorrectCounts, learnedItems } = this.data.progress;
                if (isCorrect) {
                    learnedItems[itemId] = true;
                    delete incorrectCounts[itemId];
                } else {
                    incorrectCounts[itemId] = (incorrectCounts[itemId] || 0) + 1;
                    delete learnedItems[itemId];
                }
                
                // Cập nhật trạng thái isLearned ngay trong bộ nhớ để UI phản ánh tức thì
                const itemInWords = this.data.words.find(i => i.id === itemId);
                if (itemInWords) { itemInWords.isLearned = isCorrect; }
                const itemInStructures = this.data.structures.find(i => i.id === itemId);
                if (itemInStructures) { itemInStructures.isLearned = isCorrect; }
                
                this.saveProgressToFirebase();
            },

            renderDashboard() {
                this.setActiveNav('nav-dashboard');
                this.updateHeader('Dashboard', "Tổng quan tiến trình học tập của bạn.");
                const main = document.getElementById('main-content');
                
                const wordsLearned = this.data.words.filter(w => w.isLearned).length;
                const totalWords = this.data.words.length;
                const wordProgress = totalWords > 0 ? (wordsLearned / totalWords) * 100 : 0;

                const structuresLearned = this.data.structures.filter(s => s.isLearned).length;
                const totalStructures = this.data.structures.length;
                const structureProgress = totalStructures > 0 ? (structuresLearned / totalStructures) * 100 : 0;
                
                const lastTest = this.data.progress.lastTestResult;
                let testResultHTML = `<p class="text-slate-600">Chưa có bài kiểm tra nào.</p>`;
                if (lastTest && lastTest.date) {
                    const testDate = new Date(lastTest.date).toLocaleDateString('vi-VN');
                    testResultHTML = `<p class="text-2xl font-bold text-violet-800">${lastTest.score}/${lastTest.total} (${lastTest.percentage}%)</p><p class="text-sm text-slate-600">Làm ngày: ${testDate}</p>`;
                }

                main.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold mb-3">Tiến độ Từ vựng</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${wordsLearned}/${totalWords}</span><span class="text-sm font-medium">${wordProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${wordProgress}%;"></div></div>
                            <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold mb-3">Tiến độ Cấu trúc</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${structuresLearned}/${totalStructures}</span><span class="text-sm font-medium">${structureProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${structureProgress}%;"></div></div>
                             <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel lg:col-span-2">
                             <h3 class="text-xl font-bold mb-2">Kết quả kiểm tra gần nhất</h3>
                             ${testResultHTML}
                        </div>
                    </div>`;
                main.querySelectorAll('[data-list-type]').forEach(button => {
                    button.addEventListener('click', (e) => this.showFilteredList(e.currentTarget.dataset.listType));
                });
            },
            
            renderSelectionScreen(mode) {
                this.data.mode = mode; // 'study', 'practice', 'test'
                this.setActiveNav(`nav-${mode}`);
                const modeText = mode.charAt(0).toUpperCase() + mode.slice(1);
                this.updateHeader(modeText, `Chọn nội dung bạn muốn ${mode}.`);
                const main = document.getElementById('main-content');
                
                let practiceButton = '';
                // Chế độ Ôn tập điểm yếu chỉ có ở 'practice' và 'test'
                if (mode === 'practice' || mode === 'test') {
                    const weakItemsCount = Object.keys(this.data.progress.incorrectCounts).length;
                    practiceButton = `
                     <div class="w-full mt-6 pt-6 border-t border-white/20 dark:border-white/10">
                         <button id="select-adaptive-btn" class="btn btn-main-action bg-amber-500 hover:bg-amber-600 w-full md:w-auto" ${weakItemsCount === 0 ? 'disabled' : ''}>
                             <i class="fas fa-star"></i> Ôn tập điểm yếu (${weakItemsCount} mục)
                         </button>
                         <p class="text-xs text-slate-500 mt-2 ${weakItemsCount > 0 ? 'hidden' : ''}">Tuyệt vời! Bạn không có điểm yếu nào cần ôn tập.</p>
                     </div>
                    `;
                }

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="mb-4"><button id="back-to-dashboard-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Dashboard</button></div>
                        <div class="card glass-panel text-center">
                            <h2 class="text-2xl font-bold mb-6">Bạn muốn ${mode} gì?</h2>
                            <div class="flex flex-wrap justify-center gap-4">
                                <button id="select-vocab-btn" class="btn btn-main-action"><i class="fas fa-book"></i> Từ vựng</button>
                                <button id="select-structure-btn" class="btn btn-main-action" ${this.data.structures.length === 0 ? 'disabled' : ''}><i class="fas fa-sitemap"></i> Cấu trúc</button>
                            </div>
                            ${practiceButton}
                        </div>
                    </div>`;
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('select-vocab-btn').addEventListener('click', () => this.startSession('all', 'word'));
                document.getElementById('select-structure-btn').addEventListener('click', () => this.startSession('all', 'structure'));
                if (mode === 'practice' || mode === 'test') {
                    document.getElementById('select-adaptive-btn')?.addEventListener('click', () => this.startSession('adaptive', 'all'));
                }
            },

            startSession(selection, type) {
                this.data.currentSessionIndex = 0;
                let items = [];

                if (selection === 'adaptive') {
                    this.updateHeader("Ôn tập điểm yếu", "Tập trung vào các mục bạn hay sai nhất");
                    const incorrect = this.data.progress.incorrectCounts || {};
                    const weakItemIds = Object.keys(incorrect)
                        .map(key => ({ id: key, count: incorrect[key] }))
                        .sort((a, b) => b.count - a.count)
                        .map(item => item.id);
                    
                    items = weakItemIds.map(id => {
                        return this.data.words.find(i => i.id === id) || this.data.structures.find(i => i.id === id);
                    }).filter(Boolean);
                } else {
                    const source = type === 'word' ? this.data.words : this.data.structures;
                    // Đối với study, dùng tất cả. Đối với practice/test, ưu tiên các mục chưa học.
                    const unlearned = source.filter(i => !i.isLearned);
                    items = (this.data.mode !== 'study' && unlearned.length > 0) ? unlearned : source;
                    this.updateHeader(`${this.data.mode.charAt(0).toUpperCase() + this.data.mode.slice(1)} ${type.charAt(0).toUpperCase() + type.slice(1)}`, `Hãy bắt đầu nào!`);
                }

                if (items.length === 0) {
                    this.showCustomAlert("Chúc mừng! Bạn đã học hết các mục trong phần này.", 'success');
                    this.renderDashboard();
                    return;
                }
                this.data.sessionItems = this.shuffleArray(items);
                this.renderNextInSession();
            },

            renderNextInSession() {
                if (this.data.currentSessionIndex >= this.data.sessionItems.length) {
                    this.showSessionEndSummary();
                    return;
                }
                const item = this.data.sessionItems[this.data.currentSessionIndex];
                
                // An a robust check to ensure item exists and has a type
                if (!item || !item.itemType) { 
                    this.data.currentSessionIndex++;
                    this.renderNextInSession(); 
                    return; 
                }

                // Chọn ngẫu nhiên một dạng bài tập phù hợp
                let exercisePool = this.getExercisePoolForItem(item);
                
                // If no valid exercise can be generated, skip.
                if (exercisePool.length === 0) {
                    this.data.currentSessionIndex++;
                    this.renderNextInSession();
                    return;
                }
                
                const exercise = this.shuffleArray(exercisePool)[0];

                const renderMap = {
                    'Flashcard': () => this.renderFlashcard(item),
                    'Structure Flashcard': () => this.renderFlashcard(item, true),
                    'Word Family Explorer': () => this.renderWordFamilyMindmap(item),
                    'Word Family Matching': () => this.renderWordFamilyMatching(item),
                    'Contextual MCQ': () => this.renderContextualMCQ(item),
                    'Sentence Unscramble': () => this.renderSentenceUnscramble(item),
                    'Pronunciation Match': () => this.renderPronunciationMatch(item),
                    'Audio Listening': () => this.renderAudioListening(item),
                    'Traditional MCQ': () => this.renderTraditionalMCQ(item),
                    'Trios of Gapped Sentence': () => this.renderTriosOfGappedSentence(item),
                    'Gap-Fill': () => this.renderGapFill(item),
                    'Error Correction': () => this.renderFindAndFixError(item),
                    'Correct/Incorrect Sentence': () => this.renderCorrectIncorrectSentence(item),
                };

                const renderFunction = renderMap[exercise];
                if (renderFunction) {
                    renderFunction();
                } else {
                    // Fallback an toàn
                    this.data.currentSessionIndex++;
                    this.renderNextInSession();
                }
            },
            
            getExercisePoolForItem(item) {
                const itemType = item.itemType;
                let pool = [];

                if (this.data.mode === 'study') {
                    if (itemType === 'word') {
                        pool = ['Flashcard'];
                        if (this.data.wordFamilies[item.familyRoot]?.length > 1) pool.push('Word Family Explorer');
                    } else { // structure
                        pool = ['Structure Flashcard'];
                    }
                } else { // practice or test mode
                    if (itemType === 'word') {
                        pool.push('Traditional MCQ'); // Luôn có thể tạo
                        if (item.exampleSentence) {
                             pool.push('Contextual MCQ');
                             pool.push('Sentence Unscramble');
                             pool.push('Trios of Gapped Sentence'); // Check condition inside
                        }
                        if (item.pronunciation) pool.push('Pronunciation Match');
                        pool.push('Audio Listening');
                        if (this.data.wordFamilies[item.familyRoot]?.length > 1) pool.push('Word Family Matching');
                    } else { // structure
                        if (item.applicationExamples && item.applicationExamples.length > 0) {
                             pool.push('Gap-Fill');
                             pool.push('Error Correction');
                             pool.push('Correct/Incorrect Sentence');
                        }
                    }
                }
                return pool;
            },

            // --- [START] EXERCISE RENDERERS ---
            // Các hàm render chi tiết cho từng loại bài tập
            
            renderFlashcard(item, isStructure = false) {
                const main = document.getElementById('main-content');
                const frontHTML = isStructure ? `<p class="text-3xl font-bold text-center">${item.phrase}</p>` : `<p class="text-4xl font-bold">${item.word}</p>`;
                const backHTML = isStructure ? `
                    <div class="p-4">
                        <p class="text-2xl font-semibold text-center">${item.meaning}</p>
                        <p class="text-sm text-slate-600 mt-2 text-center">${(item.applicationExamples || [])[0] || ''}</p>
                    </div>` : `
                    <div class="p-4 text-center">
                        <p class="text-2xl font-semibold">${item.meaning}</p>
                        <p class="text-lg text-slate-600 mt-2">${item.pronunciation} - (${item.type})</p>
                        <p class="text-sm text-slate-500 italic mt-4">"${item.exampleSentence || ''}"</p>
                        <button id="explore-family-btn" class="btn btn-secondary !py-2 !px-4 mt-4 text-sm"><i class="fas fa-project-diagram mr-2"></i>Khám phá họ từ</button>
                    </div>`;

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Quit</button>
                            <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                            <button id="next-btn" class="btn btn-main-action">Next <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                        <div class="card glass-panel flex items-center justify-center">
                            <div class="flashcard-container">
                                <div class="flashcard" id="flashcard">
                                    <div class="flashcard-face flashcard-front">${frontHTML}</div>
                                    <div class="flashcard-face flashcard-back">${backHTML}</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen('study'));
                document.getElementById('flashcard').addEventListener('click', (e) => e.currentTarget.classList.toggle('is-flipped'));
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.data.currentSessionIndex++;
                    this.renderNextInSession();
                });
                if (!isStructure) {
                    const exploreBtn = document.getElementById('explore-family-btn');
                    if (this.data.wordFamilies[item.familyRoot]?.length > 1) {
                         exploreBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.renderWordFamilyMindmap(item);
                        });
                    } else {
                        exploreBtn.style.display = 'none';
                    }
                }
            },

            renderWordFamilyMindmap(item) { /* Giữ nguyên từ phiên bản trước, đã ổn định */ },

            renderWordFamilyMatching(item) {
                const familyRoot = item.familyRoot;
                const familyWords = this.data.wordFamilies[familyRoot];
                if (!familyWords || familyWords.length < 2) { return this.renderNextInSession(); }

                let selected = { word: null, type: null, meaning: null, pronunciation: null };
                let matchedCount = 0;

                const renderColumns = () => {
                    const words = this.shuffleArray(familyWords.map(w => ({ text: w.word, id: w.id })));
                    const types = this.shuffleArray(familyWords.map(w => ({ text: w.type, id: w.id })));
                    const meanings = this.shuffleArray(familyWords.map(w => ({ text: w.meaning, id: w.id })));
                    const pronunciations = this.shuffleArray(familyWords.map(w => ({ text: w.pronunciation, id: w.id })));

                    const createColumn = (title, items, category) => `
                        <div class="flex-1">
                            <h4 class="font-bold text-center mb-3 text-slate-600">${title}</h4>
                            <div class="flex flex-col gap-2" data-category="${category}">
                                ${items.map(i => `<button data-id="${i.id}" class="answer-option p-3 rounded-lg text-sm text-center">${i.text}</button>`).join('')}
                            </div>
                        </div>`;
                    
                    document.getElementById('main-content').innerHTML = `
                        <div class="fade-in">
                            <div class="flex justify-between items-center mb-4">
                               <h3 class="text-xl font-bold text-slate-800">Word Family Matching</h3>
                               <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                            </div>
                            <p class="text-center text-slate-500 mb-6">Nối các mục ở 4 cột để tạo thành các từ đúng trong họ từ "${familyRoot}".</p>
                            <div class="card glass-panel">
                               <div class="flex flex-col sm:flex-row gap-4">
                                    ${createColumn('Từ vựng', words, 'word')}
                                    ${createColumn('Loại từ', types, 'type')}
                                    ${createColumn('Nghĩa', meanings, 'meaning')}
                                    ${createColumn('Phiên âm', pronunciations, 'pronunciation')}
                                </div>
                                <div id="feedback-placeholder" class="text-center mt-6"></div>
                            </div>
                        </div>`;
                    document.querySelectorAll('.answer-option').forEach(btn => btn.onclick = (e) => handleFamilySelection(e.target));
                };
                
                const handleFamilySelection = (selectedButton) => {
                    const category = selectedButton.parentElement.dataset.category;
                    selectedButton.parentElement.querySelectorAll('.answer-option').forEach(btn => btn.classList.remove('selected'));
                    selectedButton.classList.add('selected');
                    selected[category] = selectedButton;
                    if (Object.values(selected).every(val => val !== null)) checkFamilyMatch();
                };

                const checkFamilyMatch = () => {
                    const selectedWordId = selected.word.dataset.id;
                    const isCorrect = Object.values(selected).every(btn => btn.dataset.id === selectedWordId);
                    const selectedButtons = Object.values(selected);
                    
                    this.updateProgress(selectedWordId, isCorrect);
                    
                    if (isCorrect) {
                        matchedCount++;
                        selectedButtons.forEach(btn => {
                             btn.classList.add('correct');
                             btn.classList.remove('selected');
                             btn.disabled = true; 
                        });
                        if (matchedCount === familyWords.length) {
                             this.showFeedback(true, `Hoàn hảo! Bạn đã ghép đúng cả họ từ.`);
                        }
                    } else {
                        selectedButtons.forEach(btn => btn.classList.add('incorrect'));
                        setTimeout(() => selectedButtons.forEach(btn => btn.classList.remove('incorrect', 'selected')), 1000);
                    }
                    selected = { word: null, type: null, meaning: null, pronunciation: null };
                };

                renderColumns();
            },
            
            renderTraditionalMCQ(item) {
                const isEngToViet = Math.random() > 0.5;
                const question = isEngToViet ? item.word : item.meaning;
                const correctAnswer = isEngToViet ? item.meaning : item.word;
                this.data.currentCorrectAnswer = correctAnswer;
                
                const distractorPool = isEngToViet 
                    ? (item.distractors_vi || this.data.words.map(w => w.meaning))
                    : (item.distractors_en || this.data.words.map(w => w.word));
                const distractors = this.shuffleArray(distractorPool.filter(d => d !== correctAnswer)).slice(0, 3);
                const options = this.shuffleArray([correctAnswer, ...distractors]);
                
                this.renderMCQBase('Traditional MCQ', question, options);
            },
            
            renderContextualMCQ(item) {
                if (!item.exampleSentence) { return this.renderNextInSession(); }
                const question = item.exampleSentence.replace(new RegExp(`\\b${item.word}\\b`, 'gi'), '<strong class="text-2xl">____</strong>');
                this.data.currentCorrectAnswer = item.word;
                let distractors = [];
                distractors.push(...this.shuffleArray((this.data.wordFamilies[item.familyRoot] || []).filter(w => w.id !== item.id).map(w => w.word)).slice(0,1));
                distractors.push(...(item.distractors_en || []));
                if (distractors.length < 3) {
                    distractors.push(...this.shuffleArray(this.data.words.filter(w => w.type === item.type && w.id !== item.id).map(w => w.word)));
                }
                const finalDistractors = this.shuffleArray([...new Set(distractors.filter(d => d !== item.word))]).slice(0, 3);
                const options = this.shuffleArray([item.word, ...finalDistractors]);
                this.renderMCQBase('Contextual MCQ', question, options);
            },

            renderAudioListening(item) {
                if (typeof SpeechSynthesisUtterance === "undefined") {
                    this.showCustomAlert("Trình duyệt không hỗ trợ API âm thanh.", 'error');
                    return this.renderNextInSession();
                }
                this.data.currentCorrectAnswer = item.word;
                const distractors = this.shuffleArray(this.data.words.filter(w => w.id !== item.id).map(w => w.word)).slice(0, 3);
                const options = this.shuffleArray([item.word, ...distractors]);
                this.renderMCQBase('Audio Listening', 'Nghe và chọn từ đúng.', options, `
                    <button id="play-audio-btn" class="btn btn-secondary mx-auto mb-6">
                        <i class="fas fa-volume-up text-xl"></i> Phát âm
                    </button>
                `);
                const utterance = new SpeechSynthesisUtterance(item.word);
                utterance.lang = 'en-US';
                document.getElementById('play-audio-btn').onclick = () => window.speechSynthesis.speak(utterance);
            },
            
            renderPronunciationMatch(item) {
                if (!item.pronunciation) { return this.renderNextInSession(); }
                this.data.currentCorrectAnswer = item.pronunciation;
                const distractors = this.shuffleArray(this.data.words.filter(w => w.id !== item.id && w.pronunciation).map(w => w.pronunciation)).slice(0, 3);
                if (distractors.length < 3) { return this.renderNextInSession(); } // Not enough data
                const options = this.shuffleArray([item.pronunciation, ...distractors]);
                this.renderMCQBase('Pronunciation Match', `<p class="text-2xl font-bold">${item.word}</p>`, options);
            },

            renderSentenceUnscramble(item) { /* Giữ nguyên từ phiên bản trước, đã ổn định */ },

            renderTriosOfGappedSentence(item) {
                const keyword = item.word;
                let sentences = [item.exampleSentence];
                // Tìm thêm 2 câu khác chứa keyword
                this.data.words.forEach(word => {
                    if (sentences.length >= 3) return;
                    if (word.id !== item.id && word.exampleSentence?.includes(keyword)) {
                        sentences.push(word.exampleSentence);
                    }
                });
                if (sentences.length < 3) { // Không đủ 3 câu, bỏ qua bài này
                    return this.renderNextInSession();
                }
                this.data.currentCorrectAnswer = keyword;
                const questionHTML = sentences.map(s => 
                    `<p class="text-lg leading-relaxed my-2">... ${s.replace(new RegExp(`\\b${keyword}\\b`, 'gi'), '_____')} ...</p>`
                ).join('');

                this.renderInputBase(
                    'Trios of Gapped Sentence', 
                    questionHTML, 
                    'Một từ duy nhất có thể điền vào cả 3 chỗ trống dưới đây. Đó là từ gì?',
                    () => {
                        const userAnswer = document.getElementById('user-input').value.trim();
                        this.data.wasCorrect = userAnswer.toLowerCase() === this.data.currentCorrectAnswer.toLowerCase();
                        this.updateProgress(item.id, this.data.wasCorrect);
                        this.showFeedback(this.data.wasCorrect);
                    }
                );
            },

            renderGapFill(item) { /* Giữ nguyên từ phiên bản trước, đã ổn định */ },
            renderFindAndFixError(item) { /* Giữ nguyên từ phiên bản trước, đã ổn định */ },
            renderCorrectIncorrectSentence(item) { /* Giữ nguyên từ phiên bản trước, đã ổn định */ },
            
            // --- [END] EXERCISE RENDERERS ---

            // --- [START] RENDER HELPERS ---
            
            renderMCQBase(title, questionHTML, options, preQuestionHTML = '') {
                const main = document.getElementById('main-content');
                main.innerHTML = `
                    <div class="fade-in text-center">
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-xl font-bold text-slate-800">${title}</h3>
                           <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                        </div>
                        <div class="card glass-panel">
                           ${preQuestionHTML}
                           <div class="mb-8 text-xl font-semibold min-h-[60px] flex items-center justify-center">${questionHTML}</div>
                           <div id="answer-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             ${options.map(opt => `<button class="answer-option p-4">${opt}</button>`).join('')}
                           </div>
                           <div id="feedback-placeholder" class="text-center mt-6"></div>
                        </div>
                    </div>`;

                document.getElementById('answer-options').addEventListener('click', e => {
                    if (e.target.matches('.answer-option:not(.disabled)')) {
                        const selectedOption = e.target;
                        this.data.wasCorrect = selectedOption.textContent.trim() === this.data.currentCorrectAnswer.trim();
                        this.updateProgress(this.data.sessionItems[this.data.currentSessionIndex].id, this.data.wasCorrect);
                        
                        document.querySelectorAll('.answer-option').forEach(btn => {
                            btn.classList.add('disabled');
                            if(btn.textContent.trim() === this.data.currentCorrectAnswer.trim()){
                                btn.classList.add('correct');
                            }
                        });

                        if (!this.data.wasCorrect) {
                            selectedOption.classList.add('incorrect');
                        }
                        this.showFeedback(this.data.wasCorrect);
                    }
                });
            },

            renderInputBase(title, questionHTML, instruction, onCheck, inputHTML = null) { /* Giữ nguyên, đã ổn định */ },

            showFeedback(isCorrect, customMessage = null) {
                const feedbackPlaceholder = document.getElementById('feedback-placeholder');
                if(!feedbackPlaceholder) return;
                let messageHTML;
                if (customMessage) {
                    messageHTML = `<p class="${isCorrect ? 'text-green-600' : 'text-red-600'} dark:text-${isCorrect ? 'green-400' : 'red-400'} font-bold text-lg">${customMessage}</p>`;
                } else {
                    if (isCorrect) {
                        messageHTML = `<p class="text-green-600 dark:text-green-400 font-bold text-lg">Chính xác! <i class="fas fa-check-circle"></i></p>`;
                    } else {
                        messageHTML = `<p class="text-red-600 dark:text-red-400 font-bold text-lg">Chưa đúng! <i class="fas fa-times-circle"></i> Đáp án là: <strong class="underline">${this.data.currentCorrectAnswer}</strong></p>`;
                    }
                }
                
                feedbackPlaceholder.innerHTML = `
                    <div class="fade-in">
                        ${messageHTML}
                        <button id="next-session-btn" class="btn btn-main-action mt-4">Tiếp tục</button>
                    </div>
                `;

                document.getElementById('next-session-btn').onclick = () => {
                    this.data.currentSessionIndex++;
                    this.renderNextInSession(); 
                };
            },

            showSessionEndSummary() { /* Giữ nguyên, đã ổn định */ },

            // --- UTILITY & HELPER FUNCTIONS ---
            showErrorState(message) { /* Giữ nguyên, đã ổn định */ },
            initSidebarNav() { /* Giữ nguyên, đã ổn định */ },
            setActiveNav(navId) { document.querySelectorAll('.sidebar-nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(navId)?.classList.add('active'); },
            updateHeader(title, subtitle) { document.getElementById('app-title').textContent = title; document.getElementById('app-subtitle').textContent = subtitle; },
            initModals() { /* Giữ nguyên, đã ổn định */ },
            openModal(id) { document.getElementById(id)?.classList.add('is-open'); },
            closeModal(id) { const m = document.getElementById(id); if(m) { m.classList.add('is-closing'); setTimeout(() => m.classList.remove('is-open', 'is-closing'), 300); } },
            showFilteredList(listType) { /* Giữ nguyên, đã ổn định */ },
            showCustomAlert(message, type = 'info') {
                const alertId = 'custom-alert-box';
                document.getElementById(alertId)?.remove();
                const alertBox = document.createElement('div');
                const colors = {
                    info: 'text-violet-800 dark:text-violet-200',
                    success: 'text-green-800 dark:text-green-200',
                    error: 'text-red-800 dark:text-red-200',
                };
                alertBox.id = alertId;
                alertBox.className = `glass-panel ${colors[type]}`;
                alertBox.style.cssText = `position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:16px 24px; border-radius:16px; z-index:200; font-weight:600; animation:fadeIn 0.5s ease forwards; box-shadow: 0 5px 20px rgba(0,0,0,0.2);`;
                alertBox.innerHTML = message;
                document.body.appendChild(alertBox);
                setTimeout(() => { alertBox.style.animation = 'scaleOut 0.5s ease forwards'; setTimeout(() => alertBox.remove(), 500); }, 3000);
            },
            showCustomConfirm(message, onConfirm, confirmText = 'Yes', cancelText = 'Cancel') { /* Giữ nguyên, đã ổn định */ },
            shuffleArray(array) { 
                const a = [...array];
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
