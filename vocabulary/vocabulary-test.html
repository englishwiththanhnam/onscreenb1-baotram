<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Practice Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- COPY FROM ORIGINAL TEMPLATE: HIGH-CONTRAST LIGHT & DARK THEME --- */
        :root {
            --blur-intensity: 12px;
            --saturation-intensity: 150%;
            --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6);
            --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --app-bg-start: #f5f7ff;
            --app-bg-end: #e0e7ff;
        }

        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25);
            --primary-accent: #a78bfa;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --app-bg-start: #0f172a;
            --app-bg-end: #1e293b;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--app-bg-start);
            background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }
        
        body.sidebar-open {
            overflow: hidden;
        }
        
        /* --- ANTI-COPY/PASTE --- */
        .no-select {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }

        .background-shapes {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            filter: blur(15px);
            transition: opacity 0.5s ease;
        }

        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; animation: float 28s infinite alternate ease-in-out; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation: float 32s infinite alternate ease-in-out; }
        .shape3 { width: 120px; height: 120px; background: linear-gradient(135deg, #a78bfa, #c4b5fd); top: 20%; right: 25%; animation: float 24s infinite alternate ease-in-out; }
        .shape4 { width: 80px; height: 80px; background: linear-gradient(135deg, #93c5fd, #bfdbfe); bottom: 5%; left: 30%; animation: float 20s infinite alternate ease-in-out; }

        body.dark .shape {
            opacity: 0.4;
        }

        @keyframes float {
            from { transform: translateY(20px) scale(1) rotate(0deg); }
            to { transform: translateY(-20px) scale(1.05) rotate(20deg); }
        }

        .app-layout { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 1; transition: padding-left 0.3s ease-in-out; }

        .glass-panel {
            position: relative;
            background: var(--glass-bg-color);
            backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            border-radius: 24px;
            border: 1px solid var(--glass-border-color);
            box-shadow: 0 8px 32px 0 var(--shadow-color), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }

        .glass-panel::after {
            content: '';
            position: absolute;
            top: 0; left: -25%;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.35), transparent 60%);
            border-radius: inherit;
            filter: blur(5px);
            pointer-events: none;
            opacity: 0.8;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .card { padding: 1.5rem; }

        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 260px;
            padding: 1.5rem;
            z-index: 40;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        body.sidebar-open #sidebar {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            #sidebar {
                position: relative;
                transform: translateX(0);
                flex-shrink: 0;
            }
            .app-layout.sidebar-collapsed #sidebar {
                transform: translateX(-100%);
                margin-left: -260px;
            }
        }
        
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        body.sidebar-open #sidebar-overlay {
            opacity: 1;
            visibility: visible;
        }
        
        @media (min-width: 1024px) {
            #sidebar-overlay {
                display: none;
            }
        }

        .sidebar-nav-btn { display: flex; align-items: center; padding: 12px 16px; border-radius: 12px; font-weight: 600; color: var(--text-secondary); transition: all 0.2s ease-in-out; margin-bottom: 8px; }
        .sidebar-nav-btn i { width: 20px; margin-right: 16px; text-align: center; }
        .sidebar-nav-btn:hover { background-color: rgba(255, 255, 255, 0.4); color: var(--text-primary); transform: translateX(5px) scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sidebar-nav-btn.active { background-color: var(--primary-accent); color: white; box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3); transform: translateX(5px) scale(1.03); }
        
        body.dark .sidebar-nav-btn.active {
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
        }
        body.dark .sidebar-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }


        #app { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 1.5rem; transition: margin-left 0.3s ease-in-out; }
        @media (min-width: 1024px) {
            #app { padding: 2rem; }
        }
        #app::-webkit-scrollbar { width: 8px; }
        #app::-webkit-scrollbar-track { background: transparent; }
        #app::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.1); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        #app::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.2); }

        .main-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        #menu-toggle-btn {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; transform: translateY(0); }
        .btn-main-action { background: var(--primary-accent); color: white; border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(91, 33, 182, 0.25); }
        body.dark .btn-main-action { color: #1e293b; }
        .btn-main-action:hover { background: #5b21b6; transform: translateY(-3px); box-shadow: 0 7px 20px rgba(91, 33, 182, 0.4); }
        body.dark .btn-main-action:hover { background: #9333ea; }

        .btn-secondary { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); color: var(--text-primary); border-color: rgba(255, 255, 255, 0.6); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.7); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        body.dark .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }

        .btn:disabled { background-color: rgba(200, 200, 200, 0.7) !important; cursor: not-allowed; opacity: 0.7; transform: none !important; box-shadow: none !important; }
        body.dark .btn:disabled { background-color: rgba(71, 85, 105, 0.7) !important; }

        .answer-option {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        body.dark .answer-option {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .answer-option:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 1px rgba(255,255,255,0.3);
        }
        body.dark .answer-option:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .answer-option.selected {
            background-color: var(--primary-accent) !important;
            border-color: var(--primary-accent) !important;
            color: white !important;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 6px 20px rgba(91, 33, 182, 0.3);
        }
        body.dark .answer-option.selected {
            color: #1e293b !important;
        }

        .answer-option.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
            cursor: not-allowed;
        }
        body.dark .answer-option.correct {
            background-color: #052e16 !important;
            border-color: #16a34a !important;
            color: #a7f3d0 !important;
        }

        .answer-option.incorrect {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
            animation: shake 0.5s;
        }
        body.dark .answer-option.incorrect {
            background-color: #450a0a !important;
            border-color: #dc2626 !important;
            color: #fecaca !important;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- MODAL & POP-UP ANIMATIONS --- */
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes scaleOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.2); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            align-items: center; 
            justify-content: center; 
        }
        .modal.is-open {
            display: flex;
        }
        .modal-content { 
            padding: 24px; 
            width: 90%; 
            max-width: 500px; 
            animation: scaleIn 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        .modal.is-closing .modal-content {
            animation: scaleOut 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-between; align-items: center; }
        .close-button { color: #eee; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .close-button:hover { color: white; }

        #word-table th { position: sticky; top: 0; background: rgba(248, 250, 252, 0.85); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 10; }
        body.dark #word-table th { background: rgba(30, 41, 59, 0.85); }
        body.dark #word-table td, body.dark #word-table th { color: var(--text-primary); }


        .dashboard-stat-card { transition: all 0.3s ease; }
        .dashboard-stat-card:hover { transform: translateY(-5px) scale(1.03); }

        .matching-column { display: flex; flex-direction: column; gap: 0.5rem; }

        .flashcard-container { perspective: 1000px; height: 300px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction:column; align-items: center; justify-content: center; border-radius: 16px; padding: 20px; text-align: center; }
        .flashcard-front { background-color: rgba(255, 255, 255, 0.8); }
        body.dark .flashcard-front { background-color: rgba(51, 65, 85, 0.8); }
        .flashcard-back { background-color: rgba(230, 230, 255, 0.9); transform: rotateY(180deg); }
        body.dark .flashcard-back { background-color: rgba(71, 85, 105, 0.9); }
        .flashcard-front p { color: var(--primary-accent); }
        .flashcard-back p:first-child { color: #16a34a; }
        
        input[type="text"], input[type="number"] { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); border: 1px solid rgba(255, 255, 255, 0.5); color: var(--text-primary); transition: all 0.2s ease-in-out; }
        input[type="text"]:focus, input[type="number"]:focus { background: rgba(255, 255, 255, 0.7); border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3); outline: none; }
        body.dark input[type="text"], body.dark input[type="number"] { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        body.dark input[type="text"]:focus, body.dark input[type="number"]:focus { background: rgba(255, 255, 255, 0.2); border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.3); }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1rem; }
        body.dark .progress-bar { background-color: #4b5563; }
        .progress-bar-inner { background-color: var(--primary-accent); height: 100%; transition: width 0.5s ease-in-out; }

        /* --- DARK MODE TEXT COLOR FIXES --- */
        body.dark .text-slate-800,
        body.dark .text-slate-700,
        body.dark .text-violet-800 { 
            color: var(--text-primary); 
        }
        body.dark .text-slate-600 { color: var(--text-secondary); }
        body.dark .text-green-800 { color: #4ade80; }
        body.dark .text-red-800 { color: #f87171; }
        body.dark .text-blue-800 { color: #60a5fa; }
        body.dark .text-yellow-800 { color: #facc15; }
        body.dark .text-green-800\/80, body.dark .text-red-800\/80, body.dark .text-blue-800\/80, body.dark .text-yellow-800\/80 { opacity: 0.8; }
        body.dark .text-red-500 { color: #ef4444; }
        body.dark .hover\:bg-red-100:hover { --tw-bg-opacity: 1; background-color: rgb(220 38 38 / 0.2); }
        body.dark .hover\:text-red-700:hover { color: #ef4444; }

    </style>
</head>
<body>
    <div class="background-shapes">
        <div class="shape shape1"></div>
        <div class="shape shape2"></div>
        <div class="shape shape3"></div>
        <div class="shape shape4"></div>
    </div>

    <div id="loader-overlay" class="modal is-open">
        <div class="text-center">
            <div class="w-16 h-16 border-8 border-t-violet-500 border-gray-200 rounded-full animate-spin"></div>
            <p id="loader-text" class="text-lg font-semibold text-white mt-4">Đang tải dữ liệu...</p>
        </div>
    </div>

    <div class="app-layout" style="visibility: hidden;">
        <nav id="sidebar" class="glass-panel">
            <div>
                <div class="text-center mb-10">
                    <h1 id="sidebar-title" class="text-2xl font-bold text-slate-800">Vocab App</h1>
                    <p class="text-sm text-slate-600">by Thành Nam</p>
                </div>
                <div id="sidebar-nav" class="flex-grow">
                    <button id="nav-dashboard" class="sidebar-nav-btn active"><i class="fas fa-chart-pie"></i> Dashboard</button>
                    <button id="nav-study" class="sidebar-nav-btn"><i class="fas fa-book-open"></i> Study</button>
                    <button id="nav-practice" class="sidebar-nav-btn"><i class="fas fa-dumbbell"></i> Practice</button>
                    <button id="nav-test" class="sidebar-nav-btn"><i class="fas fa-graduation-cap"></i> Test</button>
                </div>
            </div>
            <div class="mt-auto">
                 <div class="pt-4 border-t border-white/20">
                    <button id="theme-toggle-btn" class="sidebar-nav-btn w-full">
                        <i id="theme-toggle-icon" class="fas fa-moon"></i>
                        <span id="theme-toggle-text">Dark Mode</span>
                    </button>
                </div>
                 <button id="nav-reset" class="sidebar-nav-btn w-full justify-center text-red-500 hover:bg-red-100 hover:text-red-700">
                     <i class="fas fa-trash-alt mr-2"></i> Reset Progress
                 </button>
            </div>
        </nav>
        
        <div id="sidebar-overlay"></div>

        <main id="app">
             <header class="main-header">
                 <button id="menu-toggle-btn">
                     <i class="fas fa-bars text-xl"></i>
                 </button>
                 <div class="text-left">
                     <h1 id="app-title" class="text-3xl lg:text-4xl font-bold text-slate-800">Dashboard</h1>
                     <p id="app-subtitle" class="text-slate-600 mt-1 lg:mt-2">Welcome back! Here's your learning progress.</p>
                 </div>
             </header>
             <div id="main-content">
                <!-- Content will be rendered by JavaScript -->
             </div>
        </main>
    </div>

    <div id="word-list-modal" class="modal">
        <div class="modal-content glass-panel" style="max-width: 1200px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header pb-4 mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800">List</h2>
                <span id="close-word-modal-btn" class="close-button">&times;</span>
            </div>
            <div id="word-table-container" class="overflow-y-auto flex-grow">
                <table id="word-table" class="w-full text-sm text-left text-slate-700">
                </table>
            </div>
        </div>
    </div>
    <div id="test-setup-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header pb-4 mb-4">
                <h2 class="text-2xl font-bold text-slate-800">Test Setup</h2>
                <span id="close-test-modal-btn" class="close-button">&times;</span>
            </div>
            <div>
                <label for="question-count" class="block mb-2 font-medium text-slate-700">Number of questions:</label>
                <input type="number" id="question-count" class="w-full p-2 rounded-lg" min="5" max="100" value="10">
                <div class="mt-6">
                    <button id="start-test-fixed-btn" class="btn btn-main-action w-full">Start with selected count</button>
                    <button id="start-test-all-btn" class="btn btn-secondary w-full mt-3">Test all items</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // --- App Object: Main container for state and methods ---
        const App = {
            // --- STATE MANAGEMENT ---
            data: {
                db: null, // Firestore instance
                submissionId: null, // ID from URL, e.g., "ABCDEF"
                testId: null, // ID of the vocab set, e.g., "unit_1_family"
                
                words: [], // Full list of word objects from Firebase
                structures: [], // Full list of structure objects, parsed from words
                wordFamilies: {}, // Grouped word families
                
                progress: { // Student's progress, loaded from and saved to Firebase
                    learnedItems: {}, // { "word_1": true, "structure_s_1_0": true }
                    lastTestResult: null, // { score, total, percentage, date }
                    incorrectCounts: {} // { "word_15": 3, "structure_s_20_1": 5 }
                },
                
                // Session-specific state
                sessionItems: [], // Shuffled items for the current practice/test
                currentSessionIndex: 0,
                mode: null, // e.g., 'vocab', 'structure', 'test'
                testTimer: null,
                incorrectTestAnswers: [],
            },

            // --- INITIALIZATION ---
            async init() {
                this.initTheme();
                this.initResponsiveSidebar();
                
                try {
                    this.data.submissionId = this.getSubmissionIdFromUrl();
                    
                    const firebaseConfig = {
                        apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
                        authDomain: "b1-baotram.firebaseapp.com",
                        projectId: "b1-baotram",
                        storageBucket: "b1-baotram.appspot.com",
                        messagingSenderId: "948701163187",
                        appId: "1:948701163187:web:043f2d381d63e741114ac6"
                    };
                    const firebaseApp = initializeApp(firebaseConfig);
                    this.data.db = getFirestore(firebaseApp);

                    await this.loadDataFromFirebase();
                    
                    this.initAntiCopy();
                    this.initModals();
                    this.initSidebarNav();
                    this.renderDashboard();

                    document.querySelector('.app-layout').style.visibility = 'visible';
                    document.getElementById('loader-overlay').classList.remove('is-open');

                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.showErrorState(error.message);
                }
            },
            
            getSubmissionIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('submission_id');
                if (!id) {
                    throw new Error("Mã truy cập không hợp lệ. Vui lòng truy cập từ cổng chính.");
                }
                return id;
            },

            async loadDataFromFirebase() {
                const db = this.data.db;
                const submissionId = this.data.submissionId;

                const submissionRef = doc(db, "submissions", submissionId);
                const submissionSnap = await getDoc(submissionRef);

                if (!submissionSnap.exists()) {
                    throw new Error("Không tìm thấy bài làm với mã truy cập này.");
                }
                
                const submissionData = submissionSnap.data();
                this.data.testId = submissionData.testId;
                if (submissionData.progress) {
                    this.data.progress = submissionData.progress;
                    // Ensure progress sub-objects exist
                    this.data.progress.learnedItems = this.data.progress.learnedItems || {};
                    this.data.progress.incorrectCounts = this.data.progress.incorrectCounts || {};
                }

                const vocabSetRef = doc(db, "vocab_sets", this.data.testId);
                const vocabSetSnap = await getDoc(vocabSetRef);

                if (!vocabSetSnap.exists()) {
                    throw new Error("Không tìm thấy bộ từ vựng tương ứng.");
                }
                
                const vocabSetData = vocabSetSnap.data();
                document.title = vocabSetData.title || "Vocabulary Practice";
                document.getElementById('sidebar-title').textContent = vocabSetData.title;

                this.data.words = vocabSetData.wordList || [];
                this.groupWordFamilies();
                this.parseAndStoreStructures();
                this.applyUserProgress();
            },
            
            applyUserProgress() {
                const learnedItems = this.data.progress.learnedItems || {};
                this.data.words.forEach(word => {
                    word.isLearned = !!learnedItems[`word_${word.id}`];
                });
                this.data.structures.forEach(structure => {
                    structure.isLearned = !!learnedItems[`structure_${structure.id}`];
                });
            },

            async saveProgressToFirebase() {
                if (!this.data.submissionId || !this.data.db) return;
                const progressPayload = { progress: this.data.progress, lastAccessed: serverTimestamp() };
                try {
                    const submissionRef = doc(this.data.db, "submissions", this.data.submissionId);
                    await setDoc(submissionRef, progressPayload, { merge: true });
                } catch (error) {
                    console.error("Error saving progress:", error);
                    this.showCustomAlert("Lỗi: Không thể lưu tiến trình.");
                }
            },
            
            // --- UI & THEME ---
            initTheme() {
                const themeToggleBtn = document.getElementById('theme-toggle-btn');
                const themeToggleIcon = document.getElementById('theme-toggle-icon');
                const themeToggleText = document.getElementById('theme-toggle-text');
                const body = document.body;
                const applyTheme = (theme) => {
                    if (theme === 'dark') {
                        body.classList.add('dark');
                        themeToggleIcon.className = 'fas fa-sun';
                        themeToggleText.textContent = 'Light Mode';
                    } else {
                        body.classList.remove('dark');
                        themeToggleIcon.className = 'fas fa-moon';
                        themeToggleText.textContent = 'Dark Mode';
                    }
                };
                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);
                themeToggleBtn.addEventListener('click', () => {
                    const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            },

            initResponsiveSidebar() {
                const menuToggleBtn = document.getElementById('menu-toggle-btn');
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                const appLayout = document.querySelector('.app-layout');
                const toggleSidebar = () => {
                    if (window.innerWidth < 1024) {
                        document.body.classList.toggle('sidebar-open');
                    } else {
                        appLayout.classList.toggle('sidebar-collapsed');
                    }
                };
                menuToggleBtn?.addEventListener('click', toggleSidebar);
                sidebarOverlay?.addEventListener('click', toggleSidebar);
                document.querySelectorAll('#sidebar-nav .sidebar-nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (window.innerWidth < 1024) document.body.classList.remove('sidebar-open');
                    });
                });
            },
            
            initAntiCopy() {
                ['contextmenu', 'copy', 'cut', 'paste'].forEach(event => {
                    document.body.addEventListener(event, e => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        e.preventDefault();
                        this.showCustomAlert("Chức năng này đã bị vô hiệu hóa.");
                        return false;
                    });
                });
            },

            // --- CORE APP LOGIC ---
            groupWordFamilies() {
                const families = {};
                this.data.words.forEach(word => {
                    const root = word.word.split(/[\s-]/)[0].toLowerCase().replace(/[^a-z]/g, '');
                    if (!families[root]) families[root] = [];
                    if (!families[root].includes(word.id)) families[root].push(word.id);
                    word.familyRoot = root;
                });
                this.data.wordFamilies = families;
            },
            
            parseAndStoreStructures() {
                this.data.structures = [];
                this.data.words.forEach(word => {
                    if (word.structures && Array.isArray(word.structures)) {
                        word.structures.forEach((struct, s_idx) => {
                            const structureId = `s_${word.id}_${s_idx}`;
                            this.data.structures.push({
                                id: structureId,
                                rootWordId: word.id,
                                fullStructure: struct.phrase,
                                translation: struct.meaning,
                                applicationExamples: struct.applicationExamples || [],
                                isLearned: false,
                            });
                        });
                    }
                });
            },
            
            findChallengingDistractors(correctItem, count = 3, questionDirection = 'eng_to_vie') {
                const isVieToEng = questionDirection === 'vie_to_eng';
                const aiDistractors = isVieToEng ? correctItem.distractors_en : correctItem.distractors_vi;
                if (aiDistractors && aiDistractors.length > 0) {
                    return this.shuffleArray([...aiDistractors]).slice(0, count);
                }
                let distractors = new Set();
                const correctItemType = correctItem.type.split('/')[0];
                this.data.words.forEach(word => {
                    if (distractors.size < count && word.id !== correctItem.id && word.type.includes(correctItemType)) {
                        distractors.add(isVieToEng ? word.word : word.meaning);
                    }
                });
                while(distractors.size < count) {
                    const randomWord = this.shuffleArray(this.data.words)[0];
                    if (randomWord && randomWord.id !== correctItem.id) {
                         distractors.add(isVieToEng ? randomWord.word : randomWord.meaning);
                    } else if (this.data.words.length <= count) {
                        break;
                    }
                }
                return this.shuffleArray([...distractors]);
            },

            updateProgress(itemId, itemType, isCorrect) {
                const progressKey = `${itemType}_${itemId}`;
                const incorrectCounts = this.data.progress.incorrectCounts || {};

                if (isCorrect) {
                    this.data.progress.learnedItems[progressKey] = true;
                    // Reset incorrect count on correct answer
                    if (incorrectCounts[progressKey]) {
                        delete incorrectCounts[progressKey];
                    }
                } else {
                    incorrectCounts[progressKey] = (incorrectCounts[progressKey] || 0) + 1;
                }
                this.data.progress.incorrectCounts = incorrectCounts;
                this.saveProgressToFirebase();
            },

            // --- UI RENDERING ---
            renderDashboard() {
                this.setActiveNav('nav-dashboard');
                this.updateHeader('Dashboard', "Welcome back! Here's your learning progress.");
                const main = document.getElementById('main-content');
                
                const wordsLearned = this.data.words.filter(w => w.isLearned).length;
                const totalWords = this.data.words.length;
                const wordProgress = totalWords > 0 ? (wordsLearned / totalWords) * 100 : 0;

                const structuresLearned = this.data.structures.filter(s => s.isLearned).length;
                const totalStructures = this.data.structures.length;
                const structureProgress = totalStructures > 0 ? (structuresLearned / totalStructures) * 100 : 0;
                
                const lastTest = this.data.progress.lastTestResult;
                let testResultHTML = `<p class="text-slate-600">Chưa có bài kiểm tra nào.</p>`;
                if (lastTest && lastTest.date) {
                    const testDate = new Date(lastTest.date).toLocaleDateString('vi-VN');
                    testResultHTML = `
                        <p class="text-2xl font-bold text-violet-800">${lastTest.score}/${lastTest.total} (${lastTest.percentage}%)</p>
                        <p class="text-sm text-slate-600">Làm ngày: ${testDate}</p>
                    `;
                }

                main.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold text-slate-800 mb-3">Tiến độ Từ vựng</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${wordsLearned} / ${totalWords}</span><span class="text-sm font-medium">${wordProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${wordProgress}%;"></div></div>
                            <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold text-slate-800 mb-3">Tiến độ Cấu trúc</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${structuresLearned} / ${totalStructures}</span><span class="text-sm font-medium">${structureProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${structureProgress}%;"></div></div>
                             <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel lg:col-span-2">
                             <h3 class="text-xl font-bold text-slate-800 mb-2">Kết quả kiểm tra gần nhất</h3>
                             ${testResultHTML}
                        </div>
                    </div>
                `;
                main.querySelectorAll('[data-list-type]').forEach(button => {
                    button.addEventListener('click', (e) => this.showFilteredList(e.currentTarget.dataset.listType));
                });
            },
            
            renderSelectionScreen(mode) {
                this.setActiveNav(mode === 'study' ? 'nav-study' : 'nav-practice');
                this.updateHeader(mode.charAt(0).toUpperCase() + mode.slice(1), `Chọn nội dung bạn muốn ${mode}.`);
                const main = document.getElementById('main-content');
                main.innerHTML = `
                    <div class="fade-in">
                        <div class="mb-4">
                            <button id="back-to-dashboard-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Dashboard</button>
                        </div>
                        <div class="card glass-panel text-center">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Bạn muốn ${mode} gì?</h2>
                            <div class="flex flex-wrap justify-center gap-4">
                                <button id="select-vocab-btn" class="btn btn-main-action"><i class="fas fa-book"></i> Từ vựng</button>
                                <button id="select-structure-btn" class="btn btn-main-action"><i class="fas fa-sitemap"></i> Cấu trúc</button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('select-vocab-btn').addEventListener('click', () => this.renderModeSelection(mode, 'vocab'));
                document.getElementById('select-structure-btn').addEventListener('click', () => this.renderModeSelection(mode, 'structure'));
            },

            renderModeSelection(mode, type) {
                const typeText = type === 'vocab' ? 'Từ vựng' : 'Cấu trúc';
                this.updateHeader(mode.charAt(0).toUpperCase() + mode.slice(1), `Chọn hình thức ${mode} cho ${typeText}.`);
                const main = document.getElementById('main-content');
                let buttonsHTML = '';

                if (mode === 'study') {
                     buttonsHTML = type === 'vocab' ? `
                        <button data-mode="Flashcard" class="btn btn-main-action"><i class="fas fa-clone"></i> Flashcards 2.0</button>
                        <button data-mode="Word Family Explorer" class="btn btn-main-action"><i class="fas fa-project-diagram"></i> Khám phá Họ từ</button>
                     ` : `
                        <button data-mode="Structure Flashcard" class="btn btn-main-action"><i class="fas fa-clone"></i> Flashcards</button>
                     `;
                } else { // Practice mode
                    const practiceTypes = type === 'vocab' ? 
                        ['Word Family Matching', 'Contextual MCQ', 'Sentence Unscramble', 'Traditional MCQ', 'Reverse Distractor', 'Contextual Clue'] :
                        ['Gap-Fill', 'Correct/Incorrect Sentence', 'Example Match-Up', 'Structure Building'];
                    
                    buttonsHTML = practiceTypes.map(pType => `<button data-mode="${pType}" class="btn btn-main-action">${pType}</button>`).join('');
                }

                main.innerHTML = `
                     <div class="fade-in">
                         <div class="mb-4">
                             <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                         </div>
                         <div class="card glass-panel text-center">
                             <h2 class="text-2xl font-bold text-slate-800 mb-6">Chọn hình thức ${mode}: ${typeText}</h2>
                             <div class="flex flex-wrap justify-center gap-4">
                                ${buttonsHTML}
                             </div>
                         </div>
                     </div>
                `;
                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen(mode));
                main.querySelectorAll('[data-mode]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.startSession(e.currentTarget.dataset.mode));
                });
            },

            // --- SESSION & EXERCISE LOGIC ---
            startSession(mode) {
                this.data.mode = mode;
                let items;
                
                const isStudy = ['Flashcard', 'Word Family Explorer', 'Structure Flashcard'].includes(mode);
                const isStructureMode = ['Structure Flashcard', 'Gap-Fill', 'Correct/Incorrect Sentence', 'Example Match-Up', 'Structure Building'].includes(mode);

                if (isStudy) {
                    items = isStructureMode ? this.data.structures : this.data.words;
                } else {
                    items = isStructureMode ? this.data.structures.filter(s => !s.isLearned) : this.data.words.filter(w => !w.isLearned);
                }
                
                if (items.length === 0) {
                    this.showCustomAlert("Chúc mừng! Bạn đã học hết các mục trong phần này.");
                    this.renderDashboard();
                    return;
                }
                
                this.data.sessionItems = this.shuffleArray(items);
                this.data.currentSessionIndex = 0;
                this.renderNextInSession();
            },

            renderNextInSession() {
                if (this.data.currentSessionIndex >= this.data.sessionItems.length) {
                    this.showCustomAlert("Bạn đã hoàn thành vòng luyện tập!");
                    this.renderSelectionScreen('practice');
                    return;
                }
                const item = this.data.sessionItems[this.data.currentSessionIndex++];
                if (!item) { this.renderNextInSession(); return; }

                // Main router for rendering exercises
                switch(this.data.mode) {
                    case 'Flashcard': this.renderFlashcard(item); break;
                    case 'Structure Flashcard': this.renderFlashcard(item, true); break;
                    case 'Word Family Matching': this.renderWordFamilyMatching(item); break;
                    case 'Contextual MCQ': this.renderContextualMCQ(item); break;
                    case 'Sentence Unscramble': this.renderSentenceUnscramble(item); break;
                    case 'Traditional MCQ': this.renderTraditionalMCQ(item); break;
                    case 'Reverse Distractor': this.renderReverseDistractor(item); break;
                    case 'Contextual Clue': this.renderContextualClue(item); break;
                    case 'Gap-Fill': this.renderGapFill(item); break;
                    case 'Correct/Incorrect Sentence': this.renderCorrectIncorrect(item); break;
                    case 'Example Match-Up': this.renderExampleMatchUp(item); break;
                    case 'Structure Building': this.renderStructureBuilding(item); break;
                    default: this.renderTraditionalMCQ(item);
                }
            },
            
            // --- EXERCISE RENDERERS ---
            renderFlashcard(item, isStructure = false) {
                this.updateHeader('Study', isStructure ? 'Structure Flashcard' : 'Vocabulary Flashcard');
                const main = document.getElementById('main-content');
                
                const frontHTML = isStructure ? `<p class="text-3xl font-bold text-center">${item.fullStructure}</p>` : `<p class="text-4xl font-bold">${item.word}</p>`;
                const backHTML = isStructure ? `
                    <div>
                        <p class="text-2xl font-semibold text-center">${item.translation}</p>
                        <p class="text-sm text-slate-600 mt-2 text-center">${item.applicationExamples[0] || ''}</p>
                    </div>
                ` : `
                    <div>
                        <p class="text-2xl font-semibold">${item.meaning}</p>
                        <p class="text-lg text-slate-600 mt-2">${item.pronunciation} - (${item.type})</p>
                        <p class="text-sm text-slate-500 italic mt-4">"${item.exampleSentence}"</p>
                    </div>
                `;

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                            <div class="text-lg font-semibold text-slate-800">${this.data.currentSessionIndex} / ${this.data.sessionItems.length}</div>
                            <button id="next-btn" class="btn btn-main-action">Next <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                        <div class="card glass-panel">
                            <div class="flashcard-container">
                                <div class="flashcard" id="flashcard">
                                    <div class="flashcard-face flashcard-front">${frontHTML}</div>
                                    <div class="flashcard-face flashcard-back">${backHTML}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen('study'));
                document.getElementById('flashcard').addEventListener('click', (e) => e.currentTarget.classList.toggle('is-flipped'));
                document.getElementById('next-btn').addEventListener('click', () => this.renderNextInSession());
            },

            renderTraditionalMCQ(item) {
                const isVieToEng = Math.random() > 0.5;
                const questionText = isVieToEng ? item.meaning : item.word;
                const correctAnswer = isVieToEng ? item.word : item.meaning;
                const wrongAnswers = this.findChallengingDistractors(item, 3, isVieToEng ? 'vie_to_eng' : 'eng_to_vie');
                const options = this.shuffleArray([correctAnswer, ...wrongAnswers]);
                const questionHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div>`;
                
                document.getElementById('main-content').innerHTML = this.getSessionHTML(item, questionHTML, false, isVieToEng);
                this.addSessionEventListeners(item, 'mcq', isVieToEng);
            },
            
            renderContextualMCQ(item) {
                if (!item.exampleSentence) { this.renderNextInSession(); return; } // Skip if no example
                const questionText = item.exampleSentence.replace(new RegExp(`\\b${item.word}\\b`, 'ig'), '______');
                const correctAnswer = item.word;
                const familyIds = this.data.wordFamilies[item.familyRoot] || [];
                const familyWords = familyIds.map(id => this.data.words.find(w => w.id === id)).filter(w => w && w.id !== item.id);
                
                let distractors = new Set(item.distractors_en || []);
                if (familyWords.length > 0) {
                    distractors.add(familyWords[0].word);
                }
                
                const wrongAnswers = this.shuffleArray([...distractors]).slice(0, 3);
                const options = this.shuffleArray([correctAnswer, ...wrongAnswers]);

                const questionHTML = `<p class="text-xl font-semibold mb-6 text-slate-800 text-center">${questionText}</p>
                                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div>`;

                document.getElementById('main-content').innerHTML = this.getSessionHTML(item, questionHTML, false, false);
                this.addSessionEventListeners(item, 'mcq', false);
            },
            
            renderReverseDistractor(item) {
                const questionText = `Một trong những từ này là đáp án đúng cho nghĩa '${item.meaning}', ba từ còn lại là các 'từ gây nhiễu'. Hãy tìm ra đáp án đúng.`;
                const correctAnswer = item.word;
                const wrongAnswers = this.findChallengingDistractors(item, 3, 'vie_to_eng');
                const options = this.shuffleArray([correctAnswer, ...wrongAnswers]);
                const questionHTML = `<p class="text-lg mb-6 text-slate-600 text-center">${questionText}</p>
                                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div>`;

                document.getElementById('main-content').innerHTML = this.getSessionHTML(item, questionHTML, false, true);
                this.addSessionEventListeners(item, 'mcq', true);
            },

            renderContextualClue(item) {
                 if (!item.exampleSentence) { this.renderNextInSession(); return; }
                 const questionHTML = `
                    <div class="space-y-4">
                        <p class="text-lg"><span class="font-semibold">Manh mối 1 (Nghĩa):</span> ${item.meaning}</p>
                        <p class="text-lg"><span class="font-semibold">Manh mối 2 (Câu):</span> ${item.exampleSentence.replace(new RegExp(`\\b${item.word}\\b`, 'ig'), '______')}</p>
                    </div>
                    <form id="quiz-form" class="mt-6">
                        <input type="text" id="answer-input" class="w-full max-w-md mx-auto p-3 text-lg rounded-lg" placeholder="Gõ đáp án của bạn..." autocomplete="off">
                        <button type="submit" class="btn btn-main-action mt-4">Check</button>
                    </form>
                    <div id="feedback" class="mt-4 h-12"></div>`;
                document.getElementById('main-content').innerHTML = this.getSessionHTML(item, questionHTML, false, true);
                this.addSessionEventListeners(item, 'writing', true);
            },

            // --- EVENT LISTENERS & HANDLERS ---
            addSessionEventListeners(item, type, isVieToEng = false) {
                document.getElementById('back-btn')?.addEventListener('click', () => this.renderSelectionScreen('practice'));

                const handleAnswer = (isCorrect) => {
                    this.updateProgress(item.id, type.includes('structure') ? 'structure' : 'word', isCorrect);
                    setTimeout(() => this.renderNextInSession(), isCorrect ? 1200 : 2500);
                };

                if (type === 'mcq') {
                    const correctAnswer = isVieToEng ? item.word : item.meaning;
                    document.querySelectorAll('.answer-option').forEach(button => button.addEventListener('click', e => {
                        const selectedButton = e.currentTarget;
                        if(selectedButton.disabled) return;
                        document.querySelectorAll('.answer-option').forEach(btn => btn.disabled = true);
                        selectedButton.classList.add('selected');
                        const isCorrect = selectedButton.dataset.answer.toLowerCase() === correctAnswer.toLowerCase();
                        setTimeout(() => {
                            selectedButton.classList.remove('selected');
                            if (isCorrect) {
                                selectedButton.classList.add('correct');
                                handleAnswer(true);
                            } else {
                                selectedButton.classList.add('incorrect');
                                const correctButton = document.querySelector(`.answer-option[data-answer="${correctAnswer}"]`);
                                if (correctButton) correctButton.classList.add('correct');
                                handleAnswer(false);
                            }
                        }, 400);
                    }));
                     document.getElementById('idk-btn')?.addEventListener('click', () => {
                        document.querySelectorAll('.answer-option').forEach(el => el.disabled = true);
                        const correctButton = document.querySelector(`.answer-option[data-answer="${correctAnswer}"]`);
                        if(correctButton) correctButton.classList.add('correct');
                        handleAnswer(false);
                    });
                } else if (type === 'writing') {
                    const correctAnswer = item.word; // Writing is always Eng
                     document.getElementById('quiz-form').addEventListener('submit', e => {
                        e.preventDefault();
                        const form = e.target;
                        const feedback = form.nextElementSibling;
                        const input = form.querySelector('#answer-input');
                        const userAnswer = input.value.trim().toLowerCase();
                        if (!userAnswer) return;
                        const isCorrect = userAnswer === correctAnswer.toLowerCase();
                        form.querySelector('button').disabled = true;
                        input.disabled = true;
                        if (isCorrect) {
                            feedback.innerHTML = `<p class="text-green-600 font-bold text-lg">Correct!</p>`;
                            handleAnswer(true);
                        } else {
                            feedback.innerHTML = `<p class="text-red-600 font-bold text-lg">Incorrect! The correct answer is: <span class="underline">${correctAnswer}</span></p>`;
                            handleAnswer(false);
                        }
                    });
                    document.getElementById('idk-btn')?.addEventListener('click', () => {
                         const form = document.getElementById('quiz-form');
                         form.querySelector('button').disabled = true;
                         form.querySelector('input').disabled = true;
                         form.nextElementSibling.innerHTML = `<p class="text-blue-600 font-bold text-lg">Correct answer: <span class="underline">${correctAnswer}</span></p>`;
                         handleAnswer(false);
                    });
                }
            },
            
            // --- UTILITY & HELPER FUNCTIONS ---
            showErrorState(message) {
                document.getElementById('loader-overlay').classList.remove('is-open');
                document.body.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-center p-8 glass-panel max-w-lg">
                            <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                            <h2 class="text-2xl font-bold text-red-700">Đã xảy ra lỗi</h2>
                            <p class="text-slate-600 mt-2">${message}</p>
                            <button onclick="window.location.href='/'" class="btn btn-main-action mt-6">Quay lại trang chủ</button>
                        </div>
                    </div>
                `;
            },
            
            initSidebarNav() {
                document.getElementById('nav-dashboard').addEventListener('click', () => this.renderDashboard());
                document.getElementById('nav-study').addEventListener('click', () => this.renderSelectionScreen('study'));
                document.getElementById('nav-practice').addEventListener('click', () => this.renderSelectionScreen('practice'));
                document.getElementById('nav-test').addEventListener('click', () => this.openModal('test-setup-modal'));
                document.getElementById('nav-reset').addEventListener('click', async () => {
                    this.showCustomConfirm("Bạn có chắc muốn xóa toàn bộ tiến trình của bài tập này không?", async () => {
                        this.data.progress = { learnedItems: {}, lastTestResult: null, incorrectCounts: {} };
                        await this.saveProgressToFirebase();
                        this.applyUserProgress(); // Re-apply the now-empty progress
                        this.renderDashboard();
                        this.showCustomAlert("Đã xóa tiến trình.");
                    }, 'Xóa', 'Hủy');
                });
            },
            setActiveNav(navId) { document.querySelectorAll('.sidebar-nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(navId)?.classList.add('active'); },
            updateHeader(title, subtitle) { document.getElementById('app-title').textContent = title; document.getElementById('app-subtitle').textContent = subtitle; },
            initModals() {
                document.getElementById('close-word-modal-btn').onclick = () => this.closeModal('word-list-modal');
                document.getElementById('close-test-modal-btn').onclick = () => this.closeModal('test-setup-modal');
                document.getElementById('start-test-fixed-btn').addEventListener('click', () => { this.closeModal('test-setup-modal'); this.startTest(parseInt(document.getElementById('question-count').value)); });
                document.getElementById('start-test-all-btn').addEventListener('click', () => { this.closeModal('test-setup-modal'); this.startTest(-1); });
            },
            openModal(id) { document.getElementById(id)?.classList.add('is-open'); },
            closeModal(id) { const m = document.getElementById(id); if(m) { m.classList.add('is-closing'); setTimeout(() => m.classList.remove('is-open', 'is-closing'), 300); } },
            showFilteredList(listType) {
                const table = document.getElementById('word-table');
                const title = document.getElementById('modal-title');
                let items, headers, rows;
                const isStruct = listType.includes('structures');
                const isLearned = listType.includes('learned');
                
                if (isStruct) {
                    items = this.data.structures.filter(i => i.isLearned === isLearned);
                    title.textContent = `${isLearned ? 'Đã học' : 'Chưa học'} Cấu trúc`;
                    headers = `<thead><tr class="text-xs text-slate-800 uppercase"><th class="px-6 py-3">Structure</th><th class="px-6 py-3">Meaning</th></tr></thead>`;
                    rows = items.map(i => `<tr class="border-b border-slate-200/50"><td class="px-6 py-4 font-medium">${i.fullStructure}</td><td class="px-6 py-4">${i.translation}</td></tr>`).join('');
                } else {
                    items = this.data.words.filter(i => i.isLearned === isLearned);
                    title.textContent = `${isLearned ? 'Đã học' : 'Chưa học'} Từ vựng`;
                    headers = `<thead><tr class="text-xs text-slate-800 uppercase"><th class="px-6 py-3">Word</th><th class="px-6 py-3">Type</th><th class="px-6 py-3">Meaning</th></tr></thead>`;
                    rows = items.map(i => `<tr class="border-b border-slate-200/50"><td class="px-6 py-4 font-medium">${i.word}</td><td class="px-6 py-4">${i.type}</td><td class="px-6 py-4">${i.meaning}</td></tr>`).join('');
                }
                table.innerHTML = headers + `<tbody>${rows}</tbody>`;
                this.openModal('word-list-modal');
            },
            getSessionHTML(item, questionHTML, isStructure = false, isVieToEng = false) {
                let title, subtitle;
                if (isStructure) {
                    title = item.word;
                    this.updateHeader('Practice', 'Fill in the blank');
                    subtitle = `<p class="text-slate-600 mb-4">(Meaning: ${item.translation})</p>`;
                } else {
                    title = isVieToEng ? item.meaning : item.word;
                    this.updateHeader('Practice', isVieToEng ? 'What is the English word?' : 'What is the Vietnamese meaning?');
                    subtitle = `<p class="text-slate-600 mb-1">${item.pronunciation}</p><p class="inline-block mt-1 mb-8 px-3 py-1 bg-slate-200/70 text-slate-700 rounded-full text-sm">${item.type}</p>`;
                }
                return `<div class="fade-in no-select"><div class="flex justify-between items-center mb-4"><button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back</button><button id="idk-btn" class="btn btn-secondary">I don't know</button></div><div class="card glass-panel text-center">${subtitle}<h2 class="text-4xl font-bold text-violet-800 mb-6">${title}</h2>${questionHTML}</div></div>`;
            },
            startTest(count) {
                this.setActiveNav('nav-test');
                this.updateHeader('Test', 'Good luck!');
                const allVocab = this.data.words.map(w => ({...w, itemType: 'word'}));
                const allStructures = this.data.structures.map(s => ({...s, itemType: 'structure'}));
                let allItems = [...allVocab, ...allStructures];
                this.data.sessionItems = (count > 0 && count < allItems.length) ? this.shuffleArray(allItems).slice(0, count) : this.shuffleArray(allItems);
                if (this.data.sessionItems.length === 0) { this.showCustomAlert("No items to test!"); return; }
                this.renderTestView();
            },
            renderTestView() {
                const main = document.getElementById('main-content');
                let testHTML = '';
                this.data.sessionItems.forEach((item) => {
                    const isVieToEng = Math.random() > 0.5;
                    testHTML += `<div class="card glass-panel mb-4" data-item-id="${item.id}" data-item-type="${item.itemType}">${this.getTestMCQ_HTML(item, isVieToEng)}</div>`;
                });
                main.innerHTML = `<div class="no-select"><div id="test-header" class="card glass-panel mb-4 sticky top-0 z-20"><div class="flex justify-between items-center"><button id="exit-test-btn" class="btn btn-secondary bg-red-100/80 text-red-700 border-red-200/80 hover:bg-red-200/80">Thoát</button><button id="submit-test-btn" class="btn btn-main-action">Nộp bài</button></div></div><div id="test-container">${testHTML}</div></div>`;
                document.getElementById('submit-test-btn').addEventListener('click', () => this.submitTest());
                document.getElementById('exit-test-btn').addEventListener('click', () => { this.showCustomConfirm("Bạn có chắc muốn thoát? Tiến trình sẽ không được lưu.", () => this.renderDashboard(), 'Thoát', 'Ở lại'); });
                document.querySelectorAll('#test-container .answer-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const qCard = e.currentTarget.closest('[data-correct-answer]');
                        qCard.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                    });
                });
            },
            renderTestEnd(correct, total) {
                const main = document.getElementById('main-content');
                const percentage = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
                this.updateHeader('Test Complete!', `Your score: ${percentage}%`);
                main.innerHTML = `<div class="card glass-panel text-center fade-in"><i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i><h2 class="text-3xl font-bold text-slate-800">Test Complete!</h2><p class="text-slate-600 mt-2 mb-6">Your result:</p><p class="text-5xl font-bold text-violet-700">${correct} / ${total}</p><p class="text-2xl font-semibold text-slate-700 mt-2">(${percentage}%)</p><div class="flex flex-wrap justify-center gap-4 mt-8"><button id="review-incorrect-btn" class="btn btn-secondary">Review Incorrect</button><button id="back-to-dash-btn" class="btn btn-main-action">Back to Dashboard</button></div></div>`;
                document.getElementById('back-to-dash-btn').addEventListener('click', () => this.renderDashboard());
                const reviewBtn = document.getElementById('review-incorrect-btn');
                if (this.data.incorrectTestAnswers.length > 0) {
                    reviewBtn.addEventListener('click', () => this.renderReviewView());
                } else {
                    reviewBtn.style.display = 'none';
                }
            },
            renderReviewView() {
                const main = document.getElementById('main-content');
                this.updateHeader('Review', 'Check your incorrect answers.');
                let reviewHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-slate-800">Incorrect Answers</h2><button id="back-to-dash-btn" class="btn btn-secondary">Back to Dashboard</button></div>`;
                this.data.incorrectTestAnswers.forEach(({item, userAnswer, correctAnswer}) => {
                    const questionText = item.word;
                    reviewHTML += `<div class="card glass-panel mb-4 bg-red-400/10 border-l-4 border-red-500 fade-in">
                        <p class="font-bold text-slate-800">${questionText || 'Error: Question not found'}</p>
                        <p class="text-sm text-slate-600">Your answer: <span class="font-semibold text-red-800">${userAnswer || '<i>(empty)</i>'}</span></p>
                        <p class="text-sm text-slate-600">Correct answer: <span class="font-semibold text-green-800">${correctAnswer}</span></p>
                    </div>`;
                });
                main.innerHTML = reviewHTML;
                document.getElementById('back-to-dash-btn').addEventListener('click', () => this.renderDashboard());
            },
            showCustomAlert(message) {
                const alertId = 'custom-alert-box';
                document.getElementById(alertId)?.remove();
                const alertBox = document.createElement('div');
                alertBox.id = alertId;
                alertBox.className = 'glass-panel';
                alertBox.style.cssText = `position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:16px 24px; border-radius:16px; z-index:200; font-weight:600; color:var(--text-primary); animation:fadeInDown 0.5s ease forwards;`;
                alertBox.innerHTML = message;
                document.body.appendChild(alertBox);
                setTimeout(() => { alertBox.style.animation = 'fadeOutUp 0.5s ease forwards'; setTimeout(() => alertBox.remove(), 500); }, 3000);
            },
            showCustomConfirm(message, onConfirm, confirmText = 'Yes', cancelText = 'Cancel') {
                const confirmId = 'custom-confirm-box';
                document.getElementById(confirmId)?.remove();
                const confirmBox = document.createElement('div');
                confirmBox.id = confirmId;
                confirmBox.className = 'modal';
                confirmBox.innerHTML = `<div class="modal-content glass-panel text-center"><p class="text-lg font-medium text-slate-800 mb-6">${message}</p><div class="flex justify-center gap-4"><button id="confirm-no" class="btn btn-secondary">${cancelText}</button><button id="confirm-yes" class="btn btn-main-action bg-red-500 hover:bg-red-600">${confirmText}</button></div></div>`;
                document.body.appendChild(confirmBox);
                const close = () => { confirmBox.classList.add('is-closing'); setTimeout(() => confirmBox.remove(), 300); };
                document.getElementById('confirm-yes').onclick = () => { onConfirm(); close(); };
                document.getElementById('confirm-no').onclick = close;
                setTimeout(() => confirmBox.classList.add('is-open'), 10);
            },
            shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; }
        };

        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>
</body>
</html>
