<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Practice Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blur-intensity: 12px;
            --saturation-intensity: 150%;
            --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6);
            --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --app-bg-start: #f5f7ff;
            --app-bg-end: #e0e7ff;
        }

        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25);
            --primary-accent: #a78bfa;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --app-bg-start: #0f172a;
            --app-bg-end: #1e293b;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--app-bg-start);
            background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }
        
        body.sidebar-open {
            overflow: hidden;
        }
        
        .no-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .background-shapes {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            filter: blur(15px);
            transition: opacity 0.5s ease;
        }

        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; animation: float 28s infinite alternate ease-in-out; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation: float 32s infinite alternate ease-in-out; }
        .shape3 { width: 120px; height: 120px; background: linear-gradient(135deg, #a78bfa, #c4b5fd); top: 20%; right: 25%; animation: float 24s infinite alternate ease-in-out; }
        .shape4 { width: 80px; height: 80px; background: linear-gradient(135deg, #93c5fd, #bfdbfe); bottom: 5%; left: 30%; animation: float 20s infinite alternate ease-in-out; }

        body.dark .shape {
            opacity: 0.4;
        }

        @keyframes float {
            from { transform: translateY(20px) scale(1) rotate(0deg); }
            to { transform: translateY(-20px) scale(1.05) rotate(20deg); }
        }

        .app-layout { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 1; transition: padding-left 0.3s ease-in-out; }

        .glass-panel {
            position: relative;
            background: var(--glass-bg-color);
            backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            border-radius: 24px;
            border: 1px solid var(--glass-border-color);
            box-shadow: 0 8px 32px 0 var(--shadow-color), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }

        .card { padding: 1.5rem; }

        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 260px;
            padding: 1.5rem;
            z-index: 40;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        body.sidebar-open #sidebar {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            #sidebar {
                position: relative;
                transform: translateX(0);
                flex-shrink: 0;
            }
            .app-layout.sidebar-collapsed #sidebar {
                transform: translateX(-100%);
                margin-left: -260px;
            }
        }
        
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        body.sidebar-open #sidebar-overlay {
            opacity: 1;
            visibility: visible;
        }
        
        @media (min-width: 1024px) {
            #sidebar-overlay {
                display: none;
            }
        }

        .sidebar-nav-btn { display: flex; align-items: center; padding: 12px 16px; border-radius: 12px; font-weight: 600; color: var(--text-secondary); transition: all 0.2s ease-in-out; margin-bottom: 8px; }
        .sidebar-nav-btn i { width: 20px; margin-right: 16px; text-align: center; }
        .sidebar-nav-btn:hover { background-color: rgba(255, 255, 255, 0.4); color: var(--text-primary); transform: translateX(5px) scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sidebar-nav-btn.active { background-color: var(--primary-accent); color: white; box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3); transform: translateX(5px) scale(1.03); }
        
        body.dark .sidebar-nav-btn.active {
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
        }
        body.dark .sidebar-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #app { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 1.5rem; transition: margin-left 0.3s ease-in-out; }
        @media (min-width: 1024px) {
            #app { padding: 2rem; }
        }
        #app::-webkit-scrollbar { width: 8px; }
        #app::-webkit-scrollbar-track { background: transparent; }
        #app::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.1); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        #app::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.2); }

        .main-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        #menu-toggle-btn {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; transform: translateY(0); }
        .btn-main-action { background: var(--primary-accent); color: white; border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(91, 33, 182, 0.25); }
        body.dark .btn-main-action { color: #1e293b; }
        .btn-main-action:hover:not(:disabled) { background: #5b21b6; transform: translateY(-3px); box-shadow: 0 7px 20px rgba(91, 33, 182, 0.4); }
        body.dark .btn-main-action:hover:not(:disabled) { background: #9333ea; }

        .btn-secondary { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); color: var(--text-primary); border-color: rgba(255, 255, 255, 0.6); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.7); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        body.dark .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); }

        .btn:disabled { background-color: rgba(200, 200, 200, 0.7) !important; cursor: not-allowed; opacity: 0.7; transform: none !important; box-shadow: none !important; }
        body.dark .btn:disabled { background-color: rgba(71, 85, 105, 0.7) !important; }

        .answer-option {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        body.dark .answer-option {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .answer-option:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 1px rgba(255,255,255,0.3);
        }
        body.dark .answer-option:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .answer-option.selected {
            background-color: var(--primary-accent) !important;
            border-color: var(--primary-accent) !important;
            color: white !important;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 6px 20px rgba(91, 33, 182, 0.3);
        }
        body.dark .answer-option.selected {
            color: #1e293b !important;
        }

        .answer-option.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
            cursor: not-allowed;
        }
        body.dark .answer-option.correct {
            background-color: #052e16 !important;
            border-color: #16a34a !important;
            color: #a7f3d0 !important;
        }

        .answer-option.incorrect {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
            animation: shake 0.5s;
        }
        body.dark .answer-option.incorrect {
            background-color: #450a0a !important;
            border-color: #dc2626 !important;
            color: #fecaca !important;
        }
        .answer-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes scaleOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }


        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.2); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            align-items: center; 
            justify-content: center; 
        }
        .modal.is-open {
            display: flex;
        }
        .modal-content { 
            padding: 24px; 
            width: 90%; 
            max-width: 500px; 
            animation: scaleIn 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        .modal.is-closing .modal-content {
            animation: scaleOut 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-between; align-items: center; }
        .close-button { color: #eee; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .close-button:hover { color: white; }

        .flashcard-container { perspective: 1000px; min-height: 250px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction:column; align-items: center; justify-content: center; border-radius: 16px; padding: 20px; text-align: center; }
        .flashcard-front { background-color: rgba(255, 255, 255, 0.8); }
        body.dark .flashcard-front { background-color: rgba(51, 65, 85, 0.8); }
        .flashcard-back { background-color: rgba(230, 230, 255, 0.9); transform: rotateY(180deg); overflow-y: auto; }
        body.dark .flashcard-back { background-color: rgba(71, 85, 105, 0.9); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1rem; }
        body.dark .progress-bar { background-color: #4b5563; }
        .progress-bar-inner { background-color: var(--primary-accent); height: 100%; transition: width 0.5s ease-in-out; }

        .word-token-area { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; min-height: 50px; padding: 10px; border-radius: 12px; }
        .unscramble-area { border: 2px dashed var(--glass-border-color); }
        .word-token { cursor: pointer; background-color: #e0e7ff; color: #3730a3; padding: 8px 12px; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        body.dark .word-token { background-color: #3730a3; color: #e0e7ff; }
        .word-token:hover { transform: translateY(-2px); background-color: #c7d2fe; }
        body.dark .word-token:hover { background-color: #4338ca; }
        
        .clickable-word { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; }
        .clickable-word:hover { background-color: #e0e7ff; }
        body.dark .clickable-word:hover { background-color: #3730a3; }
        .clickable-word.selected { background-color: #fbbf24; color: #78350f; }
        body.dark .clickable-word.selected { background-color: #f59e0b; color: #422006; }
        
        .mindmap-container { display: flex; justify-content: center; align-items: center; flex-grow: 1; padding: 1rem; }
        .mindmap { position: relative; display: flex; justify-content: center; align-items: center; }
        .mindmap-center {
            padding: 1rem 1.5rem; background-color: var(--primary-accent); color: white; border-radius: 50px; font-weight: bold; z-index: 10;
        }
        body.dark .mindmap-center { color: #1e293b; }
        .mindmap-node {
            position: absolute; padding: 0.5rem 1rem; background: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.9); border-radius: 20px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease;
        }
        body.dark .mindmap-node { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .mindmap-node:hover { transform: scale(1.1); z-index: 20; }
        
        body.dark .text-slate-800, body.dark .text-slate-700, body.dark .text-violet-800 { color: var(--text-primary); }
        body.dark .text-slate-600, body.dark .text-slate-500 { color: var(--text-secondary); }
        body.dark .text-red-500 { color: #f87171; }
        body.dark .hover\:bg-red-100:hover { background-color: rgb(220 38 38 / 0.2); }
        body.dark .hover\:text-red-700:hover { color: #f87171; }

        .text-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--glass-border-color);
            background: var(--glass-bg-color);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .text-input:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.3);
        }

    </style>
</head>
<body>
    <div class="background-shapes">
        <div class="shape shape1"></div>
        <div class="shape shape2"></div>
        <div class="shape shape3"></div>
        <div class="shape shape4"></div>
    </div>

    <div id="loader-overlay" class="modal is-open">
        <div class="text-center">
            <div class="w-16 h-16 border-8 border-t-violet-500 border-gray-200 rounded-full animate-spin"></div>
            <p id="loader-text" class="text-lg font-semibold text-white mt-4">Đang tải dữ liệu...</p>
        </div>
    </div>

    <div class="app-layout" style="visibility: hidden;">
        <nav id="sidebar" class="glass-panel">
            <div>
                <div class="text-center mb-10">
                    <h1 id="sidebar-title" class="text-2xl font-bold">Vocab App</h1>
                    <p class="text-sm text-slate-600">by Thành Nam</p>
                </div>
                <div id="sidebar-nav" class="flex-grow">
                    <button id="nav-dashboard" class="sidebar-nav-btn active"><i class="fas fa-chart-pie"></i> Dashboard</button>
                    <button id="nav-study" class="sidebar-nav-btn"><i class="fas fa-book-open"></i> Study</button>
                    <button id="nav-practice" class="sidebar-nav-btn"><i class="fas fa-dumbbell"></i> Practice</button>
                    <button id="nav-test" class="sidebar-nav-btn"><i class="fas fa-graduation-cap"></i> Test</button>
                </div>
            </div>
            <div class="mt-auto">
                 <div class="pt-4 border-t border-white/20">
                    <button id="theme-toggle-btn" class="sidebar-nav-btn w-full">
                        <i id="theme-toggle-icon" class="fas fa-moon"></i>
                        <span id="theme-toggle-text">Dark Mode</span>
                    </button>
                </div>
                <button id="nav-reset" class="sidebar-nav-btn w-full justify-center text-red-500 hover:bg-red-100 hover:text-red-700">
                   <i class="fas fa-trash-alt mr-2"></i> Reset Progress
                </button>
            </div>
        </nav>
        
        <div id="sidebar-overlay"></div>

        <main id="app">
             <header class="main-header">
                 <button id="menu-toggle-btn" class="lg:hidden">
                     <i class="fas fa-bars text-xl"></i>
                 </button>
                 <div class="text-left">
                     <h1 id="app-title" class="text-3xl lg:text-4xl font-bold">Dashboard</h1>
                     <p id="app-subtitle" class="text-slate-600 mt-1 lg:mt-2">Welcome back! Here's your learning progress.</p>
                 </div>
             </header>
             <div id="main-content">
                </div>
        </main>
    </div>

    <div id="word-list-modal" class="modal">
        <div class="modal-content glass-panel" style="max-width: 1200px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header pb-4 mb-4">
                <h2 id="modal-title" class="text-2xl font-bold">List</h2>
                <span id="close-word-modal-btn" class="close-button">&times;</span>
            </div>
            <div id="word-table-container" class="overflow-y-auto flex-grow">
                <table id="word-table" class="w-full text-sm text-left text-slate-700">
                </table>
            </div>
        </div>
    </div>
    <div id="test-setup-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header pb-4 mb-4">
                <h2 class="text-2xl font-bold">Test Setup</h2>
                <span id="close-test-modal-btn" class="close-button">&times;</span>
            </div>
            <div>
                <label for="question-count" class="block mb-2 font-medium">Number of questions:</label>
                <input type="number" id="question-count" class="w-full p-2 rounded-lg text-input" min="5" max="100" value="10">
                <div class="mt-6">
                    <button id="start-test-fixed-btn" class="btn btn-main-action w-full">Start with selected count</button>
                    <button id="start-test-all-btn" class="btn btn-secondary w-full mt-3">Test all items</button>
                </div>
            </div>
        </div>
    </div>
    <div id="feedback-container" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-4xl p-4 z-50 pointer-events-none">
        <div id="feedback-area" class="glass-panel card text-center transform translate-y-full transition-transform duration-500 pointer-events-auto"></div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const App = {
            data: {
                db: null,
                submissionId: null,
                testId: null,
                words: [],
                structures: [],
                wordFamilies: {},
                progress: { learnedItems: {}, lastTestResult: null, incorrectCounts: {} },
                sessionItems: [],
                currentSessionIndex: 0,
                currentSessionCorrect: 0,
                currentSessionTotal: 0,
                mode: null,
                currentCorrectAnswer: null,
                findAndFixState: {},
                wordFamilyState: {},
                isPracticeSession: false,
            },

            async init() {
                this.initTheme();
                this.initResponsiveSidebar();
                try {
                    this.data.submissionId = this.getSubmissionIdFromUrl();
                    // IMPORTANT: Replace with your actual Firebase config
                    const firebaseConfig = {
                        apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
                        authDomain: "b1-baotram.firebaseapp.com",
                        projectId: "b1-baotram",
                        storageBucket: "b1-baotram.appspot.com",
                        messagingSenderId: "948701163187",
                        appId: "1:948701163187:web:043f2d381d63e741114ac6"
                    };
                    const firebaseApp = initializeApp(firebaseConfig);
                    this.data.db = getFirestore(firebaseApp);
                    await this.loadDataFromFirebase();
                    this.initAntiCopy();
                    this.initModals();
                    this.initSidebarNav();
                    this.renderDashboard();
                    document.querySelector('.app-layout').style.visibility = 'visible';
                    document.getElementById('loader-overlay').classList.remove('is-open');
                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.showErrorState(error.message);
                }
            },
            
            getSubmissionIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('submission_id');
                if (!id) throw new Error("Mã truy cập không hợp lệ. Vui lòng truy cập từ cổng chính.");
                return id;
            },

            async loadDataFromFirebase() {
                const submissionSnap = await getDoc(doc(this.data.db, "submissions", this.data.submissionId));
                if (!submissionSnap.exists()) throw new Error("Không tìm thấy bài làm với mã truy cập này.");
                
                const submissionData = submissionSnap.data();
                this.data.testId = submissionData.testId;
                if (submissionData.progress) {
                    this.data.progress = submissionData.progress;
                    this.data.progress.learnedItems = this.data.progress.learnedItems || {};
                    this.data.progress.incorrectCounts = this.data.progress.incorrectCounts || {};
                }

                const vocabSetSnap = await getDoc(doc(this.data.db, "vocab_sets", this.data.testId));
                if (!vocabSetSnap.exists()) throw new Error("Không tìm thấy bộ từ vựng tương ứng.");
                
                const vocabSetData = vocabSetSnap.data();
                document.title = vocabSetData.title || "Vocabulary Practice";
                document.getElementById('sidebar-title').textContent = vocabSetData.title;

                this.data.words = (vocabSetData.wordList || []).map((word, index) => ({...word, id: word.id || `word_${index}`}));
                this.groupWordFamilies();
                this.parseAndStoreStructures();
                this.applyUserProgress();
            },
            
            applyUserProgress() {
                const { learnedItems } = this.data.progress;
                this.data.words.forEach(word => { word.isLearned = !!learnedItems[`word_${word.id}`]; });
                this.data.structures.forEach(structure => { structure.isLearned = !!learnedItems[`structure_${structure.id}`]; });
            },

            async saveProgressToFirebase() {
                if (!this.data.submissionId || !this.data.db) return;
                try {
                    await setDoc(doc(this.data.db, "submissions", this.data.submissionId), { 
                        progress: this.data.progress, 
                        lastAccessed: serverTimestamp() 
                    }, { merge: true });
                } catch (error) {
                    console.error("Error saving progress:", error);
                    this.showCustomAlert("Lỗi: Không thể lưu tiến trình.");
                }
            },
            
            initTheme() {
                const themeToggleBtn = document.getElementById('theme-toggle-btn');
                const themeToggleIcon = document.getElementById('theme-toggle-icon');
                const themeToggleText = document.getElementById('theme-toggle-text');
                const body = document.body;
                const applyTheme = (theme) => {
                    body.classList.toggle('dark', theme === 'dark');
                    themeToggleIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                    themeToggleText.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
                };
                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);
                themeToggleBtn.addEventListener('click', () => {
                    const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            },

            initResponsiveSidebar() {
                const menuToggleBtn = document.getElementById('menu-toggle-btn');
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                const appLayout = document.querySelector('.app-layout');
                const toggleSidebar = () => {
                    if (window.innerWidth < 1024) {
                        document.body.classList.toggle('sidebar-open');
                    } else {
                        appLayout.classList.toggle('sidebar-collapsed');
                    }
                };
                menuToggleBtn?.addEventListener('click', toggleSidebar);
                sidebarOverlay?.addEventListener('click', toggleSidebar);
                document.querySelectorAll('#sidebar-nav .sidebar-nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (window.innerWidth < 1024) document.body.classList.remove('sidebar-open');
                    });
                });
            },
            
            initAntiCopy() {
                ['contextmenu', 'copy', 'cut', 'paste'].forEach(event => {
                    document.body.addEventListener(event, e => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        e.preventDefault();
                        this.showCustomAlert("Chức năng này đã bị vô hiệu hóa.");
                        return false;
                    });
                });
            },

            groupWordFamilies() {
                const families = {};
                this.data.words.forEach(word => {
                    const root = (word.familyRoot || word.word.split(/[\s-]/)[0]).toLowerCase().replace(/[^a-z]/g, '');
                    if (!families[root]) families[root] = [];
                    if (!families[root].some(w => w.id === word.id)) families[root].push(word);
                    word.familyRoot = root;
                });
                this.data.wordFamilies = families;
            },
            
            parseAndStoreStructures() {
                this.data.structures = [];
                this.data.words.forEach(word => {
                    if (word.structures && Array.isArray(word.structures)) {
                        word.structures.forEach((struct, s_idx) => {
                            this.data.structures.push({
                                id: `s_${word.id}_${s_idx}`,
                                rootWordId: word.id,
                                word: word.word,
                                phrase: struct.phrase,
                                meaning: struct.meaning,
                                applicationExamples: struct.applicationExamples || [],
                                isLearned: false,
                            });
                        });
                    }
                });
            },

            updateProgress(itemId, itemType, isCorrect) {
                const progressKey = `${itemType}_${itemId}`;
                const { incorrectCounts, learnedItems } = this.data.progress;

                if (isCorrect) {
                    learnedItems[progressKey] = true;
                    // If the item was previously incorrect, remove it from the list
                    if (incorrectCounts[progressKey]) {
                        delete incorrectCounts[progressKey];
                    }
                } else {
                    // Item is incorrect, increment the count
                    incorrectCounts[progressKey] = (incorrectCounts[progressKey] || 0) + 1;
                    // An incorrect answer means it's not fully "learned" yet
                    delete learnedItems[progressKey];
                }
                
                // Update the main data objects to reflect the change immediately
                const itemCache = itemType === 'word' ? this.data.words : this.data.structures;
                const itemToUpdate = itemCache.find(i => i.id === itemId);
                if (itemToUpdate) {
                    itemToUpdate.isLearned = isCorrect;
                }

                this.saveProgressToFirebase();
            },

            renderDashboard() {
                this.setActiveNav('nav-dashboard');
                this.updateHeader('Dashboard', "Welcome back! Here's your learning progress.");
                const main = document.getElementById('main-content');
                
                const wordsLearned = this.data.words.filter(w => w.isLearned).length;
                const totalWords = this.data.words.length;
                const wordProgress = totalWords > 0 ? (wordsLearned / totalWords) * 100 : 0;

                const structuresLearned = this.data.structures.filter(s => s.isLearned).length;
                const totalStructures = this.data.structures.length;
                const structureProgress = totalStructures > 0 ? (structuresLearned / totalStructures) * 100 : 0;
                
                const lastTest = this.data.progress.lastTestResult;
                let testResultHTML = `<p class="text-slate-600">Chưa có bài kiểm tra nào.</p>`;
                if (lastTest && lastTest.date) {
                    const testDate = new Date(lastTest.date).toLocaleDateString('vi-VN');
                    testResultHTML = `<p class="text-2xl font-bold text-violet-800">${lastTest.score}/${lastTest.total} (${lastTest.percentage}%)</p><p class="text-sm text-slate-600">Làm ngày: ${testDate}</p>`;
                }

                main.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold mb-3">Tiến độ Từ vựng</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${wordsLearned}/${totalWords}</span><span class="text-sm font-medium">${wordProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${wordProgress}%;"></div></div>
                            <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold mb-3">Tiến độ Cấu trúc</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${structuresLearned}/${totalStructures}</span><span class="text-sm font-medium">${structureProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${structureProgress}%;"></div></div>
                             <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel lg:col-span-2">
                             <h3 class="text-xl font-bold mb-2">Kết quả kiểm tra gần nhất</h3>
                             ${testResultHTML}
                        </div>
                    </div>`;
                main.querySelectorAll('[data-list-type]').forEach(button => {
                    button.addEventListener('click', (e) => this.showFilteredList(e.currentTarget.dataset.listType));
                });
            },
            
            renderSelectionScreen(mode) {
                this.data.isPracticeSession = (mode === 'practice' || mode === 'test');
                this.setActiveNav(mode === 'study' ? 'nav-study' : (mode === 'test' ? 'nav-test' : 'nav-practice'));
                const modeText = mode.charAt(0).toUpperCase() + mode.slice(1);
                this.updateHeader(modeText, `Chọn nội dung bạn muốn ${mode}.`);
                const main = document.getElementById('main-content');
                
                let practiceButton = '';
                if (this.data.isPracticeSession) {
                    const weakItemsCount = Object.keys(this.data.progress.incorrectCounts).length;
                    practiceButton = `
                     <div class="w-full mt-6 pt-6 border-t border-white/20">
                         <button id="select-adaptive-btn" class="btn btn-main-action bg-amber-500 hover:bg-amber-600 w-full md:w-auto" ${weakItemsCount === 0 ? 'disabled' : ''}>
                             <i class="fas fa-star"></i> Ôn tập điểm yếu (${weakItemsCount} mục)
                         </button>
                         <p class="text-xs text-slate-500 mt-2 ${weakItemsCount > 0 ? 'hidden' : ''}">Tuyệt vời! Bạn không có điểm yếu nào cần ôn tập.</p>
                     </div>
                    `;
                }

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="mb-4"><button id="back-to-dashboard-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Dashboard</button></div>
                        <div class="card glass-panel text-center">
                            <h2 class="text-2xl font-bold mb-6">Bạn muốn ${mode} gì?</h2>
                            <div class="flex flex-wrap justify-center gap-4">
                                <button id="select-vocab-btn" class="btn btn-main-action"><i class="fas fa-book"></i> Từ vựng</button>
                                <button id="select-structure-btn" class="btn btn-main-action" ${this.data.structures.length === 0 ? 'disabled' : ''}><i class="fas fa-sitemap"></i> Cấu trúc</button>
                            </div>
                            ${practiceButton}
                        </div>
                    </div>`;
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('select-vocab-btn').addEventListener('click', () => this.startSession('all', 'word', mode));
                document.getElementById('select-structure-btn').addEventListener('click', () => this.startSession('all', 'structure', mode));
                if (this.data.isPracticeSession) {
                    document.getElementById('select-adaptive-btn')?.addEventListener('click', () => this.startSession('adaptive', 'all', mode));
                }
            },

            startSession(selection, type, mode) {
                this.data.mode = mode; // 'study', 'practice', 'test'
                this.data.currentSessionIndex = 0;
                this.data.currentSessionCorrect = 0;
                this.data.currentSessionTotal = 0;
                let items = [];

                if (selection === 'adaptive') {
                    this.updateHeader("Ôn tập điểm yếu", "Tập trung vào các mục bạn hay sai nhất");
                    const incorrect = this.data.progress.incorrectCounts || {};
                    const weakItems = Object.keys(incorrect)
                        .map(key => ({ key, count: incorrect[key] }))
                        .sort((a, b) => b.count - a.count);

                    items = weakItems.map(item => {
                        const [itemType, ...itemIdParts] = item.key.split('_');
                        const itemId = itemIdParts.join('_');
                        const source = itemType === 'word' ? this.data.words : this.data.structures;
                        const fullItem = source.find(i => i.id === itemId);
                        return { ...fullItem, type: itemType }; // Add type info for dispatcher
                    }).filter(Boolean); // Filter out any items that might not be found
                } else {
                    const source = type === 'word' ? this.data.words : this.data.structures;
                    // For study, use all items. For practice/test, use unlearned items first.
                    const unlearned = source.filter(i => !i.isLearned);
                    items = (this.data.isPracticeSession && unlearned.length > 0) ? unlearned : source;
                    this.updateHeader(`${mode.charAt(0).toUpperCase() + mode.slice(1)} ${type.charAt(0).toUpperCase() + type.slice(1)}`, `Luyện tập nào!`);
                }

                if (items.length === 0) {
                    this.showCustomAlert("Chúc mừng! Bạn đã học hết các mục trong phần này.");
                    this.renderDashboard();
                    return;
                }

                this.data.sessionItems = this.shuffleArray(items);
                this.renderNextInSession();
            },

            renderNextInSession() {
                if (this.data.currentSessionIndex >= this.data.sessionItems.length) {
                    this.showSessionEndSummary();
                    return;
                }
                const item = this.data.sessionItems[this.data.currentSessionIndex];
                if (!item) { 
                    this.data.currentSessionIndex++;
                    this.renderNextInSession(); 
                    return; 
                }

                // Determine item type for adaptive mode
                const itemType = item.type === 'word' || !item.type ? 'word' : 'structure';

                let exercisePool;
                if(this.data.mode === 'study') {
                     exercisePool = itemType === 'word' ? ['Flashcard', 'Word Family Explorer'] : ['Structure Flashcard'];
                } else { // Practice or Test mode
                    if (itemType === 'word') {
                        exercisePool = ['Traditional MCQ', 'Contextual MCQ', 'Sentence Unscramble', 'Audio Listening'];
                        if (this.data.wordFamilies[item.familyRoot]?.length > 1) exercisePool.push('Word Family Matching');
                    } else { // structure
                        exercisePool = ['Gap-Fill', 'Find and Fix Error', 'Correct/Incorrect Sentence'];
                    }
                }
                
                const exercise = this.shuffleArray(exercisePool)[0];
                const renderMap = {
                    'Flashcard': () => this.renderFlashcard(item),
                    'Structure Flashcard': () => this.renderFlashcard(item, true),
                    'Word Family Explorer': () => this.renderWordFamilyMindmap(item),
                    'Word Family Matching': () => this.renderWordFamilyMatching(item),
                    'Contextual MCQ': () => this.renderContextualMCQ(item),
                    'Sentence Unscramble': () => this.renderSentenceUnscramble(item),
                    'Pronunciation Match': () => this.renderPronunciationMatch(item),
                    'Audio Listening': () => this.renderAudioListening(item),
                    'Traditional MCQ': () => this.renderTraditionalMCQ(item),
                    'Trios of Gapped Sentence': () => this.renderTriosOfGappedSentence(item),
                    'Gap-Fill': () => this.renderGapFill(item),
                    'Find and Fix Error': () => this.renderFindAndFixError(item),
                    'Correct/Incorrect Sentence': () => this.renderCorrectIncorrectSentence(item),
                };

                const renderFunction = renderMap[exercise];
                if (renderFunction) {
                    renderFunction();
                } else {
                    // Fallback if no exercise could be generated
                    this.data.currentSessionIndex++;
                    this.renderNextInSession();
                }
            },
            
            // --- [START] EXERCISE RENDERERS ---
            
            renderFlashcard(item, isStructure = false) {
                const sessionType = isStructure ? 'structure' : 'word';
                this.updateHeader('Study', isStructure ? 'Structure Flashcard' : 'Vocabulary Flashcard');
                const main = document.getElementById('main-content');
                
                const frontHTML = isStructure ? `<p class="text-3xl font-bold text-center">${item.phrase}</p>` : `<p class="text-4xl font-bold">${item.word}</p>`;
                const backHTML = isStructure ? `
                    <div class="p-4">
                        <p class="text-2xl font-semibold text-center">${item.meaning}</p>
                        <p class="text-sm text-slate-600 mt-2 text-center">${(item.applicationExamples || [])[0] || ''}</p>
                    </div>
                ` : `
                    <div class="p-4 text-center">
                        <p class="text-2xl font-semibold">${item.meaning}</p>
                        <p class="text-lg text-slate-600 mt-2">${item.pronunciation} - (${item.type})</p>
                        <p class="text-sm text-slate-500 italic mt-4">"${item.exampleSentence}"</p>
                        <button id="explore-family-btn" class="btn btn-secondary !py-2 !px-4 mt-4 text-sm"><i class="fas fa-project-diagram mr-2"></i>Khám phá họ từ</button>
                    </div>
                `;

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Quit</button>
                            <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                            <button id="next-btn" class="btn btn-main-action">Next <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                        <div class="card glass-panel flex items-center justify-center">
                            <div class="flashcard-container">
                                <div class="flashcard" id="flashcard">
                                    <div class="flashcard-face flashcard-front">${frontHTML}</div>
                                    <div class="flashcard-face flashcard-back">${backHTML}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen('study'));
                document.getElementById('flashcard').addEventListener('click', (e) => e.currentTarget.classList.toggle('is-flipped'));
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.data.currentSessionIndex++;
                    this.renderNextInSession();
                });
                if (!isStructure) {
                    document.getElementById('explore-family-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.renderWordFamilyMindmap(item);
                    });
                }
            },

            renderWordFamilyMindmap(item) {
                this.updateHeader('Study', 'Word Family Explorer');
                const main = document.getElementById('main-content');
                const familyRoot = item.familyRoot;
                const familyWords = this.data.wordFamilies[familyRoot] || [item];

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="mb-4 flex justify-between">
                            <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                            <button id="next-btn" class="btn btn-main-action">Continue <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                        <div class="card glass-panel min-h-[60vh] flex flex-col">
                            <h2 class="text-2xl font-bold text-center mb-4">Họ từ: <span class="text-violet-700">${familyRoot}</span></h2>
                            <div class="mindmap-container">
                                <div class="mindmap" id="mindmap">
                                    <div class="mindmap-center">${familyRoot}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const mindmap = document.getElementById('mindmap');
                const radius = Math.min(mindmap.clientWidth, mindmap.clientHeight) / 2.5 || 150;
                const angleStep = (2 * Math.PI) / familyWords.length;

                familyWords.forEach((word, index) => {
                    const angle = index * angleStep;
                    const x = radius * Math.cos(angle);
                    const y = radius * Math.sin(angle);

                    const node = document.createElement('div');
                    node.className = 'mindmap-node';
                    node.style.transform = `translate(${x}px, ${y}px)`;
                    node.innerHTML = `<p class="font-bold">${word.word}</p><p class="text-xs text-slate-500">(${word.type})</p>`;
                    mindmap.appendChild(node);
                });

                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen('study'));
                 document.getElementById('next-btn').addEventListener('click', () => {
                    this.data.currentSessionIndex++;
                    this.renderNextInSession();
                });
            },

            renderWordFamilyMatching(item) {
                const familyRoot = item.familyRoot;
                const familyWords = this.data.wordFamilies[familyRoot];

                if (!familyWords || familyWords.length < 2) {
                    // This exercise is not suitable, skip to the next one
                    this.data.currentSessionIndex++;
                    this.renderNextInSession();
                    return;
                }

                this.data.wordFamilyState.familyWords = familyWords;
                this.data.wordFamilyState.matchedWords = [];
                this.data.wordFamilyState.selected = { word: null, type: null, meaning: null, pronunciation: null };

                const renderColumns = () => {
                    const words = this.shuffleArray(familyWords.map(w => ({ text: w.word, id: w.id })));
                    const types = this.shuffleArray(familyWords.map(w => ({ text: w.type, id: w.id })));
                    const meanings = this.shuffleArray(familyWords.map(w => ({ text: w.meaning, id: w.id })));
                    const pronunciations = this.shuffleArray(familyWords.map(w => ({ text: w.pronunciation, id: w.id })));

                    const createColumn = (title, items, category) => `
                        <div class="flex-1">
                            <h4 class="font-bold text-center mb-3 text-slate-600">${title}</h4>
                            <div class="flex flex-col gap-2" data-category="${category}">
                                ${items.map(item => `<button data-id="${item.id}" class="p-3 rounded-lg text-sm text-center answer-option">${item.text}</button>`).join('')}
                            </div>
                        </div>`;

                    document.getElementById('main-content').innerHTML = `
                        <div class="fade-in">
                             <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-slate-800">Word Family Matching</h3>
                                <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                            </div>
                            <p class="text-center text-slate-500 mb-6">Nối các mục ở 4 cột để tạo thành các từ đúng trong họ từ "${familyRoot}".</p>
                            <div class="card glass-panel">
                               <div class="flex flex-col sm:flex-row gap-4">
                                    ${createColumn('Từ vựng', words, 'word')}
                                    ${createColumn('Loại từ', types, 'type')}
                                    ${createColumn('Nghĩa', meanings, 'meaning')}
                                    ${createColumn('Phiên âm', pronunciations, 'pronunciation')}
                                </div>
                            </div>
                            <div id="feedback-placeholder" class="text-center mt-6"></div>
                        </div>`;

                    document.querySelectorAll('.answer-option').forEach(btn => btn.onclick = (e) => handleFamilySelection(e.target));
                };
                
                const handleFamilySelection = (selectedButton) => {
                    const category = selectedButton.parentElement.dataset.category;
                    // Deselect previous in the same column
                    selectedButton.parentElement.querySelectorAll('.answer-option').forEach(btn => btn.classList.remove('selected'));
                    // Select new one
                    selectedButton.classList.add('selected');
                    this.data.wordFamilyState.selected[category] = selectedButton;
                    
                    const allSelected = Object.values(this.data.wordFamilyState.selected).every(val => val !== null);
                    if (allSelected) {
                        checkFamilyMatch();
                    }
                };

                const checkFamilyMatch = () => {
                    const selectedWordId = this.data.wordFamilyState.selected.word.dataset.id;
                    const isCorrect = Object.values(this.data.wordFamilyState.selected).every(btn => btn.dataset.id === selectedWordId);
                    const selectedButtons = Object.values(this.data.wordFamilyState.selected);
                    
                    if (isCorrect) {
                        this.updateProgress(selectedWordId, 'word', true);
                        this.data.wordFamilyState.matchedWords.push(selectedWordId);
                        selectedButtons.forEach(btn => {
                             btn.classList.add('correct');
                             btn.classList.remove('selected');
                             btn.disabled = true; 
                        });
                        
                        if (this.data.wordFamilyState.matchedWords.length === this.data.wordFamilyState.familyWords.length) {
                             this.showFeedback(true, `Hoàn hảo! Bạn đã ghép đúng cả họ từ.`);
                        }
                    } else {
                        // All words in family are marked as incorrect for this attempt
                        this.updateProgress(item.id, 'word', false);
                        selectedButtons.forEach(btn => btn.classList.add('incorrect'));
                        setTimeout(() => selectedButtons.forEach(btn => btn.classList.remove('incorrect', 'selected')), 1000);
                    }
                    // Reset selection for next try
                    this.data.wordFamilyState.selected = { word: null, type: null, meaning: null, pronunciation: null };
                };

                renderColumns();
            },
            
            renderTraditionalMCQ(item) {
                const isEngToViet = Math.random() > 0.5;
                const question = isEngToViet ? item.word : item.meaning;
                const correctAnswer = isEngToViet ? item.meaning : item.word;
                this.data.currentCorrectAnswer = correctAnswer;
                
                const distractorPool = isEngToViet ? this.data.words.map(w => w.meaning) : this.data.words.map(w => w.word);
                const distractors = this.shuffleArray(distractorPool.filter(d => d !== correctAnswer)).slice(0, 3);
                
                const options = this.shuffleArray([correctAnswer, ...distractors]);
                
                this.renderMCQBase('Traditional MCQ', question, options, () => {
                    this.updateProgress(item.id, 'word', this.data.wasCorrect);
                });
            },
            
            renderContextualMCQ(item) {
                if (!item.exampleSentence) { return this.renderNextInSession(); }

                const question = item.exampleSentence.replace(new RegExp(`\\b${item.word}\\b`, 'i'), '<strong class="text-2xl">____</strong>');
                const correctAnswer = item.word;
                this.data.currentCorrectAnswer = correctAnswer;

                let distractors = [];
                // Priority 1: Same family
                const familyDistractors = (this.data.wordFamilies[item.familyRoot] || []).filter(w => w.id !== item.id).map(w => w.word);
                distractors.push(...this.shuffleArray(familyDistractors).slice(0, 1));

                // Priority 2: Pre-defined distractors
                distractors.push(...(item.distractors_en || []));

                // Priority 3: Random words of same type
                if (distractors.length < 3) {
                    const randomDistractors = this.data.words
                        .filter(w => w.type === item.type && w.id !== item.id && !distractors.includes(w.word))
                        .map(w => w.word);
                    distractors.push(...this.shuffleArray(randomDistractors));
                }
                
                const finalDistractors = this.shuffleArray([...new Set(distractors)]).slice(0, 3);
                const options = this.shuffleArray([correctAnswer, ...finalDistractors]);

                this.renderMCQBase('Contextual MCQ', question, options, () => {
                    this.updateProgress(item.id, 'word', this.data.wasCorrect);
                });
            },

            renderAudioListening(item) {
                if (typeof SpeechSynthesisUtterance === "undefined") {
                    this.showCustomAlert("Trình duyệt của bạn không hỗ trợ API âm thanh.");
                    return this.renderNextInSession();
                }

                const correctAnswer = item.word;
                this.data.currentCorrectAnswer = correctAnswer;
                const distractors = this.shuffleArray(this.data.words.filter(w => w.id !== item.id).map(w => w.word)).slice(0, 3);
                const options = this.shuffleArray([correctAnswer, ...distractors]);

                this.renderMCQBase('Audio Listening', 'Nghe và chọn từ đúng.', options, () => {
                    this.updateProgress(item.id, 'word', this.data.wasCorrect);
                }, `
                    <button id="play-audio-btn" class="btn btn-secondary mx-auto mb-6">
                        <i class="fas fa-volume-up text-xl"></i> Phát âm
                    </button>
                `);

                const utterance = new SpeechSynthesisUtterance(item.word);
                utterance.lang = 'en-US';
                document.getElementById('play-audio-btn').onclick = () => {
                    window.speechSynthesis.speak(utterance);
                };
            },

            renderSentenceUnscramble(item) {
                 if (!item.exampleSentence) { return this.renderNextInSession(); }
                 
                 this.updateHeader('Practice', 'Sentence Unscramble');
                 const main = document.getElementById('main-content');
                 const originalSentence = item.exampleSentence.replace(/[.,!?]/g, '');
                 const words = this.shuffleArray(originalSentence.split(/\s+/));
                 
                 main.innerHTML = `
                    <div class="fade-in text-center">
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-xl font-bold text-slate-800">Sắp xếp lại câu</h3>
                           <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                        </div>
                        <div class="card glass-panel">
                            <p class="mb-4 text-slate-600">Sắp xếp các từ dưới đây để tạo thành một câu có nghĩa.</p>
                            <div id="unscramble-drop-area" class="unscramble-area word-token-area mb-6 p-4"></div>
                            <div id="unscramble-source-area" class="word-token-area bg-black/5 rounded-xl">
                                ${words.map((word, index) => `<button data-index="${index}" class="word-token">${word}</button>`).join('')}
                            </div>
                        </div>
                        <div id="feedback-placeholder" class="mt-6">
                           <button id="check-unscramble-btn" class="btn btn-main-action" disabled>Kiểm tra</button>
                        </div>
                    </div>
                 `;

                 const dropArea = document.getElementById('unscramble-drop-area');
                 const sourceArea = document.getElementById('unscramble-source-area');
                 const checkBtn = document.getElementById('check-unscramble-btn');

                 sourceArea.addEventListener('click', e => {
                    if (e.target.classList.contains('word-token')) {
                        dropArea.appendChild(e.target);
                        checkBtn.disabled = false;
                    }
                 });

                 dropArea.addEventListener('click', e => {
                    if (e.target.classList.contains('word-token')) {
                        sourceArea.appendChild(e.target);
                        checkBtn.disabled = dropArea.children.length === 0;
                    }
                 });

                 checkBtn.addEventListener('click', () => {
                    const userAnswer = Array.from(dropArea.children).map(el => el.textContent).join(' ');
                    const isCorrect = userAnswer.toLowerCase() === originalSentence.toLowerCase();
                    this.updateProgress(item.id, 'word', isCorrect);
                    this.data.currentCorrectAnswer = item.exampleSentence;
                    this.showFeedback(isCorrect);
                 });
            },

            renderGapFill(item) { // For structures
                if (!item.applicationExamples || item.applicationExamples.length === 0) { return this.renderNextInSession(); }
                
                const sentence = item.applicationExamples[0];
                const structureParts = item.phrase.split(/\s+|(\/)/).filter(p => p && p !== '/'); // Split by space or slash
                const prepositions = ['of', 'to', 'for', 'in', 'on', 'at', 'with', 'by', 'from', 'about'];
                
                let wordToHide = this.shuffleArray(structureParts.filter(p => prepositions.includes(p.toLowerCase())))[0];
                if (!wordToHide || !sentence.includes(wordToHide)) {
                    wordToHide = this.shuffleArray(structureParts.filter(p => isNaN(p) && p.length > 2))[0]; // Fallback
                }
                if (!wordToHide) { return this.renderNextInSession(); } // Cannot generate question

                this.data.currentCorrectAnswer = wordToHide;
                const questionHTML = sentence.replace(new RegExp(`\\b${wordToHide}\\b`, 'i'), '<strong class="text-2xl">____</strong>');

                this.renderInputBase('Gap-Fill', questionHTML, `Điền từ còn thiếu vào chỗ trống. Gợi ý: ${item.phrase}`, () => {
                    const userAnswer = document.getElementById('user-input').value.trim();
                    const isCorrect = userAnswer.toLowerCase() === wordToHide.toLowerCase();
                    this.updateProgress(item.id, 'structure', isCorrect);
                    this.showFeedback(isCorrect);
                });
            },

            renderFindAndFixError(item) { // For structures
                if (!item.applicationExamples || item.applicationExamples.length === 0) { return this.renderNextInSession(); }
                
                const sentence = item.applicationExamples[0];
                const prepositionsInSentence = sentence.split(' ').filter(word => ['of', 'to', 'for', 'in', 'on', 'at', 'with'].includes(word.toLowerCase()));
                if(prepositionsInSentence.length === 0) { return this.renderNextInSession(); } // Cannot generate error

                const originalPreposition = this.shuffleArray(prepositionsInSentence)[0];
                const wrongPreposition = this.shuffleArray(['of', 'to', 'for', 'in', 'on', 'at', 'with'].filter(p => p !== originalPreposition.toLowerCase()))[0];
                const incorrectSentence = sentence.replace(new RegExp(`\\b${originalPreposition}\\b`, 'i'), `<span class="text-red-500 font-bold">${wrongPreposition}</span>`);
                const questionHTML = incorrectSentence.split(' ').map((word, i) => `<span class="clickable-word" data-word="${word.replace(/[.,!?]/g, '')}" data-index="${i}">${word}</span>`).join(' ');

                this.data.currentCorrectAnswer = `${wrongPreposition} -> ${originalPreposition}`;
                this.renderInputBase('Find and Fix Error', `<p class="text-lg leading-relaxed">${questionHTML}</p>`, 'Click vào từ sai, sau đó gõ từ đúng để sửa.', () => {
                    const selectedWordEl = document.querySelector('.clickable-word.selected');
                    if (!selectedWordEl) { this.showCustomAlert("Vui lòng chọn từ bạn cho là sai."); return; }
                    
                    const typedCorrection = document.getElementById('user-input').value.trim();
                    const selectedWord = selectedWordEl.dataset.word;
                    
                    const isCorrect = selectedWord.toLowerCase() === wrongPreposition.toLowerCase() && typedCorrection.toLowerCase() === originalPreposition.toLowerCase();
                    this.updateProgress(item.id, 'structure', isCorrect);
                    this.showFeedback(isCorrect);
                }, `
                    <input type="text" id="user-input" class="text-input text-center mt-4" placeholder="Gõ từ đúng vào đây">
                `);

                document.querySelectorAll('.clickable-word').forEach(wordEl => {
                    wordEl.onclick = () => {
                        document.querySelectorAll('.clickable-word').forEach(el => el.classList.remove('selected'));
                        wordEl.classList.add('selected');
                    }
                });
            },
            
            renderCorrectIncorrectSentence(item) { // For structures
                 if (!item.applicationExamples || item.applicationExamples.length === 0) { return this.renderNextInSession(); }
                 
                 let sentence = item.applicationExamples[0];
                 const isCorrect = Math.random() > 0.5;
                 
                 if (!isCorrect) {
                    const prepositionsInSentence = sentence.split(' ').filter(word => ['of', 'to', 'for', 'in', 'on', 'at', 'with'].includes(word.toLowerCase()));
                    if(prepositionsInSentence.length > 0) {
                        const originalPreposition = this.shuffleArray(prepositionsInSentence)[0];
                        const wrongPreposition = this.shuffleArray(['of', 'to', 'for', 'in', 'on', 'at', 'with'].filter(p => p !== originalPreposition.toLowerCase()))[0];
                        sentence = sentence.replace(new RegExp(`\\b${originalPreposition}\\b`, 'i'), wrongPreposition);
                    }
                 }
                 this.data.currentCorrectAnswer = isCorrect ? "Đúng" : "Sai";

                 const options = ["Đúng", "Sai"];
                 this.renderMCQBase('Correct/Incorrect Sentence', `<p class="text-lg italic">"${sentence}"</p>`, options, () => {
                     this.updateProgress(item.id, 'structure', this.data.wasCorrect);
                 }, '<p class="mb-4 text-slate-600">Câu dưới đây đúng hay sai?</p>');
            },
            
            // --- [END] EXERCISE RENDERERS ---

            // --- [START] RENDER HELPERS ---
            
            renderMCQBase(title, questionHTML, options, onCheck, preQuestionHTML = '') {
                this.updateHeader('Practice', title);
                const main = document.getElementById('main-content');
                main.innerHTML = `
                    <div class="fade-in text-center">
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-xl font-bold text-slate-800">${title}</h3>
                           <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                        </div>
                        <div class="card glass-panel">
                           ${preQuestionHTML}
                           <div class="mb-8 text-xl font-semibold min-h-[60px] flex items-center justify-center">${questionHTML}</div>
                           <div id="answer-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             ${options.map(opt => `<button class="answer-option p-4">${opt}</button>`).join('')}
                           </div>
                        </div>
                        <div id="feedback-placeholder" class="mt-6"></div>
                    </div>
                `;

                document.getElementById('answer-options').addEventListener('click', e => {
                    if (e.target.classList.contains('answer-option')) {
                        const selectedOption = e.target;
                        const isCorrect = selectedOption.textContent.trim() === this.data.currentCorrectAnswer.trim();
                        this.data.wasCorrect = isCorrect;
                        
                        document.querySelectorAll('.answer-option').forEach(btn => {
                            btn.disabled = true;
                            btn.classList.add('disabled');
                            if(btn.textContent.trim() === this.data.currentCorrectAnswer.trim()){
                                btn.classList.add('correct');
                            }
                        });

                        if (!isCorrect) {
                            selectedOption.classList.add('incorrect');
                        }
                        
                        onCheck();
                        this.showFeedback(isCorrect);
                    }
                });
            },

            renderInputBase(title, questionHTML, instruction, onCheck, inputHTML = null) {
                this.updateHeader('Practice', title);
                const main = document.getElementById('main-content');
                main.innerHTML = `
                     <div class="fade-in text-center">
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-xl font-bold text-slate-800">${title}</h3>
                           <div class="text-lg font-semibold">${this.data.currentSessionIndex + 1} / ${this.data.sessionItems.length}</div>
                        </div>
                        <div class="card glass-panel">
                            <p class="mb-4 text-slate-600">${instruction}</p>
                            <div class="mb-6 text-xl font-semibold">${questionHTML}</div>
                            ${inputHTML || `<input type="text" id="user-input" class="text-input text-center" placeholder="Gõ câu trả lời...">`}
                        </div>
                        <div id="feedback-placeholder" class="mt-6">
                            <button id="check-btn" class="btn btn-main-action">Kiểm tra</button>
                        </div>
                    </div>
                `;

                document.getElementById('check-btn').onclick = onCheck;
                document.getElementById('user-input')?.addEventListener('keyup', e => {
                    if (e.key === 'Enter') onCheck();
                });
            },

            // --- [END] RENDER HELPERS ---
            
            showFeedback(isCorrect, customMessage = null) {
                const feedbackArea = document.getElementById('feedback-area');
                document.getElementById('feedback-placeholder')?.remove(); // Remove button placeholder
                
                let messageHTML;
                if (customMessage) {
                    messageHTML = `<p class="${isCorrect ? 'text-green-600' : 'text-red-600'} font-bold text-lg">${customMessage}</p>`;
                } else {
                    if (isCorrect) {
                        messageHTML = `<p class="text-green-600 font-bold text-lg">Chính xác! <i class="fas fa-check-circle"></i></p>`;
                    } else {
                        messageHTML = `<p class="text-red-600 font-bold text-lg">Chưa đúng! <i class="fas fa-times-circle"></i> Đáp án đúng là: <strong class="underline">${this.data.currentCorrectAnswer}</strong></p>`;
                    }
                }
                
                feedbackArea.innerHTML = `
                    ${messageHTML}
                    <button id="next-session-btn" class="btn btn-main-action mt-4">Câu tiếp theo</button>
                `;
                feedbackArea.parentElement.style.transform = 'translate(-50%, 0)'; // Slide up

                document.getElementById('next-session-btn').onclick = () => {
                    feedbackArea.parentElement.style.transform = 'translate(-50%, 150%)'; // Slide down
                    this.data.currentSessionIndex++;
                    this.renderNextInSession(); 
                };
            },

            showSessionEndSummary() {
                 this.updateHeader('Hoàn thành!', "Bạn đã kết thúc phiên luyện tập.");
                 const main = document.getElementById('main-content');
                 main.innerHTML = `
                    <div class="fade-in text-center">
                        <div class="card glass-panel">
                            <i class="fas fa-trophy text-5xl text-amber-400 mb-4"></i>
                            <h2 class="text-3xl font-bold mb-4">Chúc mừng!</h2>
                            <p class="text-lg text-slate-600 mb-6">Bạn đã hoàn thành phiên luyện tập này.</p>
                             <button id="back-to-dashboard-btn" class="btn btn-main-action">Về trang chính</button>
                        </div>
                    </div>
                 `;
                 document.getElementById('back-to-dashboard-btn').onclick = () => this.renderDashboard();
            },

            // --- UTILITY & HELPER FUNCTIONS ---
            showErrorState(message) {
                document.getElementById('loader-overlay').classList.remove('is-open');
                document.body.innerHTML = `<div class="flex items-center justify-center min-h-screen bg-red-100"><div class="text-center p-8 bg-white/70 backdrop-blur-md rounded-2xl shadow-lg max-w-lg"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i><h2 class="text-2xl font-bold text-red-700">Đã xảy ra lỗi</h2><p class="text-slate-600 mt-2">${message}</p><button onclick="window.location.href='/'" class="btn btn-main-action mt-6">Quay lại trang chủ</button></div></div>`;
            },
            
            initSidebarNav() {
                document.getElementById('nav-dashboard').addEventListener('click', () => this.renderDashboard());
                document.getElementById('nav-study').addEventListener('click', () => this.renderSelectionScreen('study'));
                document.getElementById('nav-practice').addEventListener('click', () => this.renderSelectionScreen('practice'));
                document.getElementById('nav-test').addEventListener('click', () => this.renderSelectionScreen('test'));
                document.getElementById('nav-reset').addEventListener('click', () => {
                    this.showCustomConfirm("Bạn có chắc muốn xóa toàn bộ tiến trình của bài tập này không?", async () => {
                        this.data.progress = { learnedItems: {}, lastTestResult: null, incorrectCounts: {} };
                        await this.saveProgressToFirebase();
                        this.applyUserProgress();
                        this.renderDashboard();
                        this.showCustomAlert("Đã xóa tiến trình.");
                    }, 'Xóa', 'Hủy');
                });
            },
            setActiveNav(navId) { document.querySelectorAll('.sidebar-nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(navId)?.classList.add('active'); },
            updateHeader(title, subtitle) { document.getElementById('app-title').textContent = title; document.getElementById('app-subtitle').textContent = subtitle; },
            initModals() {
                document.getElementById('close-word-modal-btn').onclick = () => this.closeModal('word-list-modal');
                document.getElementById('close-test-modal-btn').onclick = () => this.closeModal('test-setup-modal');
                document.getElementById('start-test-fixed-btn').addEventListener('click', () => { this.closeModal('test-setup-modal'); this.startTest(parseInt(document.getElementById('question-count').value)); });
                document.getElementById('start-test-all-btn').addEventListener('click', () => { this.closeModal('test-setup-modal'); this.startTest(-1); });
            },
            openModal(id) { document.getElementById(id)?.classList.add('is-open'); },
            closeModal(id) { const m = document.getElementById(id); if(m) { m.classList.add('is-closing'); setTimeout(() => m.classList.remove('is-open', 'is-closing'), 300); } },
            showFilteredList(listType) {
                const table = document.getElementById('word-table');
                const title = document.getElementById('modal-title');
                let items, headers, rows;
                const isStruct = listType.includes('structures');
                const isLearned = listType.includes('learned');
                
                if (isStruct) {
                    items = this.data.structures.filter(i => i.isLearned === isLearned);
                    title.textContent = `${isLearned ? 'Đã học' : 'Chưa học'} Cấu trúc (${items.length})`;
                    headers = `<thead><tr class="text-xs uppercase"><th class="px-6 py-3">Structure</th><th class="px-6 py-3">Meaning</th></tr></thead>`;
                    rows = items.map(i => `<tr class="border-b border-slate-200/50 dark:border-slate-700/50"><td class="px-6 py-4 font-medium">${i.phrase}</td><td class="px-6 py-4">${i.meaning}</td></tr>`).join('');
                } else {
                    items = this.data.words.filter(i => i.isLearned === isLearned);
                    title.textContent = `${isLearned ? 'Đã học' : 'Chưa học'} Từ vựng (${items.length})`;
                    headers = `<thead><tr class="text-xs uppercase"><th class="px-6 py-3">Word</th><th class="px-6 py-3">Type</th><th class="px-6 py-3">Meaning</th></tr></thead>`;
                    rows = items.map(i => `<tr class="border-b border-slate-200/50 dark:border-slate-700/50"><td class="px-6 py-4 font-medium">${i.word}</td><td class="px-6 py-4">${i.type}</td><td class="px-6 py-4">${i.meaning}</td></tr>`).join('');
                }
                table.innerHTML = headers + `<tbody>${rows.length > 0 ? rows : `<tr><td colspan="3" class="text-center p-8 text-slate-500">Không có mục nào.</td></tr>`}</tbody>`;
                this.openModal('word-list-modal');
            },
            showCustomAlert(message) {
                const alertId = 'custom-alert-box';
                document.getElementById(alertId)?.remove();
                const alertBox = document.createElement('div');
                alertBox.id = alertId;
                alertBox.className = 'glass-panel';
                alertBox.style.cssText = `position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:16px 24px; border-radius:16px; z-index:200; font-weight:600; color:var(--text-primary); animation:fadeIn 0.5s ease forwards; box-shadow: 0 5px 20px rgba(0,0,0,0.2);`;
                alertBox.innerHTML = message;
                document.body.appendChild(alertBox);
                setTimeout(() => { alertBox.style.animation = 'scaleOut 0.5s ease forwards'; setTimeout(() => alertBox.remove(), 500); }, 3000);
            },
            showCustomConfirm(message, onConfirm, confirmText = 'Yes', cancelText = 'Cancel') {
                const confirmId = 'custom-confirm-box';
                document.getElementById(confirmId)?.remove();
                const confirmBox = document.createElement('div');
                confirmBox.id = confirmId;
                confirmBox.className = 'modal is-open';
                confirmBox.innerHTML = `<div class="modal-content glass-panel text-center"><p class="text-lg font-medium mb-6">${message}</p><div class="flex justify-center gap-4"><button id="confirm-no" class="btn btn-secondary">${cancelText}</button><button id="confirm-yes" class="btn btn-main-action bg-red-500 hover:bg-red-600">${confirmText}</button></div></div>`;
                document.body.appendChild(confirmBox);
                const close = () => { confirmBox.classList.add('is-closing'); setTimeout(() => confirmBox.remove(), 300); };
                document.getElementById('confirm-yes').onclick = () => { onConfirm(); close(); };
                document.getElementById('confirm-no').onclick = close;
            },
            shuffleArray(array) { 
                const a = [...array];
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
