<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc v√† Luy·ªán t·∫≠p T·ª´ v·ª±ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>

    <style>
        :root {
            --primary-color: #6d28d9; --primary-hover: #5b21b6;
            --correct-color: #16a34a; --incorrect-color: #dc2626;
            --bg-light: #f5f7ff; --bg-card: #ffffff; --text-primary: #0f172a;
            --text-secondary: #475569; --border-color: #e5e7eb;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--bg-light); color: var(--text-primary); }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--bg-card); color: var(--text-secondary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: #f9fafb; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-fill { background-color: var(--primary-color); height: 100%; transition: width 0.4s ease; }
        
        /* Flashcard Styles */
        .flashcard-viewer { display: flex; flex-direction: column; height: 70vh; max-width: 800px; margin: 0 auto; }
        .flashcard-main { flex-grow: 1; display: flex; align-items: center; justify-content: center; perspective: 1000px; }
        .flashcard { width: 100%; height: 80%; max-height: 400px; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07); padding: 2rem; text-align: center; border: 1px solid var(--border-color); }
        .flashcard-front { background-image: linear-gradient(to top right, var(--bg-card), #f7f8ff); }
        .flashcard-back { transform: rotateY(180deg); background-color: #f9fafb; }
        
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @keyframes slideInLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-out-left { animation: slideOutLeft 0.3s forwards ease-in-out; }
        .slide-out-right { animation: slideOutRight 0.3s forwards ease-in-out; }
        .slide-in-left { animation: slideInLeft 0.3s forwards ease-in-out; }
        .slide-in-right { animation: slideInRight 0.3s forwards ease-in-out; }

        /* Practice Styles */
        .answer-option { display: block; width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: 0.75rem; background-color: var(--bg-card); text-align: left; font-weight: 500; }
        .answer-option:hover:not(.disabled) { border-color: var(--primary-color); background-color: #f5f3ff; }
        .answer-option.disabled { cursor: not-allowed; }
        .answer-option.correct { border-color: var(--correct-color); background-color: #f0fdf4; color: #14532d; }
        .answer-option.incorrect { border-color: var(--incorrect-color); background-color: #fef2f2; color: #991b1b; }
        .token-area { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 1rem; border: 2px dashed #cbd5e1; border-radius: 0.5rem; min-height: 80px; }
        .word-token { padding: 0.5rem 1rem; background-color: #eef2ff; color: #4338ca; border-radius: 0.5rem; font-weight: 500; cursor: pointer; }
        .speed-control { display: flex; align-items: center; gap: 0.5rem; background-color: rgba(255, 255, 255, 0.5); padding: 4px 8px; border-radius: 9999px; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .audio-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.05);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }
        .audio-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <div id="loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-8 border-t-violet-500 border-gray-200 rounded-full animate-spin"></div>
            <p id="loader-text" class="text-lg font-semibold text-white mt-4">ƒêang t·∫£i d·ªØ li·ªáu b√†i h·ªçc...</p>
        </div>
    </div>
    <div id="modal-container"></div>
    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-8 hidden">
        <header id="app-header" class="mb-8"></header>
        <main id="app-main"></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const App = {
            state: {
                db: null,
                submissionId: null,
                studentName: '',
                testData: {},
                wordList: [],
                structureList: [],
                wordFamilies: {},
                currentSessionItems: [],
                sessionCorrectItems: [],
                sessionIncorrectItems: [],
                currentIndex: 0,
                currentScore: 0,
                currentCorrectAnswer: null,
                progress: { learnedItems: new Set(), incorrectCounts: {} },
             session: {
            isCompleted: false, // Tr·∫°ng th√°i ho√†n th√†nh chung
            finalTestTaken: false, // ƒê√£ l√†m b√†i test cu·ªëi ch∆∞a
            finalTestScore: null,  // ƒêi·ªÉm c·ªßa b√†i test cu·ªëi
        },
        proctoring: {
            violations: 0,
            timerId: null,
            timeRemaining: 0,
        }
    },
            DOM: {},

            async init() {
                this.DOM = {
                    loader: document.getElementById('loader-overlay'),
                    loaderText: document.getElementById('loader-text'),
                    container: document.getElementById('app-container'),
                    header: document.getElementById('app-header'),
                    main: document.getElementById('app-main'),
                    modal: document.getElementById('modal-container'),
                };
                this.state.db = getFirestore(initializeApp(window.firebaseConfig));
                this.state.audioPlayer = new Audio();
                const params = new URLSearchParams(window.location.search);
                const submissionId = params.get('submission_id');

                if (!submissionId) {
                    this.showModal("L·ªói", "Kh√¥ng t√¨m th·∫•y m√£ d·ª± thi.");
                    return;
                }
                
                this.state.submissionId = submissionId;
                await this.startSession(submissionId);
            },
            
            async startSession(submissionId) {
                try {
                    const submissionRef = doc(this.state.db, 'submissions', submissionId);
                    const submissionSnap = await getDoc(submissionRef);
                    if (!submissionSnap.exists()) throw new Error("M√£ truy c·∫≠p kh√¥ng h·ª£p l·ªá.");

                    let submissionData = submissionSnap.data();
                    if (submissionData.finalTest && submissionData.finalTest.status === 'completed') {
    this.state.session.finalTestTaken = true;
    this.state.session.finalTestScore = submissionData.finalTest.score;
}
                  this.state.session.isCompleted = submissionData.status === 'submitted';
if (this.state.session.isCompleted) {
    console.log("Session already completed. Entering review mode.");
                    
                    const testRef = doc(this.state.db, 'vocab_sets', submissionData.testId);
                    const testSnap = await getDoc(testRef);
                    if (!testSnap.exists()) throw new Error("Kh√¥ng t√¨m th·∫•y b·ªô t·ª´ v·ª±ng t∆∞∆°ng ·ª©ng.");

                    this.state.studentName = submissionData.studentName;
                    this.state.testData = testSnap.data();
                    this.state.wordList = this.state.testData.wordList || [];
                    
                    this.processData();
                    this.loadProgress();
                    
                    this.DOM.loader.classList.add('hidden');
                    this.DOM.container.classList.remove('hidden');
                    
                    this.renderHeader();
                    this.renderDashboard();
                } catch (error) {
                    this.showModal("L·ªói", error.message);
                }
            },
            
            processData() {
                const structures = [];
                const families = {};
                this.state.wordList.forEach((word, idx) => {
                    word.itemType = 'word';
                    word.id = `word_${word.id || idx}`; 
                    if (word.structures && Array.isArray(word.structures)) {
                        word.structures.forEach((struct, s_idx) => {
                            structures.push({ ...struct, id: `structure_${word.id}_${s_idx}`, itemType: 'structure', rootWord: word.word });
                        });
                    }
                    const root = this.findRoot(word.word);
                    word.familyRoot = root;
                    if (!families[root]) families[root] = [];
                    families[root].push(word);
                });
                this.state.structureList = structures;
                this.state.wordFamilies = families;
            },

            loadProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                const savedProgress = localStorage.getItem(progressKey);
                if (savedProgress) {
                    const parsed = JSON.parse(savedProgress);
                    this.state.progress.learnedItems = new Set(parsed.learnedItems || []);
                    this.state.progress.incorrectCounts = parsed.incorrectCounts || {};
                }
            },

            saveProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                localStorage.setItem(progressKey, JSON.stringify({
                    learnedItems: [...this.state.progress.learnedItems],
                    incorrectCounts: this.state.progress.incorrectCounts,
                }));
            },

            renderHeader() {
                this.DOM.header.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">${this.state.testData.title}</h1>
                            <p class="text-sm text-gray-500">H·ªçc vi√™n: <span class="font-medium">${this.state.studentName}</span></p>
                        </div>
                        <button id="submit-final-btn" class="btn btn-primary"><i class="fas fa-check-circle mr-2"></i> Ho√†n th√†nh & L∆∞u ti·∫øn ƒë·ªô</button>
                    </div>`;
                document.getElementById('submit-final-btn').addEventListener('click', () => {
                    this.showModal(
                        "X√°c nh·∫≠n Ho√†n th√†nh", "B·∫°n c√≥ ch·∫Øc mu·ªën k·∫øt th√∫c v√† l∆∞u ti·∫øn ƒë·ªô h·ªçc t·∫≠p kh√¥ng? Thao t√°c n√†y s·∫Ω ghi nh·∫≠n k·∫øt qu·∫£ cu·ªëi c√πng.",
                        true, () => this.submitToFirebase(true)
                    );
                });
            },

            renderDashboard() {
                const { wordList, structureList, progress } = this.state;
                const vocabLearned = wordList.filter(w => progress.learnedItems.has(w.id)).length;
                const structLearned = structureList.filter(s => progress.learnedItems.has(s.id)).length;
                const vocabProgress = wordList.length > 0 ? (vocabLearned / wordList.length * 100) : 0;
                const structProgress = structureList.length > 0 ? (structLearned / structureList.length * 100) : 0;
                const totalItems = wordList.length + structureList.length;
const learnedCount = progress.learnedItems.size;
const overallProgress = totalItems > 0 ? (learnedCount / totalItems * 100) : 0;
const isEligibleForFinalTest = overallProgress >= 85;
                const notifKey = `finalTestNotif_${this.state.submissionId}`;
if (isEligibleForFinalTest && !localStorage.getItem(notifKey) && !this.state.session.finalTestTaken) {
    setTimeout(() => {
        this.showModal("Congratulations!", "You have learned 85% of the material and unlocked the Final Test!");
        localStorage.setItem(notifKey, 'true');
    }, 1000);
}
                this.DOM.main.innerHTML = `
                    <div class="space-y-8 fade-in">
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                             <h2 class="text-xl font-bold mb-4">T·ªïng quan Ti·∫øn ƒë·ªô</h2>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div><p class="font-medium mb-1">T·ª´ v·ª±ng ƒë√£ h·ªçc</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${vocabProgress.toFixed(0)}%;"></div></div><p class="text-right text-sm mt-1">${vocabLearned}/${wordList.length}</p></div>
                                 <div><p class="font-medium mb-1">C·∫•u tr√∫c ƒë√£ h·ªçc</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${structProgress.toFixed(0)}%;"></div></div><p class="text-right text-sm mt-1">${structLearned}/${structureList.length}</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h2 class="text-xl font-bold mb-4">H·ªçc t·∫≠p üìö</h2>
                            <div id="study-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button data-study-mode="vocab-flashcard" class="btn btn-secondary !p-4 !items-start text-left"><div class="text-lg"><i class="fas fa-clone w-6 text-violet-500"></i></div><div><p class="font-bold">Flashcard T·ª´ v·ª±ng</p><p class="text-xs font-normal">H·ªçc t·ª´ m·ªõi qua th·∫ª ghi nh·ªõ.</p></div></button>
                                <button data-study-mode="mindmap" class="btn btn-secondary !p-4 !items-start text-left"><div class="text-lg"><i class="fas fa-project-diagram w-6 text-sky-500"></i></div><div><p class="font-bold">S∆° ƒë·ªì H·ªç t·ª´</p><p class="text-xs font-normal">Kh√°m ph√° m·ªëi li√™n h·ªá c√°c t·ª´.</p></div></button>
                                <button data-study-mode="struct-flashcard" class="btn btn-secondary !p-4 !items-start text-left"><div class="text-lg"><i class="fas fa-sitemap w-6 text-emerald-500"></i></div><div><p class="font-bold">Flashcard C·∫•u tr√∫c</p><p class="text-xs font-normal">H·ªçc c√°c c·∫•u tr√∫c c√¢u quan tr·ªçng.</p></div></button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h2 class="text-xl font-bold mb-4">Luy·ªán t·∫≠p üèãÔ∏è‚Äç‚ôÄÔ∏è</h2>
                            <div id="practice-guide-buttons" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mb-6"></div>
                            <div id="practice-buttons" class="flex flex-col gap-4">
    <div class="flex flex-col sm:flex-row gap-4">
        <button data-practice-mode="normal" class="btn btn-primary flex-1"><i class="fas fa-random mr-2"></i> Normal Practice</button>
        <button data-practice-mode="weakness" class="btn btn-secondary flex-1 border-amber-500 text-amber-600 hover:bg-amber-50"><i class="fas fa-star-half-alt mr-2"></i> Review Weaknesses</button>
    </div>
    ${ isEligibleForFinalTest ? `
        <button id="start-final-test-btn" class="btn btn-danger w-full mt-4 text-lg py-4" ${this.state.session.finalTestTaken ? 'disabled' : ''}>
            <i class="fas fa-graduation-cap mr-2"></i>
            ${this.state.session.finalTestTaken ? `Final Test Taken (Score: ${this.state.session.finalTestScore}%)` : 'Start Final Test'}
        </button>
    ` : '' }
</div>
                        </div>
                    </div>`;

                this.renderPracticeGuide();
                document.getElementById('study-buttons').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button || !button.dataset.studyMode) return;
                    const mode = button.dataset.studyMode;
                    if (mode === 'vocab-flashcard') this.startFlashcardSession('word');
                    if (mode === 'struct-flashcard') this.startFlashcardSession('structure');
                    if (mode === 'mindmap') this.renderMindmapFamilySelection();
                });

                const practiceButtons = document.getElementById('practice-buttons');
                practiceButtons.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.practiceMode) this.startPractice(button.dataset.practiceMode);
                });
                const finalTestBtn = document.getElementById('start-final-test-btn');
if (finalTestBtn) {
    finalTestBtn.addEventListener('click', () => {
        this.showModal(
            "Confirm Final Test", 
            "This is your final test. It can only be taken once and will be timed. Are you ready to begin?", 
            true, 
            () => this.startFinalTest()
        );
    });
}
                if (Object.keys(this.state.progress.incorrectCounts).length === 0) {
                    practiceButtons.querySelector('[data-practice-mode="weakness"]').disabled = true;
                }
            },

            startFlashcardSession(type) {
                this.state.currentSessionItems = type === 'word' ? this.state.wordList : this.state.structureList;
                if(this.state.currentSessionItems.length === 0) {
                    this.showModal("Th√¥ng b√°o", "Kh√¥ng c√≥ d·ªØ li·ªáu cho ph·∫ßn h·ªçc n√†y.");
                    return;
                }
                this.state.currentIndex = 0;
                this.renderFlashcardViewer();
            },
            
            renderFlashcardViewer() {
                this.DOM.main.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                    <div class="flashcard-viewer">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-to-dashboard-btn" class="btn btn-secondary !py-2 !px-4"><i class="fas fa-arrow-left mr-2"></i> Quay l·∫°i</button>
                            <div id="card-counter" class="font-semibold text-slate-700"></div>
                        </div>
                        <div class="flashcard-main"><div class="flashcard" id="flashcard"></div></div>
                        <div class="flashcard-nav flex justify-between items-center p-4">
                            <button id="prev-card-btn" class="btn btn-secondary !rounded-full !w-14 !h-14 text-xl"><i class="fas fa-arrow-left"></i></button>
                            <p class="text-sm text-gray-500">Nh·∫•n v√†o th·∫ª ƒë·ªÉ l·∫≠t</p>
                            <button id="next-card-btn" class="btn btn-secondary !rounded-full !w-14 !h-14 text-xl"><i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>`;
                
                this.updateFlashcardView();
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('flashcard').addEventListener('click', e => {
                    if (e.target.closest('.audio-btn')) return;
                    e.currentTarget.classList.toggle('is-flipped');
                });
                document.getElementById('prev-card-btn').addEventListener('click', () => this.navigateCard(-1));
                document.getElementById('next-card-btn').addEventListener('click', () => this.navigateCard(1));
            },

            updateFlashcardView() {
                const item = this.state.currentSessionItems[this.state.currentIndex];
                const card = document.getElementById('flashcard');
                if (!item || !card) return;

                card.classList.remove('is-flipped');
                const isStructure = item.itemType === 'structure';
                const audioBtnHTML = item.audioUrl ? `<button class="audio-btn" data-audio-url="${item.audioUrl}"><i class="fas fa-volume-up"></i></button>` : '';

                const frontHTML = `${audioBtnHTML}<div class="text-4xl font-bold">${isStructure ? item.phrase : item.word}</div>`;
                const backHTML = isStructure
                    ? `<div class="text-2xl font-semibold">${item.meaning}</div><p class="text-slate-500 mt-4 italic">"${item.applicationExamples?.[0] || ''}"</p>`
                    : `${audioBtnHTML}<div class="text-3xl font-semibold">${item.meaning}</div><p class="text-slate-500 mt-2 text-lg">${item.pronunciation} <span class="mx-2">&bull;</span> ${item.type}</p><p class="text-slate-500 mt-4 italic">"${item.exampleSentence || ''}"</p>`;
                
                card.innerHTML = `<div class="flashcard-face flashcard-front">${frontHTML}</div><div class="flashcard-face flashcard-back">${backHTML}</div>`;
                
                card.querySelectorAll('.audio-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.playAudio(e.currentTarget.dataset.audioUrl);
                    });
                });
                
                document.getElementById('card-counter').textContent = `${this.state.currentIndex + 1} / ${this.state.currentSessionItems.length}`;
            },

            navigateCard(direction) {
                const card = document.getElementById('flashcard');
                if (!card) return;
                const animationClass = direction === 1 ? 'slide-out-left' : 'slide-out-right';
                card.classList.add(animationClass);
                setTimeout(() => {
                    const newIndex = this.state.currentIndex + direction;
                    const total = this.state.currentSessionItems.length;
                    this.state.currentIndex = (newIndex + total) % total;
                    card.classList.remove('slide-out-left', 'slide-out-right');
                    this.updateFlashcardView();
                    card.classList.add(direction === 1 ? 'slide-in-right' : 'slide-in-left');
                    setTimeout(() => card.classList.remove('slide-in-right', 'slide-in-left'), 300);
                }, 300);
            },

            renderMindmapFamilySelection() {
                const familiesWithMultipleMembers = Object.entries(this.state.wordFamilies).filter(([root, members]) => members.length > 1);
                if (familiesWithMultipleMembers.length === 0) {
                    this.showModal("Th√¥ng b√°o", "Kh√¥ng c√≥ ƒë·ªß h·ªç t·ª´ ƒë·ªÉ t·∫°o s∆° ƒë·ªì.");
                    return;
                }
                this.DOM.main.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                    <div class="flex items-center mb-6">
                        <button id="back-to-dashboard-btn" class="btn btn-secondary !py-2 !px-4 mr-4"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold">Ch·ªçn m·ªôt h·ªç t·ª´ ƒë·ªÉ kh√°m ph√°</h2>
                    </div>
                    <div id="family-list" class="flex flex-wrap gap-3">
                        ${familiesWithMultipleMembers.map(([root, members]) => `
                            <button data-family-root="${root}" class="btn btn-secondary !py-3 !px-5">${root} (${members.length})</button>
                        `).join('')}
                    </div>
                </div>`;
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('family-list').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.familyRoot) this.renderMindmap(button.dataset.familyRoot);
                });
            },

            renderMindmap(familyRoot) {
                const family = this.state.wordFamilies[familyRoot];
                const centerWord = family[0];
                this.DOM.main.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                    <div class="flex items-center mb-6">
                         <button id="back-to-selection-btn" class="btn btn-secondary !py-2 !px-4 mr-4"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold">H·ªç t·ª´: ${familyRoot}</h2>
                    </div>
                    <div class="relative w-full h-[60vh] flex items-center justify-center overflow-hidden">
                        <div id="mindmap" class="relative w-[150px] h-[150px]"></div>
                    </div>
                </div>`;
                document.getElementById('back-to-selection-btn').addEventListener('click', () => this.renderMindmapFamilySelection());

                const container = document.getElementById('mindmap');
                const children = family.slice(1);
                let html = `<div class="mindmap-node center"><span>${centerWord.word}</span><span class="text-sm font-normal">(${centerWord.type})</span></div>`;

                if (children.length > 0) {
                    const angleStep = 360 / children.length;
                    const radius = Math.min(container.parentElement.offsetWidth / 2.5, 250);
                    children.forEach((child, i) => {
                        const angle = angleStep * i;
                        const x = radius * Math.cos(angle * Math.PI / 180);
                        const y = radius * Math.sin(angle * Math.PI / 180);
                        html += `<div class="mindmap-line" style="width: ${radius}px; transform: translate(75px, 75px) rotate(${angle}deg);"></div>`;
                        html += `<div class="mindmap-node child" style="transform: translate(${x}px, ${y}px) translate(20px, 20px);"><span class="font-semibold">${child.word}</span><span class="text-xs">(${child.type})</span></div>`;
                    });
                }
                container.innerHTML = html;
            },

            renderPracticeGuide() {
                const guideContainer = document.getElementById('practice-guide-buttons');
                const exerciseTypes = [
                    { type: 'TraditionalMCQ', name: 'Tr·∫Øc nghi·ªám', icon: 'fa-list-check', color: 'text-violet-500' },
                    { type: 'ContextualMCQ', name: 'Ng·ªØ c·∫£nh', icon: 'fa-quote-left', color: 'text-sky-500' },
                    { type: 'WordFamilyMCQ', name: 'H·ªç t·ª´', icon: 'fa-users', color: 'text-blue-500' },
                    { type: 'SentenceUnscramble', name: 'S·∫Øp x·∫øp c√¢u', icon: 'fa-sort-alpha-down', color: 'text-indigo-500' },
                    { type: 'GapFill', name: 'ƒêi·ªÅn t·ª´', icon: 'fa-edit', color: 'text-emerald-500' },
                    { type: 'AudioListening', name: 'Nghe & G√µ', icon: 'fa-volume-up', color: 'text-pink-500' },
                    { type: 'TriosOfGappedSentence', name: 'T√¨m t·ª´ chung', icon: 'fa-search-plus', color: 'text-teal-500' },
                    { type: 'ErrorCorrection', name: 'S·ª≠a l·ªói', icon: 'fa-check-double', color: 'text-rose-500' },
                    { type: 'IPAFill', name: 'Phi√™n √¢m', icon: 'fa-language', color: 'text-orange-500' },
                ];
                guideContainer.innerHTML = exerciseTypes.map(ex => `
                    <button data-guide-type="${ex.type}" class="btn btn-secondary !p-2 !justify-start text-left text-sm">
                        <i class="fas ${ex.icon} ${ex.color} w-8 text-center text-base"></i>
                        <span class="font-semibold">${ex.name}</span>
                    </button>
                `).join('');
                
                guideContainer.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.guideType) {
                        this.renderGuideModal(button.dataset.guideType);
                    }
                });
            },

            renderGuideModal(exerciseType) {
                const exerciseInfo = {
                    'TraditionalMCQ': { name: 'Tr·∫Øc nghi·ªám T·ª´ & Nghƒ©a', desc: 'Ch·ªçn nghƒ©a ti·∫øng Vi·ªát ƒë√∫ng cho t·ª´ ti·∫øng Anh cho s·∫µn, ho·∫∑c ng∆∞·ª£c l·∫°i.' },
                    'ContextualMCQ': { name: 'Tr·∫Øc nghi·ªám Ng·ªØ c·∫£nh', desc: 'Ch·ªçn t·ª´ v·ª±ng ph√π h·ª£p nh·∫•t ƒë·ªÉ ƒëi·ªÅn v√†o ch·ªó tr·ªëng trong m·ªôt c√¢u v√≠ d·ª•.' },
                    'WordFamilyMCQ': { name: 'Tr·∫Øc nghi·ªám H·ªç t·ª´', desc: 'Ch·ªçn d·∫°ng ƒë√∫ng c·ªßa t·ª´ (danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´...) trong c√πng m·ªôt h·ªç t·ª´ ƒë·ªÉ ho√†n th√†nh c√¢u.' },
                    'SentenceUnscramble': { name: 'S·∫Øp x·∫øp c√¢u', desc: 'Nh·∫•n v√†o c√°c t·ª´ cho s·∫µn theo ƒë√∫ng th·ª© t·ª± ƒë·ªÉ t·∫°o th√†nh m·ªôt c√¢u ho√†n ch·ªânh.' },
                    'GapFill': { name: 'ƒêi·ªÅn v√†o ch·ªó tr·ªëng', desc: 'G√µ m·ªôt t·ª´ (th∆∞·ªùng l√† gi·ªõi t·ª´) c√≤n thi·∫øu v√†o ch·ªó tr·ªëng trong m·ªôt c·∫•u tr√∫c c√¢u.' },
                    'AudioListening': { name: 'Nghe & G√µ', desc: 'Nghe ph√°t √¢m c·ªßa m·ªôt t·ª´ ho·∫∑c m·ªôt c√¢u v√† g√µ l·∫°i ch√≠nh x√°c nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c.' },
                    'TriosOfGappedSentence': { name: 'T√¨m t·ª´ chung', desc: 'T√¨m m·ªôt t·ª´ duy nh·∫•t c√≥ th·ªÉ ƒëi·ªÅn v√†o c·∫£ 3 ch·ªó tr·ªëng trong c√°c c√¢u kh√°c nhau.'},
                    'ErrorCorrection': { name: 'S·ª≠a l·ªói sai', desc: 'X√°c ƒë·ªãnh m·ªôt c√¢u cho s·∫µn l√† ƒë√∫ng hay sai. N·∫øu sai, h√£y s·ª≠a l·∫°i cho ƒë√∫ng.' },
                    'IPAFill': { name: 'ƒêi·ªÅn phi√™n √¢m', desc: 'Ch·ªçn nguy√™n √¢m ƒë√∫ng ƒë·ªÉ ho√†n th√†nh phi√™n √¢m IPA c·ªßa m·ªôt t·ª´ cho s·∫µn.' }
                };
                
                const info = exerciseInfo[exerciseType];
                const allItems = [...this.state.wordList, ...this.state.structureList];
                const suitableItem = allItems.find(item => this.getPossibleExerciseTypes(item).includes(exerciseType));

                if (!suitableItem) {
                    this.showModal("Th√¥ng b√°o", "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p ƒë·ªÉ t·∫°o v√≠ d·ª• cho d·∫°ng b√†i n√†y.");
                    return;
                }
                
                suitableItem.exerciseType = exerciseType;
                const exampleHTML = this[`get${exerciseType}HTML`](suitableItem, true);

                this.showModal(
                    `H∆∞·ªõng d·∫´n: ${info.name}`,
                    `<p class="text-slate-600 mb-6 text-left">${info.desc}</p>
                     <div class="bg-slate-50 p-4 rounded-lg border">
                         <h4 class="font-bold mb-3 text-left">V√≠ d·ª• t∆∞∆°ng t√°c:</h4>
                         <div id="guide-question-container">${exampleHTML}</div>
                         <div id="guide-feedback-container" class="mt-4"></div>
                     </div>`,
                    false, null, true
                );
                
                const guideContainer = document.getElementById('guide-question-container');
                this.attachPracticeEventListeners(suitableItem, guideContainer, true);
            },

            startPractice(mode, count = 10) {
                this.state.currentIndex = 0;
                this.state.currentScore = 0;
                this.state.sessionCorrectItems = [];
                this.state.sessionIncorrectItems = [];
                let itemsToPractice = [];
                const allItems = [...this.state.wordList, ...this.state.structureList];

                if (mode === 'weakness') {
                    const weakItemIds = Object.keys(this.state.progress.incorrectCounts)
                        .sort((a,b) => this.state.progress.incorrectCounts[b] - this.state.progress.incorrectCounts[a]);
                    itemsToPractice = weakItemIds.map(id => allItems.find(item => item.id === id)).filter(Boolean);
                } else {
                    itemsToPractice = allItems;
                }

                if (itemsToPractice.length === 0) {
                    this.showModal("Tuy·ªát v·ªùi!", mode === 'weakness' ? "B·∫°n kh√¥ng c√≥ ƒëi·ªÉm y·∫øu n√†o c·∫ßn √¥n t·∫≠p." : "B·∫°n ƒë√£ h·ªçc h·∫øt b√†i!");
                    return;
                }
                
                this.state.currentSessionItems = this.shuffleArray(itemsToPractice).slice(0, count);
                this.renderPracticeView();
            },

            renderPracticeView() {
                const total = this.state.currentSessionItems.length;
                const progressPercent = total > 0 ? (this.state.currentIndex / total * 100) : 0;
                this.DOM.main.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm font-medium">C√¢u ${this.state.currentIndex + 1} / ${total}</p>
                                <button id="exit-practice-btn" class="text-sm font-semibold text-gray-600 hover:text-red-500"><i class="fas fa-times mr-1"></i> Tho√°t</button>
                            </div>
                            <div class="progress-bar"><div class="progress-bar-fill" style="width: ${progressPercent}%;"></div></div>
                        </div>
                        <div id="question-container" class="min-h-[300px]"></div>
                        <div id="feedback-container" class="mt-4"></div>
                    </div>`;
                
                document.getElementById('exit-practice-btn').addEventListener('click', () => this.renderDashboard());
                this.renderNextQuestion();
            },

            renderNextQuestion() {
                if (this.state.currentIndex >= this.state.currentSessionItems.length) {
                    this.renderSummary();
                    return;
                }
                const item = this.state.currentSessionItems[this.state.currentIndex];
                const qContainer = document.getElementById('question-container');
                if (!qContainer) return;
                
                const possibleTypes = this.getPossibleExerciseTypes(item);
                const exerciseType = this.shuffleArray(possibleTypes)[0];
                item.exerciseType = exerciseType;

                const renderFunction = this[`get${exerciseType}HTML`];
                qContainer.innerHTML = renderFunction.call(this, item);
                this.attachPracticeEventListeners(item, qContainer);
            },

            getPossibleExerciseTypes(item) {
                const types = [];
                if (item.itemType === 'word') {
                    if (item.distractors_vi?.length >= 3) types.push('TraditionalMCQ');
                    if (item.exampleSentence && item.distractors_en?.length >=3) types.push('ContextualMCQ');
                    if (item.exampleSentence) types.push('SentenceUnscramble');
                    if ((this.state.wordFamilies[item.familyRoot]?.length || 0) > 1) types.push('WordFamilyMCQ');
                    if (this.findSentencesWithWord(item.word).length >= 3) types.push('TriosOfGappedSentence');
                    if (item.audioUrl) types.push('AudioListening');
                    if (item.pronunciation) types.push('IPAFill');
                } else { // structure
                    const sentence = item.applicationExamples?.[0];
                    if (sentence) {
                        const phraseParts = item.phrase.split(/\s+/);
                        const blank = phraseParts.find(p => !['be', 'of', 'to', 'sb', 'sth'].includes(p.toLowerCase()) && p.length > 1 && p.length < 5);
                        if (blank && new RegExp(`\\b${blank}\\b`, 'i').test(sentence)) {
                            item.gapFill = { blank, sentence: sentence.replace(new RegExp(`\\b${blank}\\b`, 'i'), '___') };
                            types.push('GapFill');
                        }
                        const commonErrors = {'on': 'in', 'in': 'at', 'at': 'on', 'to': 'for', 'for': 'to'};
                        for(const correctPrep in commonErrors) {
                            if (sentence.includes(` ${correctPrep} `)) {
                                item.errorCorrection = {
                                    correct: sentence,
                                    incorrect: sentence.replace(` ${correctPrep} `, ` ${commonErrors[correctPrep]} `)
                                };
                                types.push('ErrorCorrection');
                                break;
                            }
                        }
                    }
                }
                return types.length > 0 ? types : ['TraditionalMCQ'];
            },

            renderSummary() {
                const score = this.state.currentScore;
                const total = this.state.currentSessionItems.length;
                this.DOM.main.innerHTML = `
                    <div class="text-center max-w-lg mx-auto bg-white p-8 rounded-xl shadow-sm fade-in">
                        <h1 class="text-3xl font-bold mb-2">Ho√†n th√†nh L∆∞·ª£t luy·ªán t·∫≠p!</h1>
                        <p class="text-lg text-slate-600 mb-6">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${score} / ${total} c√¢u.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-bold text-green-800 mb-2">ƒê√£ h·ªçc (${this.state.sessionCorrectItems.length})</h3>
                                <ul class="text-sm space-y-1 max-h-32 overflow-y-auto">${this.state.sessionCorrectItems.map(item => `<li>${item.word || item.phrase}</li>`).join('')}</ul>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h3 class="font-bold text-red-800 mb-2">C·∫ßn √¥n l·∫°i (${this.state.sessionIncorrectItems.length})</h3>
                                <ul class="text-sm space-y-1 max-h-32 overflow-y-auto">${this.state.sessionIncorrectItems.map(item => `<li>${item.word || item.phrase}</li>`).join('')}</ul>
                            </div>
                        </div>
                        <div class="mt-8 flex flex-col sm:flex-row gap-4">
                            <button id="continue-practice-btn" class="btn btn-primary w-full">Luy·ªán t·∫≠p ti·∫øp</button>
                            <button id="back-to-dashboard-btn" class="btn btn-secondary w-full">Tho√°t</button>
                        </div>
                    </div>`;
                document.getElementById('continue-practice-btn').addEventListener('click', () => this.startPractice('normal'));
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
            },
startFinalTest() {
    const totalItems = this.state.wordList.length + this.state.structureList.length;
    let numQuestions = Math.min(Math.floor(totalItems * 0.5), 50);

    const weakItemIds = Object.keys(this.state.progress.incorrectCounts)
        .sort((a,b) => this.state.progress.incorrectCounts[b] - this.state.progress.incorrectCounts[a]);
    
    let itemsToPractice = weakItemIds
        .map(id => [...this.state.wordList, ...this.state.structureList].find(item => item.id === id))
        .filter(Boolean);

    // N·∫øu kh√¥ng ƒë·ªß c√¢u h·ªèi t·ª´ ƒëi·ªÉm y·∫øu, l·∫•y th√™m t·ª´ c√°c c√¢u ƒë√£ h·ªçc
    if (itemsToPractice.length < numQuestions) {
        const learnedButNotWeak = [...this.state.progress.learnedItems]
            .filter(id => !this.state.progress.incorrectCounts[id])
            .map(id => [...this.state.wordList, ...this.state.structureList].find(item => item.id === id))
            .filter(Boolean);
        itemsToPractice.push(...this.shuffleArray(learnedButNotWeak));
    }

    if (itemsToPractice.length === 0) {
        this.showModal("Error", "Not enough learned items to start the final test.");
        return;
    }

    this.state.currentSessionItems = itemsToPractice.slice(0, numQuestions);
    this.state.currentIndex = 0;
    this.state.currentScore = 0;
    this.state.sessionCorrectItems = [];
    this.state.sessionIncorrectItems = [];
    this.state.proctoring.violations = 0;
    this.state.proctoring.timeRemaining = this.state.currentSessionItems.length * 75; // 75 gi√¢y m·ªói c√¢u

    this.renderFinalTestView();
    this.startProctoring();
},

renderFinalTestView() {
    const total = this.state.currentSessionItems.length;
    const progressPercent = total > 0 ? (this.state.currentIndex / total * 100) : 0;
    
    const minutes = Math.floor(this.state.proctoring.timeRemaining / 60);
    const seconds = this.state.proctoring.timeRemaining % 60;
    const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

    this.DOM.main.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-red-200 fade-in">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2 text-red-700 font-bold">
                    <p>FINAL TEST - Question ${this.state.currentIndex + 1} / ${total}</p>
                    <div id="timer-display" class="text-lg"><i class="fas fa-clock mr-2"></i>${timeString}</div>
                </div>
                <div class="progress-bar"><div id="progress-bar-final-test" class="progress-bar-fill bg-red-500" style="width: ${progressPercent}%;"></div></div>
            </div>
            <div id="question-container" class="min-h-[300px]"></div>
            <div id="feedback-container" class="mt-4"></div>
        </div>`;
    
    this.state.proctoring.timerId = setInterval(() => {
        this.state.proctoring.timeRemaining--;
        const mins = Math.floor(this.state.proctoring.timeRemaining / 60);
        const secs = this.state.proctoring.timeRemaining % 60;
        document.getElementById('timer-display').innerHTML = `<i class="fas fa-clock mr-2"></i>${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        if (this.state.proctoring.timeRemaining <= 0) {
            this.submitFinalTest();
        }
    }, 1000);

    this.renderNextQuestion(); // D√πng chung h√†m render c√¢u h·ªèi
},

startProctoring() {
    this.proctoringEventHandler = (e) => {
        this.state.proctoring.violations++;
        console.warn(`Violation detected: ${e.type}. Total: ${this.state.proctoring.violations}`);
        const warning = document.createElement('div');
        warning.className = 'fixed top-4 right-4 bg-yellow-400 text-black p-3 rounded-lg shadow-lg z-50';
        warning.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Warning: Activity detected! Violations: ${this.state.proctoring.violations}`;
        document.body.appendChild(warning);
        setTimeout(() => warning.remove(), 3000);
        
        // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh
        if (e.type === 'copy' || e.type === 'paste' || e.type === 'contextmenu') {
            e.preventDefault();
        }
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
            e.preventDefault();
        }
    };
    
    document.addEventListener('visibilitychange', this.proctoringEventHandler);
    window.addEventListener('blur', this.proctoringEventHandler);
    document.addEventListener('copy', this.proctoringEventHandler);
    document.addEventListener('paste', this.proctoringEventHandler);
    document.addEventListener('contextmenu', this.proctoringEventHandler);
    document.addEventListener('keydown', this.proctoringEventHandler);
},

stopProctoring() {
    clearInterval(this.state.proctoring.timerId);
    document.removeEventListener('visibilitychange', this.proctoringEventHandler);
    window.removeEventListener('blur', this.proctoringEventHandler);
    document.removeEventListener('copy', this.proctoringEventHandler);
    document.removeEventListener('paste', this.proctoringEventHandler);
    document.removeEventListener('contextmenu', this.proctoringEventHandler);
    document.removeEventListener('keydown', this.proctoringEventHandler);
},

async submitFinalTest() {
    this.stopProctoring();
    if (this.state.isSubmitting) return;
    this.state.isSubmitting = true;

    const score = this.state.currentSessionItems.length > 0 ? Math.round((this.state.currentScore / this.state.currentSessionItems.length) * 100) : 0;
    
    this.DOM.main.innerHTML = `<div class="text-center p-8"><div class="w-12 h-12 border-4 border-t-violet-500 border-gray-200 rounded-full animate-spin mx-auto"></div><p class="mt-4 font-semibold">Submitting your score...</p></div>`;

    const payload = {
        finalTest: {
            status: 'completed',
            score: score,
            violations: this.state.proctoring.violations,
            takenAt: serverTimestamp(),
            correctCount: this.state.currentScore,
            totalQuestions: this.state.currentSessionItems.length
        }
    };

    try {
        await updateDoc(doc(this.state.db, 'submissions', this.state.submissionId), payload);
        this.state.session.finalTestTaken = true;
        this.state.session.finalTestScore = score;
        this.showModal(
            "Test Submitted!",
            `You have completed the final test with a score of ${score}%.<br>Violations detected: ${this.state.proctoring.violations}.<br><br>You can now continue to review the materials.`,
            false,
            () => this.renderDashboard()
        );
    } catch(error) {
        this.showModal("Error", "Could not submit your test score: " + error.message);
    } finally {
        this.state.isSubmitting = false;
    }
}
            getTraditionalMCQHTML(item, isExample = false) {
                const isEngToViet = Math.random() > 0.5;
                const question = isEngToViet ? `${item.word} <span class="text-base font-normal text-slate-500">(${item.type})</span>` : item.meaning;
                this.state.currentCorrectAnswer = isEngToViet ? item.meaning : item.word;
                
                const distractors = this.shuffleArray(isEngToViet ? [...item.distractors_vi] : [...item.distractors_en]).slice(0, 3);
                const options = this.shuffleArray([this.state.currentCorrectAnswer, ...distractors]);

                return `<div class="question-block"><h2 class="text-sm font-semibold text-indigo-600 mb-2">Tr·∫Øc nghi·ªám: Ch·ªçn ƒë√°p √°n ƒë√∫ng</h2><div class="text-2xl font-bold min-h-[60px] mb-8">${question}</div><div id="answer-options" class="space-y-3">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div></div>`;
            },
            
            getContextualMCQHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.word;
                const wordRegex = new RegExp(`\\b${item.word.replace(/s$/, '')}(s?)\\b`, 'gi');
                const sentence = item.exampleSentence.replace(wordRegex, '<span class="font-bold text-indigo-600">[...]</span>');
                const distractors = this.shuffleArray([...item.distractors_en]).slice(0, 3);
                const options = this.shuffleArray([this.state.currentCorrectAnswer, ...distractors]);

                return `<div class="question-block"><h2 class="text-sm font-semibold text-indigo-600 mb-2">Tr·∫Øc nghi·ªám: Ho√†n th√†nh c√¢u</h2><p class="text-xl font-serif italic text-slate-700 min-h-[60px] mb-8">"${sentence}"</p><div id="answer-options" class="space-y-3">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div></div>`;
            },

            getWordFamilyMCQHTML(item, isExample = false) {
                const family = this.state.wordFamilies[item.familyRoot];
                if (!family || family.length < 2) return this.getContextualMCQHTML(item);

                this.state.currentCorrectAnswer = item.word;
                const wordRegex = new RegExp(`\\b${item.word.replace(/s$/, '')}(s?)\\b`, 'gi');
                const sentence = item.exampleSentence.replace(wordRegex, '<span class="font-bold text-indigo-600">[...]</span>');
                
                const distractors = this.shuffleArray(family.filter(w => w.id !== item.id)).slice(0, 3).map(w => w.word);
                const options = this.shuffleArray([this.state.currentCorrectAnswer, ...distractors]);

                return `<div class="question-block"><h2 class="text-sm font-semibold text-indigo-600 mb-2">Tr·∫Øc nghi·ªám: H·ªç t·ª´</h2><p class="text-slate-600 mb-4">Ch·ªçn t·ª´ ƒë√∫ng trong h·ªç t·ª´ "<strong>${item.familyRoot}</strong>" ƒë·ªÉ ho√†n th√†nh c√¢u.</p><p class="text-xl font-serif italic text-slate-700 min-h-[60px] mb-8">"${sentence}"</p><div id="answer-options" class="space-y-3">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div></div>`;
            },
            
            getAudioListeningHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.word;
                return `<div class="question-block">
                    <h2 class="text-sm font-semibold text-indigo-600 mb-2">Luy·ªán nghe: G√µ l·∫°i t·ª´</h2>
                    <div class="text-center mb-6">
                        <button id="play-audio-btn" data-audio-url="${item.audioUrl}" class="text-5xl text-indigo-500 hover:text-indigo-700 transition-colors"><i class="fas fa-play-circle"></i></button>
                    </div>
                    <div class="flex justify-center mb-6">
                        <div class="speed-control">
                            <button data-speed="0.75" class="speed-btn px-2 text-sm">0.75x</button>
                            <button data-speed="1.0" class="speed-btn px-2 text-sm font-bold text-indigo-600">1x</button>
                            <button data-speed="1.25" class="speed-btn px-2 text-sm">1.25x</button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="text-input" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="G√µ nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c...">
                        <button id="check-btn" class="btn btn-primary !py-3">Ki·ªÉm tra</button>
                    </div>
                </div>`;
            },
            
            getSentenceUnscrambleHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.exampleSentence;
                const words = this.shuffleArray(item.exampleSentence.split(' '));
                return `<div class="question-block"><h2 class="text-sm font-semibold text-indigo-600 mb-2">S·∫Øp x·∫øp c√¢u</h2><p class="text-slate-600 mb-4">Nh·∫•n v√†o c√°c t·ª´ theo ƒë√∫ng th·ª© t·ª± ƒë·ªÉ t·∫°o th√†nh c√¢u ho√†n ch·ªânh.</p><div id="unscramble-answer-area" class="token-area mb-4"></div><div id="unscramble-source-area" class="token-area bg-slate-50">${words.map(word => `<span class="word-token">${word}</span>`).join('')}</div><div class="mt-6 text-right"><button id="check-btn" class="btn btn-primary">Ki·ªÉm tra</button></div></div>`;
            },

            getGapFillHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.gapFill.blank;
                return `<div class="question-block"><h2 class="text-sm font-semibold text-indigo-600 mb-2">ƒêi·ªÅn v√†o ch·ªó tr·ªëng</h2><p class="text-xl font-serif italic text-slate-700 min-h-[60px] mb-8">"${item.gapFill.sentence}"</p><div class="flex gap-2"><input type="text" id="text-input" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="G√µ t·ª´ c√≤n thi·∫øu..."><button id="check-btn" class="btn btn-primary !py-3">Ki·ªÉm tra</button></div></div>`;
            },

            getTriosOfGappedSentenceHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.word;
                const sentences = this.findSentencesWithWord(item.word);
                const wordRegex = new RegExp(`\\b${item.word.replace(/s$/, '')}(s?)\\b`, 'gi');
                const gappedSentences = this.shuffleArray(sentences).slice(0, 3).map(s => s.replace(wordRegex, '______'));
                return `<div class="question-block"><h2 class="text-sm font-semibold text-indigo-600 mb-2">T√¨m t·ª´ chung</h2><p class="text-slate-600 mb-6">M·ªôt t·ª´ duy nh·∫•t c√≥ th·ªÉ ƒëi·ªÅn v√†o c·∫£ 3 ch·ªó tr·ªëng d∆∞·ªõi ƒë√¢y?</p><div class="space-y-4 mb-6">${gappedSentences.map((s, i) => `<p class="text-lg font-serif italic text-slate-700">${i + 1}. "${s}"</p>`).join('')}</div><div class="flex gap-2"><input type="text" id="text-input" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg" placeholder="G√µ t·ª´ chung..."><button id="check-btn" class="btn btn-primary !py-3">Ki·ªÉm tra</button></div></div>`;
            },

            getErrorCorrectionHTML(item, isExample = false) {
                item.errorCorrection.isActuallyIncorrect = Math.random() > 0.5;
                const sentenceToShow = item.errorCorrection.isActuallyIncorrect ? item.errorCorrection.incorrect : item.errorCorrection.correct;
                this.state.currentCorrectAnswer = item.errorCorrection.correct;

                return `<div class="question-block" id="error-correction-block">
                    <h2 class="text-sm font-semibold text-indigo-600 mb-2">S·ª≠a l·ªói sai</h2>
                    <p class="text-xl font-serif italic text-slate-700 min-h-[60px] mb-8">"${sentenceToShow}"</p>
                    <div id="error-step-1">
                        <p class="text-center font-semibold mb-4">C√¢u n√†y ƒë√∫ng hay sai?</p>
                        <div class="flex justify-center gap-4">
                            <button data-choice="correct" class="btn btn-secondary !px-8 !py-3 border-green-500 text-green-600 hover:bg-green-50">ƒê√∫ng</button>
                            <button data-choice="incorrect" class="btn btn-secondary !px-8 !py-3 border-red-500 text-red-600 hover:bg-red-50">Sai</button>
                        </div>
                    </div>
                    <div id="error-step-2" class="hidden">
                        <p class="font-semibold mb-2">S·ª≠a l·∫°i c√¢u cho ƒë√∫ng:</p>
                        <div class="flex gap-2">
                            <input type="text" id="error-correction-input" class="w-full p-3 border-2 border-gray-300 rounded-lg" value="${sentenceToShow}">
                            <button id="error-correction-check-btn" class="btn btn-primary">N·ªôp</button>
                        </div>
                    </div>
                </div>`;
            },
            
            getIPAFillHTML(item, isExample = false) {
                const ipa = item.pronunciation.replace(/\//g, '');
                const vowels = ['…™', 'e', '√¶', '…í', '…îÀê', ' ä', 'uÀê', ' å', '…úÀê', '…ô', 'e…™', 'a…™', '…î…™', 'a ä', '…ô ä', '…™…ô', 'e…ô', ' ä…ô'];
                const presentVowels = vowels.filter(v => ipa.includes(v));
                if (presentVowels.length === 0) return this.getTraditionalMCQHTML(item);

                const vowelToGuess = this.shuffleArray(presentVowels)[0];
                this.state.currentCorrectAnswer = vowelToGuess;
                const gappedIPA = `/${ipa.replace(vowelToGuess, '...')}/`;

                const distractors = this.shuffleArray(vowels.filter(v => v !== vowelToGuess)).slice(0, 3);
                const options = this.shuffleArray([vowelToGuess, ...distractors]);

                return `<div class="question-block"><h2 class="text-sm font-semibold text-indigo-600 mb-2">ƒêi·ªÅn phi√™n √¢m</h2>
                <p class="text-slate-600 mb-4">Ch·ªçn √¢m ƒë√∫ng ƒë·ªÉ ho√†n th√†nh phi√™n √¢m cho t·ª´ c√≥ nghƒ©a l√†: <strong class="text-indigo-700">"${item.meaning}"</strong></p>
                <p class="text-3xl font-mono text-center min-h-[60px] mb-8">${gappedIPA}</p>
                <div id="answer-options" class="grid grid-cols-2 gap-3">${options.map(opt => `<button class="answer-option font-mono text-center !text-2xl" data-answer="${opt}">${opt}</button>`).join('')}</div></div>`;
            },
            
            attachPracticeEventListeners(item, container, isGuide = false) {
                if (!container) return;
                const checkAnswerFunction = isGuide ? this.checkGuideAnswer.bind(this) : this.checkAnswer.bind(this);
                
                switch(item.exerciseType) {
                    case 'TraditionalMCQ': case 'ContextualMCQ': case 'WordFamilyMCQ': case 'IPAFill':
                        container.querySelectorAll('.answer-option').forEach(option => {
                            option.addEventListener('click', (e) => checkAnswerFunction(e.target.closest('.answer-option').dataset.answer, item, container));
                        });
                        break;
                    case 'AudioListening':
                        const input = container.querySelector('#text-input');
                        const checkBtn = container.querySelector('#check-btn');
                        container.querySelector('#play-audio-btn')?.addEventListener('click', (e) => {
                            this.playAudio(e.currentTarget.dataset.audioUrl);
                        });
                        container.querySelectorAll('.speed-btn').forEach(btn => {
                            btn.addEventListener('click', e => {
                                this.state.playbackRate = parseFloat(e.currentTarget.dataset.speed);
                                container.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('font-bold', 'text-indigo-600'));
                                e.currentTarget.classList.add('font-bold', 'text-indigo-600');
                            });
                        });
                        if (input && checkBtn) {
                            const doCheck = () => checkAnswerFunction(input.value, item, container);
                            checkBtn.addEventListener('click', doCheck);
                            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') doCheck(); });
                        }
                        break;
                    case 'GapFill': case 'TriosOfGappedSentence': {
                        const input = container.querySelector('#text-input');
                        const checkBtn = container.querySelector('#check-btn');
                        if (input && checkBtn) {
                            const doCheck = () => checkAnswerFunction(input.value, item, container);
                            checkBtn.addEventListener('click', doCheck);
                            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') doCheck(); });
                        }
                        break;
                    }
                    case 'SentenceUnscramble': {
                        const answerArea = container.querySelector('#unscramble-answer-area');
                        const sourceArea = container.querySelector('#unscramble-source-area');
                        const moveToken = (e) => {
                            if (e.target.classList.contains('word-token')) {
                                const isFromSource = e.currentTarget.id === 'unscramble-source-area';
                                (isFromSource ? answerArea : sourceArea).appendChild(e.target);
                            }
                        };
                        sourceArea.addEventListener('click', moveToken);
                        answerArea.addEventListener('click', moveToken);
                        container.querySelector('#check-btn')?.addEventListener('click', () => {
                            const answer = Array.from(answerArea.querySelectorAll('.word-token')).map(t => t.textContent).join(' ');
                            checkAnswerFunction(answer, item, container);
                        });
                        break;
                    }
                    case 'ErrorCorrection':
                        container.querySelectorAll('#error-step-1 button').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const userThinksIsCorrect = e.target.closest('button').dataset.choice === 'correct';
                                const isActuallyCorrect = !item.errorCorrection.isActuallyIncorrect;
                                if (userThinksIsCorrect === isActuallyCorrect) {
                                    if (isActuallyCorrect) {
                                        checkAnswerFunction(item.errorCorrection.correct, item, container);
                                    } else {
                                        container.querySelector('#error-step-1')?.classList.add('hidden');
                                        container.querySelector('#error-step-2')?.classList.remove('hidden');
                                        container.querySelector('#error-correction-input')?.focus();
                                    }
                                } else {
                                    checkAnswerFunction("user-was-wrong-about-correctness", item, container);
                                }
                            });
                        });
                        const correctionInput = container.querySelector('#error-correction-input');
                        const correctionBtn = container.querySelector('#error-correction-check-btn');
                        if (correctionInput && correctionBtn) {
                            const doCheck = () => checkAnswerFunction(correctionInput.value, item, container);
                            correctionBtn.addEventListener('click', doCheck);
                            correctionInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doCheck(); });
                        }
                        break;
                }
            },
            
            checkAnswer(userAnswer, item, container) {
                if (!item) item = this.state.currentSessionItems[this.state.currentIndex];
                const correctAnswer = this.state.currentCorrectAnswer;
                const isCorrect = userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();

                (container || this.DOM.main).querySelectorAll('button, input').forEach(el => el.disabled = true);
                
                const itemId = item.id;
                if (isCorrect) {
                    this.state.currentScore++;
                    this.state.sessionCorrectItems.push(item);
                    this.state.progress.learnedItems.add(itemId);
                    delete this.state.progress.incorrectCounts[itemId];
                } else {
                    this.state.sessionIncorrectItems.push(item);
                    this.state.progress.incorrectCounts[itemId] = (this.state.progress.incorrectCounts[itemId] || 0) + 1;
                }
                
                this.saveProgress();
                this.showFeedback(isCorrect, correctAnswer);
            },

            checkGuideAnswer(userAnswer, item, container) {
                const correctAnswer = this.state.currentCorrectAnswer;
                const isCorrect = userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();
                container.querySelectorAll('button, input').forEach(el => el.disabled = true);
                this.showFeedback(isCorrect, correctAnswer, container.parentElement.querySelector('#guide-feedback-container'), true);
            },

            showFeedback(isCorrect, correctAnswer, container = null, isGuide = false) {
                if (!container) container = document.getElementById('feedback-container');
                if (!container) return;

                const bgColor = isCorrect ? 'bg-green-100' : 'bg-red-100';
                const textColor = isCorrect ? 'text-green-800' : 'text-red-800';
                let message = isCorrect ? 'Ch√≠nh x√°c!' : `Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: <strong class="font-bold">${correctAnswer}</strong>`;

                const nextButtonHTML = isGuide ? '' : `<button id="next-question-btn" class="btn btn-secondary !py-2 !px-4">Ti·∫øp theo <i class="fas fa-arrow-right ml-2"></i></button>`;
                container.innerHTML = `
                    <div class="${bgColor} ${textColor} p-4 rounded-lg flex justify-between items-center fade-in">
                        <p class="font-semibold">${message}</p>
                        ${nextButtonHTML}
                    </div>`;

                if (!isGuide) {
                    const nextBtn = document.getElementById('next-question-btn');
                    nextBtn.focus();
                    nextBtn.addEventListener('click', () => {
                        this.state.currentIndex++;
                        this.renderPracticeView(); 
                    });
                }
            },

            playAudio(url) {
                if (!url) {
                    console.warn("No audio URL provided.");
                    return;
                }
                this.state.audioPlayer.src = url;
                this.state.audioPlayer.playbackRate = this.state.playbackRate;
                this.state.audioPlayer.play().catch(e => console.error("Audio play failed:", e));
            },

            async submitToFirebase(isFinal = false) {
                if (this.state.isSubmitting) return;
                this.state.isSubmitting = true;
                this.DOM.loader.classList.remove('hidden');

                const learnedCount = this.state.progress.learnedItems.size;
                const totalItems = this.state.wordList.length + this.state.structureList.length;
                const score = totalItems > 0 ? Math.round((learnedCount / totalItems) * 100) : 0;
                
                const submissionPayload = {
                    score: score,
                    totalPoints: 100,
                    status: isFinal ? 'submitted' : 'in-progress',
                    answers: { 
                        learnedCount, 
                        totalItems,
                        incorrectCounts: this.state.progress.incorrectCounts 
                    },
                    endTime: isFinal ? serverTimestamp() : null,
                };

                try {
                    await updateDoc(doc(this.state.db, 'submissions', this.state.submissionId), submissionPayload);
                    if (isFinal) {
                        localStorage.removeItem(`vocabProgress_${this.state.submissionId}`);
                        this.showModal("Th√†nh c√¥ng!", `ƒê√£ n·ªôp b√†i th√†nh c√¥ng v·ªõi ti·∫øn ƒë·ªô ${score}%.`, false, () => window.location.href='index.html');
                    }
                } catch(error) { 
                    this.showModal("L·ªói", "Kh√¥ng th·ªÉ l∆∞u ti·∫øn ƒë·ªô: " + error.message); 
                } finally { 
                    this.state.isSubmitting = false;
                    this.DOM.loader.classList.add('hidden');
                }
            },

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            findRoot(word) {
                const endings = ['s', 'es', 'ing', 'ed', 'er', 'est', 'ly', 'tion', 'sion', 'ment', 'able', 'ible', 'al', 'ial', 'ive', 'ous', 'ness'];
                for (const ending of endings) {
                    if (word.length > ending.length + 3 && word.endsWith(ending)) {
                        return word.slice(0, -ending.length);
                    }
                }
                return word;
            },

            showModal(title, message, showCancel = false, onConfirm = null, isGuide = false) {
                const modalId = isGuide ? 'guide-modal' : 'main-modal';
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modalContainer = document.createElement('div');
                modalContainer.id = modalId;
                modalContainer.className = "fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4";
                
                const buttonsHTML = showCancel 
                    ? `<button id="modal-cancel-btn" class="btn btn-secondary">H·ªßy</button><button id="modal-confirm-btn" class="btn btn-primary">ƒê·ªìng √Ω</button>`
                    : `<button id="modal-confirm-btn" class="btn btn-primary w-full">${isGuide ? 'ƒê√≥ng' : 'ƒê√£ hi·ªÉu'}</button>`;
                
                const modalWidth = isGuide ? 'max-w-2xl' : 'max-w-sm';
                modalContainer.innerHTML = `
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full ${modalWidth} fade-in">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 text-left">${title}</h3>
                        <div class="text-gray-600 mb-6">${message}</div>
                        <div class="flex gap-4 justify-end mt-8">${buttonsHTML}</div>
                    </div>`;
                this.DOM.modal.appendChild(modalContainer);

                const confirmBtn = modalContainer.querySelector('#modal-confirm-btn');
                const cancelBtn = modalContainer.querySelector('#modal-cancel-btn');

                const closeModal = () => modalContainer.remove();

                confirmBtn.onclick = () => {
                    closeModal();
                    if (onConfirm) onConfirm();
                };
                if(cancelBtn) {
                    cancelBtn.onclick = closeModal;
                }
            },

            findSentencesWithWord(word) {
                const sentences = new Set();
                const regex = new RegExp(`\\b${word.replace(/s$/, '')}(s?)\\b`, 'i');
                this.state.wordList.forEach(w => {
                    if (w.exampleSentence && regex.test(w.exampleSentence)) sentences.add(w.exampleSentence);
                    if (w.structures) {
                        w.structures.forEach(s => {
                            if (s.applicationExamples) s.applicationExamples.forEach(ex => {
                                if (regex.test(ex)) sentences.add(ex);
                            });
                        });
                    }
                });
                return [...sentences];
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
