<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện tập Từ vựng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Cấu hình Firebase được giữ nguyên từ hệ thống gốc của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>

    <style>
        :root {
            --primary-color: #6d28d9;
            --primary-hover: #5b21b6;
            --correct-color: #16a34a;
            --incorrect-color: #dc2626;
            --bg-light: #f5f7ff;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e5e7eb;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--bg-light); color: var(--text-primary); }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--bg-card); color: var(--text-secondary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: #f9fafb; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-fill { background-color: var(--primary-color); height: 100%; transition: width 0.4s ease; }
        
        .answer-option { display: block; width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: 0.75rem; background-color: var(--bg-card); text-align: left; font-weight: 500; }
        .answer-option:hover:not(.disabled) { border-color: var(--primary-color); background-color: #f5f3ff; }
        .answer-option.disabled { cursor: not-allowed; }
        .answer-option.correct { border-color: var(--correct-color); background-color: #f0fdf4; color: #14532d; }
        .answer-option.incorrect { border-color: var(--incorrect-color); background-color: #fef2f2; color: #991b1b; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-8 border-t-violet-500 border-gray-200 rounded-full animate-spin"></div>
            <p class="text-lg font-semibold text-white mt-4">Đang tải dữ liệu bài học...</p>
        </div>
    </div>
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50"></div>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-8 hidden">
        <header id="app-header" class="mb-8"></header>
        <main id="app-main"></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const App = {
            // Trạng thái tập trung của ứng dụng
            state: {
                db: null,
                submissionId: null,
                studentName: '',
                testData: {},
                wordList: [],
                practiceQueue: [],
                currentIndex: 0,
                currentScore: 0,
                currentCorrectAnswer: null,
                currentMode: '',
                progress: {
                    learnedItems: new Set(),
                    incorrectCounts: {}
                },
                isSubmitting: false,
            },

            // Cache các đối tượng DOM
            DOM: {
                loader: document.getElementById('loader-overlay'),
                modal: document.getElementById('custom-modal'),
                container: document.getElementById('app-container'),
                header: document.getElementById('app-header'),
                main: document.getElementById('app-main'),
            },

            // --- CORE LOGIC ---

            async init() {
                this.state.db = getFirestore(initializeApp(window.firebaseConfig));
                const params = new URLSearchParams(window.location.search);
                const submissionId = params.get('submission_id');

                if (!submissionId) {
                    this.showError("Lỗi", "Không tìm thấy mã dự thi. Vui lòng truy cập lại từ cổng chính.");
                    return;
                }
                
                this.state.submissionId = submissionId;
                await this.startSession(submissionId);
            },
            
            async startSession(submissionId) {
                try {
                    const submissionRef = doc(this.state.db, 'submissions', submissionId);
                    const submissionSnap = await getDoc(submissionRef);
                    if (!submissionSnap.exists()) throw new Error("Mã truy cập không hợp lệ.");

                    let submissionData = submissionSnap.data();
                    if (submissionData.status === 'submitted') {
                        this.showError("Thông báo", "Bạn đã hoàn thành bài luyện tập này. Kết quả đã được ghi nhận.", true);
                        return;
                    }
                    
                    const testRef = doc(this.state.db, 'vocab_sets', submissionData.testId);
                    const testSnap = await getDoc(testRef);
                    if (!testSnap.exists()) throw new Error("Không tìm thấy bộ từ vựng tương ứng.");

                    this.state.studentName = submissionData.studentName;
                    this.state.testData = testSnap.data();
                    this.state.wordList = this.state.testData.wordList || [];
                    
                    this.loadProgress(); // Tải tiến độ từ localStorage
                    this.DOM.loader.classList.add('hidden');
                    this.DOM.container.classList.remove('hidden');
                    
                    this.renderHeader();
                    this.renderDashboard();

                } catch (error) {
                    this.showError("Lỗi", error.message);
                }
            },

            // --- PROGRESS MANAGEMENT ---

            loadProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                const savedProgress = localStorage.getItem(progressKey);
                if (savedProgress) {
                    const parsed = JSON.parse(savedProgress);
                    this.state.progress.learnedItems = new Set(parsed.learnedItems || []);
                    this.state.progress.incorrectCounts = parsed.incorrectCounts || {};
                }
            },

            saveProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                const progressToSave = {
                    learnedItems: [...this.state.progress.learnedItems],
                    incorrectCounts: this.state.progress.incorrectCounts,
                };
                localStorage.setItem(progressKey, JSON.stringify(progressToSave));
            },

            // --- UI RENDERING ---

            renderHeader() {
                this.DOM.header.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">${this.state.testData.title}</h1>
                            <p class="text-sm text-gray-500">Thí sinh: <span class="font-medium">${this.state.studentName}</span></p>
                        </div>
                        <button id="submit-final-btn" class="btn btn-primary"><i class="fas fa-check-circle mr-2"></i> Hoàn thành & Nộp bài</button>
                    </div>`;
                document.getElementById('submit-final-btn').addEventListener('click', () => this.confirmSubmit());
            },

            renderDashboard() {
                const totalWords = this.state.wordList.length;
                const learnedCount = this.state.progress.learnedItems.size;
                const progressPercent = totalWords > 0 ? (learnedCount / totalWords * 100).toFixed(0) : 0;

                this.DOM.main.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                        <h2 class="text-xl font-bold mb-4">Chọn chế độ luyện tập</h2>
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2 text-sm">
                                <span class="font-medium text-slate-600">Tiến độ chung: ${learnedCount} / ${totalWords} từ</span>
                                <span class="font-semibold text-indigo-600">${progressPercent}%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-bar-fill" style="width: ${progressPercent}%;"></div></div>
                        </div>
                        <div id="mode-buttons" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <button data-mode="mcq_meaning" class="btn btn-secondary text-left !p-4 !items-start"><div class="text-lg"><i class="fas fa-list-check w-6 text-violet-500"></i></div><div><p class="font-bold">Trắc nghiệm - Nghĩa</p><p class="text-xs font-normal">Chọn nghĩa đúng cho từ.</p></div></button>
                            <button data-mode="mcq_word" class="btn btn-secondary text-left !p-4 !items-start"><div class="text-lg"><i class="fas fa-font w-6 text-sky-500"></i></div><div><p class="font-bold">Trắc nghiệm - Từ</p><p class="text-xs font-normal">Chọn từ đúng cho nghĩa.</p></div></button>
                            <button data-mode="typing" class="btn btn-secondary text-left !p-4 !items-start"><div class="text-lg"><i class="fas fa-keyboard w-6 text-emerald-500"></i></div><div><p class="font-bold">Luyện gõ</p><p class="text-xs font-normal">Điền từ vào câu ví dụ.</p></div></button>
                            <button data-mode="weakness" class="btn btn-secondary text-left !p-4 !items-start"><div class="text-lg"><i class="fas fa-star-half-alt w-6 text-amber-500"></i></div><div><p class="font-bold">Ôn tập điểm yếu</p><p class="text-xs font-normal">Luyện tập các từ hay sai.</p></div></button>
                        </div>
                    </div>`;
                
                const modeButtons = document.getElementById('mode-buttons');
                modeButtons.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.mode) {
                        this.startPractice(button.dataset.mode);
                    }
                });

                const weaknessBtn = modeButtons.querySelector('[data-mode="weakness"]');
                if (Object.keys(this.state.progress.incorrectCounts).length === 0) {
                    weaknessBtn.disabled = true;
                    weaknessBtn.querySelector('div:last-child p:last-child').textContent = 'Bạn chưa có điểm yếu nào!';
                }
            },

            renderPracticeView() {
                const progressPercent = this.state.practiceQueue.length > 0 ? (this.state.currentIndex / this.state.practiceQueue.length * 100) : 0;
                this.DOM.main.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm font-medium">Câu ${this.state.currentIndex + 1} / ${this.state.practiceQueue.length}</p>
                                <button id="exit-practice-btn" class="text-sm font-semibold text-gray-600 hover:text-red-500"><i class="fas fa-times mr-1"></i> Thoát</button>
                            </div>
                            <div class="progress-bar"><div class="progress-bar-fill" style="width: ${progressPercent}%;"></div></div>
                        </div>
                        <div id="question-container" class="min-h-[250px]"></div>
                        <div id="feedback-container" class="mt-4"></div>
                    </div>`;
                
                document.getElementById('exit-practice-btn').addEventListener('click', () => this.renderDashboard());
                this.renderNextQuestion();
            },
            
            renderNextQuestion() {
                if (this.state.currentIndex >= this.state.practiceQueue.length) {
                    this.renderSummary();
                    return;
                }
                const word = this.state.practiceQueue[this.state.currentIndex];
                const questionContainer = document.getElementById('question-container');
                const feedbackContainer = document.getElementById('feedback-container');
                
                if (!questionContainer || !feedbackContainer) return;
                
                feedbackContainer.innerHTML = '';
                let questionHTML = '';

                // Tự động chọn dạng câu hỏi dựa trên mode và dữ liệu có sẵn
                switch(this.state.currentMode) {
                    case 'mcq_meaning':
                        questionHTML = this.getMcqMeaningHTML(word);
                        break;
                    case 'mcq_word':
                        questionHTML = this.getMcqWordHTML(word);
                        break;
                    case 'typing':
                        questionHTML = this.getTypingHTML(word);
                        break;
                    default: // Bao gồm cả 'weakness' - sẽ tự chọn ngẫu nhiên
                        const possibleTypes = ['mcq_meaning', 'mcq_word'];
                        if (word.exampleSentence) possibleTypes.push('typing');
                        const randomType = possibleTypes[Math.floor(Math.random() * possibleTypes.length)];
                        questionHTML = this[`get${randomType.charAt(0).toUpperCase() + randomType.slice(1)}HTML`](word);
                }
                
                questionContainer.innerHTML = questionHTML;
                this.attachQuestionEventListeners();
            },

            renderSummary() {
                const score = this.state.currentScore;
                const total = this.state.practiceQueue.length;
                const percentage = total > 0 ? (score / total * 100).toFixed(0) : 0;
                this.DOM.main.innerHTML = `
                    <div class="text-center max-w-lg mx-auto bg-white p-8 rounded-xl shadow-sm fade-in">
                        <h1 class="text-3xl font-bold mb-4">Hoàn thành!</h1>
                        <p class="text-lg text-slate-600">Điểm của bạn:</p>
                        <p class="text-6xl font-bold my-4 text-indigo-600">${percentage}%</p>
                        <p class="font-semibold">${score} / ${total} câu đúng</p>
                        <div class="mt-8">
                            <button id="back-to-dashboard-btn" class="w-full btn btn-primary">Quay về Bảng điều khiển</button>
                        </div>
                    </div>`;
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
            },

            showFeedback(isCorrect) {
                const feedbackContainer = document.getElementById('feedback-container');
                if (!feedbackContainer) return;

                const bgColor = isCorrect ? 'bg-green-100' : 'bg-red-100';
                const textColor = isCorrect ? 'text-green-800' : 'text-red-800';
                let message = isCorrect ? 'Chính xác!' : `Sai rồi! Đáp án đúng là: <strong class="font-bold">${this.state.currentCorrectAnswer}</strong>`;

                feedbackContainer.innerHTML = `
                    <div class="${bgColor} ${textColor} p-4 rounded-lg flex justify-between items-center fade-in">
                        <p class="font-semibold">${message}</p>
                        <button id="next-question-btn" class="btn btn-secondary !py-2 !px-4">Tiếp theo <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>`;
                
                const nextBtn = document.getElementById('next-question-btn');
                nextBtn.focus();
                nextBtn.addEventListener('click', () => {
                    this.state.currentIndex++;
                    this.renderPracticeView(); 
                });
            },

            // --- QUESTION GENERATION ---

            getMcqMeaningHTML(word) {
                this.state.currentCorrectAnswer = word.meaning;
                const options = this.shuffleArray([word.meaning, ...word.distractors_vi]);
                return `
                    <h2 class="text-sm font-semibold text-gray-500 mb-2">Chọn nghĩa đúng cho từ:</h2>
                    <p class="text-3xl font-bold mb-6">${word.word} <span class="text-lg font-normal text-gray-400">(${word.type})</span></p>
                    <div id="answer-options" class="space-y-3">
                        ${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}
                    </div>`;
            },
            
            getMcqWordHTML(word) {
                this.state.currentCorrectAnswer = word.word;
                const options = this.shuffleArray([word.word, ...word.distractors_en]);
                return `
                    <h2 class="text-sm font-semibold text-gray-500 mb-2">Chọn từ đúng cho nghĩa:</h2>
                    <p class="text-3xl font-bold mb-6">${word.meaning}</p>
                    <div id="answer-options" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}
                    </div>`;
            },
            
            getTypingHTML(word) {
                if (!word.exampleSentence) return this.getMcqMeaningHTML(word); // Fallback
                this.state.currentCorrectAnswer = word.word;
                // Regex to replace only the whole word, case-insensitive
                const sentenceHTML = word.exampleSentence.replace(new RegExp(`\\b${word.word}\\b`, 'gi'), '<span class="font-bold text-indigo-600">[ _______ ]</span>');

                return `
                    <h2 class="text-sm font-semibold text-gray-500 mb-2">Điền từ còn thiếu vào câu:</h2>
                    <p class="text-xl font-serif italic text-slate-700 mb-6">"${sentenceHTML}"</p>
                    <div class="flex gap-2">
                        <input type="text" id="text-input" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="Gõ đáp án...">
                        <button id="check-btn" class="btn btn-primary !py-3">Kiểm tra</button>
                    </div>`;
            },


            // --- EVENT HANDLING & ACTIONS ---

            startPractice(mode) {
                this.state.currentMode = mode;
                this.state.currentIndex = 0;
                this.state.currentScore = 0;

                let itemsToPractice = [];
                if (mode === 'weakness') {
                    const weakIds = Object.keys(this.state.progress.incorrectCounts)
                        .sort((a,b) => this.state.progress.incorrectCounts[b] - this.state.progress.incorrectCounts[a]);
                    itemsToPractice = weakIds.map(id => this.state.wordList.find(w => `word_${w.id}` === id)).filter(Boolean);
                } else {
                    // Ưu tiên các từ chưa học
                    const unlearned = this.state.wordList.filter(w => !this.state.progress.learnedItems.has(`word_${w.id}`));
                    itemsToPractice = unlearned.length > 0 ? unlearned : this.state.wordList;
                }
                
                this.state.practiceQueue = this.shuffleArray([...itemsToPractice]);
                this.renderPracticeView();
            },

            attachQuestionEventListeners() {
                const answerOptions = document.getElementById('answer-options');
                if (answerOptions) {
                    answerOptions.addEventListener('click', e => {
                        const button = e.target.closest('button');
                        if (button && button.dataset.answer) {
                            this.checkAnswer(button.dataset.answer);
                        }
                    });
                }
                const checkBtn = document.getElementById('check-btn');
                const textInput = document.getElementById('text-input');
                if(checkBtn && textInput) {
                    const doCheck = () => this.checkAnswer(textInput.value);
                    checkBtn.addEventListener('click', doCheck);
                    textInput.addEventListener('keypress', e => { if (e.key === 'Enter') doCheck(); });
                }
            },
            
            checkAnswer(userAnswer) {
                const word = this.state.practiceQueue[this.state.currentIndex];
                const correctAnswer = this.state.currentCorrectAnswer;
                const isCorrect = userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();

                // Disable inputs
                this.DOM.main.querySelectorAll('button, input').forEach(el => el.disabled = true);
                
                if (isCorrect) {
                    this.state.currentScore++;
                    this.state.progress.learnedItems.add(`word_${word.id}`);
                    delete this.state.progress.incorrectCounts[`word_${word.id}`];
                } else {
                    this.state.progress.incorrectCounts[`word_${word.id}`] = (this.state.progress.incorrectCounts[`word_${word.id}`] || 0) + 1;
                }
                
                this.saveProgress();
                this.showFeedback(isCorrect);
            },
            
            confirmSubmit() {
                const learnedCount = this.state.progress.learnedItems.size;
                const totalWords = this.state.wordList.length;
                this.showModal(
                    "Xác nhận Nộp bài",
                    `Bạn đã học được ${learnedCount} / ${totalWords} từ. Bạn có chắc chắn muốn kết thúc và nộp bài không? Bạn sẽ không thể luyện tập tiếp sau khi nộp.`,
                    () => this.submitToFirebase(),
                    true // showCancel
                );
            },

            async submitToFirebase() {
                if (this.state.isSubmitting) return;
                this.state.isSubmitting = true;
                this.DOM.loader.classList.remove('hidden');

                const learnedCount = this.state.progress.learnedItems.size;
                const totalWords = this.state.wordList.length;
                const score = totalWords > 0 ? Math.round((learnedCount / totalWords) * 100) : 0;
                
                const finalSubmission = {
                    score: score, // Điểm là % số từ đã học
                    totalPoints: 100,
                    answers: this.state.progress.incorrectCounts, // Lưu lại các từ sai để giáo viên xem
                    status: 'submitted',
                    endTime: serverTimestamp()
                };

                try {
                    await updateDoc(doc(this.state.db, 'submissions', this.state.submissionId), finalSubmission);
                    localStorage.removeItem(`vocabProgress_${this.state.submissionId}`);
                    this.showError("Thành công!", `Đã nộp bài thành công với kết quả ${score}%.`, true);
                } catch(error) {
                    this.showError("Lỗi", "Không thể nộp bài. Vui lòng thử lại. " + error.message);
                    this.state.isSubmitting = false;
                    this.DOM.loader.classList.add('hidden');
                }
            },

            // --- UTILITIES ---
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            showError(title, message, isSuccess = false) {
                this.DOM.loader.classList.add('hidden');
                const icon = isSuccess ? `<i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>` : `<i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>`;
                this.DOM.modal.innerHTML = `
                    <div class="modal-content bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm fade-in">
                        ${icon}
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <button id="modal-confirm-btn" class="btn btn-primary w-full">Đã hiểu</button>
                    </div>`;
                this.DOM.modal.classList.remove('hidden');
                document.getElementById('modal-confirm-btn').onclick = () => {
                    this.DOM.modal.classList.add('hidden');
                    if (isSuccess) window.location.href = 'index.html';
                };
            },
            showModal(title, message, onConfirm, showCancel = false) {
                 this.DOM.modal.innerHTML = `
                    <div class="modal-content bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm fade-in">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex gap-4 justify-center">
                            ${showCancel ? '<button id="modal-cancel-btn" class="btn btn-secondary">Hủy</button>' : ''}
                            <button id="modal-confirm-btn" class="btn btn-primary">Đồng ý</button>
                        </div>
                    </div>`;
                this.DOM.modal.classList.remove('hidden');
                document.getElementById('modal-confirm-btn').onclick = () => {
                    this.DOM.modal.classList.add('hidden');
                    if (onConfirm) onConfirm();
                };
                if (showCancel) {
                    document.getElementById('modal-cancel-btn').onclick = () => this.DOM.modal.classList.add('hidden');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
