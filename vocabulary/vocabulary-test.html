<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Practice Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blur-intensity: 12px;
            --saturation-intensity: 150%;
            --glass-bg-color: rgba(255, 255, 255, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.6);
            --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --app-bg-start: #f5f7ff;
            --app-bg-end: #e0e7ff;
        }

        body.dark {
            --glass-bg-color: rgba(29, 39, 58, 0.45);
            --glass-border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.25);
            --primary-accent: #a78bfa;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --app-bg-start: #0f172a;
            --app-bg-end: #1e293b;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--app-bg-start);
            background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }
        
        body.sidebar-open {
            overflow: hidden;
        }
        
        .no-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .background-shapes {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            filter: blur(15px);
            transition: opacity 0.5s ease;
        }

        .shape1 { width: 250px; height: 250px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); top: 10%; left: 5%; animation: float 28s infinite alternate ease-in-out; }
        .shape2 { width: 180px; height: 180px; background: linear-gradient(135deg, #14b8a6, #67e8f9); bottom: 15%; right: 10%; animation: float 32s infinite alternate ease-in-out; }
        .shape3 { width: 120px; height: 120px; background: linear-gradient(135deg, #a78bfa, #c4b5fd); top: 20%; right: 25%; animation: float 24s infinite alternate ease-in-out; }
        .shape4 { width: 80px; height: 80px; background: linear-gradient(135deg, #93c5fd, #bfdbfe); bottom: 5%; left: 30%; animation: float 20s infinite alternate ease-in-out; }

        body.dark .shape {
            opacity: 0.4;
        }

        @keyframes float {
            from { transform: translateY(20px) scale(1) rotate(0deg); }
            to { transform: translateY(-20px) scale(1.05) rotate(20deg); }
        }

        .app-layout { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 1; transition: padding-left 0.3s ease-in-out; }

        .glass-panel {
            position: relative;
            background: var(--glass-bg-color);
            backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(var(--saturation-intensity));
            border-radius: 24px;
            border: 1px solid var(--glass-border-color);
            box-shadow: 0 8px 32px 0 var(--shadow-color), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }

        .card { padding: 1.5rem; }

        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 260px;
            padding: 1.5rem;
            z-index: 40;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        body.sidebar-open #sidebar {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            #sidebar {
                position: relative;
                transform: translateX(0);
                flex-shrink: 0;
            }
            .app-layout.sidebar-collapsed #sidebar {
                transform: translateX(-100%);
                margin-left: -260px;
            }
        }
        
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        body.sidebar-open #sidebar-overlay {
            opacity: 1;
            visibility: visible;
        }
        
        @media (min-width: 1024px) {
            #sidebar-overlay {
                display: none;
            }
        }

        .sidebar-nav-btn { display: flex; align-items: center; padding: 12px 16px; border-radius: 12px; font-weight: 600; color: var(--text-secondary); transition: all 0.2s ease-in-out; margin-bottom: 8px; }
        .sidebar-nav-btn i { width: 20px; margin-right: 16px; text-align: center; }
        .sidebar-nav-btn:hover { background-color: rgba(255, 255, 255, 0.4); color: var(--text-primary); transform: translateX(5px) scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sidebar-nav-btn.active { background-color: var(--primary-accent); color: white; box-shadow: 0 4px 12px rgba(91, 33, 182, 0.3); transform: translateX(5px) scale(1.03); }
        
        body.dark .sidebar-nav-btn.active {
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
        }
        body.dark .sidebar-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #app { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 1.5rem; transition: margin-left 0.3s ease-in-out; }
        @media (min-width: 1024px) {
            #app { padding: 2rem; }
        }
        #app::-webkit-scrollbar { width: 8px; }
        #app::-webkit-scrollbar-track { background: transparent; }
        #app::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.1); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        #app::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.2); }

        .main-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        #menu-toggle-btn {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; transform: translateY(0); }
        .btn-main-action { background: var(--primary-accent); color: white; border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(91, 33, 182, 0.25); }
        body.dark .btn-main-action { color: #1e293b; }
        .btn-main-action:hover:not(:disabled) { background: #5b21b6; transform: translateY(-3px); box-shadow: 0 7px 20px rgba(91, 33, 182, 0.4); }
        body.dark .btn-main-action:hover:not(:disabled) { background: #9333ea; }

        .btn-secondary { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); color: var(--text-primary); border-color: rgba(255, 255, 255, 0.6); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.7); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        body.dark .btn-secondary { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        body.dark .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); }

        .btn:disabled { background-color: rgba(200, 200, 200, 0.7) !important; cursor: not-allowed; opacity: 0.7; transform: none !important; box-shadow: none !important; }
        body.dark .btn:disabled { background-color: rgba(71, 85, 105, 0.7) !important; }

        .answer-option {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        body.dark .answer-option {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .answer-option:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 1px rgba(255,255,255,0.3);
        }
        body.dark .answer-option:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .answer-option.selected {
            background-color: var(--primary-accent) !important;
            border-color: var(--primary-accent) !important;
            color: white !important;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 6px 20px rgba(91, 33, 182, 0.3);
        }
        body.dark .answer-option.selected {
            color: #1e293b !important;
        }

        .answer-option.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
            cursor: not-allowed;
        }
        body.dark .answer-option.correct {
            background-color: #052e16 !important;
            border-color: #16a34a !important;
            color: #a7f3d0 !important;
        }

        .answer-option.incorrect {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
            animation: shake 0.5s;
        }
        body.dark .answer-option.incorrect {
            background-color: #450a0a !important;
            border-color: #dc2626 !important;
            color: #fecaca !important;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.2); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            align-items: center; 
            justify-content: center; 
        }
        .modal.is-open {
            display: flex;
        }
        .modal-content { 
            padding: 24px; 
            width: 90%; 
            max-width: 500px; 
            animation: scaleIn 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        .modal.is-closing .modal-content {
            animation: scaleOut 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-between; align-items: center; }
        .close-button { color: #eee; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .close-button:hover { color: white; }

        .flashcard-container { perspective: 1000px; min-height: 250px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction:column; align-items: center; justify-content: center; border-radius: 16px; padding: 20px; text-align: center; }
        .flashcard-front { background-color: rgba(255, 255, 255, 0.8); }
        body.dark .flashcard-front { background-color: rgba(51, 65, 85, 0.8); }
        .flashcard-back { background-color: rgba(230, 230, 255, 0.9); transform: rotateY(180deg); overflow-y: auto; }
        body.dark .flashcard-back { background-color: rgba(71, 85, 105, 0.9); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1rem; }
        body.dark .progress-bar { background-color: #4b5563; }
        .progress-bar-inner { background-color: var(--primary-accent); height: 100%; transition: width 0.5s ease-in-out; }

        .word-token { cursor: pointer; background-color: #e0e7ff; color: #3730a3; }
        body.dark .word-token { background-color: #3730a3; color: #e0e7ff; }
        .clickable-word { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; }
        .clickable-word:hover { background-color: #e0e7ff; }
        .clickable-word.selected { background-color: #fbbf24; color: #78350f; }
        
        .mindmap-container { display: flex; justify-content: center; align-items: center; flex-grow: 1; padding: 1rem; }
        .mindmap { position: relative; display: flex; justify-content: center; align-items: center; }
        .mindmap-center {
            padding: 1rem 1.5rem; background-color: var(--primary-accent); color: white; border-radius: 50px; font-weight: bold; z-index: 10;
        }
        body.dark .mindmap-center { color: #1e293b; }
        .mindmap-node {
            position: absolute; padding: 0.5rem 1rem; background: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.9); border-radius: 20px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease;
        }
        body.dark .mindmap-node { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .mindmap-node:hover { transform: scale(1.1); z-index: 20; }
        
        body.dark .text-slate-800, body.dark .text-slate-700, body.dark .text-violet-800 { color: var(--text-primary); }
        body.dark .text-slate-600 { color: var(--text-secondary); }
        body.dark .text-red-500 { color: #ef4444; }
        body.dark .hover\:bg-red-100:hover { background-color: rgb(220 38 38 / 0.2); }
        body.dark .hover\:text-red-700:hover { color: #ef4444; }
    </style>
</head>
<body>
    <div class="background-shapes">
        <div class="shape shape1"></div>
        <div class="shape shape2"></div>
        <div class="shape shape3"></div>
        <div class="shape shape4"></div>
    </div>

    <div id="loader-overlay" class="modal is-open">
        <div class="text-center">
            <div class="w-16 h-16 border-8 border-t-violet-500 border-gray-200 rounded-full animate-spin"></div>
            <p id="loader-text" class="text-lg font-semibold text-white mt-4">Đang tải dữ liệu...</p>
        </div>
    </div>

    <div class="app-layout" style="visibility: hidden;">
        <nav id="sidebar" class="glass-panel">
            <div>
                <div class="text-center mb-10">
                    <h1 id="sidebar-title" class="text-2xl font-bold text-slate-800">Vocab App</h1>
                    <p class="text-sm text-slate-600">by Thành Nam</p>
                </div>
                <div id="sidebar-nav" class="flex-grow">
                    <button id="nav-dashboard" class="sidebar-nav-btn active"><i class="fas fa-chart-pie"></i> Dashboard</button>
                    <button id="nav-study" class="sidebar-nav-btn"><i class="fas fa-book-open"></i> Study</button>
                    <button id="nav-practice" class="sidebar-nav-btn"><i class="fas fa-dumbbell"></i> Practice</button>
                    <button id="nav-test" class="sidebar-nav-btn"><i class="fas fa-graduation-cap"></i> Test</button>
                </div>
            </div>
            <div class="mt-auto">
                 <div class="pt-4 border-t border-white/20">
                    <button id="theme-toggle-btn" class="sidebar-nav-btn w-full">
                        <i id="theme-toggle-icon" class="fas fa-moon"></i>
                        <span id="theme-toggle-text">Dark Mode</span>
                    </button>
                </div>
                 <button id="nav-reset" class="sidebar-nav-btn w-full justify-center text-red-500 hover:bg-red-100 hover:text-red-700">
                     <i class="fas fa-trash-alt mr-2"></i> Reset Progress
                 </button>
            </div>
        </nav>
        
        <div id="sidebar-overlay"></div>

        <main id="app">
             <header class="main-header">
                 <button id="menu-toggle-btn">
                     <i class="fas fa-bars text-xl"></i>
                 </button>
                 <div class="text-left">
                     <h1 id="app-title" class="text-3xl lg:text-4xl font-bold text-slate-800">Dashboard</h1>
                     <p id="app-subtitle" class="text-slate-600 mt-1 lg:mt-2">Welcome back! Here's your learning progress.</p>
                 </div>
             </header>
             <div id="main-content">
                <!-- Content will be rendered by JavaScript -->
             </div>
        </main>
    </div>

    <div id="word-list-modal" class="modal">
        <div class="modal-content glass-panel" style="max-width: 1200px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header pb-4 mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800">List</h2>
                <span id="close-word-modal-btn" class="close-button">&times;</span>
            </div>
            <div id="word-table-container" class="overflow-y-auto flex-grow">
                <table id="word-table" class="w-full text-sm text-left text-slate-700">
                </table>
            </div>
        </div>
    </div>
    <div id="test-setup-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header pb-4 mb-4">
                <h2 class="text-2xl font-bold text-slate-800">Test Setup</h2>
                <span id="close-test-modal-btn" class="close-button">&times;</span>
            </div>
            <div>
                <label for="question-count" class="block mb-2 font-medium text-slate-700">Number of questions:</label>
                <input type="number" id="question-count" class="w-full p-2 rounded-lg" min="5" max="100" value="10">
                <div class="mt-6">
                    <button id="start-test-fixed-btn" class="btn btn-main-action w-full">Start with selected count</button>
                    <button id="start-test-all-btn" class="btn btn-secondary w-full mt-3">Test all items</button>
                </div>
            </div>
        </div>
    </div>
    <div id="feedback-area" class="text-center"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const App = {
            data: {
                db: null,
                submissionId: null,
                testId: null,
                words: [],
                structures: [],
                wordFamilies: {},
                progress: { learnedItems: {}, lastTestResult: null, incorrectCounts: {} },
                sessionItems: [],
                currentSessionIndex: 0,
                mode: null,
                currentCorrectAnswer: null,
                findAndFixState: {},
                wordFamilyState: {},
            },

            async init() {
                this.initTheme();
                this.initResponsiveSidebar();
                try {
                    this.data.submissionId = this.getSubmissionIdFromUrl();
                    const firebaseConfig = {
                        apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
                        authDomain: "b1-baotram.firebaseapp.com",
                        projectId: "b1-baotram",
                        storageBucket: "b1-baotram.appspot.com",
                        messagingSenderId: "948701163187",
                        appId: "1:948701163187:web:043f2d381d63e741114ac6"
                    };
                    const firebaseApp = initializeApp(firebaseConfig);
                    this.data.db = getFirestore(firebaseApp);
                    await this.loadDataFromFirebase();
                    this.initAntiCopy();
                    this.initModals();
                    this.initSidebarNav();
                    this.renderDashboard();
                    document.querySelector('.app-layout').style.visibility = 'visible';
                    document.getElementById('loader-overlay').classList.remove('is-open');
                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.showErrorState(error.message);
                }
            },
            
            getSubmissionIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('submission_id');
                if (!id) throw new Error("Mã truy cập không hợp lệ. Vui lòng truy cập từ cổng chính.");
                return id;
            },

            async loadDataFromFirebase() {
                const submissionSnap = await getDoc(doc(this.data.db, "submissions", this.data.submissionId));
                if (!submissionSnap.exists()) throw new Error("Không tìm thấy bài làm với mã truy cập này.");
                
                const submissionData = submissionSnap.data();
                this.data.testId = submissionData.testId;
                if (submissionData.progress) {
                    this.data.progress = submissionData.progress;
                    this.data.progress.learnedItems = this.data.progress.learnedItems || {};
                    this.data.progress.incorrectCounts = this.data.progress.incorrectCounts || {};
                }

                const vocabSetSnap = await getDoc(doc(this.data.db, "vocab_sets", this.data.testId));
                if (!vocabSetSnap.exists()) throw new Error("Không tìm thấy bộ từ vựng tương ứng.");
                
                const vocabSetData = vocabSetSnap.data();
                document.title = vocabSetData.title || "Vocabulary Practice";
                document.getElementById('sidebar-title').textContent = vocabSetData.title;

                this.data.words = (vocabSetData.wordList || []).map((word, index) => ({...word, id: word.id || `word_${index}`}));
                this.groupWordFamilies();
                this.parseAndStoreStructures();
                this.applyUserProgress();
            },
            
            applyUserProgress() {
                const learnedItems = this.data.progress.learnedItems || {};
                this.data.words.forEach(word => { word.isLearned = !!learnedItems[`word_${word.id}`]; });
                this.data.structures.forEach(structure => { structure.isLearned = !!learnedItems[`structure_${structure.id}`]; });
            },

            async saveProgressToFirebase() {
                if (!this.data.submissionId || !this.data.db) return;
                try {
                    await setDoc(doc(this.data.db, "submissions", this.data.submissionId), { progress: this.data.progress, lastAccessed: serverTimestamp() }, { merge: true });
                } catch (error) {
                    console.error("Error saving progress:", error);
                    this.showCustomAlert("Lỗi: Không thể lưu tiến trình.");
                }
            },
            
            initTheme() {
                const themeToggleBtn = document.getElementById('theme-toggle-btn');
                const themeToggleIcon = document.getElementById('theme-toggle-icon');
                const themeToggleText = document.getElementById('theme-toggle-text');
                const body = document.body;
                const applyTheme = (theme) => {
                    body.classList.toggle('dark', theme === 'dark');
                    themeToggleIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                    themeToggleText.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
                };
                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);
                themeToggleBtn.addEventListener('click', () => {
                    const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            },

            initResponsiveSidebar() {
                const menuToggleBtn = document.getElementById('menu-toggle-btn');
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                const appLayout = document.querySelector('.app-layout');
                const toggleSidebar = () => {
                    if (window.innerWidth < 1024) {
                        document.body.classList.toggle('sidebar-open');
                    } else {
                        appLayout.classList.toggle('sidebar-collapsed');
                    }
                };
                menuToggleBtn?.addEventListener('click', toggleSidebar);
                sidebarOverlay?.addEventListener('click', toggleSidebar);
                document.querySelectorAll('#sidebar-nav .sidebar-nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (window.innerWidth < 1024) document.body.classList.remove('sidebar-open');
                    });
                });
            },
            
            initAntiCopy() {
                ['contextmenu', 'copy', 'cut', 'paste'].forEach(event => {
                    document.body.addEventListener(event, e => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        e.preventDefault();
                        this.showCustomAlert("Chức năng này đã bị vô hiệu hóa.");
                        return false;
                    });
                });
            },

            groupWordFamilies() {
                const families = {};
                this.data.words.forEach(word => {
                    const root = (word.familyRoot || word.word.split(/[\s-]/)[0]).toLowerCase().replace(/[^a-z]/g, '');
                    if (!families[root]) families[root] = [];
                    if (!families[root].some(w => w.id === word.id)) families[root].push(word);
                    word.familyRoot = root;
                });
                this.data.wordFamilies = families;
            },
            
            parseAndStoreStructures() {
                this.data.structures = [];
                this.data.words.forEach(word => {
                    if (word.structures && Array.isArray(word.structures)) {
                        word.structures.forEach((struct, s_idx) => {
                            this.data.structures.push({
                                id: `s_${word.id}_${s_idx}`,
                                rootWordId: word.id,
                                fullStructure: struct.phrase,
                                translation: struct.meaning,
                                applicationExamples: struct.applicationExamples || [],
                                isLearned: false,
                            });
                        });
                    }
                });
            },

            updateProgress(itemId, itemType, isCorrect) {
                const progressKey = `${itemType}_${itemId}`;
                const incorrectCounts = this.data.progress.incorrectCounts || {};
                if (isCorrect) {
                    this.data.progress.learnedItems[progressKey] = true;
                    delete incorrectCounts[progressKey];
                } else {
                    incorrectCounts[progressKey] = (incorrectCounts[progressKey] || 0) + 1;
                }
                this.data.progress.incorrectCounts = incorrectCounts;
                this.saveProgressToFirebase();
            },

            renderDashboard() {
                this.setActiveNav('nav-dashboard');
                this.updateHeader('Dashboard', "Welcome back! Here's your learning progress.");
                const main = document.getElementById('main-content');
                
                const wordsLearned = this.data.words.filter(w => w.isLearned).length;
                const totalWords = this.data.words.length;
                const wordProgress = totalWords > 0 ? (wordsLearned / totalWords) * 100 : 0;

                const structuresLearned = this.data.structures.filter(s => s.isLearned).length;
                const totalStructures = this.data.structures.length;
                const structureProgress = totalStructures > 0 ? (structuresLearned / totalStructures) * 100 : 0;
                
                const lastTest = this.data.progress.lastTestResult;
                let testResultHTML = `<p class="text-slate-600 dark:text-slate-400">Chưa có bài kiểm tra nào.</p>`;
                if (lastTest && lastTest.date) {
                    const testDate = new Date(lastTest.date).toLocaleDateString('vi-VN');
                    testResultHTML = `<p class="text-2xl font-bold text-violet-800">${lastTest.score}/${lastTest.total} (${lastTest.percentage}%)</p><p class="text-sm text-slate-600">Làm ngày: ${testDate}</p>`;
                }

                main.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold text-slate-800 mb-3">Tiến độ Từ vựng</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${wordsLearned}/${totalWords}</span><span class="text-sm font-medium">${wordProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${wordProgress}%;"></div></div>
                            <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-words" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel">
                            <h3 class="text-xl font-bold text-slate-800 mb-3">Tiến độ Cấu trúc</h3>
                            <div class="flex justify-between items-center mb-2"><span class="font-semibold">${structuresLearned}/${totalStructures}</span><span class="text-sm font-medium">${structureProgress.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${structureProgress}%;"></div></div>
                             <div class="flex justify-center gap-4 mt-4">
                                <button data-list-type="learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Đã học</button>
                                <button data-list-type="not-learned-structures" class="btn btn-secondary text-sm !py-2 !px-4">Chưa học</button>
                            </div>
                        </div>
                        <div class="card glass-panel lg:col-span-2">
                             <h3 class="text-xl font-bold text-slate-800 mb-2">Kết quả kiểm tra gần nhất</h3>
                             ${testResultHTML}
                        </div>
                    </div>`;
                main.querySelectorAll('[data-list-type]').forEach(button => {
                    button.addEventListener('click', (e) => this.showFilteredList(e.currentTarget.dataset.listType));
                });
            },
            
            renderSelectionScreen(mode) {
                this.setActiveNav(mode === 'study' ? 'nav-study' : 'nav-practice');
                this.updateHeader(mode.charAt(0).toUpperCase() + mode.slice(1), `Chọn nội dung bạn muốn ${mode}.`);
                const main = document.getElementById('main-content');
                main.innerHTML = `
                    <div class="fade-in">
                        <div class="mb-4"><button id="back-to-dashboard-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Dashboard</button></div>
                        <div class="card glass-panel text-center">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Bạn muốn ${mode} gì?</h2>
                            <div class="flex flex-wrap justify-center gap-4">
                                <button id="select-vocab-btn" class="btn btn-main-action"><i class="fas fa-book"></i> Từ vựng</button>
                                <button id="select-structure-btn" class="btn btn-main-action"><i class="fas fa-sitemap"></i> Cấu trúc</button>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('select-vocab-btn').addEventListener('click', () => this.renderModeSelection(mode, 'vocab'));
                document.getElementById('select-structure-btn').addEventListener('click', () => this.renderModeSelection(mode, 'structure'));
            },

            renderModeSelection(mode, type) {
                const typeText = type === 'vocab' ? 'Từ vựng' : 'Cấu trúc';
                this.updateHeader(mode.charAt(0).toUpperCase() + mode.slice(1), `Chọn hình thức ${mode} cho ${typeText}.`);
                const main = document.getElementById('main-content');
                let buttonsHTML = '';

                if (mode === 'study') {
                     buttonsHTML = type === 'vocab' ? `
                        <button data-mode="Flashcard" class="btn btn-main-action"><i class="fas fa-clone"></i> Flashcards 2.0</button>
                        <button data-mode="Word Family Explorer" class="btn btn-main-action"><i class="fas fa-project-diagram"></i> Khám phá Họ từ</button>
                     ` : `<button data-mode="Structure Flashcard" class="btn btn-main-action"><i class="fas fa-clone"></i> Flashcards</button>`;
                } else {
                    const practiceTypes = type === 'vocab' ? 
                        ['Word Family Matching', 'Contextual MCQ', 'Sentence Unscramble', 'Pronunciation Match', 'Audio Listening', 'Traditional MCQ', 'Trios of Gapped Sentence'] :
                        ['Gap-Fill', 'Find and Fix Error'];
                    buttonsHTML = practiceTypes.map(pType => `<button data-mode="${pType}" class="btn btn-main-action">${pType}</button>`).join('');
                    buttonsHTML += `<button data-mode="Adaptive Practice" class="btn btn-main-action bg-amber-500 hover:bg-amber-600"><i class="fas fa-star mr-2"></i>Ôn tập điểm yếu</button>`;
                }

                main.innerHTML = `
                     <div class="fade-in">
                         <div class="mb-4"><button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button></div>
                         <div class="card glass-panel text-center">
                             <h2 class="text-2xl font-bold text-slate-800 mb-6">Chọn hình thức ${mode}: ${typeText}</h2>
                             <div class="flex flex-wrap justify-center gap-4">${buttonsHTML}</div>
                         </div>
                     </div>`;
                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen(mode));
                main.querySelectorAll('[data-mode]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.startSession(e.currentTarget.dataset.mode, type));
                });
            },

            startSession(mode, type) {
                this.data.mode = mode;
                let items;
                const isStudy = ['Flashcard', 'Word Family Explorer', 'Structure Flashcard'].includes(mode);

                if(mode === 'Adaptive Practice') { this.renderAdaptivePractice(); return; }

                items = type === 'structure' 
                    ? (isStudy ? this.data.structures : this.data.structures.filter(s => !s.isLearned))
                    : (isStudy ? this.data.words : this.data.words.filter(w => !w.isLearned));
                
                if (items.length === 0) {
                    this.showCustomAlert("Chúc mừng! Bạn đã học hết các mục trong phần này.");
                    this.renderDashboard();
                    return;
                }
                
                this.data.sessionItems = this.shuffleArray(items);
                this.data.currentSessionIndex = 0;
                this.renderNextInSession();
            },

            renderNextInSession() {
                if (this.data.currentSessionIndex >= this.data.sessionItems.length) {
                    this.showCustomAlert("Bạn đã hoàn thành vòng luyện tập!");
                    const modeType = this.data.mode.includes('Flashcard') || this.data.mode.includes('Explorer') ? 'study' : 'practice';
                    this.renderSelectionScreen(modeType);
                    return;
                }
                const item = this.data.sessionItems[this.data.currentSessionIndex];
                if (!item) { 
                    this.data.currentSessionIndex++;
                    this.renderNextInSession(); 
                    return; 
                }

                const renderMap = {
                    'Flashcard': () => this.renderFlashcard(item),
                    'Structure Flashcard': () => this.renderFlashcard(item, true),
                    'Word Family Explorer': () => this.renderWordFamilyMindmap(item),
                    'Word Family Matching': () => this.renderWordFamilyMatching(),
                    'Contextual MCQ': () => this.renderContextualMCQ(item),
                    'Sentence Unscramble': () => this.renderSentenceUnscramble(item),
                    'Pronunciation Match': () => this.renderPronunciationMatch(item),
                    'Audio Listening': () => this.renderAudioListening(item),
                    'Traditional MCQ': () => this.renderTraditionalMCQ(item),
                    'Trios of Gapped Sentence': () => this.renderTriosOfGappedSentence(),
                    'Gap-Fill': () => this.renderGapFill(item),
                    'Find and Fix Error': () => this.renderFindAndFixError(item),
                };
                
                const renderFunction = renderMap[this.data.mode];
                if (renderFunction) {
                    this.data.currentSessionIndex++;
                    renderFunction();
                } else {
                    this.renderDashboard();
                }
            },
            
            // --- [START] EXERCISE RENDERERS ---
            
            renderFlashcard(item, isStructure = false) {
                this.updateHeader('Study', isStructure ? 'Structure Flashcard' : 'Vocabulary Flashcard');
                const main = document.getElementById('main-content');
                
                const frontHTML = isStructure ? `<p class="text-3xl font-bold text-center">${item.fullStructure}</p>` : `<p class="text-4xl font-bold">${item.word}</p>`;
                const backHTML = isStructure ? `
                    <div class="p-4">
                        <p class="text-2xl font-semibold text-center">${item.translation}</p>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mt-2 text-center">${(item.applicationExamples || [])[0] || ''}</p>
                    </div>
                ` : `
                    <div class="p-4 text-center">
                        <p class="text-2xl font-semibold">${item.meaning}</p>
                        <p class="text-lg text-slate-600 dark:text-slate-400 mt-2">${item.pronunciation} - (${item.type})</p>
                        <p class="text-sm text-slate-500 dark:text-slate-400 italic mt-4">"${item.exampleSentence}"</p>
                        <button id="explore-family-btn" class="btn btn-secondary !py-2 !px-4 mt-4 text-sm"><i class="fas fa-project-diagram mr-2"></i>Khám phá họ từ</button>
                    </div>
                `;

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                            <div class="text-lg font-semibold">${this.data.currentSessionIndex} / ${this.data.sessionItems.length}</div>
                            <button id="next-btn" class="btn btn-main-action">Next <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                        <div class="card glass-panel flex items-center justify-center">
                            <div class="flashcard-container">
                                <div class="flashcard" id="flashcard">
                                    <div class="flashcard-face flashcard-front">${frontHTML}</div>
                                    <div class="flashcard-face flashcard-back">${backHTML}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen('study'));
                document.getElementById('flashcard').addEventListener('click', (e) => e.currentTarget.classList.toggle('is-flipped'));
                document.getElementById('next-btn').addEventListener('click', () => this.renderNextInSession());
                if (!isStructure) {
                    document.getElementById('explore-family-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.renderWordFamilyMindmap(item);
                    });
                }
            },

            renderWordFamilyMindmap(item) {
                this.updateHeader('Study', 'Word Family Explorer');
                const main = document.getElementById('main-content');
                const familyRoot = item.familyRoot;
                const familyWords = this.data.wordFamilies[familyRoot] || [item];

                main.innerHTML = `
                    <div class="fade-in">
                        <div class="mb-4">
                            <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                        </div>
                        <div class="card glass-panel min-h-[60vh] flex flex-col">
                            <h2 class="text-2xl font-bold text-center mb-4">Họ từ: <span class="text-violet-700 dark:text-violet-300">${familyRoot}</span></h2>
                            <div class="mindmap-container">
                                <div class="mindmap" id="mindmap">
                                    <div class="mindmap-center">${familyRoot}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const mindmap = document.getElementById('mindmap');
                const radius = Math.min(mindmap.clientWidth, mindmap.clientHeight) / 2.5 || 150;
                const angleStep = (2 * Math.PI) / familyWords.length;

                familyWords.forEach((word, index) => {
                    const angle = index * angleStep;
                    const x = radius * Math.cos(angle);
                    const y = radius * Math.sin(angle);

                    const node = document.createElement('div');
                    node.className = 'mindmap-node';
                    node.style.transform = `translate(${x}px, ${y}px)`;
                    node.innerHTML = `<p class="font-bold">${word.word}</p><p class="text-xs text-slate-500">(${word.type})</p>`;
                    mindmap.appendChild(node);
                });

                document.getElementById('back-btn').addEventListener('click', () => this.renderSelectionScreen('study'));
            },

            renderWordFamilyMatching() {
                const familyRoot = this.shuffleArray(Object.keys(this.data.wordFamilies))[0] || this.data.words[0].familyRoot;
                this.data.wordFamilyState.familyWords = this.data.wordFamilies[familyRoot];
                this.data.wordFamilyState.matchedWords = [];
                this.data.wordFamilyState.selected = { word: null, type: null, meaning: null, pronunciation: null };

                const renderColumns = () => {
                    const familyWords = this.data.wordFamilyState.familyWords;
                    const words = this.shuffleArray(familyWords.map(w => ({ text: w.word, id: w.id })));
                    const types = this.shuffleArray(familyWords.map(w => ({ text: w.type, id: w.id })));
                    const meanings = this.shuffleArray(familyWords.map(w => ({ text: w.meaning, id: w.id })));
                    const pronunciations = this.shuffleArray(familyWords.map(w => ({ text: w.pronunciation, id: w.id })));

                    const createColumn = (title, items, category) => `
                        <div class="flex-1">
                            <h4 class="font-bold text-center mb-3 text-slate-600">${title}</h4>
                            <div class="flex flex-col gap-2" data-category="${category}">
                                ${items.map(item => `<button data-id="${item.id}" class="p-3 rounded-lg text-sm text-center answer-option">${item.text}</button>`).join('')}
                            </div>
                        </div>`;

                    document.getElementById('main-content').innerHTML = `
                        <div class="fade-in">
                            <h3 class="text-xl font-bold mb-4 text-center text-slate-800">Word Family Matching</h3>
                            <p class="text-center text-slate-500 mb-6">Nối các mục ở 4 cột để tạo thành các từ đúng trong họ từ "${familyRoot}".</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                ${createColumn('Từ vựng', words, 'word')}
                                ${createColumn('Loại từ', types, 'type')}
                                ${createColumn('Nghĩa', meanings, 'meaning')}
                                ${createColumn('Phiên âm', pronunciations, 'pronunciation')}
                            </div>
                            <div class="text-center mt-6">
                                <button id="check-family-btn" class="btn btn-main-action" disabled>Kiểm tra</button>
                            </div>
                        </div>`;

                    document.querySelectorAll('.answer-option').forEach(btn => btn.onclick = (e) => handleFamilySelection(e.target));
                    document.getElementById('check-family-btn').onclick = checkFamilyMatch;
                };
                
                const handleFamilySelection = (selectedButton) => {
                    const category = selectedButton.parentElement.dataset.category;
                    selectedButton.parentElement.querySelectorAll('.answer-option').forEach(btn => btn.classList.remove('selected'));
                    selectedButton.classList.add('selected');
                    this.data.wordFamilyState.selected[category] = selectedButton;
                    const allSelected = Object.values(this.data.wordFamilyState.selected).every(val => val !== null);
                    document.getElementById('check-family-btn').disabled = !allSelected;
                };

                const checkFamilyMatch = () => {
                    const selectedWordId = this.data.wordFamilyState.selected.word.dataset.id;
                    const isCorrect = Object.values(this.data.wordFamilyState.selected).every(btn => btn.dataset.id === selectedWordId);
                    const selectedButtons = Object.values(this.data.wordFamilyState.selected);
                    selectedButtons.forEach(btn => btn.classList.add(isCorrect ? 'correct' : 'incorrect'));
                    
                    if (isCorrect) {
                        this.data.wordFamilyState.matchedWords.push(selectedWordId);
                        selectedButtons.forEach(btn => { btn.disabled = true; btn.classList.remove('selected'); });
                        if (this.data.wordFamilyState.matchedWords.length === this.data.wordFamilyState.familyWords.length) {
                            this.showFeedback(true, `<p class="text-green-600 font-bold text-lg">Hoàn hảo! Bạn đã ghép đúng cả họ từ. <i class="fas fa-award"></i></p>`);
                        }
                    } else {
                        setTimeout(() => selectedButtons.forEach(btn => btn.classList.remove('incorrect', 'selected')), 1000);
                    }
                    this.data.wordFamilyState.selected = { word: null, type: null, meaning: null, pronunciation: null };
                    document.getElementById('check-family-btn').disabled = true;
                };

                renderColumns();
            },

            // ... All other 9 render functions will be here ...

            // --- [END] EXERCISE RENDERERS ---
            
            showFeedback(isCorrect, customMessage = null) {
                const feedbackArea = document.getElementById('feedback-area');
                feedbackArea.innerHTML = '';
                if (customMessage) {
                    feedbackArea.innerHTML = customMessage;
                } else if (isCorrect) {
                    feedbackArea.innerHTML = `<p class="text-green-600 font-bold text-lg">Chính xác! <i class="fas fa-check-circle"></i></p>`;
                } else {
                    feedbackArea.innerHTML = `<p class="text-red-600 font-bold text-lg">Chưa đúng! <i class="fas fa-times-circle"></i> Đáp án đúng là: <strong class="underline">${this.data.currentCorrectAnswer}</strong></p>`;
                }
                const nextButton = document.createElement('button');
                nextButton.textContent = 'Câu tiếp theo';
                nextButton.className = 'btn btn-main-action mt-4';
                nextButton.onclick = () => { feedbackArea.innerHTML = ''; this.renderNextInSession(); };
                feedbackArea.appendChild(nextButton);
            },

            checkMCQAnswer(selectedOption) {
                const buttons = document.querySelectorAll('.answer-option');
                buttons.forEach(btn => btn.disabled = true);
                const isCorrect = selectedOption.textContent === this.data.currentCorrectAnswer;
                selectedOption.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) {
                    buttons.forEach(btn => {
                        if (btn.textContent === this.data.currentCorrectAnswer) btn.classList.add('correct');
                    });
                }
                this.showFeedback(isCorrect);
            },

            // --- UTILITY & HELPER FUNCTIONS ---
            showErrorState(message) {
                document.getElementById('loader-overlay').classList.remove('is-open');
                document.body.innerHTML = `<div class="flex items-center justify-center min-h-screen"><div class="text-center p-8 glass-panel max-w-lg"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i><h2 class="text-2xl font-bold text-red-700">Đã xảy ra lỗi</h2><p class="text-slate-600 mt-2">${message}</p><button onclick="window.location.href='/'" class="btn btn-main-action mt-6">Quay lại trang chủ</button></div></div>`;
            },
            
            initSidebarNav() {
                document.getElementById('nav-dashboard').addEventListener('click', () => this.renderDashboard());
                document.getElementById('nav-study').addEventListener('click', () => this.renderSelectionScreen('study'));
                document.getElementById('nav-practice').addEventListener('click', () => this.renderSelectionScreen('practice'));
                document.getElementById('nav-test').addEventListener('click', () => this.openModal('test-setup-modal'));
                document.getElementById('nav-reset').addEventListener('click', () => {
                    this.showCustomConfirm("Bạn có chắc muốn xóa toàn bộ tiến trình của bài tập này không?", async () => {
                        this.data.progress = { learnedItems: {}, lastTestResult: null, incorrectCounts: {} };
                        await this.saveProgressToFirebase();
                        this.applyUserProgress();
                        this.renderDashboard();
                        this.showCustomAlert("Đã xóa tiến trình.");
                    }, 'Xóa', 'Hủy');
                });
            },
            setActiveNav(navId) { document.querySelectorAll('.sidebar-nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(navId)?.classList.add('active'); },
            updateHeader(title, subtitle) { document.getElementById('app-title').textContent = title; document.getElementById('app-subtitle').textContent = subtitle; },
            initModals() {
                document.getElementById('close-word-modal-btn').onclick = () => this.closeModal('word-list-modal');
                document.getElementById('close-test-modal-btn').onclick = () => this.closeModal('test-setup-modal');
                document.getElementById('start-test-fixed-btn').addEventListener('click', () => { this.closeModal('test-setup-modal'); this.startTest(parseInt(document.getElementById('question-count').value)); });
                document.getElementById('start-test-all-btn').addEventListener('click', () => { this.closeModal('test-setup-modal'); this.startTest(-1); });
            },
            openModal(id) { document.getElementById(id)?.classList.add('is-open'); },
            closeModal(id) { const m = document.getElementById(id); if(m) { m.classList.add('is-closing'); setTimeout(() => m.classList.remove('is-open', 'is-closing'), 300); } },
            showFilteredList(listType) {
                const table = document.getElementById('word-table');
                const title = document.getElementById('modal-title');
                let items, headers, rows;
                const isStruct = listType.includes('structures');
                const isLearned = listType.includes('learned');
                
                if (isStruct) {
                    items = this.data.structures.filter(i => i.isLearned === isLearned);
                    title.textContent = `${isLearned ? 'Đã học' : 'Chưa học'} Cấu trúc`;
                    headers = `<thead><tr class="text-xs text-slate-800 uppercase"><th class="px-6 py-3">Structure</th><th class="px-6 py-3">Meaning</th></tr></thead>`;
                    rows = items.map(i => `<tr class="border-b border-slate-200/50"><td class="px-6 py-4 font-medium">${i.fullStructure}</td><td class="px-6 py-4">${i.translation}</td></tr>`).join('');
                } else {
                    items = this.data.words.filter(i => i.isLearned === isLearned);
                    title.textContent = `${isLearned ? 'Đã học' : 'Chưa học'} Từ vựng`;
                    headers = `<thead><tr class="text-xs text-slate-800 uppercase"><th class="px-6 py-3">Word</th><th class="px-6 py-3">Type</th><th class="px-6 py-3">Meaning</th></tr></thead>`;
                    rows = items.map(i => `<tr class="border-b border-slate-200/50"><td class="px-6 py-4 font-medium">${i.word}</td><td class="px-6 py-4">${i.type}</td><td class="px-6 py-4">${i.meaning}</td></tr>`).join('');
                }
                table.innerHTML = headers + `<tbody>${rows}</tbody>`;
                this.openModal('word-list-modal');
            },
            showCustomAlert(message) {
                const alertId = 'custom-alert-box';
                document.getElementById(alertId)?.remove();
                const alertBox = document.createElement('div');
                alertBox.id = alertId;
                alertBox.className = 'glass-panel';
                alertBox.style.cssText = `position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:16px 24px; border-radius:16px; z-index:200; font-weight:600; color:var(--text-primary); animation:fadeIn 0.5s ease forwards;`;
                alertBox.innerHTML = message;
                document.body.appendChild(alertBox);
                setTimeout(() => { alertBox.style.animation = 'scaleOut 0.5s ease forwards'; setTimeout(() => alertBox.remove(), 500); }, 3000);
            },
            showCustomConfirm(message, onConfirm, confirmText = 'Yes', cancelText = 'Cancel') {
                const confirmId = 'custom-confirm-box';
                document.getElementById(confirmId)?.remove();
                const confirmBox = document.createElement('div');
                confirmBox.id = confirmId;
                confirmBox.className = 'modal is-open';
                confirmBox.innerHTML = `<div class="modal-content glass-panel text-center"><p class="text-lg font-medium text-slate-800 mb-6">${message}</p><div class="flex justify-center gap-4"><button id="confirm-no" class="btn btn-secondary">${cancelText}</button><button id="confirm-yes" class="btn btn-main-action bg-red-500 hover:bg-red-600">${confirmText}</button></div></div>`;
                document.body.appendChild(confirmBox);
                const close = () => { confirmBox.classList.add('is-closing'); setTimeout(() => confirmBox.remove(), 300); };
                document.getElementById('confirm-yes').onclick = () => { onConfirm(); close(); };
                document.getElementById('confirm-no').onclick = close;
            },
            shuffleArray(array) { 
                const a = [...array];
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
