<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc v√† Luy·ªán t·∫≠p T·ª´ v·ª±ng</title>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- OGL Library for 3D Particles -->
    <script type="module">
        import { Renderer, Camera, Transform, Program, Geometry, Mesh } from 'https://cdn.skypack.dev/ogl';
        window.OGL = { Renderer, Camera, Transform, Program, Geometry, Mesh };
    </script>
    
    <!-- Firebase Config (Gi·ªØ nguy√™n c·ªßa b·∫°n) -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>
    
    <style>
        :root {
            --bg-dark: #111827;
            --text-light: #f0f6fc;
            --text-secondary: #d1d5db;
            --glass-bg: radial-gradient(ellipse at center, rgba(31, 41, 55, 0.65) 0%, rgba(31, 41, 55, 0.4) 100%);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary-accent: #8b5cf6;
            --grad-color-1: #d8b4fe;
            --grad-color-2: #a855f7;
            --correct-color: #22c55e;
            --incorrect-color: #ef4444;
        }

        /* --- C√ÄI ƒê·∫∂T C∆† B·∫¢N --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- L·ªöP N·ªÄN 3D --- */
        .background-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .background-shapes { z-index: 1; }
        #ogl-canvas-back { z-index: 2; }
        #ogl-canvas-front { z-index: 4; }
        .shape { position: absolute; border-radius: 50%; filter: blur(120px); opacity: 0.4; animation: float 20s ease-in-out infinite alternate; }
        .shape1 { width: 40vw; height: 40vw; max-width: 450px; max-height: 450px; background: var(--grad-color-2); top: -15%; left: -10%; animation-delay: -10s;}
        .shape2 { width: 35vw; height: 35vw; max-width: 400px; max-height: 400px; background: #22d3ee; bottom: -15%; right: -10%; }
        @keyframes float { to { transform: translateY(20vh); } }

        /* --- CONTAINER CH√çNH & HI·ªÜU ·ª®NG PARALLAX --- */
        #app-container {
            max-width: 860px;
            margin: 0 auto;
            padding: 2rem 1rem;
            position: relative;
            z-index: 3;
            display: none; /* Hi·ªÉn th·ªã b·∫±ng JS */
            perspective: 1000px;
        }
        #app-header, #app-main {
            transform-style: preserve-3d;
            transition: transform 0.1s linear;
        }
        
        /* --- TH·∫∫ K√çNH (GLASS CARD) --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
        }

        /* --- N√öT B·∫§M (CTA BUTTON) --- */
        .cta-btn {
            position: relative; overflow: hidden; display: inline-flex; align-items: center; justify-content: center; gap: 12px;
            background: linear-gradient(90deg, var(--primary-accent), #6d28d9);
            font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 16px;
            padding: 12px 24px; border-radius: 99px; border: none; cursor: pointer;
            text-decoration: none; color: rgba(255,255,255,0.95);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.2), inset 0 -1px 1px rgba(0,0,0,0.1), 0 10px 20px -8px rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
        }
        .cta-btn > * { z-index: 2; }
        .cta-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: inset 0 1px 1px rgba(255,255,255,0.2), inset 0 -1px 1px rgba(0,0,0,0.1), 0 12px 25px -8px rgba(139, 92, 246, 0.8); }
        .cta-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .cta-btn.secondary {
            background: transparent; border: 2px solid #4a5568; box-shadow: none; color: var(--text-secondary);
        }
        .cta-btn.secondary:hover:not(:disabled) { background: rgba(139, 92, 246, 0.15); border-color: var(--primary-accent); color: white; }
        .cta-btn.danger { background: linear-gradient(90deg, #ef4444, #b91c1c); box-shadow: 0 10px 20px -8px rgba(239, 68, 68, 0.5); }
        .cta-btn.danger:hover:not(:disabled) { box-shadow: 0 12px 25px -8px rgba(239, 68, 68, 0.8); }
        .cta-btn::before {
            content: ''; position: absolute; z-index: 1; inset: 0;
            background: linear-gradient(110deg, transparent 35%, rgba(255, 255, 255, 0.35) 50%, transparent 65%);
            background-size: 250% 100%; background-position: 150% 0; transition: background-position 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .cta-btn:hover:not(:disabled)::before { background-position: -50% 0; }

        /* --- TI√äU ƒê·ªÄ & THANH TI·∫æN ƒê·ªò --- */
        .app-header-content { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
        .progress-bar { background-color: rgba(0,0,0,0.2); border-radius: 9999px; height: 8px; overflow: hidden; width: 100%; }
        .progress-bar-fill { background: linear-gradient(90deg, var(--grad-color-1), var(--primary-accent)); height: 100%; transition: width 0.4s ease; }

        /* --- DASHBOARD --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .dashboard-grid .cta-btn { text-align: left; justify-content: flex-start; padding: 1rem; height: 100%; border-radius: 1rem;}
        .dashboard-grid .cta-btn > div:first-child { width: 2rem; text-align: center; }

        /* --- FLASHCARD --- */
        .flashcard-viewer { display: flex; flex-direction: column; min-height: 70vh; }
        .flashcard-main { flex-grow: 1; display: flex; align-items: center; justify-content: center; perspective: 1000px; padding: 1rem 0; }
        .flashcard { width: 100%; height: 350px; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); padding: 2rem; border-radius: 1.5rem; text-align: center;
        }
        .flashcard-back { transform: rotateY(180deg); background: radial-gradient(ellipse at center, rgba(55, 65, 81, 0.7) 0%, rgba(55, 65, 81, 0.5) 100%); }
        .audio-btn {
            position: absolute; top: 1.5rem; right: 1.5rem; width: 44px; height: 44px; border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1); color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; z-index: 10; border: none;
        }
        .audio-btn:hover { background-color: var(--primary-accent); color: white; }

        /* --- C√ÅC TH√ÄNH PH·∫¶N LUY·ªÜN T·∫¨P --- */
        .answer-option {
            display: block; width: 100%; padding: 1rem; border: 2px solid var(--glass-border); border-radius: 0.75rem;
            background-color: rgba(255,255,255,0.05); text-align: left; font-weight: 500; color: var(--text-light);
            cursor: pointer; transition: all 0.2s ease;
        }
        .answer-option:hover:not(.disabled) { border-color: var(--primary-accent); background-color: rgba(139, 92, 246, 0.1); }
        .answer-option.disabled { cursor: not-allowed; opacity: 0.6; }
        .answer-option.correct { border-color: var(--correct-color); background-color: rgba(34, 197, 94, 0.1); color: #a7f3d0; font-weight: bold; }
        .answer-option.incorrect { border-color: var(--incorrect-color); background-color: rgba(239, 68, 68, 0.1); color: #fca5a5; font-weight: bold; }
        .text-input-wrapper { position: relative; width: 100%; border-radius: 14px; }
        @property --angle { syntax: '<angle>'; initial-value: 0deg; inherits: false; }
        .text-input-wrapper::before, .text-input-wrapper::after { content: ''; position: absolute; inset: -2px; z-index: -1; border-radius: inherit; background: conic-gradient(from var(--angle), #a855f7, #8b5cf6 30%, #22d3ee 60%, #a855f7); opacity: 0; transition: opacity 0.3s ease; animation: spin 4s linear infinite paused; }
        .text-input-wrapper::after { filter: blur(10px); }
        .text-input-wrapper:has(.text-input:focus)::before, .text-input-wrapper:has(.text-input:focus)::after { opacity: 1; animation-play-state: running; }
        @keyframes spin { to { --angle: 360deg; } }
        .text-input { width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(55, 65, 81, 0.5); font-family: 'Inter', sans-serif; font-size: 16px; color: var(--text-light); caret-color: var(--primary-accent); transition: all 0.2s ease-in-out; position: relative; z-index: 1; }
        .text-input::placeholder { color: var(--text-secondary); }
        .text-input:focus { outline: none; border-color: rgba(139, 92, 246, 0.6); background: rgba(55, 65, 81, 0.8); }
        .token-area { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 1rem; border: 2px dashed rgba(255, 255, 255, 0.2); border-radius: 0.5rem; min-height: 80px; }
        .word-token { padding: 0.5rem 1rem; background-color: rgba(139, 92, 246, 0.2); color: #d8b4fe; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .word-token:hover { background-color: rgba(139, 92, 246, 0.4); }

        /* --- MINDMAP --- */
        .mindmap-node { position: absolute; width: 120px; height: 120px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .mindmap-node:hover { transform: scale(1.05); }
        .mindmap-node.center { background: linear-gradient(135deg, var(--primary-accent), #6d28d9); color: white; font-weight: bold; font-size: 1.1rem; z-index: 10; }
        .mindmap-node.child { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-light); }
        .mindmap-line { position: absolute; height: 2px; background: var(--glass-border); transform-origin: 0 50%; z-index: 5; }

        /* --- MODAL --- */
        #modal-container { position: relative; z-index: 50; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; padding: 1rem; animation: fadeIn 0.3s ease; }
        .modal-content { max-width: 500px; width: 100%; }

        /* --- LOADER --- */
        #loader-overlay {
            position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center; z-index: 60;
            flex-direction: column;
        }
        .loader-spinner {
            width: 64px; height: 64px; border: 8px solid rgba(255,255,255,0.2);
            border-top-color: var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite;
        }
        
        /* --- HI·ªÜU ·ª®NG --- */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .slide-out-left { animation: slideOutLeft 0.3s forwards ease-in-out; }
        .slide-out-right { animation: slideOutRight 0.3s forwards ease-in-out; }
    </style>
</head>
<body>
    
    <div class="background-shapes background-layer">
        <div class="shape shape1"></div>
        <div class="shape shape2"></div>
    </div>
    <div id="ogl-canvas-back" class="background-layer"></div>
    <div id="ogl-canvas-front" class="background-layer"></div>

    <div id="loader-overlay">
        <div class="loader-spinner"></div>
        <p id="loader-text" style="font-size: 1.125rem; font-weight: 600; color: white; margin-top: 1rem;">ƒêang t·∫£i d·ªØ li·ªáu b√†i h·ªçc...</p>
    </div>
    
    <div id="modal-container"></div>
    
    <div id="app-container">
        <header id="app-header" style="transform: translateZ(20px);"></header>
        <main id="app-main" style="transform: translateZ(50px);"></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // --- SCRIPT 3D PARTICLE BACKGROUND ---
        const OGL = window.OGL;
        if (OGL) {
            const createParticleSystem = (containerId, zRange) => {
                const container = document.getElementById(containerId);
                if (!container) return null;
                const renderer = new OGL.Renderer({ dpr: 2, alpha: true });
                const gl = renderer.gl;
                container.appendChild(gl.canvas);
                const camera = new OGL.Camera(gl, { fov: 15, near: 1, far: 100 });
                camera.position.set(0, 0, 25);
                const scene = new OGL.Transform();
                const program = new OGL.Program(gl, {
                    vertex: `attribute vec3 position;attribute vec4 random;attribute vec3 color;uniform mat4 modelMatrix;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform float uTime;uniform float uSpread;uniform float uBaseSize;varying vec4 vRandom;varying vec3 vColor;void main(){vRandom=random;vColor=color;vec3 pos=position*uSpread;vec4 mPos=modelMatrix*vec4(pos,1.);float t=uTime*.1;mPos.x+=sin(t*random.z+6.28*random.w)*mix(.1,1.5,random.x);mPos.y+=sin(t*random.y+6.28*random.x)*mix(.1,1.5,random.w);mPos.z+=cos(t*random.w+6.28*random.y)*mix(.1,1.5,random.z);vec4 mvPos=viewMatrix*mPos;gl_PointSize=uBaseSize/-mvPos.z;gl_Position=projectionMatrix*mvPos;}`,
                    fragment: `precision highp float;varying vec3 vColor;void main(){vec2 uv=gl_PointCoord.xy;float d=length(uv-vec2(.5));float glow=smoothstep(.5,0.,d)*.3;float core=smoothstep(.2,.18,d);float alpha=max(core,glow);if(alpha<.01)discard;vec3 finalColor=vColor+vColor*pow(glow,2.)*2.;gl_FragColor=vec4(finalColor,alpha);}`,
                    uniforms: { uTime: { value: 0 }, uSpread: { value: 1 }, uBaseSize: { value: 350 } },
                    transparent: true, depthTest: false
                });
                const count = 500;
                const positions = new Float32Array(count * 3);
                const randoms = new Float32Array(count * 4);
                const colors = new Float32Array(count * 3);
                const palette = ['#a855f7', '#8b5cf6', '#22d3ee', '#f59e0b'];
                const hexToRgb = (h) => { const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h); return r ? [parseInt(r[1], 16)/255, parseInt(r[2], 16)/255, parseInt(r[3], 16)/255] : [0,0,0]; };
                for (let i = 0; i < count; i++) {
                    const z = zRange[0] + Math.random() * (zRange[1] - zRange[0]);
                    positions.set([(Math.random() - 0.5) * 30, (Math.random() - 0.5) * 30, z], i * 3);
                    randoms.set([Math.random(), Math.random(), Math.random(), Math.random()], i * 4);
                    colors.set(hexToRgb(palette[Math.floor(Math.random() * palette.length)]), i * 3);
                }
                const geometry = new OGL.Geometry(gl, { position: { size: 3, data: positions }, random: { size: 4, data: randoms }, color: { size: 3, data: colors } });
                const particles = new OGL.Mesh(gl, { mode: gl.POINTS, geometry, program });
                particles.setParent(scene);
                return { renderer, camera, scene, program };
            };
            const backParticles = createParticleSystem('ogl-canvas-back', [-20, -1]);
            const frontParticles = createParticleSystem('ogl-canvas-front', [1, 20]);
            
            const mouse = { x: 0, y: 0 };
            document.addEventListener('mousemove', (e) => {
                mouse.x = (e.clientX / window.innerWidth) - 0.5;
                mouse.y = (e.clientY / window.innerHeight) - 0.5;

                const rotateX = -mouse.y * 3;
                const rotateY = mouse.x * 3;
                
                const appHeader = document.getElementById('app-header');
                const appMain = document.getElementById('app-main');
                if (appHeader) appHeader.style.transform = `translateZ(20px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                if (appMain) appMain.style.transform = `translateZ(50px) rotateX(${rotateX*1.5}deg) rotateY(${rotateY*1.5}deg)`;
            });

            const resize = () => {
                if (backParticles) {
                    backParticles.renderer.setSize(window.innerWidth, window.innerHeight);
                    backParticles.camera.perspective({ aspect: window.innerWidth / window.innerHeight });
                }
                if (frontParticles) {
                    frontParticles.renderer.setSize(window.innerWidth, window.innerHeight);
                    frontParticles.camera.perspective({ aspect: window.innerWidth / window.innerHeight });
                }
            };
            window.addEventListener("resize", resize, false);
            resize();
            
            const update = (t) => {
                requestAnimationFrame(update);
                if (backParticles) {
                    backParticles.program.uniforms.uTime.value = t * 0.001;
                    backParticles.scene.rotation.y += (-mouse.x * 0.1 - backParticles.scene.rotation.y) * 0.05;
                    backParticles.scene.rotation.x += (mouse.y * 0.1 - backParticles.scene.rotation.x) * 0.05;
                    backParticles.renderer.render({ scene: backParticles.scene, camera: backParticles.camera });
                }
                if (frontParticles) {
                    frontParticles.program.uniforms.uTime.value = t * 0.001;
                    frontParticles.scene.rotation.y += (-mouse.x * 0.15 - frontParticles.scene.rotation.y) * 0.05;
                    frontParticles.scene.rotation.x += (mouse.y * 0.15 - frontParticles.scene.rotation.x) * 0.05;
                    frontParticles.renderer.render({ scene: frontParticles.scene, camera: frontParticles.camera });
                }
            };
            requestAnimationFrame(update);
        }

        const App = {
            state: {
                db: null,
                submissionId: null,
                studentName: '',
                testData: {},
                wordList: [],
                structureList: [],
                wordFamilies: {},
                currentSessionItems: [],
                sessionCorrectItems: [],
                sessionIncorrectItems: [],
                currentIndex: 0,
                currentScore: 0,
                currentCorrectAnswer: null,
                progress: { learnedItems: new Set(), incorrectCounts: {} },
                isSubmitting: false,
                audioPlayer: null,
                playbackRate: 1.0,
                session: {
                    isCompleted: false,
                    finalTestTaken: false,
                    finalTestScore: null,
                },
                proctoring: {
                    violations: 0,
                    timerId: null,
                    timeRemaining: 0,
                }
            },
            DOM: {},

            async init() {
                this.DOM = {
                    loader: document.getElementById('loader-overlay'),
                    loaderText: document.getElementById('loader-text'),
                    container: document.getElementById('app-container'),
                    header: document.getElementById('app-header'),
                    main: document.getElementById('app-main'),
                    modal: document.getElementById('modal-container'),
                };
                this.state.db = getFirestore(initializeApp(window.firebaseConfig));
                this.state.audioPlayer = new Audio();
                const params = new URLSearchParams(window.location.search);
                const submissionId = params.get('submission_id');

                if (!submissionId) {
                    this.showModal("L·ªói", "Kh√¥ng t√¨m th·∫•y m√£ b√†i l√†m (Submission ID).");
                    return;
                }

                this.state.submissionId = submissionId;
                await this.startSession(submissionId);
            },
            
            async startSession(submissionId) {
                try {
                    const submissionRef = doc(this.state.db, 'submissions', submissionId);
                    const submissionSnap = await getDoc(submissionRef);
                    if (!submissionSnap.exists()) throw new Error("M√£ b√†i l√†m kh√¥ng h·ª£p l·ªá.");

                    let submissionData = submissionSnap.data();
                    
                    this.state.session.isCompleted = submissionData.status === 'submitted';
                    if (submissionData.finalTest && submissionData.finalTest.status === 'completed') {
                        this.state.session.finalTestTaken = true;
                        this.state.session.finalTestScore = submissionData.finalTest.score;
                    }
                    
                    this.state.testData = submissionData.testSnapshot;
                    
                    const userDoc = await getDoc(doc(this.state.db, "users", submissionData.studentId));
                    this.state.studentName = userDoc.exists() ? userDoc.data().displayName : "Kh√¥ng r√µ";

                    this.state.wordList = this.state.testData.wordList || [];
                    
                    this.processData();
                    this.loadProgress();
                    
                    this.DOM.loader.style.display = 'none';
                    this.DOM.container.style.display = 'block';
                    
                    this.renderHeader();
                    this.renderDashboard();
                } catch (error) {
                    this.showModal("L·ªói", error.message);
                    this.DOM.loader.style.display = 'none';
                }
            },
            
            processData() {
                const structures = [];
                const families = {};
                this.state.wordList.forEach((word, idx) => {
                    word.itemType = 'word';
                    word.id = `word_${word.id || idx}`; 
                    if (word.structures && Array.isArray(word.structures)) {
                        word.structures.forEach((struct, s_idx) => {
                            structures.push({ ...struct, id: `structure_${word.id}_${s_idx}`, itemType: 'structure', rootWord: word.word });
                        });
                    }
                    const root = this.findRoot(word.word);
                    word.familyRoot = root;
                    if (!families[root]) families[root] = [];
                    families[root].push(word);
                });
                this.state.structureList = structures;
                this.state.wordFamilies = families;
            },

            loadProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                const savedProgress = localStorage.getItem(progressKey);
                if (savedProgress) {
                    const parsed = JSON.parse(savedProgress);
                    this.state.progress.learnedItems = new Set(parsed.learnedItems || []);
                    this.state.progress.incorrectCounts = parsed.incorrectCounts || {};
                }
            },

            saveProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                localStorage.setItem(progressKey, JSON.stringify({
                    learnedItems: [...this.state.progress.learnedItems],
                    incorrectCounts: this.state.progress.incorrectCounts,
                }));
            },

            renderHeader() {
                const isCompleted = this.state.session.isCompleted;
                const buttonText = isCompleted ? "C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô" : "Ho√†n th√†nh & L∆∞u";
                const buttonIcon = isCompleted ? "fa-sync-alt" : "fa-check-circle";

                this.DOM.header.innerHTML = `
                    <div class="glass-card">
                        <div class="app-header-content">
                            <div>
                                <h1 style="font-family: 'Poppins', sans-serif; font-size: 1.75rem; font-weight: 700;">${this.state.testData.title}</h1>
                                <p style="font-size: 0.9rem; color: var(--text-secondary);">H·ªçc sinh: <span style="font-weight: 600; color: var(--text-light);">${this.state.studentName}</span></p>
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                                <a href="student-dashboard.html" class="cta-btn secondary"><i class="fas fa-arrow-left"></i><span>Dashboard</span></a>
                                <button id="submit-final-btn" class="cta-btn"><i class="fas ${buttonIcon}"></i><span>${buttonText}</span></button>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('submit-final-btn').addEventListener('click', () => {
                    const title = isCompleted ? "X√°c nh·∫≠n C·∫≠p nh·∫≠t" : "X√°c nh·∫≠n Ho√†n th√†nh";
                    const message = isCompleted ? "B·∫°n c√≥ mu·ªën l∆∞u l·∫°i ti·∫øn ƒë·ªô h·ªçc t·∫≠p m·ªõi nh·∫•t kh√¥ng?" : "B·∫°n c√≥ ch·∫Øc mu·ªën k·∫øt th√∫c v√† l∆∞u ti·∫øn ƒë·ªô kh√¥ng? Thao t√°c n√†y s·∫Ω ghi nh·∫≠n k·∫øt qu·∫£ cu·ªëi c√πng c·ªßa b·∫°n.";
                    this.showModal(title, message, true, () => this.submitToFirebase(true));
                });
            },

            renderDashboard() {
                const { wordList, structureList, progress } = this.state;
                const vocabLearned = wordList.filter(w => progress.learnedItems.has(w.id)).length;
                const structLearned = structureList.filter(s => progress.learnedItems.has(s.id)).length;
                const vocabProgress = wordList.length > 0 ? (vocabLearned / wordList.length * 100) : 0;
                const structProgress = structureList.length > 0 ? (structLearned / structureList.length * 100) : 0;
                const totalItems = wordList.length + structureList.length;
                const learnedCount = progress.learnedItems.size;
                const overallProgress = totalItems > 0 ? (learnedCount / totalItems * 100) : 0;
                const isEligibleForFinalTest = overallProgress >= 85;

                const notifKey = `finalTestNotif_${this.state.submissionId}`;
                if (isEligibleForFinalTest && !localStorage.getItem(notifKey) && !this.state.session.finalTestTaken) {
                    setTimeout(() => {
                        this.showModal("Ch√∫c m·ª´ng!", "B·∫°n ƒë√£ h·ªçc ƒë∆∞·ª£c 85% v√† m·ªü kh√≥a B√†i ki·ªÉm tra cu·ªëi k·ª≥!");
                        localStorage.setItem(notifKey, 'true');
                    }, 1000);
                }

                this.DOM.main.innerHTML = `
                    <div class="fade-in">
                        <div class="glass-card">
                             <h2 style="font-family: 'Poppins'; font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">T·ªïng quan Ti·∫øn ƒë·ªô</h2>
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                 <div><p style="font-weight: 500; margin-bottom: 0.5rem;">T·ª´ v·ª±ng ƒë√£ h·ªçc</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${vocabProgress.toFixed(0)}%;"></div></div><p style="text-align: right; font-size: 0.875rem; margin-top: 0.25rem; color: var(--text-secondary);">${vocabLearned}/${wordList.length}</p></div>
                                 <div><p style="font-weight: 500; margin-bottom: 0.5rem;">C·∫•u tr√∫c ƒë√£ h·ªçc</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${structProgress.toFixed(0)}%;"></div></div><p style="text-align: right; font-size: 0.875rem; margin-top: 0.25rem; color: var(--text-secondary);">${structLearned}/${structureList.length}</p></div>
                             </div>
                        </div>
                        <div class="glass-card">
                            <h2 style="font-family: 'Poppins'; font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">Ch·∫ø ƒë·ªô H·ªçc üìö</h2>
                            <div id="study-buttons" class="dashboard-grid">
                                <button data-study-mode="vocab-flashcard" class="cta-btn secondary"><div><i class="fas fa-clone" style="color:#d8b4fe;"></i></div><div><p style="font-weight: bold;">Flashcard T·ª´ v·ª±ng</p><p style="font-size: 0.8rem; font-weight: 400; color: var(--text-secondary);">H·ªçc t·ª´ m·ªõi qua flashcard.</p></div></button>
                                <button data-study-mode="mindmap" class="cta-btn secondary"><div><i class="fas fa-project-diagram" style="color:#7dd3fc;"></i></div><div><p style="font-weight: bold;">S∆° ƒë·ªì T·ª´ lo·∫°i</p><p style="font-size: 0.8rem; font-weight: 400; color: var(--text-secondary);">Kh√°m ph√° m·ªëi li√™n h·ªá t·ª´.</p></div></button>
                                <button data-study-mode="struct-flashcard" class="cta-btn secondary"><div><i class="fas fa-sitemap" style="color:#6ee7b7;"></i></div><div><p style="font-weight: bold;">Flashcard C·∫•u tr√∫c</p><p style="font-size: 0.8rem; font-weight: 400; color: var(--text-secondary);">H·ªçc c√°c c·∫•u tr√∫c c√¢u ch√≠nh.</p></div></button>
                            </div>
                        </div>
                        <div class="glass-card">
                            <h2 style="font-family: 'Poppins'; font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">Ch·∫ø ƒë·ªô Luy·ªán t·∫≠p üèãÔ∏è‚Äç‚ôÄÔ∏è</h2>
                            <div id="practice-buttons" style="display: flex; flex-direction: column; gap: 1rem;">
                                 <div style="display: flex; flex-direction: column; sm:flex-direction: row; gap: 1rem;">
                                     <button data-practice-mode="normal" class="cta-btn" style="flex:1;"><i class="fas fa-random"></i><span>Luy·ªán t·∫≠p Th∆∞·ªùng</span></button>
                                     <button data-practice-mode="weakness" class="cta-btn secondary" style="flex:1; border-color: #f59e0b; color: #f59e0b;"><i class="fas fa-star-half-alt"></i><span>√în t·∫≠p ƒêi·ªÉm y·∫øu</span></button>
                                 </div>
                                 ${ isEligibleForFinalTest ? `
                                     <button id="start-final-test-btn" class="cta-btn danger" style="width: 100%; margin-top: 1rem; padding: 1rem; font-size: 1.1rem;" ${this.state.session.finalTestTaken ? 'disabled' : ''}>
                                         <i class="fas fa-graduation-cap"></i>
                                         <span>${this.state.session.finalTestTaken ? `ƒê√£ l√†m KT cu·ªëi k·ª≥ (ƒêi·ªÉm: ${this.state.session.finalTestScore}%)` : 'B·∫Øt ƒë·∫ßu KT cu·ªëi k·ª≥'}</span>
                                     </button>
                                 ` : '' }
                            </div>
                        </div>
                    </div>`;

                document.getElementById('study-buttons').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button || !button.dataset.studyMode) return;
                    const mode = button.dataset.studyMode;
                    if (mode === 'vocab-flashcard') this.startFlashcardSession('word');
                    if (mode === 'struct-flashcard') this.startFlashcardSession('structure');
                    if (mode === 'mindmap') this.renderMindmapFamilySelection();
                });

                document.getElementById('practice-buttons').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.practiceMode) this.startPractice(button.dataset.practiceMode);
                });

                const finalTestBtn = document.getElementById('start-final-test-btn');
                if (finalTestBtn) {
                    finalTestBtn.addEventListener('click', () => {
                        this.showModal("X√°c nh·∫≠n KT cu·ªëi k·ª≥", "ƒê√¢y l√† b√†i ki·ªÉm tra cu·ªëi c√πng. N√≥ ch·ªâ ƒë∆∞·ª£c l√†m m·ªôt l·∫ßn v√† s·∫Ω ƒë∆∞·ª£c t√≠nh gi·ªù. B·∫°n ƒë√£ s·∫µn s√†ng ch∆∞a?", true, this.startFinalTest.bind(this));
                    });
                }
                if (Object.keys(this.state.progress.incorrectCounts).length === 0) {
                    this.DOM.main.querySelector('[data-practice-mode="weakness"]').disabled = true;
                }
            },

            async submitToFirebase(isFinal = false) {
                if (this.state.isSubmitting) return;
                this.state.isSubmitting = true;
                
                const loaderText = this.state.session.isCompleted ? "ƒêang c·∫≠p nh·∫≠t..." : "ƒêang n·ªôp b√†i...";
                this.DOM.loaderText.textContent = loaderText;
                this.DOM.loader.style.display = 'flex';

                const learnedCount = this.state.progress.learnedItems.size;
                const totalItems = this.state.wordList.length + this.state.structureList.length;
                const score = totalItems > 0 ? Math.round((learnedCount / totalItems) * 100) : 0;
                
                const submissionPayload = {
                    score: score,
                    totalPoints: 100,
                    answers: { 
                        learnedCount, 
                        totalItems,
                        incorrectCounts: this.state.progress.incorrectCounts 
                    },
                };

                if (isFinal) {
                    submissionPayload.status = 'submitted';
                    if (!this.state.session.isCompleted) {
                        submissionPayload.submissionTime = serverTimestamp();
                    }
                }

                try {
                    await updateDoc(doc(this.state.db, 'submissions', this.state.submissionId), submissionPayload);
                    
                    const message = this.state.session.isCompleted
                        ? `ƒê√£ c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô th√†nh c√¥ng.`
                        : `ƒê√£ n·ªôp b√†i th√†nh c√¥ng v·ªõi m·ª©c ƒë·ªô ho√†n th√†nh ${score}%.`;

                    this.showModal("Th√†nh c√¥ng!", message, false, () => {
                        this.state.session.isCompleted = true;
                        this.renderHeader();
                    });

                } catch(error) { 
                    this.showModal("L·ªói", "Kh√¥ng th·ªÉ l∆∞u ti·∫øn ƒë·ªô: " + error.message); 
                } finally { 
                    this.state.isSubmitting = false;
                    this.DOM.loader.style.display = 'none';
                }
            },
            
            startFlashcardSession(type) {
                this.state.currentSessionItems = type === 'word' ? this.state.wordList : this.state.structureList;
                if(this.state.currentSessionItems.length === 0) {
                    this.showModal("Th√¥ng b√°o", "Kh√¥ng c√≥ d·ªØ li·ªáu cho ch·∫ø ƒë·ªô h·ªçc n√†y.");
                    return;
                }
                this.state.currentIndex = 0;
                this.renderFlashcardViewer();
            },
            
            renderFlashcardViewer() {
                this.DOM.main.innerHTML = `
                    <div class="glass-card fade-in">
                        <div class="flashcard-viewer">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <button id="back-to-dashboard-btn" class="cta-btn secondary" style="padding: 8px 16px;"><i class="fas fa-arrow-left"></i><span>Quay l·∫°i</span></button>
                                <div id="card-counter" style="font-weight: 600; color: var(--text-secondary);"></div>
                            </div>
                            <div class="flashcard-main"><div class="flashcard" id="flashcard"></div></div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem;">
                                <button id="prev-card-btn" class="cta-btn secondary" style="border-radius: 50%; width: 56px; height: 56px; font-size: 1.25rem;"><i class="fas fa-arrow-left"></i></button>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">B·∫•m v√†o th·∫ª ƒë·ªÉ l·∫≠t</p>
                                <button id="next-card-btn" class="cta-btn" style="border-radius: 50%; width: 56px; height: 56px; font-size: 1.25rem;"><i class="fas fa-arrow-right"></i></button>
                            </div>
                        </div>
                    </div>`;

                this.updateFlashcardView();
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('flashcard').addEventListener('click', e => {
                    if (e.target.closest('.audio-btn')) return;
                    e.currentTarget.classList.toggle('is-flipped');
                });
                document.getElementById('prev-card-btn').addEventListener('click', () => this.navigateCard(-1));
                document.getElementById('next-card-btn').addEventListener('click', () => this.navigateCard(1));
            },

            updateFlashcardView() {
                const item = this.state.currentSessionItems[this.state.currentIndex];
                const card = document.getElementById('flashcard');
                if (!item || !card) return;

                card.classList.remove('is-flipped');
                setTimeout(() => {
                    const isStructure = item.itemType === 'structure';
                    const audioBtnHTML = item.audioUrl ? `<button class="audio-btn" data-audio-url="${item.audioUrl}"><i class="fas fa-volume-up"></i></button>` : '';

                    const frontContent = isStructure ? item.phrase : item.word;
                    const frontHTML = `${audioBtnHTML}<div style="font-family:'Poppins'; font-size: 2.5rem; font-weight: 700;">${frontContent}</div>`;
                    const backHTML = isStructure
                        ? `<div style="font-size: 1.5rem; font-weight: 600;">${item.meaning}</div><p style="color: var(--text-secondary); margin-top: 1rem; font-style: italic;">"${item.applicationExamples?.[0] || ''}"</p>`
                        : `${audioBtnHTML}<div style="font-size: 2rem; font-weight: 600;">${item.meaning}</div><p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 1.1rem;">${item.pronunciation} <span style="margin: 0 0.5rem;">&bull;</span> ${item.type}</p><p style="color: var(--text-secondary); margin-top: 1rem; font-style: italic;">"${item.exampleSentence || ''}"</p>`;

                    card.innerHTML = `<div class="flashcard-face">${frontHTML}</div><div class="flashcard-face flashcard-back">${backHTML}</div>`;

                    card.querySelectorAll('.audio-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => { e.stopPropagation(); this.playAudio(e.currentTarget.dataset.audioUrl); });
                    });
                }, 100); // Small delay to allow flip animation to reset

                document.getElementById('card-counter').textContent = `${this.state.currentIndex + 1} / ${this.state.currentSessionItems.length}`;
            },

            navigateCard(direction) {
                const card = document.getElementById('flashcard');
                if (!card) return;
                const animationClass = direction === 1 ? 'slide-out-left' : 'slide-out-right';
                card.parentElement.classList.add(animationClass);
                
                setTimeout(() => {
                    const newIndex = this.state.currentIndex + direction;
                    const total = this.state.currentSessionItems.length;
                    this.state.currentIndex = (newIndex + total) % total;
                    this.updateFlashcardView();
                    card.parentElement.classList.remove('slide-out-left', 'slide-out-right');
                }, 300);
            },

            renderMindmapFamilySelection() {
                const familiesWithMultipleMembers = Object.entries(this.state.wordFamilies).filter(([root, members]) => members.length > 1);
                if (familiesWithMultipleMembers.length === 0) {
                    this.showModal("Th√¥ng b√°o", "Kh√¥ng c√≥ ƒë·ªß t·ª´ c√πng lo·∫°i ƒë·ªÉ t·∫°o s∆° ƒë·ªì.");
                    return;
                }
                this.DOM.main.innerHTML = `
                <div class="glass-card fade-in">
                    <div style="display:flex; align-items:center; margin-bottom: 1.5rem;">
                        <button id="back-to-dashboard-btn" class="cta-btn secondary" style="padding: 8px 16px; margin-right: 1rem;"><i class="fas fa-arrow-left"></i></button>
                        <h2 style="font-family: 'Poppins'; font-size: 1.25rem; font-weight: 600;">Ch·ªçn m·ªôt h·ªç t·ª´</h2>
                    </div>
                    <div id="family-list" style="display:flex; flex-wrap:wrap; gap: 0.75rem;">
                        ${familiesWithMultipleMembers.map(([root, members]) => `
                            <button data-family-root="${root}" class="cta-btn secondary">${root} (${members.length})</button>
                        `).join('')}
                    </div>
                </div>`;
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('family-list').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.familyRoot) this.renderMindmap(button.dataset.familyRoot);
                });
            },

            renderMindmap(familyRoot) {
                const family = this.state.wordFamilies[familyRoot];
                const centerWord = family.find(w => w.familyRoot === w.word) || family[0];
                const children = family.filter(w => w.id !== centerWord.id);

                this.DOM.main.innerHTML = `
                <div class="glass-card fade-in">
                     <div style="display:flex; align-items:center; margin-bottom: 1.5rem;">
                        <button id="back-to-selection-btn" class="cta-btn secondary" style="padding: 8px 16px; margin-right: 1rem;"><i class="fas fa-arrow-left"></i></button>
                        <h2 style="font-family: 'Poppins'; font-size: 1.25rem; font-weight: 600;">H·ªç t·ª´: ${familyRoot}</h2>
                    </div>
                    <div style="position: relative; width: 100%; height: 60vh; display:flex; align-items:center; justify-content:center;" id="mindmap-container">
                    </div>
                </div>`;
                document.getElementById('back-to-selection-btn').addEventListener('click', () => this.renderMindmapFamilySelection());

                const container = document.getElementById('mindmap-container');
                let html = `<div class="mindmap-node center" style="position:relative;"><span>${centerWord.word}</span><span style="font-size:0.8rem; opacity:0.8;">(${centerWord.type})</span></div>`;

                const radius = Math.min(container.offsetWidth / 2.5, 250);
                if (children.length > 0) {
                    const angleStep = 360 / children.length;
                    children.forEach((child, i) => {
                        const angle = angleStep * i - 90; // Start from top
                        const x = radius * Math.cos(angle * Math.PI / 180);
                        const y = radius * Math.sin(angle * Math.PI / 180);
                        
                        const lineAngle = Math.atan2(y, x) * 180 / Math.PI;
                        const lineLength = Math.sqrt(x*x + y*y);

                        html += `<div class="mindmap-line" style="width: ${lineLength}px; top: 50%; left: 50%; transform: rotate(${lineAngle}deg);"></div>`;
                        html += `<div class="mindmap-node child" style="top: 50%; left: 50%; transform: translate(-50%, -50%) translate(${x}px, ${y}px);"><span style="font-weight:600;">${child.word}</span><span style="font-size:0.8rem; opacity:0.8;">(${child.type})</span></div>`;
                    });
                }
                container.innerHTML += html;
            },

            startPractice(mode, count = 10) {
                this.state.currentIndex = 0;
                this.state.currentScore = 0;
                this.state.sessionCorrectItems = [];
                this.state.sessionIncorrectItems = [];
                let itemsToPractice = [];
                const allItems = [...this.state.wordList, ...this.state.structureList];

                if (mode === 'weakness') {
                    const weakItemIds = Object.keys(this.state.progress.incorrectCounts)
                        .sort((a,b) => this.state.progress.incorrectCounts[b] - this.state.progress.incorrectCounts[a]);
                    itemsToPractice = weakItemIds.map(id => allItems.find(item => item.id === id)).filter(Boolean);
                } else {
                    itemsToPractice = allItems;
                }

                if (itemsToPractice.length === 0) {
                    this.showModal("Tuy·ªát v·ªùi!", mode === 'weakness' ? "B·∫°n kh√¥ng c√≥ ƒëi·ªÉm y·∫øu n√†o c·∫ßn √¥n t·∫≠p." : "B·∫°n ƒë√£ h·ªçc h·∫øt m·ªçi th·ª©!");
                    return;
                }
                
                this.state.currentSessionItems = this.shuffleArray(itemsToPractice).slice(0, count);
                this.renderPracticeView();
            },

            renderPracticeView() {
                const total = this.state.currentSessionItems.length;
                const progressPercent = total > 0 ? ((this.state.currentIndex) / total * 100) : 0;
                this.DOM.main.innerHTML = `
                    <div class="glass-card fade-in">
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <p style="font-size: 0.9rem; font-weight: 500;">C√¢u h·ªèi ${this.state.currentIndex + 1} / ${total}</p>
                                <button id="exit-practice-btn" style="font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); background: none; border: none; cursor: pointer;"><i class="fas fa-times" style="margin-right: 0.25rem;"></i> Tho√°t</button>
                            </div>
                            <div class="progress-bar"><div class="progress-bar-fill" style="width: ${progressPercent}%;"></div></div>
                        </div>
                        <div id="question-container" style="min-height: 300px;"></div>
                        <div id="feedback-container" style="margin-top: 1rem;"></div>
                    </div>`;

                document.getElementById('exit-practice-btn').addEventListener('click', () => {
                    this.showModal("X√°c nh·∫≠n Tho√°t", "B·∫°n c√≥ ch·∫Øc mu·ªën d·ª´ng luy·ªán t·∫≠p? Ti·∫øn ƒë·ªô s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.", true, () => this.renderDashboard());
                });
                this.renderNextQuestion();
            },

            renderNextQuestion() {
                if (this.state.currentIndex >= this.state.currentSessionItems.length) {
                    this.renderSummary();
                    return;
                }
                const item = this.state.currentSessionItems[this.state.currentIndex];
                const qContainer = document.getElementById('question-container');
                if (!qContainer) return;
                
                const possibleTypes = this.getPossibleExerciseTypes(item);
                const exerciseType = this.shuffleArray(possibleTypes)[0];
                item.exerciseType = exerciseType;

                const renderFunction = this[`get${exerciseType}HTML`];
                qContainer.innerHTML = renderFunction.call(this, item);
                this.attachPracticeEventListeners(item, qContainer);
            },

            getPossibleExerciseTypes(item) {
                const types = [];
                if (item.itemType === 'word') {
                    if (item.distractors_vi?.length >= 3 && item.distractors_en?.length >= 3) types.push('TraditionalMCQ');
                    if (item.exampleSentence && item.distractors_en?.length >=3) types.push('ContextualMCQ');
                    if (item.exampleSentence) types.push('SentenceUnscramble');
                } else { // structure
                     const sentence = item.applicationExamples?.[0];
                     if (sentence) {
                        const phraseParts = item.phrase.split(/\s+/);
                        const blank = phraseParts.find(p => !['be', 'of', 'to', 'sb', 'sth'].includes(p.toLowerCase()) && p.length > 1 && p.length < 5);
                        if (blank && new RegExp(`\\b${blank}\\b`, 'i').test(sentence)) {
                            item.gapFill = { blank, sentence: sentence.replace(new RegExp(`\\b${blank}\\b`, 'i'), '___') };
                            types.push('GapFill');
                        }
                     }
                }
                return types.length > 0 ? types : ['TraditionalMCQ'];
            },

            getTraditionalMCQHTML(item, isExample = false) {
                const isEngToViet = Math.random() > 0.5;
                const question = isEngToViet ? `${item.word} <span style="font-size: 1rem; font-weight: 400; color: var(--text-secondary);">(${item.type})</span>` : item.meaning;
                this.state.currentCorrectAnswer = isEngToViet ? item.meaning : item.word;

                const distractors = this.shuffleArray(isEngToViet ? [...(item.distractors_vi || [])] : [...(item.distractors_en || [])]).slice(0, 3);
                const options = this.shuffleArray([this.state.currentCorrectAnswer, ...distractors]);

                return `<div><h2 style="font-size: 0.9rem; font-weight: 600; color: var(--primary-accent); margin-bottom: 0.5rem;">Tr·∫Øc nghi·ªám: Ch·ªçn ƒë√°p √°n ƒë√∫ng</h2><div style="font-size: 1.75rem; font-weight: 700; min-height: 60px; margin-bottom: 2rem;">${question}</div><div id="answer-options" style="display:flex; flex-direction: column; gap: 0.75rem;">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div></div>`;
            },
            
            getContextualMCQHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.word;
                const wordRegex = new RegExp(`\\b${item.word.replace(/s$/, '')}(s?)\\b`, 'gi');
                const sentence = item.exampleSentence.replace(wordRegex, `<span style="font-weight: bold; color: var(--primary-accent);">[...]</span>`);
                const distractors = this.shuffleArray([...(item.distractors_en || [])]).slice(0, 3);
                const options = this.shuffleArray([this.state.currentCorrectAnswer, ...distractors]);

                return `<div><h2 style="font-size: 0.9rem; font-weight: 600; color: var(--primary-accent); margin-bottom: 0.5rem;">Tr·∫Øc nghi·ªám: Ho√†n th√†nh c√¢u</h2><p style="font-size: 1.25rem; font-style: italic; color: var(--text-secondary); min-height: 60px; margin-bottom: 2rem;">"${sentence}"</p><div id="answer-options" style="display:flex; flex-direction: column; gap: 0.75rem;">${options.map(opt => `<button class="answer-option" data-answer="${opt}">${opt}</button>`).join('')}</div></div>`;
            },

            getSentenceUnscrambleHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.exampleSentence;
                const words = this.shuffleArray(item.exampleSentence.split(' '));
                return `<div><h2 style="font-size: 0.9rem; font-weight: 600; color: var(--primary-accent); margin-bottom: 0.5rem;">S·∫Øp x·∫øp c√¢u</h2><p style="color: var(--text-secondary); margin-bottom: 1rem;">B·∫•m v√†o c√°c t·ª´ theo ƒë√∫ng th·ª© t·ª± ƒë·ªÉ t·∫°o th√†nh c√¢u ho√†n ch·ªânh.</p><div id="unscramble-answer-area" class="token-area" style="margin-bottom: 1rem;"></div><div id="unscramble-source-area" class="token-area" style="background-color: rgba(0,0,0,0.2);">${words.map(word => `<span class="word-token">${word}</span>`).join('')}</div><div style="margin-top: 1.5rem; text-align: right;"><button id="check-btn" class="cta-btn">Ki·ªÉm tra</button></div></div>`;
            },

            getGapFillHTML(item, isExample = false) {
                this.state.currentCorrectAnswer = item.gapFill.blank;
                return `<div>
                    <h2 style="font-size: 0.9rem; font-weight: 600; color: var(--primary-accent); margin-bottom: 0.5rem;">ƒêi·ªÅn v√†o ch·ªó tr·ªëng</h2>
                    <p style="font-size: 1.25rem; font-style: italic; color: var(--text-secondary); min-height: 60px; margin-bottom: 2rem;">"${item.gapFill.sentence}"</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <div class="text-input-wrapper" style="flex-grow:1;"><input type="text" id="text-input" class="text-input" placeholder="G√µ t·ª´ c√≤n thi·∫øu..."></div>
                        <button id="check-btn" class="cta-btn">Ki·ªÉm tra</button>
                    </div>
                </div>`;
            },

            attachPracticeEventListeners(item, container, isGuide = false) {
                if (!container) return;
                const checkAnswerFunction = this.checkAnswer.bind(this);
                
                switch(item.exerciseType) {
                    case 'TraditionalMCQ': case 'ContextualMCQ':
                        container.querySelectorAll('.answer-option').forEach(option => {
                            option.addEventListener('click', (e) => checkAnswerFunction(e.target.closest('.answer-option').dataset.answer, item, container));
                        });
                        break;
                    case 'GapFill': {
                        const input = container.querySelector('#text-input');
                        const checkBtn = container.querySelector('#check-btn');
                        if (input && checkBtn) {
                            const doCheck = () => checkAnswerFunction(input.value, item, container);
                            checkBtn.addEventListener('click', doCheck);
                            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') doCheck(); });
                        }
                        break;
                    }
                    case 'SentenceUnscramble': {
                        const answerArea = container.querySelector('#unscramble-answer-area');
                        const sourceArea = container.querySelector('#unscramble-source-area');
                        const moveToken = (e) => {
                            if (e.target.classList.contains('word-token')) {
                                const isFromSource = e.currentTarget.id === 'unscramble-source-area';
                                (isFromSource ? answerArea : sourceArea).appendChild(e.target);
                            }
                        };
                        sourceArea.addEventListener('click', moveToken);
                        answerArea.addEventListener('click', moveToken);
                        container.querySelector('#check-btn')?.addEventListener('click', () => {
                            const answer = Array.from(answerArea.querySelectorAll('.word-token')).map(t => t.textContent).join(' ');
                            checkAnswerFunction(answer, item, container);
                        });
                        break;
                    }
                }
            },
            
            checkAnswer(userAnswer, item, container) {
                if (!item) item = this.state.currentSessionItems[this.state.currentIndex];
                const correctAnswer = this.state.currentCorrectAnswer;
                const isCorrect = userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();

                (container || this.DOM.main).querySelectorAll('button, input').forEach(el => el.disabled = true);
                
                const itemId = item.id;
                if (isCorrect) {
                    this.state.currentScore++;
                    this.state.sessionCorrectItems.push(item);
                    this.state.progress.learnedItems.add(itemId);
                    delete this.state.progress.incorrectCounts[itemId];
                } else {
                    this.state.sessionIncorrectItems.push(item);
                    this.state.progress.incorrectCounts[itemId] = (this.state.progress.incorrectCounts[itemId] || 0) + 1;
                }
                
                this.saveProgress();
                this.showFeedback(isCorrect, correctAnswer, container.querySelector('#answer-options')?.parentElement);
            },

            showFeedback(isCorrect, correctAnswer, container = null, isGuide = false) {
                const feedbackContainer = document.getElementById('feedback-container');
                if (!feedbackContainer) return;

                if (container) {
                     container.querySelectorAll('.answer-option').forEach(opt => {
                        opt.classList.add('disabled');
                        if (opt.dataset.answer.toLowerCase() === correctAnswer.toLowerCase()) {
                            opt.classList.add('correct');
                        } else if (opt.classList.contains('incorrect')) {
                           // keep it incorrect if user selected it
                        }
                    });
                }
                
                const bgColor = isCorrect ? 'rgba(34, 197, 94, 0.15)' : 'rgba(239, 68, 68, 0.15)';
                const textColor = isCorrect ? 'var(--correct-color)' : 'var(--incorrect-color)';
                const message = isCorrect ? 'Ch√≠nh x√°c!' : `Kh√¥ng ƒë√∫ng! ƒê√°p √°n ƒë√∫ng l√†: <strong style="font-weight: bold; color: var(--text-light);">${correctAnswer}</strong>`;

                const nextButtonHTML = isGuide ? '' : `<button id="next-question-btn" class="cta-btn secondary" style="padding: 8px 16px;">Ti·∫øp theo <i class="fas fa-arrow-right" style="margin-left: 0.5rem;"></i></button>`;
                feedbackContainer.innerHTML = `
                    <div style="background-color: ${bgColor}; color: ${textColor}; padding: 1rem; border-radius: 0.75rem; display: flex; justify-content: space-between; align-items: center;" class="fade-in">
                        <p style="font-weight: 600;">${message}</p>
                        ${nextButtonHTML}
                    </div>`;

                if (!isGuide) {
                    const nextBtn = document.getElementById('next-question-btn');
                    nextBtn.focus();
                    nextBtn.addEventListener('click', () => {
                        this.state.currentIndex++;
                        this.renderPracticeView();
                    });
                }
            },

            renderSummary() {
                const score = this.state.currentScore;
                const total = this.state.currentSessionItems.length;
                this.DOM.main.innerHTML = `
                    <div class="glass-card fade-in" style="text-align: center;">
                        <h1 style="font-family: 'Poppins'; font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Ho√†n th√†nh Luy·ªán t·∫≠p!</h1>
                        <p style="font-size: 1.125rem; color: var(--text-secondary); margin-bottom: 1.5rem;">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${score} / ${total} c√¢u.</p>
                        <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                            <button id="continue-practice-btn" class="cta-btn" style="width: 100%;">Luy·ªán t·∫≠p l·∫°i</button>
                            <button id="back-to-dashboard-btn" class="cta-btn secondary" style="width: 100%;">Tho√°t</button>
                        </div>
                    </div>`;
                document.getElementById('continue-practice-btn').addEventListener('click', () => this.startPractice('normal'));
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
            },

            startFinalTest() {
                const totalItems = this.state.wordList.length + this.state.structureList.length;
                let numQuestions = Math.min(Math.floor(totalItems * 0.5), 50);

                const weakItemIds = Object.keys(this.state.progress.incorrectCounts)
                    .sort((a,b) => this.state.progress.incorrectCounts[b] - this.state.progress.incorrectCounts[a]);
                
                let itemsToPractice = weakItemIds
                    .map(id => [...this.state.wordList, ...this.state.structureList].find(item => item.id === id))
                    .filter(Boolean);

                if (itemsToPractice.length < numQuestions) {
                    const learnedButNotWeak = [...this.state.progress.learnedItems]
                        .filter(id => !this.state.progress.incorrectCounts[id])
                        .map(id => [...this.state.wordList, ...this.state.structureList].find(item => item.id === id))
                        .filter(Boolean);
                    itemsToPractice.push(...this.shuffleArray(learnedButNotWeak));
                }

                if (itemsToPractice.length === 0) {
                    this.showModal("L·ªói", "Kh√¥ng c√≥ ƒë·ªß m·ª•c ƒë√£ h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu b√†i ki·ªÉm tra cu·ªëi k·ª≥.");
                    return;
                }

                this.state.currentSessionItems = itemsToPractice.slice(0, numQuestions);
                this.state.currentIndex = 0;
                this.state.currentScore = 0;
                this.state.sessionCorrectItems = [];
                this.state.sessionIncorrectItems = [];
                this.state.proctoring.violations = 0;
                this.state.proctoring.timeRemaining = this.state.currentSessionItems.length * 75;

                this.renderFinalTestView();
                this.startProctoring();
            },

            renderFinalTestView() {
                // This function needs to be implemented if you want a final test view
            },

            startProctoring() {
                // This function needs to be implemented for proctoring
            },
            
            stopProctoring() {
                // This function needs to be implemented to stop proctoring
            },

            async submitFinalTest() {
                // This function needs to be implemented to submit the final test
            },

            playAudio(url) {
                if (!url) {
                    console.warn("No audio URL provided.");
                    return;
                }
                this.state.audioPlayer.src = url;
                this.state.audioPlayer.playbackRate = this.state.playbackRate;
                this.state.audioPlayer.play().catch(e => console.error("Audio play failed:", e));
            },

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            findRoot(word) {
                const endings = ['s', 'es', 'ing', 'ed', 'er', 'est', 'ly', 'tion', 'sion', 'ment', 'able', 'ible', 'al', 'ial', 'ive', 'ous', 'ness'];
                for (const ending of endings) {
                    if (word.length > ending.length + 3 && word.endsWith(ending)) {
                        return word.slice(0, -ending.length);
                    }
                }
                return word;
            },

            showModal(title, message, showCancel = false, onConfirm = null) {
                const modalId = 'main-modal';
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modalOverlay = document.createElement('div');
                modalOverlay.id = modalId;
                modalOverlay.className = "modal-overlay";

                const buttonsHTML = showCancel 
                    ? `<button id="modal-cancel-btn" class="cta-btn secondary">H·ªßy</button><button id="modal-confirm-btn" class="cta-btn">X√°c nh·∫≠n</button>`
                    : `<button id="modal-confirm-btn" class="cta-btn" style="width: 100%;">OK</button>`;

                modalOverlay.innerHTML = `
                    <div class="modal-content glass-card fade-in">
                        <h3 style="font-family: 'Poppins'; font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">${title}</h3>
                        <div style="color: var(--text-secondary); margin-bottom: 1.5rem;">${message}</div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">${buttonsHTML}</div>
                    </div>`;
                this.DOM.modal.appendChild(modalOverlay);

                const closeModal = () => modalOverlay.remove();
                modalOverlay.querySelector('#modal-confirm-btn').onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
                if(showCancel) { modalOverlay.querySelector('#modal-cancel-btn').onclick = closeModal; }
            },
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
