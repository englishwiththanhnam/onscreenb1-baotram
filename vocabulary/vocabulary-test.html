<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học và Luyện tập Từ vựng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBUet6ZsBTwJG_gTKM2bGFG1AKD3t0hV20",
            authDomain: "b1-baotram.firebaseapp.com",
            projectId: "b1-baotram",
            storageBucket: "b1-baotram.appspot.com",
            messagingSenderId: "948701163187",
            appId: "1:948701163187:web:043f2d381d63e741114ac6",
            measurementId: "G-33NHT07JHE"
        };
        window.firebaseConfig = firebaseConfig;
    </script>

    <style>
        :root {
            --primary-color: #6d28d9; --primary-hover: #5b21b6;
            --bg-light: #f5f7ff; --bg-card: #ffffff; --text-primary: #0f172a;
            --text-secondary: #475569; --border-color: #e5e7eb;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--bg-light); color: var(--text-primary); }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--bg-card); color: var(--text-secondary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: #f9fafb; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-fill { background-color: var(--primary-color); height: 100%; transition: width 0.4s ease; }
        
        /* Flashcard Styles */
        .flashcard-viewer { display: flex; flex-direction: column; height: 70vh; max-width: 800px; margin: 0 auto; }
        .flashcard-main { flex-grow: 1; display: flex; align-items: center; justify-content: center; perspective: 1000px; }
        .flashcard { width: 100%; height: 80%; max-height: 400px; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--bg-card); border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07); padding: 2rem; text-align: center; }
        .flashcard-back { transform: rotateY(180deg); }
        .flashcard-nav { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; }

        /* Mindmap Styles */
        .mindmap-node { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; text-align: center; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .mindmap-node.center { width: 150px; height: 150px; background-color: var(--primary-color); color: white; font-weight: bold; font-size: 1.25rem; z-index: 10; }
        .mindmap-node.child { width: 110px; height: 110px; font-size: 0.9rem; cursor: pointer; background-color: #eef2ff; color: #4338ca; }
        .mindmap-line { position: absolute; height: 2px; background-color: #cbd5e1; transform-origin: 0 50%; z-index: 1; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-8 border-t-violet-500 border-gray-200 rounded-full animate-spin"></div>
            <p class="text-lg font-semibold text-white mt-4">Đang tải dữ liệu bài học...</p>
        </div>
    </div>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-8 hidden">
        <header id="app-header" class="mb-8"></header>
        <main id="app-main"></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const App = {
            // Trạng thái tập trung của ứng dụng
            state: {
                db: null,
                submissionId: null,
                studentName: '',
                testData: {},
                wordList: [],
                structureList: [],
                wordFamilies: {},
                flashcardQueue: [],
                currentIndex: 0,
                progress: {
                    learnedItems: new Set(),
                },
                isSubmitting: false,
            },

            // Cache các đối tượng DOM
            DOM: {
                loader: document.getElementById('loader-overlay'),
                container: document.getElementById('app-container'),
                header: document.getElementById('app-header'),
                main: document.getElementById('app-main'),
            },

            // --- 1. CORE LOGIC ---

            async init() {
                this.state.db = getFirestore(initializeApp(window.firebaseConfig));
                const params = new URLSearchParams(window.location.search);
                const submissionId = params.get('submission_id');

                if (!submissionId) {
                    this.showModal("Lỗi", "Không tìm thấy mã dự thi. Vui lòng truy cập lại từ cổng chính.");
                    return;
                }
                
                this.state.submissionId = submissionId;
                await this.startSession(submissionId);
            },
            
            async startSession(submissionId) {
                try {
                    const submissionRef = doc(this.state.db, 'submissions', submissionId);
                    const submissionSnap = await getDoc(submissionRef);
                    if (!submissionSnap.exists()) throw new Error("Mã truy cập không hợp lệ.");

                    let submissionData = submissionSnap.data();
                    if (submissionData.status === 'submitted') {
                        this.showModal("Thông báo", "Bạn đã hoàn thành bài học này.", false, () => window.location.href='index.html');
                        return;
                    }
                    
                    const testRef = doc(this.state.db, 'vocab_sets', submissionData.testId);
                    const testSnap = await getDoc(testRef);
                    if (!testSnap.exists()) throw new Error("Không tìm thấy bộ từ vựng tương ứng.");

                    this.state.studentName = submissionData.studentName;
                    this.state.testData = testSnap.data();
                    this.state.wordList = this.state.testData.wordList || [];
                    
                    this.processData();
                    this.loadProgress();
                    
                    this.DOM.loader.classList.add('hidden');
                    this.DOM.container.classList.remove('hidden');
                    
                    this.renderHeader();
                    this.renderDashboard();
                } catch (error) {
                    this.showModal("Lỗi", error.message);
                }
            },
            
            processData() {
                const structures = [];
                const families = {};
                this.state.wordList.forEach(word => {
                    word.itemType = 'word';
                    if (word.structures && Array.isArray(word.structures)) {
                        word.structures.forEach((struct, index) => {
                            structures.push({
                                ...struct,
                                id: `structure_${word.id}_${index}`,
                                itemType: 'structure',
                                rootWord: word.word
                            });
                        });
                    }
                    // Tự suy luận familyRoot nếu API chưa cung cấp
                    const root = word.familyRoot || word.word.toLowerCase();
                    if (!families[root]) families[root] = [];
                    families[root].push(word);
                });
                this.state.structureList = structures;
                this.state.wordFamilies = families;
            },

            // --- 2. PROGRESS MANAGEMENT ---

            loadProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                const savedProgress = localStorage.getItem(progressKey);
                if (savedProgress) {
                    const parsed = JSON.parse(savedProgress);
                    this.state.progress.learnedItems = new Set(parsed.learnedItems || []);
                }
            },

            saveProgress() {
                const progressKey = `vocabProgress_${this.state.submissionId}`;
                const progressToSave = {
                    learnedItems: [...this.state.progress.learnedItems],
                };
                localStorage.setItem(progressKey, JSON.stringify(progressToSave));
            },

            // --- 3. UI RENDERING ---

            renderHeader() {
                 this.DOM.header.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">${this.state.testData.title}</h1>
                            <p class="text-sm text-gray-500">Học viên: <span class="font-medium">${this.state.studentName}</span></p>
                        </div>
                        <button id="submit-final-btn" class="btn btn-primary"><i class="fas fa-check-circle mr-2"></i> Hoàn thành & Lưu tiến độ</button>
                    </div>`;
                document.getElementById('submit-final-btn').addEventListener('click', () => {
                    this.showModal(
                        "Xác nhận Hoàn thành",
                        "Bạn có chắc muốn kết thúc và lưu tiến độ học tập không? Thao tác này sẽ ghi nhận kết quả cuối cùng.",
                        true, // showCancel
                        () => this.submitToFirebase(true) // onConfirm
                    );
                });
            },

            renderDashboard() {
                const { wordList, structureList, progress } = this.state;
                const vocabLearned = wordList.filter(w => progress.learnedItems.has(`word_${w.id}`)).length;
                const structLearned = structureList.filter(s => progress.learnedItems.has(s.id)).length;
                const vocabProgress = wordList.length > 0 ? (vocabLearned / wordList.length * 100) : 0;
                const structProgress = structureList.length > 0 ? (structLearned / structureList.length * 100) : 0;
                
                this.DOM.main.innerHTML = `
                    <div class="space-y-8 fade-in">
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h2 class="text-xl font-bold mb-4">Tổng quan Tiến độ</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><p class="font-medium mb-1">Từ vựng đã học</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${vocabProgress.toFixed(0)}%;"></div></div><p class="text-right text-sm mt-1">${vocabLearned}/${wordList.length}</p></div>
                                <div><p class="font-medium mb-1">Cấu trúc đã học</p><div class="progress-bar"><div class="progress-bar-fill" style="width: ${structProgress.toFixed(0)}%;"></div></div><p class="text-right text-sm mt-1">${structLearned}/${structureList.length}</p></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h2 class="text-xl font-bold mb-4">Học tập 📚</h2>
                            <div id="study-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button data-study-mode="vocab-flashcard" class="btn btn-secondary !p-4 !items-start text-left"><div class="text-lg"><i class="fas fa-clone w-6 text-violet-500"></i></div><div><p class="font-bold">Flashcard Từ vựng</p><p class="text-xs font-normal">Học từ mới qua thẻ ghi nhớ.</p></div></button>
                                <button data-study-mode="mindmap" class="btn btn-secondary !p-4 !items-start text-left"><div class="text-lg"><i class="fas fa-project-diagram w-6 text-sky-500"></i></div><div><p class="font-bold">Sơ đồ Họ từ</p><p class="text-xs font-normal">Khám phá mối liên hệ các từ.</p></div></button>
                                <button data-study-mode="struct-flashcard" class="btn btn-secondary !p-4 !items-start text-left"><div class="text-lg"><i class="fas fa-sitemap w-6 text-emerald-500"></i></div><div><p class="font-bold">Flashcard Cấu trúc</p><p class="text-xs font-normal">Học các cấu trúc câu quan trọng.</p></div></button>
                            </div>
                        </div>
                    </div>`;

                document.getElementById('study-buttons').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const mode = button.dataset.studyMode;
                    if (mode === 'vocab-flashcard') this.startFlashcardSession('word');
                    if (mode === 'struct-flashcard') this.startFlashcardSession('structure');
                    if (mode === 'mindmap') this.renderMindmapFamilySelection();
                });
            },
            
            // --- 4. STUDY IMPLEMENTATION: FLASHCARD ---
            startFlashcardSession(type) {
                this.state.flashcardQueue = type === 'word' ? this.state.wordList : this.state.structureList;
                if(this.state.flashcardQueue.length === 0) {
                    this.showModal("Thông báo", "Không có dữ liệu cho phần học này.");
                    return;
                }
                this.state.currentIndex = 0;
                this.renderFlashcardViewer();
            },
            
            renderFlashcardViewer() {
                this.DOM.main.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                    <div class="flashcard-viewer">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-to-dashboard-btn" class="btn btn-secondary !py-2 !px-4"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                            <div id="card-counter" class="font-semibold text-slate-700"></div>
                        </div>
                        <div class="flashcard-main"><div class="flashcard" id="flashcard"></div></div>
                        <div class="flashcard-nav">
                            <button id="prev-card-btn" class="btn btn-secondary !rounded-full !w-14 !h-14"><i class="fas fa-arrow-left"></i></button>
                            <p class="text-sm text-gray-500">Nhấn vào thẻ để lật</p>
                            <button id="next-card-btn" class="btn btn-secondary !rounded-full !w-14 !h-14"><i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>`;
                
                this.updateFlashcardView();
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('flashcard').addEventListener('click', e => e.currentTarget.classList.toggle('is-flipped'));
                document.getElementById('prev-card-btn').addEventListener('click', () => this.navigateCard(-1));
                document.getElementById('next-card-btn').addEventListener('click', () => this.navigateCard(1));
            },

            updateFlashcardView() {
                const item = this.state.flashcardQueue[this.state.currentIndex];
                const card = document.getElementById('flashcard');
                if (!item || !card) return;

                // Đánh dấu là đã học khi xem flashcard
                const itemId = item.itemType === 'word' ? `word_${item.id}` : item.id;
                this.state.progress.learnedItems.add(itemId);
                this.saveProgress();

                card.classList.remove('is-flipped');
                const isStructure = item.itemType === 'structure';
                const frontHTML = `<div class="text-4xl font-bold">${isStructure ? item.phrase : item.word}</div>`;
                const backHTML = isStructure
                    ? `<div class="text-2xl font-semibold">${item.meaning}</div><p class="text-slate-500 mt-4 italic">"${item.applicationExamples[0] || ''}"</p>`
                    : `<div class="text-2xl font-semibold">${item.meaning}</div><p class="text-slate-500 mt-2">${item.pronunciation} <span class="mx-2">&bull;</span> ${item.type}</p><p class="text-slate-500 mt-4 italic">"${item.exampleSentence || ''}"</p>`;
                
                setTimeout(() => { card.innerHTML = `<div class="flashcard-face flashcard-front">${frontHTML}</div><div class="flashcard-face flashcard-back">${backHTML}</div>`; }, 100);
                document.getElementById('card-counter').textContent = `${this.state.currentIndex + 1} / ${this.state.flashcardQueue.length}`;
            },

            navigateCard(direction) {
                const newIndex = this.state.currentIndex + direction;
                const total = this.state.flashcardQueue.length;
                this.state.currentIndex = (newIndex + total) % total; // Vòng lặp
                this.updateFlashcardView();
            },

            // --- 5. STUDY IMPLEMENTATION: MINDMAP ---
            renderMindmapFamilySelection() {
                const familiesWithMultipleMembers = Object.entries(this.state.wordFamilies).filter(([root, members]) => members.length > 1);

                if (familiesWithMultipleMembers.length === 0) {
                    this.showModal("Thông báo", "Không có đủ họ từ để tạo sơ đồ.");
                    return;
                }

                this.DOM.main.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                    <div class="flex items-center mb-6">
                        <button id="back-to-dashboard-btn" class="btn btn-secondary !py-2 !px-4 mr-4"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold">Chọn một họ từ để khám phá</h2>
                    </div>
                    <div id="family-list" class="flex flex-wrap gap-3">
                        ${familiesWithMultipleMembers.map(([root, members]) => `
                            <button data-family-root="${root}" class="btn btn-secondary !py-3 !px-5">${root} (${members.length})</button>
                        `).join('')}
                    </div>
                </div>`;

                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => this.renderDashboard());
                document.getElementById('family-list').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.familyRoot) {
                        this.renderMindmap(button.dataset.familyRoot);
                    }
                });
            },

            renderMindmap(familyRoot) {
                const family = this.state.wordFamilies[familyRoot];
                const centerWord = family[0];

                this.DOM.main.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm fade-in">
                    <div class="flex items-center mb-6">
                         <button id="back-to-selection-btn" class="btn btn-secondary !py-2 !px-4 mr-4"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold">Họ từ: ${familyRoot}</h2>
                    </div>
                    <div class="relative w-full h-[60vh] flex items-center justify-center overflow-hidden">
                        <div id="mindmap" class="relative w-[150px] h-[150px]"></div>
                    </div>
                </div>`;
                document.getElementById('back-to-selection-btn').addEventListener('click', () => this.renderMindmapFamilySelection());

                const container = document.getElementById('mindmap');
                const children = family.slice(1);
                let html = `<div class="mindmap-node center"><span>${centerWord.word}</span><span class="text-sm font-normal">(${centerWord.type})</span></div>`;

                if (children.length > 0) {
                    const angleStep = 360 / children.length;
                    const radius = Math.min(container.parentElement.offsetWidth / 2.5, 250);
                    children.forEach((child, i) => {
                        const angle = angleStep * i;
                        const x = radius * Math.cos(angle * Math.PI / 180);
                        const y = radius * Math.sin(angle * Math.PI / 180);
                        html += `<div class="mindmap-line" style="width: ${radius}px; transform: translate(75px, 75px) rotate(${angle}deg);"></div>`;
                        html += `<div class="mindmap-node child" style="transform: translate(${x}px, ${y}px) translate(20px, 20px);"><span class="font-semibold">${child.word}</span><span class="text-xs">(${child.type})</span></div>`;
                    });
                }
                container.innerHTML = html;
            },

            // --- 6. SUBMISSION & UTILITIES ---
            async submitToFirebase(isFinal = false) {
                 if (this.state.isSubmitting) return;
                this.state.isSubmitting = true;
                this.DOM.loader.classList.remove('hidden');

                const learnedCount = this.state.progress.learnedItems.size;
                const totalItems = this.state.wordList.length + this.state.structureList.length;
                const score = totalItems > 0 ? Math.round((learnedCount / totalItems) * 100) : 0;
                
                const finalSubmission = {
                    score: score, totalPoints: 100,
                    status: isFinal ? 'submitted' : 'in-progress',
                    answers: { learnedCount, totalItems },
                    endTime: isFinal ? serverTimestamp() : null,
                };

                try {
                    await updateDoc(doc(this.state.db, 'submissions', this.state.submissionId), finalSubmission);
                    if (isFinal) {
                        localStorage.removeItem(`vocabProgress_${this.state.submissionId}`);
                        this.showModal("Thành công!", `Đã nộp bài thành công với tiến độ ${score}%.`, false, () => window.location.href='index.html');
                    }
                } catch(error) { this.showModal("Lỗi", "Không thể lưu tiến độ: " + error.message); }
                 finally { 
                    this.state.isSubmitting = false;
                    this.DOM.loader.classList.add('hidden');
                 }
            },
            
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            showModal(title, message, showCancel = false, onConfirm = null) {
                this.DOM.loader.classList.add('hidden');
                const modalContainer = document.createElement('div');
                modalContainer.className = "fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50";
                
                const buttonsHTML = showCancel 
                    ? `<button id="modal-cancel-btn" class="btn btn-secondary">Hủy</button><button id="modal-confirm-btn" class="btn btn-primary">Đồng ý</button>`
                    : `<button id="modal-confirm-btn" class="btn btn-primary w-full">Đã hiểu</button>`;
                
                modalContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm fade-in">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex gap-4 justify-center">${buttonsHTML}</div>
                    </div>`;
                document.body.appendChild(modalContainer);

                const confirmBtn = modalContainer.querySelector('#modal-confirm-btn');
                const cancelBtn = modalContainer.querySelector('#modal-cancel-btn');

                confirmBtn.onclick = () => {
                    modalContainer.remove();
                    if (onConfirm) onConfirm();
                };
                if(cancelBtn) {
                    cancelBtn.onclick = () => modalContainer.remove();
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
